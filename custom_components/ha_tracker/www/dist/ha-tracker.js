var ct=null;async function pn(){try{let e=new URLSearchParams(window.location.search);if(e.has("code")){let t=e.get("code");await gn(t)}}catch(e){throw console.error("Error during authentication:",e),e}}async function hn(){return ct||(ct=(async()=>{if(window!==window.parent){let{token:t,exp:n}=await Ko();if(!t||!t.trim())throw new Error("Empty token from parent");return t}else{await Jo();let t=localStorage.getItem("hassTokens"),n=t?JSON.parse(t):null;if(!n?.access_token)throw new Error("No access_token in hassTokens");let o=typeof n.expires=="number"?n.expires:0,r=Date.now();if(o&&r>=o)throw new Error("Token has expired");return n.access_token}})().finally(()=>{ct=null})),ct}function Ko(e=7e3){return new Promise((t,n)=>{let o=Math.random().toString(36).slice(2),r=window.parent,s="";try{s=new URL(document.referrer).origin}catch{}s||(s=window.location.origin);let a=setTimeout(()=>{window.removeEventListener("message",i),n(new Error("Token not returned"))},e);function i(d){if(d.source!==r||d.origin!==s&&d.origin!==window.location.origin)return;let c=d.data||{};if(c.type==="auth-token"&&c.reqId===o&&c.token){clearTimeout(a),window.removeEventListener("message",i);let m=typeof c.exp=="number"&&isFinite(c.exp)?c.exp:0;t({token:c.token,exp:m})}}window.addEventListener("message",i),window.parent.postMessage({type:"request-token",reqId:o},s||"*")})}async function Jo(){let e=localStorage.getItem("hassTokens");try{if(e){let o=JSON.parse(e),r=Number(o.expires||0);if(r&&Date.now()<r-900*1e3||(console.log("The token has expired. Trying to renew it..."),await Yo(o.refresh_token)))return}console.log("No valid token found. Redirecting to authorize...");let t=`${H}/local/ha-tracker/index.html`,n=`${H}/auth/authorize?client_id=${encodeURIComponent(`${H}/`)}&redirect_uri=${encodeURIComponent(t)}`;window.location.href=n}catch(t){console.error("Error during authenticate:",t)}}async function Yo(e){try{let t=await yn(e);if(!t)return console.error("Failed to renew token."),!1;let n=localStorage.getItem("hassTokens");if(!n)return console.error("No existing token found in local storage."),!1;let o=JSON.parse(n);return t.refresh_token=o.refresh_token,t.hassUrl=o.hassUrl,t.clientId=o.clientId,t.ha_auth_provider=o.ha_auth_provider,t.expires=Date.now()+t.expires_in*1e3,localStorage.setItem("hassTokens",JSON.stringify(t)),console.log("Token renewed and stored:",t),!0}catch(t){return console.error("Error processing renewed token:",t),!1}}var G=typeof window<"u"?window:globalThis;G.__assetLoader??(G.__assetLoader={js:new Map,css:new Map});function bn(e){return new Promise((t,n)=>{if(e.dataset.loaded==="true"||e.readyState==="complete")return t();e.addEventListener("load",()=>t(),{once:!0}),e.addEventListener("error",()=>n(new Error("Resource failed: "+(e.src||e.href))),{once:!0})})}function Be(e,{attrs:t={},matchPrefix:n=!0}={}){let o=e;if(G.__assetLoader.css.has(o))return G.__assetLoader.css.get(o);let r=n?`link[rel="stylesheet"][href^="${e}"]`:`link[rel="stylesheet"][href="${e}"]`,s=document.querySelector(r);if(s){let i=bn(s);return G.__assetLoader.css.set(o,i),i.finally(()=>G.__assetLoader.css.delete(o))}let a=new Promise((i,d)=>{let c=document.createElement("link");c.rel="stylesheet",c.href=e;for(let[m,p]of Object.entries(t))c.setAttribute(m,p);c.onload=()=>{c.dataset.loaded="true",i()},c.onerror=()=>d(new Error("CSS not loaded: "+e)),document.head.appendChild(c)});return G.__assetLoader.css.set(o,a),a.finally(()=>G.__assetLoader.css.delete(o))}function xe(e,{attrs:t={},matchPrefix:n=!0,test:o=null}={}){try{if(typeof o=="function"&&o())return Promise.resolve()}catch{}let r=e;if(G.__assetLoader.js.has(r))return G.__assetLoader.js.get(r);let s=n?`script[src^="${e}"]`:`script[src="${e}"]`,a=document.querySelector(s);if(a){let d=bn(a).then(()=>{if(typeof o=="function"&&!o())throw new Error("Script present but test() failed: "+e)});return G.__assetLoader.js.set(r,d),d.finally(()=>G.__assetLoader.js.delete(r))}let i=new Promise((d,c)=>{let m=document.createElement("script");m.src=e,m.async=!0;for(let[p,l]of Object.entries(t))m.setAttribute(p,l);m.onload=()=>{m.dataset.loaded="true";try{typeof o=="function"&&!o()?c(new Error("Script loaded but test() failed: "+e)):d()}catch(p){c(p)}},m.onerror=()=>c(new Error("Script not loaded: "+e)),document.head.appendChild(m)});return G.__assetLoader.js.set(r,i),i.finally(()=>G.__assetLoader.js.delete(r))}var zt="en",wn={};async function vn(e){try{let t=await fetch(`locales/${e}.json`);if(!t.ok)throw new Error(`Translation not found for ${e}`);wn=await t.json(),zt=e,Xo()}catch(t){if(console.error(`Error loading translations for ${e}.`,t),e==="en"){console.error("The English translation file could not be loaded. No changes will be made to the texts.");return}else console.error("Trying to load english as fallback."),await vn("en")}}function u(e){return wn[e]||e}function xn(e,t={}){let n=u(e);for(let[o,r]of Object.entries(t))n=n.replace(`{${o}}`,r);return n}function Xo(){document.querySelectorAll("[data-i18n]").forEach(e=>{let t=e.getAttribute("data-i18n");e.textContent=u(t)}),document.querySelectorAll("[data-i18n-placeholder]").forEach(e=>{let t=e.getAttribute("data-i18n-placeholder"),n=u(t);n&&n!==t&&(e.placeholder=n)})}async function En(){let e=navigator.language.slice(0,2);document.documentElement.setAttribute("lang",e),await vn(e)}var w,Ye={leafletCSS:"https://unpkg.com/leaflet@1.9.4/dist/leaflet.css",leafletJS:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js",geocoderCSS:"https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css",geocoderJS:"https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js",editableJS:"https://cdnjs.cloudflare.com/ajax/libs/leaflet-editable/1.3.0/Leaflet.Editable.min.js"};async function Qo(){await Be(Ye.leafletCSS),await Be(Ye.geocoderCSS),await xe(Ye.leafletJS,{test:()=>!!window.L}),await xe(Ye.editableJS,{test:()=>!!(window.L&&L.Editable)}),await xe(Ye.geocoderJS,{test:()=>!!(window.L&&L.Control&&L.Control.Geocoder)})}async function Sn(){try{let p=function(){let l=w.getBounds();m.options.geocoder.options.geocodingQueryParams.viewbox=[l.getWest(),l.getSouth(),l.getEast(),l.getNorth()].join(","),m.options.geocoder.options.geocodingQueryParams.bounded=1};await Qo();let e={center:[40.4168,-3.7038],zoom:6,editable:!0,preferCanvas:!0};w=L.map("map",e);let t={maxZoom:19,minZoom:1,crossOrigin:!0},n={OpenStreetMap:L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{...t,attribution:"\xA9 OpenStreetMap contributors"}),"Esri Sat\xE9lite":L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{...t,attribution:"\xA9 Esri, Maxar, Earthstar Geographics"})};n.OpenStreetMap.addTo(w),L.control.layers(n,null,{position:"topleft"}).addTo(w);let r=L.control.scale({position:"bottomleft"}).addTo(w),s=document.querySelector(".leaflet-control-layers"),a=document.querySelector(".leaflet-control-zoom");if(s&&a){let l=a.getBoundingClientRect();s.style.position="absolute",s.style.left=`${l.right}px`}let i=()=>w&&w.invalidateSize(!0);document.body.addEventListener("transitionend",l=>{l.target===document.body&&l.propertyName==="opacity"&&setTimeout(i,0)},{once:!0});let d=document.getElementById("map");d&&"ResizeObserver"in window&&new ResizeObserver(()=>i()).observe(d),window.addEventListener("resize",i),document.addEventListener("visibilitychange",()=>{document.hidden||setTimeout(i,0)}),setTimeout(i,350);let c=navigator.languages&&navigator.languages.length?navigator.languages.join(","):navigator.language||"en",m=L.Control.geocoder({position:"bottomleft",placeholder:u("search_place"),collapsed:!1,defaultMarkGeocode:!1,geocoder:L.Control.Geocoder.nominatim({geocodingQueryParams:{"accept-language":c,limit:5}})}).on("markgeocode",l=>{let{center:h,name:f,bbox:g}=l.geocode;g?w.fitBounds(g):w.setView(h,16),L.popup({autoClose:!0,closeOnClick:!0,keepInView:!0}).setLatLng(h).setContent(f).openOn(w)}).addTo(w);w.on("moveend",p),p(),setTimeout(()=>w.invalidateSize(!0),0)}catch(e){console.error("Error starting map:",e)}}function Ft(e,t){return e!=null&&t!=null&&!isNaN(e)&&!isNaN(t)}function ut(e,t,n,o){let s=dt(n-e),a=dt(o-t),i=Math.sin(s/2)*Math.sin(s/2)+Math.cos(dt(e))*Math.cos(dt(n))*Math.sin(a/2)*Math.sin(a/2);return 6371e3*(2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)))}function dt(e){return e*(Math.PI/180)}var er=["#008000","#09CB09","#946F24","#333333","#999999","#EEF077","#BBB31A","#ECAA77","#981052","#D265E4","#854CD7","#2196F3","#28A289","#0000FF","#42DFD3","#FF0000","#D2A3A3"],Ee=null,Y=null,ae=null,_n=!1;function tr(){if(_n)return;let e=document.createElement("style");e.id="window-overlay-styles",e.textContent=`
    #window-overlay{
      position: fixed; inset: 0; display: none;
      align-items: center; justify-content: center;
      background: rgba(0,0,0,.35);
      z-index: 2147483647;
    }
    #window-message{
      padding: 14px 18px;
      border-radius: 12px;
      border: 2px solid transparent;
      font: 600 15px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      box-shadow: 0 8px 30px rgba(0,0,0,.2);
      user-select: none;
    }`,document.head.appendChild(e),_n=!0}function nr(){Y&&ae||(tr(),Y=document.getElementById("window-overlay"),ae=document.getElementById("window-message"),Y||(Y=document.createElement("div"),Y.id="window-overlay",document.body.appendChild(Y)),ae||(ae=document.createElement("div"),ae.id="window-message",ae.dataset.i18n="loading",ae.textContent="Loading",Y.appendChild(ae)))}function mt(e="Mensaje",t="rgba(0, 0, 255, 0.5)",n="white",o="rgba(0, 0, 200, 0.8)",r="rgba(0,0,0,.35)"){nr(),Y.style.display!=="flex"&&(Y.style.background=r,ae.textContent=e,ae.style.backgroundColor=t,ae.style.color=n,ae.style.border=`2px solid ${o}`,Y.style.display="flex")}function ft(){Y&&(Y.style.display==="none"||Y.style.display===""||(Y.style.display="none"))}function $n(e,t={}){return Ee?Promise.resolve(!1):(Ee="confirm",new Promise(n=>{let o=Rt({title:t.title??u("confirmation"),message:e,type:t.type??"info",okLabel:t.okLabel??u("accept"),cancelLabel:t.cancelLabel??u("cancel")});Ot(o,{withInput:!1,resolve:n}),o.focusDefault()}))}function Bt(e,t="",n={}){return Ee?Promise.resolve(null):(Ee="prompt",new Promise(o=>{let r=Rt({title:n.title??u("enter_value"),message:e,type:n.type??"info",withInput:!0,inputValue:t,inputDisabled:n.inputDisabled===!0,placeholder:n.placeholder??"",withColor:n.withColor===!0,colorValue:n.defaultColor??Z,colorLabel:n.colorLabel,withVisibility:n.withVisibility===!0,visibilityValue:n.visibilityValue!==!1,visibilityLabel:n.visibilityLabel||"Mostrar en el mapa",okLabel:n.okLabel??u("save"),cancelLabel:n.cancelLabel??u("cancel"),colorOptions:n.colorOptions});Ot(r,{withInput:!0,withColor:n.withColor===!0,withVisibility:n.withVisibility===!0,resolve:o}),r.focusDefault()}))}function B(e,t={}){return Ee?Promise.resolve():(Ee="alert",new Promise(n=>{let o=Rt({title:t.title??u("information"),message:e,type:t.type??"info",okLabel:t.okLabel??u("accept"),cancelLabel:u("close")});(t.hideCancel??!0)&&o.modal.querySelector(".btn-secondary")?.remove(),Ot(o,{withInput:!1,resolve:n}),o.focusDefault()}))}function Se(e,t=U){let n=String(e||"").trim().toLowerCase(),o=/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i.exec(n),r=/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i.exec(n),s=/^#([0-9a-f]{8})$/i.exec(n),a,i,d;if(o)a=parseInt(o[1]+o[1],16),i=parseInt(o[2]+o[2],16),d=parseInt(o[3]+o[3],16);else if(r)a=parseInt(r[1],16),i=parseInt(r[2],16),d=parseInt(r[3],16);else if(s)a=parseInt(s[1].slice(0,2),16),i=parseInt(s[1].slice(2,4),16),d=parseInt(s[1].slice(4,6),16);else return null;let c=Math.min(1,Math.max(0,Number(t)||0));return`rgba(${a},${i},${d},${c})`}function or(e){let t=String(e||"").trim().toLowerCase(),n=/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i.exec(t),o=/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i.exec(t),r=/^#([0-9a-f]{8})$/i.exec(t),s,a,i;if(n)s=parseInt(n[1]+n[1],16),a=parseInt(n[2]+n[2],16),i=parseInt(n[3]+n[3],16);else if(o)s=parseInt(o[1],16),a=parseInt(o[2],16),i=parseInt(o[3],16);else if(r)s=parseInt(r[1].slice(0,2),16),a=parseInt(r[1].slice(2,4),16),i=parseInt(r[1].slice(4,6),16);else return null;return{r:s,g:a,b:i}}function rr(){let e=document.getElementById("ui-modal-root");e||(e=document.createElement("div"),e.id="ui-modal-root",document.body.appendChild(e));let t=document.getElementById("ui-toast-root");return t||(t=document.createElement("div"),t.id="ui-toast-root",document.body.appendChild(t)),{modalRoot:e,toastRoot:t}}function sr(e){let t=["a[href]","button:not([disabled])","textarea:not([disabled])","input:not([disabled])","select:not([disabled])",'[tabindex]:not([tabindex="-1"])'],n=e.querySelectorAll(t.join(",")),o=n[0],r=n[n.length-1];function s(a){a.key==="Tab"&&n.length&&(a.shiftKey&&document.activeElement===o?(a.preventDefault(),r.focus()):!a.shiftKey&&document.activeElement===r&&(a.preventDefault(),o.focus()))}return e.addEventListener("keydown",s),()=>e.removeEventListener("keydown",s)}function Rt({title:e,message:t,type:n="info",withInput:o=!1,inputValue:r="",inputDisabled:s=!1,placeholder:a="",withColor:i=!1,colorValue:d=Z,colorLabel:c,withVisibility:m=!1,visibilityValue:p=!0,visibilityLabel:l="Mostrar en el mapa",okLabel:h,cancelLabel:f,colorOptions:g={}}){let{modalRoot:b}=rr(),_=document.createElement("div");_.className="modal-overlay",_.setAttribute("role","dialog"),_.setAttribute("aria-modal","true");let T=document.createElement("div");T.className=`modal modal-${n}`;let x=document.createElement("div");x.className="modal-header",x.innerHTML=`<span class="modal-title">${e||""}</span>`;let S=document.createElement("button");S.className="modal-close",S.setAttribute("aria-label",u("close")),S.textContent="\xD7",x.appendChild(S);let v=document.createElement("div");v.className="modal-body";let E=document.createElement("div");E.className="modal-message",E.textContent=t||"",v.appendChild(E);let y=null;o&&(y=document.createElement("input"),y.className="modal-input",y.type="text",y.value=r??"",s&&(y.disabled=!0),a&&(y.placeholder=a),v.appendChild(y));let k=null;if(m){let P=document.createElement("div");P.className="modal-message";let q=document.createElement("label");q.append(document.createTextNode(l+" "));let V=document.createElement("input");V.type="checkbox",V.checked=!!p,V.autocomplete="off",q.append(V),P.append(q),v.appendChild(P),k=V}let I=null;if(i){let P=document.createElement("div");P.className="modal-message",P.textContent=c??(u?u("select_color"):"Seleccione un color"),v.appendChild(P);let{palette:q=[],allowAlpha:V=!1,showNative:j=!1}=g||{},A=ar({initial:d||Z,palette:q,allowAlpha:V,showNative:j});I=A.hiddenInput,v.appendChild(A.root)}let D=document.createElement("div");D.className="modal-actions";let z=document.createElement("button");z.className="btn btn-secondary",z.textContent=f??u("cancel");let C=document.createElement("button");C.className="btn "+(n==="danger"?"btn-danger":"btn-primary"),C.textContent=h??u("accept"),D.append(z,C),T.append(x,v,D),_.appendChild(T),b.appendChild(_);let F=sr(T),O=()=>{F(),_.remove(),document.body.classList.remove("no-scroll"),Ee=null};return document.body.classList.add("no-scroll"),{overlay:_,modal:T,ok:C,cancel:z,closeBtn:S,inputEl:y,colorEl:I,visibleEl:k,focusDefault:()=>{o&&y&&!y.disabled?y.focus():C.focus()},destroy:O}}function Ot(e,{withInput:t,withColor:n=!1,withVisibility:o=!1,resolve:r,reject:s}){let{overlay:a,modal:i,ok:d,cancel:c,closeBtn:m,inputEl:p,colorEl:l,visibleEl:h,destroy:f}=e,g=x=>{if(Ee){if(x.key==="Escape"){x.preventDefault(),T();return}if(x.key==="Enter"){let S=(document.activeElement?.tagName||"").toLowerCase();S==="input"||S==="textarea"||document.activeElement?.isContentEditable||_()}}};function b(){i.removeEventListener("keydown",g)}function _(){let x=t?p?.value??"":!0,S=n?l?.value??"":void 0,v=o?!!h?.checked:void 0;b(),f();let E=t?{value:x}:{};n&&(E.color=S),o&&(E.visible=v),r(Object.keys(E).length?E:x)}function T(){b(),f(),r(t?null:!1)}d.addEventListener("click",_),c.addEventListener("click",T),m.addEventListener("click",T),a.addEventListener("click",x=>{x.target===a&&T()}),i.addEventListener("keydown",g)}function ar({initial:e=Z,palette:t=[],allowAlpha:n=!1,showNative:o=!1}={}){let r=document.createElement("div");r.className="modal-color";let s=document.createElement("div");s.className="cp";let a=document.createElement("div");a.className="cp-left";let i=document.createElement("div");i.className="cp-right";let d=document.createElement("div");d.className="cp-sv",d.tabIndex=0;let c=document.createElement("div");c.className="cp-cursor",d.appendChild(c);let m=document.createElement("div");m.className="cp-hue",m.tabIndex=0;let p=document.createElement("div");p.className="cp-cursor h",m.appendChild(p);let l=document.createElement("div");l.className="cp-alpha",l.tabIndex=0;let h=document.createElement("div");h.className="cp-cursor h",l.appendChild(h),n||(l.style.display="none"),a.appendChild(d);let f=document.createElement("div");f.style.display="flex",f.style.flexDirection="column",f.style.gap="12px",f.appendChild(m),f.appendChild(l),a.appendChild(f);let g=document.createElement("div");g.className="cp-fields";let b=document.createElement("div");b.className="cp-preview";let _=document.createElement("span");b.appendChild(_);let T=document.createElement("div");T.className="cp-row";let x=document.createElement("label");x.textContent="HEX";let S=document.createElement("input");S.type="text",S.placeholder="#RRGGBB",S.autocomplete="off",T.append(x,S);let v=document.createElement("div");v.className="cp-row";let E=document.createElement("label");E.textContent="Alpha";let y=document.createElement("input");y.type="text",y.placeholder="0\u20131",y.value="1",v.append(E,y),n||(v.style.display="none");let k=document.createElement("div");k.className="cp-palette",(t.length?t:er).forEach(N=>{let $=document.createElement("button");$.type="button",$.className="cp-swatch",$.title=N,$.style.background=N,$.addEventListener("click",()=>ce(N)),k.appendChild($)});let D=document.createElement("div");if(D.className="cp-native",o){let N=document.createElement("details"),$=document.createElement("summary");$.textContent="Selector del sistema";let R=document.createElement("input");R.type="color",R.addEventListener("input",()=>ce(R.value)),N.append($,R),D.appendChild(N)}g.append(b,T,v,k,D),i.appendChild(g),s.append(a,i),r.appendChild(s);let z=document.createElement("input");z.type="text",z.className="modal-input-color",z.style.display="none",r.appendChild(z);let C=120,F=1,O=.5,P=1,q=!1;S.addEventListener("focus",()=>{q=!0}),S.addEventListener("blur",()=>{q=!1,A()}),S.addEventListener("keydown",N=>{N.key==="Enter"&&N.preventDefault(),N.stopPropagation()});function V(){d.style.background=`hsl(${C}, 100%, 50%)`}function j(){let{r:N,g:$,b:R}=kn(C,F,O);l.style.background=`conic-gradient(#ccc 25%, #fff 0 50%, #ccc 0 75%, #fff 0) 0 0/12px 12px,
       linear-gradient(to bottom, rgba(${N},${$},${R},0), rgba(${N},${$},${R},1))`}function A(){c.style.left=`${F*100}%`,c.style.top=`${(1-O)*100}%`,p.style.top=`${C/360*100}%`,h.style.top=`${(1-P)*100}%`;let{r:N,g:$,b:R}=kn(C,F,O),te=ir({r:N,g:$,b:R});_.style.background=`rgba(${N},${$},${R},${P})`,q||(S.value=te),z.value=n?`rgba(${N}, ${$}, ${R}, ${P})`:te,V(),j()}function ce(N){let $=Cn(N);if(!$)return;let R=Ln($.r,$.g,$.b);C=R.h,F=R.s,O=R.v,$.a!==void 0&&(P=ee(+$.a,0,1)),A()}function ee(N,$,R){return Math.min(R,Math.max($,N))}function Ge(N,$){let R=me=>{let Te=N.getBoundingClientRect(),Ne=ee(((me.touches?me.touches[0].clientX:me.clientX)-Te.left)/Te.width,0,1),Je=ee(((me.touches?me.touches[0].clientY:me.clientY)-Te.top)/Te.height,0,1);$(Ne,Je)},te=()=>{window.removeEventListener("mousemove",R),window.removeEventListener("touchmove",R),window.removeEventListener("mouseup",te),window.removeEventListener("touchend",te)},ve=me=>{me.preventDefault(),R(me),window.addEventListener("mousemove",R),window.addEventListener("touchmove",R,{passive:!1}),window.addEventListener("mouseup",te,{once:!0}),window.addEventListener("touchend",te,{once:!0})};N.addEventListener("mousedown",ve),N.addEventListener("touchstart",ve,{passive:!1})}Ge(d,(N,$)=>{F=N,O=1-$,A()}),Ge(m,(N,$)=>{C=ee($,0,1)*360,A()}),Ge(l,(N,$)=>{P=1-$,A()});function Ke(N,$){N.addEventListener("keydown",R=>{let te=R.key.toLowerCase(),ve=.02;te==="arrowup"&&$(0,-ve),te==="arrowdown"&&$(0,ve),te==="arrowleft"&&$(-ve,0),te==="arrowright"&&$(ve,0)})}Ke(d,(N,$)=>{F=ee(F+N,0,1),O=ee(O-$,0,1),A()}),Ke(m,(N,$)=>{C=ee(C+$*360,0,360),A()}),Ke(l,(N,$)=>{P=ee(P-$,0,1),A()}),[d,m,l].forEach(N=>{N.addEventListener("keydown",$=>{$.key==="Enter"&&$.stopPropagation()})}),S.addEventListener("input",()=>{let N=Cn(S.value);if(N){let $=Ln(N.r,N.g,N.b);C=$.h,F=$.s,O=$.v,A()}}),y.addEventListener("input",()=>{let N=parseFloat(y.value.replace(",","."));isNaN(N)||(P=ee(N,0,1),A())}),ce(e||Z);function Pt(){s.style.minWidth=a.style.minWidth=i.style.minWidth=g.style.minWidth="0";let Te=()=>{let Ne=1+(n?1:0),Je=s.clientWidth||r.clientWidth,Vo=110+Ne*14+20+180+10,mn=Je<Vo;s.style.display="grid",s.style.gap="10px",s.style.alignItems="start",s.style.gridTemplateColumns=mn?"1fr":"minmax(0, 1fr) minmax(180px, 28ch)";let Go=(mn?Je:Je-180-10)-Ne*14-20,fn=Math.max(110,Math.min(Go,210)),At=Math.max(0,Math.round(fn*.62));d.style.width=Math.max(0,Math.floor(fn))+"px",d.style.height=At+"px",m.style.height=At+"px",l.style.height=At+"px"};requestAnimationFrame(()=>{Te();let Ne=new ResizeObserver(Te);Ne.observe(s),Ne.observe(a)})}return Pt(),{root:r,hiddenInput:z,getValue:()=>z.value,setValue:ce}}function ir({r:e,g:t,b:n}){let o=r=>r.toString(16).padStart(2,"0");return`#${o(e)}${o(t)}${o(n)}`.toUpperCase()}function Ln(e,t,n){e/=255,t/=255,n/=255;let o=Math.max(e,t,n),r=Math.min(e,t,n),s=o-r,a=0,i=o?s/o:0,d=o;if(s!==0){switch(o){case e:a=(t-n)/s+(t<n?6:0);break;case t:a=(n-e)/s+2;break;case n:a=(e-t)/s+4;break}a*=60}return{h:a,s:i,v:d}}function kn(e,t,n){let o=n*t,r=o*(1-Math.abs(e/60%2-1)),s=n-o,a=0,i=0,d=0;return 0<=e&&e<60?(a=o,i=r):60<=e&&e<120?(a=r,i=o):120<=e&&e<180?(i=o,d=r):180<=e&&e<240?(i=r,d=o):240<=e&&e<300?(a=r,d=o):(a=o,d=r),{r:Math.round((a+s)*255),g:Math.round((i+s)*255),b:Math.round((d+s)*255)}}function Cn(e){if(!e)return null;let t=String(e).trim();if(t.startsWith("#")){let o=or(t);return o?{...o,a:1}:null}let n=t.match(/rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*([.\d]+))?\)/i);return n?{r:+n[1],g:+n[2],b:+n[3],a:n[4]!==void 0?+n[4]:1}:null}var le=[],ne={},Re="name",ie=!0,Tn="",Nn=!0,Xe={},lr=30,cr=/\p{Diacritic}/gu,dr="/local/ha-tracker/images/ha-tracker16x16.png",ur="/local/ha-tracker/images/ha16x16.png";async function Dn(){let e=document.getElementById("add-zone-button"),t=document.getElementById("delete-zone-button"),n=document.getElementById("edit-zone-button");e&&e.addEventListener("click",async()=>{try{await pr()}catch(o){console.error("Error adding a zone:",o)}}),t&&t.addEventListener("click",async()=>{try{await mr()}catch(o){console.error("Error deleting a zone:",o)}}),n&&n.addEventListener("click",async()=>{try{await fr()}catch(o){console.error("Error when modifying a zone:",o)}})}async function Mn(){try{await Le(),await Me(),await et()}catch(e){throw console.error("Error updating zones:",e),e}}async function In(e){try{e&&Array.isArray(e)?(le=e,console.log("Zones:",le)):(console.log("No valid zones were obtained from the server."),le=[])}catch(t){console.error("Error getting zones:",t),le=[]}}async function et(){w.getPane("circlePane")||(w.createPane("circlePane"),w.getPane("circlePane").style.zIndex=400);let e=le.map(t=>String(t.id));Object.keys(ne).forEach(t=>{e.includes(String(t))||(w.removeLayer(ne[t]),delete ne[t],delete Xe[t])}),le.forEach(t=>{let n=String(t.id),{latitude:o,longitude:r,radius:s,name:a,custom:i,visible:d}=t;if(!Number.isFinite(o)||!Number.isFinite(r)||!Number.isFinite(s)){console.error("Invalid zone (lat/lon/radius):",t.id);return}if(d===!1){ne[n]&&(w.removeLayer(ne[n]),delete ne[n],delete Xe[n]);return}if(Xe[n])return;let c=ne[n],m=!c||c.getLatLng().lat!==o||c.getLatLng().lng!==r||c.getRadius()!==s,p=t.color||Z,l=p,h=Se(p,U);if(c){let b=Ht(t),_=c.getPopup?.();_?_.getContent()!==b&&c.setPopupContent(b):c.bindPopup(b,{autoPan:!1}),(c.options.color!==l||c.options.fillColor!==h)&&c.setStyle({color:l,fillColor:h,fillOpacity:1})}if(!m)return;let f=!1;if(ne[n]){let b=ne[n];f=b.isPopupOpen(),w.removeLayer(b),delete ne[n]}let g=L.circle([o,r],{radius:s,color:l,fillColor:h,fillOpacity:1,opacity:.8,pane:"circlePane"}).addTo(w);Oe&&i&&typeof g.enableEdit=="function"&&g.enableEdit(),g.bindPopup(Ht(t),{autoPan:!1}),f&&g.openPopup(),g.on("click",async()=>{try{w.fitBounds(g.getBounds(),{padding:[24,24]}),g.openPopup(),await pt(t.id)}catch(b){console.error("Error handling zone row selection:",b)}}),g.on("editable:vertex:dragstart",()=>{Xe[n]=!0,w.closePopup()}),g.on("editable:vertex:dragend",async()=>{Xe[n]=!1;let b=g.getLatLng(),_=g.getRadius();if(t.latitude=b.lat,t.longitude=b.lng,t.radius=_,g.bindPopup(Ht(t),{autoPan:!1}),g.openPopup(),await Me(),Oe&&i)try{let T=await jt(t.id,t.name,_,b.lat,b.lng,t.color,t.visible!==!1);T&&T.success?(await Le(),await Me(),await et(),await pt(t.id),console.log(`Zone with ID ${t.id} updated on server.`)):console.error(`Error updating zone with ID ${t.id} on server.`)}catch(T){console.error("Error in zone update request:",T)}}),ne[n]=g})}async function pt(e){let t=document.getElementById("zones-table-body");if(!t){console.error("The zone table tbody was not found.");return}let n=t.querySelector(`tr[data-zone-id="${String(e)}"]`);if(!n){console.error("No row found for the zone:",e);return}let o=document.getElementById("combo-select");if(o&&o.value!=="zones"){o.value="zones";let r=new Event("change",{bubbles:!0});o.dispatchEvent(r)}t.querySelectorAll("tr").forEach(r=>r.classList.remove("selected")),n.classList.add("selected"),n.scrollIntoView({behavior:"smooth",block:"center"}),typeof De=="function"&&De()}async function De(){let e=document.getElementById("zones-table-body");if(!e){console.error("Zone table body not found.");return}let t=e.querySelectorAll("tr"),n=document.getElementById("add-zone-button"),o=document.getElementById("delete-zone-button"),r=document.getElementById("edit-zone-button"),s=document.getElementById("zone-actions");if(!s||([n,o,r].filter(Boolean).forEach(i=>i.classList.add("hidden")),s.style.display=Oe?"flex":"none",!Oe))return;if(t.length===0)n.classList.remove("hidden");else{let i=e.querySelector("tr.selected");if(!i)n.classList.remove("hidden");else{let d=i.dataset.custom==="true";n.classList.remove("hidden"),d&&o.classList.remove("hidden"),r.classList.remove("hidden")}}let a=[n,o,r].filter(Boolean).filter(i=>!i.classList.contains("hidden"));a.length===1?(s.classList.add("single-button"),a[0].style.flex="1"):(s.classList.remove("single-button"),a.forEach(i=>i.style.flex="1"))}async function mr(){let t=document.getElementById("zones-table-body").querySelector("tr.selected");if(!t){B(u("select_delete_zone"),{title:u("zones")});return}let n=t.dataset.zoneId,o=t.dataset.name;if(!n){console.error("The selected zone ID was not found.");return}if(await $n(xn("confirm_delete_zone",{name:o}),{type:"danger",okLabel:u("delete"),title:u("zones")}))try{await Fn(n),await Le(),await Me(),await et()}catch(s){console.error("Error trying to delete zone:",s),B(u("error_deleting_zone"),{title:u("zones")})}}async function fr(){let e=document.getElementById("zones-table-body");if(!e){console.error("Zone table body not found.");return}let t=e.querySelector("tr.selected");if(!t){B(u("select_zone"),{title:u("zones")});return}let n=t.dataset.zoneId,o=le.find(c=>String(c.id)===String(n));if(!o){B(u("error_finding_zone"),{title:u("zones")});return}let r=!o.custom,s=await Bt(r?u("zone_name_ha"):u("enter_zone_name"),o.name||u("zone_without_name"),{title:u("zones"),withColor:!0,defaultColor:o.color,colorLabel:u("select_color"),withVisibility:!0,visibilityValue:o.visible!==!1,visibilityLabel:u?u("show_on_map"):"Mostrar en el mapa",inputDisabled:r,colorOptions:{palette:[],allowAlpha:!1,showNative:!1}});if(s===null)return;let a=s.visible!==void 0?!!s.visible:o.visible!==!1,i=s.color||o.color||Z,d=o.name;if(!(!r&&(d=Pn(s.value),d===null))&&!(!r&&_e(d)===_e(o.name)&&i===(o.color||Z)&&a===(o.visible!==!1))){if(!r&&(await Le(),An(d,{excludeId:o.id}))){B(u("zone_name_exists"),{title:u("zones")});return}try{let c=await jt(o.id,d,o.radius,o.latitude,o.longitude,i,a);c&&c.success?(r||(o.name=d),o.color=i,o.visible=a,await Le(),await Me(),await et(),await pt(o.id)):B(u("error_updating_zone"),{title:u("zones")})}catch(c){console.error("Error in zone update request:",c),B(u("error_updating_zone"),{title:u("zones")})}}}async function pr(){if(!w)return console.error("The map is not initialized."),null;let e=await Bt(u("enter_zone_name"),"",{title:u("zones"),withColor:!0,defaultColor:Z,colorLabel:u("select_color"),colorOptions:{palette:[],allowAlpha:!1,showNative:!1}});if(e===null)return;let t=Pn(e.value);if(t===null)return;if(await Le(),An(t)){B(u("zone_name_exists"),{title:u("zones")});return}let n=w.getCenter(),o=n.lat,r=n.lng,s=100;try{let a=e.color||Z,i=await Bn(t,s,o,r,"mdi:map-marker",!1,!0,a);return i?(await Le(),await Me(),await et(),await pt(i),console.log(`Zone created successfully. ID: ${i}`),i):(console.error("Failed to create zone."),B(u("error_creating_zone"),{title:u("zones")}),null)}catch(a){console.error("Error in zone update request:",a),B(u("error_creating_zone"),{title:u("zones")})}}function ke(e,t,n={}){let{accuracy:o=0,includePassive:r=!1,epsilonM:s=.5,epsilonDeg:a=1e-5}=n,i=l=>Math.round(l/a),d=(l,h)=>`${i(l)},${i(h)}`;if(e==null||t==null||Number.isNaN(e)||Number.isNaN(t))return null;let c=[];for(let l=0;l<le.length;l++){let h=le[l];if(!h||h.passive&&!r)continue;let f=ut(e,t,h.latitude,h.longitude),g=(Number(h.radius)||0)+(Number(o)||0);f<=g&&c.push({zone:h,idx:l,distanceToCenter:f,key:d(h.latitude,h.longitude),radius:Number(h.radius)||0,id:h.entity_id||h.id||h.name||`idx:${l}`})}if(c.length===0)return null;if(c.length===1)return c[0].zone;let m=new Map;for(let l of c){let h=m.get(l.key);(!h||l.radius<h.radius-s||Math.abs(l.radius-h.radius)<=s&&String(l.id)<String(h.id))&&m.set(l.key,l)}let p=Array.from(m.values());return p.length===1||p.sort((l,h)=>{let f=l.distanceToCenter-h.distanceToCenter;if(Math.abs(f)>s)return f;let g=l.radius-h.radius;return Math.abs(g)>s?g:String(l.id).localeCompare(String(h.id))}),p[0].zone}async function Ut(e){if(!e)return;let t=String(e),n=ne[t];n?(w.setView(n.getLatLng(),w.getZoom()),n.openPopup()):console.error("Marker for zone not found:",t)}async function Me(){let e=document.getElementById("zones-table-body");if(!e){console.error("Zone table body not found."),Qe(),De();return}let t=e.querySelector("tr.selected"),n=t?t.dataset.zoneId:null,o=[...le].sort((s,a)=>{let i,d;switch(Re){case"vmap":{let c=s.visible===!1?1:0,m=a.visible===!1?1:0;if(c!==m)return ie?c-m:m-c;let p=_e(s.name),l=_e(a.name);return ie?p.localeCompare(l):l.localeCompare(p)}case"ctype":{let c=s.custom?0:1,m=a.custom?0:1;if(c!==m)return ie?c-m:m-c;let p=_e(s.name),l=_e(a.name);return ie?p.localeCompare(l):l.localeCompare(p)}case"radius":return i=Number(s.radius)||0,d=Number(a.radius)||0,ie?i-d:d-i;case"name":default:return i=(s.name||"").toLowerCase(),d=(a.name||"").toLowerCase(),ie?i.localeCompare(d):d.localeCompare(i)}}),r=Array.from(e.querySelectorAll("tr"));o.forEach((s,a)=>{let{id:i,latitude:d,longitude:c,name:m,custom:p}=s;if(!Number.isFinite(d)||!Number.isFinite(c)){console.error("Invalid coordinates for the zone:",i);return}let l=r.find(v=>String(v.dataset.zoneId)===String(i));l||(l=document.createElement("tr"),l.dataset.zoneId=String(i),l.dataset.custom=String(p),l.dataset.name=m,l.style.cursor="pointer",e.appendChild(l));let h=s.color||Z,f=s.visible!==!1;l.dataset.visible=String(f),l.style.setProperty("--color-bg",Se(h,U));let g=f?`<div style="
              width:12px; height:12px; border:2px solid ${h};
              border-radius:50%;
              background-color:${Se(h,.3)};
              margin:auto;"></div>`:"",b=s.custom?dr:ur,_=s.custom?"custom":"ha",T=`<img src="${b}" alt="${_}" width="16" height="16" style="display:block;margin:auto;">`,x=`${M?K(s.radius*3.28084):K(s.radius)}`,S=`
		  <td>${g}</td>
          <td>${T}</td>
		  <td>${m||u("zone_without_name")}</td>
		  <td>${x}</td>
		`;l.innerHTML!==S&&(l.innerHTML=S,l.dataset.name=m),l.onclick=()=>{let v=ne[String(i)];if(v){let E=v.getBounds();w.fitBounds(E,{padding:[24,24]}),v.openPopup()}else console.error("No marker found for the zone:",i);e.querySelectorAll("tr").forEach(E=>E.classList.remove("selected")),l.classList.add("selected"),De()},e.children[a]!==l&&e.insertBefore(l,e.children[a]),String(i)===String(n)&&l.classList.add("selected")}),r.forEach(s=>{o.some(a=>String(a.id)===String(s.dataset.zoneId))||s.remove()}),De(),Qe(),(Tn!==Re||Nn!==ie)&&(hr(),Tn=Re,Nn=ie)}function hr(){let e=document.querySelector("#zones-table");if(!e){console.error("Zone summary table not found.");return}e.querySelectorAll("thead th").forEach((n,o)=>{let r=n.getAttribute("data-i18n")||"",s="";switch(r){case"column_map":s="vmap";break;case"column_type":s="ctype";break;case"name":s="name";break;case"radius":s="radius";break}if(!s)return;n.style.cursor="pointer",n.onclick=()=>{Re===s?ie=!ie:(Re=s,ie=!0),Me()};let a="";Re===s&&(a=ie?"\u25B2":"\u25BC");let i=r==="radius"?`${M?u("feet"):u("meters")}`:u(r);n.innerHTML=`
		  <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:30px;">
			<span class="hdr-label">${i}</span>
			<span style="font-size:12px;">${a}</span>
		  </div>
		`})}function Pn(e){let t=(e||"").trim();return t===""?(B(u("empty_name"),{title:u("zones")}),null):t.length>lr?(B(u("long_zone"),{title:u("zones")}),null):t}function _e(e){return(e??"").toLocaleLowerCase().normalize("NFD").replace(cr,"").replace(/\s+/g," ").trim()}function An(e,{excludeId:t=null}={}){let n=_e(e);return n?le.some(o=>o&&_e(o.name)===n&&(t==null||String(o.id)!==String(t))):!1}function Ht(e){let{latitude:t,longitude:n,radius:o}=e,r=`https://www.google.com/maps/search/?api=1&query=${t},${n}`,s=M?K(o*3.28084):K(o),a=M?u("feet"):u("meters");return`
    <strong>${e.name||u("zone_without_name")}</strong><br>
    ${u("radius")}: ${s} ${a}
    <br><br><a href="${r}" target="_blank" rel="noopener noreferrer"><strong>${u("open_location")}</strong></a>
  `}function gr(e){return le.find(t=>String(t?.id)===String(e))||null}function zn(e){let t=gr(e);if(!t)return null;let n=t.color||Z;return{id:t.id,name:t.name,lat:t.latitude,lon:t.longitude,color:n}}var yr=400,br=4,Rn=2;var wr=(e,t,n)=>`${Number(e).toFixed(6)},${Number(t).toFixed(6)},${Number(n)}`,vr=(e,t)=>`${Number(e).toFixed(6)},${Number(t).toFixed(6)}`,Ie=new Map,Zt=new Map,ht=new Map,oe=new Map,Pe=new Map,tt=new Map;function qt(e,t){if(Ie.has(e)&&Ie.delete(e),Ie.set(e,t),Ie.size>yr){let n=Ie.keys().next().value;Ie.delete(n)}}function Ae(e){tt.delete(e)}function xr(e,t,n){let o=(tt.get(e)||0)+1;tt.set(e,o);let r=Math.floor(Math.random()*250),s=Math.min(8e3,Math.max(300,t)*Math.pow(1.6,o))+r;setTimeout(n,s)}var Wt=0,Vt=[];function Er(e){return new Promise((t,n)=>{Vt.push({task:e,res:t,rej:n}),On()})}function On(){for(;Wt<br&&Vt.length;){let{task:e,res:t,rej:n}=Vt.shift();Wt++,e().then(t,n).finally(()=>{Wt--,On()})}}function He(e,t){try{let n=document.querySelector(`tr.pos-main-row[data-entity-id="${e}"]`);n&&(n.dataset.address=t||"");let o=document.querySelector(`tr.position-address-row[data-entity-id="${e}"]`);o&&(o.dataset.address=t||"")}catch{}}async function nt(e,t,n,o,r){if(!Number.isFinite(t)||!Number.isFinite(n)||!Number.isFinite(o))return;let s=wr(t,n,o);oe.set(e,s);let a=Ie.get(e);if(a?.key===s){let c=a.address||"";r?.(c),He(e,c),oe.delete(e),Ae(e);return}if(Pe.get(e)===s)return;Pe.set(e,s);let i=c=>{Pe.get(e)===s&&Pe.delete(e),xr(e,c,()=>{oe.get(e)===s&&nt(e,t,n,o,r)})},d=vr(t,n);try{if(Zt.has(d)){let l=Zt.get(d)||"";qt(e,{key:s,address:l}),oe.get(e)===s&&(r?.(l),He(e,l),oe.delete(e),Ae(e));return}if(ht.has(d)){let l=await ht.get(d);if(oe.get(e)!==s)return;if(!l){if((tt.get(e)||0)<Rn){i(600);return}r?.(""),He(e,""),oe.delete(e),Ae(e);return}qt(e,{key:s,address:l}),r?.(l),He(e,l),oe.delete(e),Ae(e);return}let c=Er(()=>Un(t,n));ht.set(d,c.then(l=>(l?.address?.display_name||"").trim()));let m=await c;if(oe.get(e)!==s)return;if(m?.error==="queued"&&Number.isFinite(m?.retry_after)){i(m.retry_after*1e3);return}if(["temporarily_unavailable","rate_limited","busy"].includes(m?.error)){let l=Number.isFinite(m?.retry_after)?m.retry_after:1.5;i(l*1e3);return}let p=(m?.address?.display_name||"").trim();if(!p){if((tt.get(e)||0)<Rn){i(600);return}r?.(""),He(e,""),oe.delete(e),Ae(e);return}Zt.set(d,p),qt(e,{key:s,address:p}),r?.(p),He(e,p),oe.delete(e),Ae(e)}catch{oe.get(e)===s&&i(1200)}finally{ht.delete(d),Pe.get(e)===s&&Pe.delete(e)}}function Hn(e){oe.delete(e),Pe.delete(e),Ae(e)}var Sr="/local/ha-tracker/images/location-red.png",ze=[],gt=[],X={},fe={},Ue="name",de=!0,jn="",Zn=!0,Gt={};(function(){if(document.getElementById("persons-tint-css"))return;let t=document.createElement("style");t.id="persons-tint-css",t.textContent=`
    #persons-table-body tr.selected > td {
      background-color: transparent !important;
    }
    #persons-table-body tr.zone-tinted:not(.selected) > td {
      background-color: var(--zone-bg) !important;
    }	
  `,document.head.appendChild(t)})();var ot=null;function _r(){if(ot)return ot;let e=document.querySelector("#users .table-wrapper")||null;return ot=new IntersectionObserver(t=>{for(let n of t){if(!n.isIntersecting)continue;let o=n.target;ot.unobserve(o);let r=o.dataset.personId,s=Number(o.dataset.latitude),a=Number(o.dataset.longitude),i=Number(o.dataset.lastUpdated),d=`${r}_${i}`,c=o.querySelector("td");!Number.isFinite(s)||!Number.isFinite(a)||!c||nt(d,s,a,i,m=>{Gt[r]={lat:s,lon:a,timestamp:i,address:m||""};let p=document.querySelector(`tr.person-address-row[data-person-id="${r}"]`);if(p&&p.dataset.lastUpdated===String(i)){let l=p.querySelector("td");l&&(l.textContent=m||"")}})}},{root:e,rootMargin:"200px"}),ot}async function Wn(){try{await Yn(),await Jn(),await Lr(),await Qe(),await kr(),await Jt()}catch(e){throw console.error("Error updating devices:",e),e}}async function Vn(e){try{gt=Array.isArray(e)?e.filter(t=>t.entity_id&&t.attributes):[],console.log("Devices:",gt)}catch(t){console.error("Error processing devices:",t),gt=[]}}async function Gn(e){try{ze=Array.isArray(e)?e.filter(t=>t.attributes?.friendly_name):[],console.log("Persons:",ze)}catch(t){console.error("Error processing persons:",t),ze=[]}}async function Kt(e){if(!e)return;let t=fe[e];if(!t)return;let n=X[e];if(!n){console.error(`No device was found for the person with ID: ${e}`);return}Object.values(fe).forEach(s=>s.setZIndexOffset(500)),t.setZIndexOffset(600);let{latitude:o,longitude:r}=n.attributes||{};if(!Ft(o,r)){console.error(`Invalid coordinates for ${e}: lat=${o}, lng=${r}`);return}t.openPopup(),w.invalidateSize(),w.setView([o,r],w.getZoom())}function Jt(){let e=document.getElementById("person-select");if(!e)return;let t=e.value,n=document.createDocumentFragment(),o=document.createElement("option");o.value="",o.textContent=u("select_user"),n.appendChild(o),ze.filter(a=>!!X[a.entity_id]).forEach(a=>{let i=document.createElement("option");i.value=a.entity_id;let d=a.attributes.friendly_name||a.attributes.id||a.entity_id;i.textContent=(d||"").trim(),n.appendChild(i)}),e.innerHTML="",e.appendChild(n);let r=e.options.length>1,s=!!(t&&X[t]);r&&s?e.value=t:(e.value="",e.dispatchEvent(new Event("change",{bubbles:!0})))}async function Kn(){try{let e=Object.values(X).filter(n=>n.attributes.latitude&&n.attributes.longitude).map(n=>[n.attributes.latitude,n.attributes.longitude]);if(!e.length){console.log("There are no devices with coordinates to adjust the map."),w.fitWorld();return}let t=L.latLngBounds(e);w.fitBounds(t)}catch(e){console.error("Error doing fitMapToAllDevices:",e)}}async function Lr(){X={},ze.forEach(e=>{let t=e.attributes?.source;if(!t||typeof t!="string"||t.trim()===""){console.log(`The person ${e.attributes.friendly_name||e.entity_id} does not have a valid 'source'.`);return}let n=gt.find(o=>o.entity_id===t);if(!n){console.error(`The 'source' (${t}) of ${e.attributes.friendly_name||e.entity_id} is not in device_trackers.`);return}if(!n.attributes.latitude||!n.attributes.longitude){console.log(`The device_tracker ${t} of ${e.attributes.friendly_name||e.entity_id} does not have lat/lng.`);return}X[e.entity_id]=n}),console.log("Devices to persons:",X)}async function kr(){if(!w.getPane("personsMarkers")){let t=w.createPane("personsMarkers");t.style.zIndex=600,t.style.pointerEvents="auto"}let e=Object.keys(X);Object.keys(fe).forEach(t=>{e.includes(t)||(w.removeLayer(fe[t]),delete fe[t])}),e.forEach(t=>{let n=X[t],{latitude:o,longitude:r,friendly_name:s,speed:a}=n.attributes,i=yt(n),d=i!=null?`<br>${u("battery")}: ${i}${u("percentage")}`:"";if(!Ft(o,r))return;let c=re(n.last_updated||u("date_unavailable")),m=ze.find(b=>b.entity_id===t),p=m?.attributes.friendly_name||"",l=m?.attributes.entity_picture||Sr,h=`https://www.google.com/maps/search/?api=1&query=${o},${r}`,f=`
		  <strong>${p}</strong> (${s})<br>
		  ${c}<br>
		  ${u("speed")}: ${Math.round((a||0)*(M?2.23694:3.6))} ${u(M?"mi_per_hour":"km_per_hour")}
		  ${d}
		  <br><br><a href="${h}" target="_blank" rel="noopener noreferrer"><strong>${u("open_location")}</strong></a>
		`,g=L.divIcon({className:"",html:`<img src="${l}" style="width:48px;height:48px;border-radius:50%;object-fit:cover;" />`,iconSize:[48,48],iconAnchor:[24,24],popupAnchor:[0,-24]});if(fe[t]){let b=fe[t];b.setLatLng([o,r]),b.setIcon(g);let _=b.getPopup?.();_?_.setContent(f):b.bindPopup(f,{autoPan:!1})}else fe[t]=L.marker([o,r],{icon:g,pane:"personsMarkers"}).addTo(w).bindPopup(f,{autoPan:!1}).on("click",async()=>{await Cr(t),w.invalidateSize();let b=fe[t].getLatLng();w.setView(b,w.getZoom()),fe[t].openPopup()})})}async function Cr(e){let t=document.getElementById("combo-select");t&&t.value!=="users"&&(t.value="users",t.dispatchEvent(new Event("change",{bubbles:!0})),await new Promise(i=>requestAnimationFrame(i)));let o=document.getElementById("persons-table-body");if(o||(await new Promise(i=>requestAnimationFrame(i)),o=document.getElementById("persons-table-body")),!o){console.error("Person table tbody not found.");return}let r=window.CSS&&CSS.escape?CSS.escape(e):e.replace(/"/g,'\\"'),s=o.querySelector(`tr[data-person-id="${r}"]`);if(s||(s=Array.from(o.querySelectorAll("tr")).find(i=>i.dataset.personId===e)),!s)return;let a=s.nextElementSibling&&s.nextElementSibling.classList.contains("person-address-row")?s.nextElementSibling:null;o.querySelectorAll("tr.selected").forEach(i=>i.classList.remove("selected")),s.classList.add("selected"),a&&a.classList.add("selected"),s.scrollIntoView({behavior:"smooth",block:"center"})}function $r(){let e=document.querySelector("#persons-table");if(!e){console.error("Zone summary table not found.");return}e.querySelectorAll("thead th").forEach(n=>{let o=n.getAttribute("data-i18n"),r="";switch(o){case"name":r="name";break;case"date":r="date";break;case"speed":r="speed";break;case"percentage":r="percentage";break;case"zone":r="zone";break}if(!r)return;n.style.cursor="pointer",n.onclick=()=>{Ue===r?de=!de:(Ue=r,de=!0),Qe()};let s=Ue===r?de?"\u25B2":"\u25BC":"",a=o==="speed"?M?u("mi_per_hour"):u("km_per_hour"):u(o);n.innerHTML=`
		  <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:30px;">
			<span class="hdr-label">${a}</span>
			<span class="hdr-arrow" style="font-size:12px;">${s}</span>
		  </div>
		`})}function qn(e,t){e&&(t?(e.classList.add("zone-tinted"),e.style.setProperty("--zone-bg",t)):(e.classList.remove("zone-tinted"),e.style.removeProperty("--zone-bg")))}async function Qe(){try{let e=document.getElementById("persons-table-body");if(!e){console.error("Person table tbody not found.");return}let t=e.querySelector("tr.selected"),n=t?t.dataset.personId:null,r=[...ze.filter(i=>X[i.entity_id])].sort((i,d)=>{let c=X[i.entity_id]||{},m=X[d.entity_id]||{},p,l;switch(Ue){case"name":return p=i.attributes.friendly_name||i.entity_id,l=d.attributes.friendly_name||d.entity_id,de?p.localeCompare(l):l.localeCompare(p);case"date":return p=c.last_updated?new Date(c.last_updated).getTime():0,l=m.last_updated?new Date(m.last_updated).getTime():0,de?p-l:l-p;case"speed":return p=parseFloat(c.attributes?.speed)||0,l=parseFloat(m.attributes?.speed)||0,de?p-l:l-p;case"percentage":return p=Number(yt(c))||0,l=Number(yt(m))||0,de?p-l:l-p;case"zone":return p=ke(c.attributes?.latitude,c.attributes?.longitude)?.name||"",l=ke(m.attributes?.latitude,m.attributes?.longitude)?.name||"",de?p.localeCompare(l):l.localeCompare(p);default:return 0}}),s=Array.from(e.querySelectorAll("tr")),a=_r();r.forEach((i,d)=>{let c=i.entity_id,m=i.attributes.friendly_name||c,p=i.attributes.source||null,l="",h="",f="",g=null,b="",_="",T=null,x,S,v,E=!1;if(p&&X[c]){let C=X[c];l=C.attributes.friendly_name?`(${C.attributes.friendly_name})`:"",g=yt(C),h=re(C.last_updated),f=Math.round((C.attributes.speed||0)*(M?2.23694:3.6)),T=ke(C.attributes.latitude,C.attributes.longitude),b=T?T.name:"",x=Number(C.attributes.latitude),S=Number(C.attributes.longitude),v=new Date(C.last_updated).getTime();let F=Gt[c];if(_=F?.address||"",!F)E=!0;else{let O=ut(F.lat,F.lon,x,S),P=(v-(F.timestamp||0))/1e3;O>=Xt&&P>=Yt&&(_="",E=!0)}}let y=s.find(C=>C.dataset.personId===c&&!C.classList.contains("person-address-row")),k=y?y.nextElementSibling:null;if(!y){y=document.createElement("tr"),y.dataset.personId=c,y.style.cursor="pointer",k=document.createElement("tr"),k.dataset.personId=c,k.classList.add("person-address-row"),k.style.cursor="pointer";let C=document.createElement("td");C.setAttribute("colspan","5"),C.textContent=_||"",C.style.borderBottom="1px solid rgba(0,0,0,0.1)",k.appendChild(C),e.appendChild(y),e.appendChild(k)}let I=`
				<td><p style="font-weight:bold;color:#003366;margin:0;">${m}</p>${l}</td>
				<td>${h}</td>
				<td>${b}</td>
				<td>${f}</td>
				<td>${g??""}</td>
			  `;y.innerHTML!==I&&(y.innerHTML=I);let D=Tr(T,U);if(qn(y,D),qn(k,D),k){let C=k.querySelector("td");k.dataset.latitude=Number.isFinite(x)?String(x):"",k.dataset.longitude=Number.isFinite(S)?String(S):"",k.dataset.lastUpdated=Number.isFinite(v)?String(v):"0";let F=!!Gt[c];E||!F&&Number.isFinite(x)&&Number.isFinite(S)?(C&&C.textContent!=="\u2026"&&(C.textContent="\u2026"),a.observe(k)):(Hn(`${c}_${k?.dataset?.lastUpdated??""}`),C&&C.textContent!==_&&(C.textContent=_||""))}let z=()=>{e.querySelectorAll("tr.selected").forEach(C=>C.classList.remove("selected")),y.classList.add("selected"),k&&k.classList.add("selected"),Kt(c)};y.onclick=z,k&&(k.onclick=z),e.children[d*2]!==y&&(e.insertBefore(y,e.children[d*2]),e.insertBefore(k,y.nextSibling)),c===n&&(y.classList.add("selected"),k&&k.classList.add("selected"))}),Array.from(e.querySelectorAll("tr")).forEach(i=>{let d=i.dataset.personId;r.some(c=>c.entity_id===d)||(i.nextElementSibling&&i.nextElementSibling.classList.contains("person-address-row")&&i.nextElementSibling.remove(),i.remove())}),(jn!==Ue||Zn!==de)&&($r(),jn=Ue,Zn=de)}catch(e){console.error("Error updating people table:",e)}}function Tr(e,t=U){if(!e||!e.color)return null;let n=Math.min(1,Math.max(0,Number(t)||0));return Se(e.color,n)||e.color}function yt(e){return e?.battery_level??e?.attributes?.battery_level??null}var Xn=" \u21D2 ",rt={coreJS:"https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js",coreCSS:"https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css",confirmJS:"https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/plugins/confirmDate/confirmDate.js",confirmCSS:"https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/plugins/confirmDate/confirmDate.css",l10nBase:"https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n"},bt,he=null,no=null;function Qt(){let e=new Set(["ar","de","en","es","fr","hi","it","ja","pt","zh"]),t=(navigator.languages?.length?navigator.languages:[navigator.language||"en"]).map(n=>String(n).toLowerCase());for(let n of t){let o=n.slice(0,2);if(e.has(o))return o}return"en"}async function Nr(){return bt||(bt=(async()=>{await Be(rt.coreCSS),await Be(rt.confirmCSS),await xe(rt.coreJS,{test:()=>!!window.flatpickr}),await xe(rt.confirmJS,{test:()=>!!window.confirmDatePlugin});let e=Qt();e!=="en"&&await xe(`${rt.l10nBase}/${e}.js`,{test:()=>!!window.flatpickr?.l10ns?.[e]}).catch(()=>{}),he=window.flatpickr,no=window.confirmDatePlugin,console.log("[flatpickr] v",he?.version,"locale:",e)})(),bt)}var Ze=[],st=null,qe,We,W,ge="00:00:00",ye="23:59:59",pe=e=>String(e).padStart(2,"0"),je=e=>`${e.getFullYear()}-${pe(e.getMonth()+1)}-${pe(e.getDate())}T${pe(e.getHours())}:${pe(e.getMinutes())}:${pe(e.getSeconds())}`;function Dr(e,t){return e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate()}function Qn(e){let[t="00",n="00"]=String(e||"").split(":");return`${pe(t)}:${pe(n)}`}async function oo(e={}){if(st=typeof e.onApplyFilter=="function"?e.onApplyFilter:null,window.__rangePickerInitDone)return;try{await Nr(),Rr()}catch(r){console.error("[calendar] no se pudo cargar flatpickr:",r);return}let t=document.getElementById("daterange");if(!t){console.error("[calendar] #daterange no existe");return}let n=Qt(),o=he?.l10ns?.[n]||he?.l10ns?.default;W=he(t,{mode:"range",enableTime:!1,closeOnSelect:!1,dateFormat:"Y-m-d",allowInput:!1,locale:o,plugins:[new no({confirmText:u("accept"),showAlways:!0,theme:"light"})],onDayCreate(r,s,a,i){i.addEventListener("click",()=>{ge="00:00:00",ye="23:59:59",qe?.setDate(ge,!1),We?.setDate(ye,!1),setTimeout(()=>Ce(a),0)})},onReady(r,s,a){eo(a),Ce(a)},onOpen(r,s,a){a._prevTextboxValue=a.input.value,a.calendarContainer.classList.add("fp-at-top"),eo(a),Ze.length===2?a.setDate(Ze,!0):Ce(a)},onClose(r,s,a){a.calendarContainer.classList.remove("fp-at-top")},onValueUpdate(){Ce(W)},onChange(){Ce(W)}}),window.addEventListener("resize",()=>{let r=W?.calendarContainer;r&&ro(r)}),window.__rangePickerInitDone=!0}function vt(){let e,t;if(W&&Array.isArray(W.selectedDates)){let n=W.selectedDates.length;if(n===2){let[o,r]=W.selectedDates,[s,a,i]=(ge||"00:00:00").split(":").map(h=>+h||0),[d,c,m]=(ye||"23:59:59").split(":").map(h=>+h||0),p=new Date(o);p.setHours(s,a,i,0);let l=new Date(r);l.setHours(d,c,m,0),e=je(p),t=je(l)}else if(n===1){let o=W.selectedDates[0],[r,s,a]=(ge||"00:00:00").split(":").map(l=>+l||0),[i,d,c]=(ye||"23:59:59").split(":").map(l=>+l||0),m=new Date(o);m.setHours(r,s,a,0);let p=new Date(o);p.setHours(i,d,c,0),e=je(m),t=je(p)}}else if(Array.isArray(Ze)&&Ze.length===2){let[n,o]=Ze;e=je(n),t=je(o)}return{startLocal:e,endLocal:t}}function wt(e="00:00:00",t="23:59:59"){ge=e||"00:00:00",ye=t||"23:59:59",qe?.setDate(ge,!1),We?.setDate(ye,!1),W&&Ce(W)}function en([e,t],n=!0){W&&(W.setDate([e,t],!!n),n||Ce(W))}function at(){Ze=[],W&&(W.clear(!1),W.input.value="")}function xt(){let e=document.getElementById("person-select"),t=document.getElementById("daterange"),n=t?.closest(".group")||t;if(!e||!n)return;let o=e.value===""||e.selectedIndex===-1;n.style.display=o?"none":"",o&&(t.value="",W?.clear(!1))}function Ce(e){if(!e)return;let t=new Intl.DateTimeFormat(void 0,{year:"2-digit",month:"2-digit",day:"2-digit"}),[n,o]=e.selectedDates||[],r=Qn(ge||"00:00:00"),s=Qn(ye||"23:59:59");if(n&&!o){e.input.value=`${t.format(n)} ${r}`;return}if(n&&o){Dr(n,o)?e.input.value=`${t.format(n)} ${r}${Xn}${s}`:e.input.value=`${t.format(n)} ${r}${Xn}${t.format(o)} ${s}`;return}e.input.value=""}function Mr(e){let t=e.selectedDates||[];if(t.length===1){let n=t[0];e.setDate([n,n],!1)}Ce(e),e.close(),st&&st()}function ro(e){let t=e.getBoundingClientRect().width+"px";qe?.calendarContainer&&(qe.calendarContainer.style.width=t),We?.calendarContainer&&(We.calendarContainer.style.width=t)}function Ir(e){let t=document.createElement("div");t.className="fp-quickbar";let n=o=>`${pe(o.getHours())}:${pe(o.getMinutes())}:${pe(o.getSeconds())}`;return["today","yesterday","last_24h","last_7_days","this_week"].forEach(o=>{let r=document.createElement("button");r.type="button",r.textContent=u(o),r.addEventListener("click",()=>{let{start:s,end:a}=Br(o);if(s&&a){if(o==="last_24h"){let i=new Date(a.getTime()-1e3);wt(n(s),n(i))}else wt("00:00:00","23:59:59");en([s,a],!0),e.close(),st&&st()}}),t.appendChild(r)}),t}function eo(e){let t=e.calendarContainer;t.querySelector(".fp-quickbar")||t.appendChild(Ir(e));let n=t.querySelector(".fp-timepanel");if(!n){n=document.createElement("div"),n.className="fp-timepanel";let s=document.createElement("div");s.className="fp-timeblock";let a=document.createElement("div");a.className="fp-timehost",s.appendChild(a);let i=document.createElement("div");i.className="fp-timeblock";let d=document.createElement("div");d.className="fp-timehost",i.appendChild(d),n.append(s,i),t.appendChild(n);let c=Qt(),m=he?.l10ns?.[c]||he?.l10ns?.default,p=!new Intl.DateTimeFormat(void 0,{hour:"numeric"}).formatToParts(new Date).some(f=>f.type==="dayPeriod"),l=document.createElement("input");l.type="hidden";let h=document.createElement("input");h.type="hidden",document.body.appendChild(l),document.body.appendChild(h),qe=he(l,{inline:!0,noCalendar:!0,enableTime:!0,enableSeconds:!0,time_24hr:p,dateFormat:"H:i:S",defaultDate:ge,locale:m,onChange:(f,g)=>{ge=g||"00:00:00"}}),We=he(h,{inline:!0,noCalendar:!0,enableTime:!0,enableSeconds:!0,time_24hr:p,dateFormat:"H:i:S",defaultDate:ye,locale:m,onChange:(f,g)=>{ye=g||"23:59:59"}}),a.appendChild(qe.calendarContainer),d.appendChild(We.calendarContainer)}let o=t.querySelector(".fp-actionbar");o||(o=document.createElement("div"),o.className="fp-actionbar",t.appendChild(o));let r=t.querySelector(".flatpickr-confirm");if(r&&!o.contains(r)&&(r.textContent=u("accept"),r.classList.add("fp-btn"),o.appendChild(r),r.dataset._bound||(r.addEventListener("click",()=>Mr(e)),r.dataset._bound="1")),!o.querySelector(".flatpickr-cancel")){let s=document.createElement("button");s.type="button",s.className="fp-btn flatpickr-cancel",s.textContent=u("cancel"),o.insertBefore(s,o.querySelector(".flatpickr-confirm")||null),s.addEventListener("click",()=>{Array.isArray(e._prevSelectedDates)?e.setDate(e._prevSelectedDates,!1):e.clear(!1),typeof e._prevTextboxValue=="string"?e.input.value=e._prevTextboxValue:e.input.value="",e.close()})}ro(t)}function Pr(e){let t=new Date(e);return t.setHours(0,0,0,0),t}function to(e,t){let n=new Date(e);return n.setDate(n.getDate()+t),n}function Ar(e){let t=new Date(e.getFullYear(),e.getMonth(),1);return t.setHours(0,0,0,0),t}function zr(e){let t=new Date(e.getFullYear(),e.getMonth()+1,1);return t.setHours(0,0,0,0),t}function so(e){let t=new Date(e),n=t.getDay(),o=n===0?-6:1-n;return t.setDate(t.getDate()+o),t.setHours(0,0,0,0),t}function Fr(e){let t=so(e),n=new Date(t);return n.setDate(t.getDate()+7),new Date(n.getTime()-1e3)}function Br(e){let t=new Date,n=Pr(t);switch(e){case"today":return{start:n,end:n};case"yesterday":return{start:to(n,-1),end:to(n,-1)};case"last_24h":return{start:new Date(t-1440*60*1e3),end:new Date(t-1e3)};case"last_7_days":return{start:new Date(t-10080*60*1e3),end:t};case"this_month":return{start:Ar(t),end:zr(t)};case"last_month":{let o=new Date(t.getFullYear(),t.getMonth()-1,1,0,0,0,0),r=new Date(t.getFullYear(),t.getMonth(),1,0,0,0,0),s=new Date(r.getTime()-1e3);return{start:o,end:s}}case"this_week":return{start:so(t),end:Fr(t)};default:return{start:null,end:null}}}function Rr(){if(document.getElementById("fp-shadow-patch"))return;let e=document.createElement("style");e.id="fp-shadow-patch",e.textContent=`
    .flatpickr-calendar{
      background:#fff !important;
      border:1px solid rgba(0,0,0,.12) !important;
      border-radius:12px !important;
      box-shadow:0 12px 28px rgba(0,0,0,.30) !important;
      overflow:hidden;
    }
    @media (max-width: 600px){
      .flatpickr-calendar.fp-at-top{
        left: 8px !important;
        right: 8px !important;
        width: auto !important;
        max-width: calc(100% - 16px) !important;
        margin: 0 auto !important;
      }
    }
  `,document.head.appendChild(e)}function tn(e){return(e instanceof Date?e:new Date(e)).toISOString()}function Q(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Or(e=""){return`<![CDATA[${e}]]>`}function Hr(e){return Number.isFinite(e)?Math.round(e*3.6):0}function Ur(e){let t=[];for(let n of e||[]){let o=Number(n?.attributes?.latitude),r=Number(n?.attributes?.longitude);!Number.isFinite(o)||!Number.isFinite(r)||t.push(`${r},${o},0`)}return t}function jr(e,t={}){let{stopIconHref:n,includeRoute:o=!0,routeColor:r="ff0000ff",routeWidth:s=6,describeStop:a,nameStop:i,unitLabel:d="km/h",formatLocal:c,batteryLabel:m="Battery"}=t;if(!e||!e.length)throw new Error("No hay posiciones para exportar.");let p=tn(e[0].last_updated),l=tn(e[e.length-1].last_updated),h=`
    <Style id="stopStyle">
      <IconStyle>
        <scale>1.2</scale>
        ${n?`<Icon><href>${Q(n)}</href></Icon>`:""}
      </IconStyle>
      <LabelStyle><scale>0</scale></LabelStyle>
    </Style>
    <Style id="routeStyle">
      <LineStyle>
        <color>${Q(r)}</color>
        <width>${Number(s)||6}</width>
      </LineStyle>
    </Style>
  `,f=o?Ur(e):[],g=o&&f.length>=2?`
    <Placemark>
      <name>Route</name>
      <styleUrl>#routeStyle</styleUrl>
      <LineString>
        <tessellate>1</tessellate>
        <coordinates>${f.join(" ")}</coordinates>
      </LineString>
    </Placemark>
  `:"",b=(e||[]).filter(x=>!!x?.stop).map((x,S)=>{let v=Number(x?.attributes?.latitude),E=Number(x?.attributes?.longitude);if(!Number.isFinite(v)||!Number.isFinite(E))return"";let y=tn(x.last_updated),k=c?c(x.last_updated):y,I=Hr(Number(x?.attributes?.speed)),D=`${x?.entity_id||"position"} #${S+1}`,z=i?i(x):D,C=Number.isFinite(x?.battery)?Math.round(x.battery):null,F="\u2022",O=(x?.zone||"").trim(),P=(x?.address||"").trim(),q=`${I} ${d}`,V=C!=null?`${m}: ${C}%`:"",A=[O,q,V,P].filter(Boolean).map(ee=>`${F} ${ee}`).join(`
`).trim(),ce=a?a(x):`<table cellspacing="0" cellpadding="0" style="border-collapse:collapse">
			  <tr><td><b>${Q(k)}</b></td></tr>
			  ${O?`<tr><td>${Q(O)}</td></tr>`:""}
			  ${P?`<tr><td>${Q(P)}</td></tr>`:""}
			  <tr><td>${Q(q)}</td></tr>
			  ${C!=null?`<tr><td>${Q(V)}</td></tr>`:""}
			 </table>`;return`
		  <Placemark>
			<name>${Q(z)}</name>
			<Snippet maxLines="6"><![CDATA[${A}]]></Snippet>
			<styleUrl>#stopStyle</styleUrl>
			<TimeStamp><when>${y}</when></TimeStamp>
			<ExtendedData>
			  <Data name="entity_id"><value>${Q(x?.entity_id||"")}</value></Data>
			  <Data name="speed_kmh"><value>${I}</value></Data>
			  <Data name="is_stop"><value>true</value></Data>
			  <Data name="zone"><value>${Q(O)}</value></Data>
			  <Data name="address"><value>${Q(P)}</value></Data>
			  <Data name="when_local"><value>${Q(k)}</value></Data>
			  <Data name="unit"><value>${Q(d)}</value></Data>
			  ${C!=null?`<Data name="battery_pct"><value>${C}</value></Data>`:""}
			</ExtendedData>
			<description>${Or(ce)}</description>
			<Point><coordinates>${E},${v},0</coordinates></Point>
		  </Placemark>
		`}).join(`
`),_=`HA Tracker ${p} - ${l}`;return`<?xml version="1.0" encoding="UTF-8"?>
  <kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
      <name>${Q(_)}</name>
      ${h}
      ${g}
      <Folder>
        <name>Stops</name>
        ${b}
      </Folder>
    </Document>
  </kml>`}function io(e,t){let n=new Blob([t],{type:"application/vnd.google-earth.kml+xml"}),o=URL.createObjectURL(n),r=document.createElement("a");r.href=o,r.download=e.endsWith(".kml")?e:`${e}.kml`,document.body.appendChild(r),r.click(),r.remove(),URL.revokeObjectURL(o)}async function Zr(e,t){let n=new Blob([t],{type:"application/vnd.google-earth.kml+xml"});if("showSaveFilePicker"in window){let r=await(await window.showSaveFilePicker({suggestedName:e.endsWith(".kml")?e:`${e}.kml`,types:[{description:"KML file",accept:{"application/vnd.google-earth.kml+xml":[".kml"]}}]})).createWritable();await r.write(n),await r.close()}else io(e,t)}function Et(e){return String(e).padStart(2,"0")}function ao(e){let t=e instanceof Date?e:new Date(e);return`${t.getFullYear()}-${Et(t.getMonth()+1)}-${Et(t.getDate())}_${Et(t.getHours())}-${Et(t.getMinutes())}`}function qr(e,t="person"){if(!e||!e.length)return`ha-tracker_${t}.kml`;let n=e[0]?.last_updated,o=e[e.length-1]?.last_updated;return`ha-tracker_${t}_${ao(n)}_${ao(o)}.kml`}async function lo(e,t={}){let{personId:n="person",filename:o,usePicker:r=!1,...s}=t,a=jr(e,s),i=o||qr(e,n);r?await Zr(i,a):io(i,a)}function co(e){return e==null?"":`"${String(e).replace(/\r?\n/g," ").trim().replace(/"/g,'""')}"`}function uo(e){let t=Number(e);return Number.isFinite(t)?t.toFixed(6):""}function Wr(e,t){if(!Number.isFinite(e))return"";let n=e*3.6,o=n*.621371192;return Math.round(t?o:n)}function Vr(e,{useImperial:t,formatLocal:n,delimiter:o=";"}={}){let r=t?u("mi_per_hour"):u("km_per_hour"),a=[[u("date"),u("stops"),u("latitude"),u("longitude"),r,u("battery"),u("zone"),u("address")].map(co).join(o)];for(let i of e||[]){let d=i?.attributes?.latitude,c=i?.attributes?.longitude,m=n?n(i?.last_updated):i?.last_updated||"",p=i?.stop?u("stop"):"",l=Wr(Number(i?.attributes?.speed),t),h=Number.isFinite(i?.battery)?i.battery:"",f=[m,p,uo(d),uo(c),l,h,i?.zone||"",i?.address||""].map(co).join(o);a.push(f)}return a.join(`
`)}function mo(e,t){let n=new Blob(["\uFEFF"+t],{type:"text/csv;charset=utf-8"}),o=URL.createObjectURL(n),r=document.createElement("a");r.href=o,r.download=e.endsWith(".csv")?e:`${e}.csv`,document.body.appendChild(r),r.click(),r.remove(),URL.revokeObjectURL(o)}async function Gr(e,t){let n=new Blob(["\uFEFF"+t],{type:"text/csv;charset=utf-8"});if("showSaveFilePicker"in window){let r=await(await window.showSaveFilePicker({suggestedName:e.endsWith(".csv")?e:`${e}.csv`,types:[{description:"CSV",accept:{"text/csv":[".csv"]}}]})).createWritable();await r.write(n),await r.close()}else mo(e,t)}async function fo(e,{filename:t,useImperial:n,formatLocal:o,delimiter:r=";",usePicker:s=!1}={}){let a=Vr(e,{useImperial:n,formatLocal:o,delimiter:r});s?await Gr(t,a):mo(t,a)}var Kr="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js";async function Jr(){window.ExcelJS||await new Promise((e,t)=>{let n=document.createElement("script");n.src=Kr,n.async=!0,n.onload=()=>e(),n.onerror=o=>t(o),document.head.appendChild(n)})}function po(e){let t=Number(e);return Number.isFinite(t)?Number(t.toFixed(6)):null}function Yr(e,t){if(!Number.isFinite(e))return null;let n=e*3.6,o=n*.621371192;return Math.round(t?o:n)}function be(e){return String(e||"").split(`
`).reduce((t,n)=>Math.max(t,n.length),0)}function Xr(e,t){let n=[19,6,11,11,12,8,18,30],o=[40,10,16,16,16,10,50,80],r=t.map(s=>be(s));for(let s of e)r[0]=Math.max(r[0],be(s.date)),r[1]=Math.max(r[1],be(s.stop)),r[2]=Math.max(r[2],be(s.latStr)),r[3]=Math.max(r[3],be(s.lonStr)),r[4]=Math.max(r[4],be(s.speedStr)),r[5]=Math.max(r[5],be(s.battStr)),r[6]=Math.max(r[6],be(s.zone)),r[7]=Math.max(r[7],be(s.address));return r.map((s,a)=>Math.min(o[a],Math.max(n[a],s+2)))}async function ho(e,{filename:t="ha-tracker.xlsx",useImperial:n=!1,formatLocal:o=s=>new Date(s).toLocaleString(),sheetName:r=u("positions")}={}){await Jr();let s=window.ExcelJS,a=new s.Workbook,i=a.addWorksheet(r),d={name:"Verdana",size:9},c={vertical:"middle",horizontal:"left"},m=n?u("mi_per_hour"):u("km_per_hour"),p=[u("date"),u("stops"),u("latitude"),u("longitude"),m,u("battery"),u("zone"),u("address")],l=(e||[]).map(v=>{let E=o?o(v?.last_updated):v?.last_updated||"",y=v?.stop?u("stop"):"",k=po(v?.attributes?.latitude),I=po(v?.attributes?.longitude),D=Yr(Number(v?.attributes?.speed),n),z=Number.isFinite(v?.battery)?v.battery:null,C=v?.zone||"",F=(v?.address||"").replace(/\u00A0/g," ");return{date:E,stop:y,lat:k,lon:I,speed:D,batt:z,latStr:k==null?"":String(k),lonStr:I==null?"":String(I),speedStr:D==null?"":String(D),battStr:z==null?"":String(z),zone:C,address:F}}),h={type:"pattern",pattern:"solid",fgColor:{argb:"FF003E78"}},f={...d,bold:!0,color:{argb:"FFFFFFFF"}},g={...c,wrapText:!0};i.addRow(p);let b=i.getRow(1);b.height=18,b.font=f,b.alignment=g,b.eachCell(v=>{v.fill=h,v.font=f,v.alignment=g});for(let v of l){let E=i.addRow([v.date,v.stop,v.lat,v.lon,v.speed,v.batt,v.zone,v.address]);E.font=d,E.alignment=c}i.views=[{state:"frozen",ySplit:1}];let _=Xr(l,p);i.columns=_.map((v,E)=>({width:v,style:{font:d,alignment:{...c,wrapText:E===7}}})),i.getRow(1).eachCell(v=>{v.font=f,v.alignment=g,v.fill=h});let T=await a.xlsx.writeBuffer(),x=new Blob([T],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),S=document.createElement("a");S.href=URL.createObjectURL(x),S.download=t.endsWith(".xlsx")?t:`${t}.xlsx`,document.body.appendChild(S),S.click(),S.remove(),URL.revokeObjectURL(S.href)}var Qr="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js",es="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js",ts="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js",St=[0,62,120],nn=[255,255,255];function on(e){return new Promise((t,n)=>{if([...document.scripts].some(r=>r.src===e))return t();let o=document.createElement("script");o.src=e,o.async=!0,o.onload=()=>t(),o.onerror=r=>n(r),document.head.appendChild(o)})}async function ns(){window.jspdf?.jsPDF?.API?.autoTable||(await on(Qr),await on(es))}async function os(){window.html2canvas||await on(ts)}async function rs(){await os();let e=document.getElementById("map");return e?(await window.html2canvas(e,{useCORS:!0,backgroundColor:"#ffffff",logging:!1,scale:2})).toDataURL("image/jpeg",.92):null}function ss(e,t=U){let n=/^#?([0-9a-f]{6})$/i.exec(e||"");if(!n)return null;let o=parseInt(n[1],16),r=o>>16&255,s=o>>8&255,a=o&255,i=d=>Math.round((1-t)*255+t*d);return[i(r),i(s),i(a)]}function as(e,{defaultColor:t=Z}={}){return e&&e.color?e.color:t}function rn(e,t={},{alpha:n=U}={}){if(!e)return null;let o=t[e],r=as(o);return ss(r,n)}function yo(e=[]){let t=[],n=null;for(let o of e){let r=(o.zone||"").trim(),s=r!==n;(o.stop||s)&&t.push(o),n=r}return t}function go(e,t,n,o,r,s,{font:a="helvetica",labelStyle:i="bold",valueStyle:d="normal",lineHeight:c=14}={}){e.setFont(a,i);let m=e.getTextWidth(r);e.setFont(a,d);let p=e.splitTextToSize(String(s||""),Math.max(20,o-m));e.setFont(a,i),e.text(r,t,n),e.setFont(a,d),e.text(p[0]||"",t+m,n);for(let l=1;l<p.length;l++)n+=c,e.text(p[l],t+m,n);return n+c}function is(e,{margin:t,pageW:n,personName:o,startLocal:r,endLocal:s,nameColor:a=[0,62,120]}){let i=n-t*2,d=t;e.setFont("helvetica","bold"),e.setFontSize(16),e.setTextColor(a[0],a[1],a[2]);let c=e.splitTextToSize(o||"",i);return e.text(c,t,d),d+=c.length*18,e.setFontSize(11),e.setTextColor(a[0],a[1],a[2]),d=go(e,t,d,i,`${u("start")||"Inicio"}: `,r||"",{lineHeight:14,labelStyle:"bold",valueStyle:"normal"}),d=go(e,t,d,i,`${u("end")||"Fin"}: `,s||"",{lineHeight:14,labelStyle:"bold",valueStyle:"normal"}),d+=6,d}function ls(e,t,n=.9){let o=e.internal.pageSize.getWidth(),r=o-t*2,s=Math.floor(r*n),a=t+Math.round((r-s)/2);return{tableWidth:s,left:a,pageW:o}}function cs(e){let t={date:.22,stop:.03,zone:.24,speed:.12,batt:.09,addr:.3},n={date:90,stop:12,zone:90,speed:54,batt:40,addr:90},o=Math.max(n.date,Math.floor(e*t.date)),r=Math.max(n.stop,Math.floor(e*t.stop)),s=Math.max(n.zone,Math.floor(e*t.zone)),a=Math.max(n.speed,Math.floor(e*t.speed)),i=Math.max(n.batt,Math.floor(e*t.batt)),d=Math.max(n.addr,Math.floor(e*t.addr)),c=o+r+s+a+i+d,m=e-c;return m!==0&&(d=Math.max(n.addr,d+m)),{wDate:o,wStop:r,wZone:s,wSpeed:a,wBatt:i,wAddr:d}}async function bo({filename:e,summaryRows:t,zonesRows:n,positionsRows:o,stopIconUrl:r,header:s}){await ns();let{jsPDF:a}=window.jspdf,i=new a({unit:"pt",format:"a4",compress:!0}),d=i.internal.pageSize.getWidth(),c=36,m=ls(i,c,.9),p=null;if(r)try{let k=await(await fetch(r,{cache:"force-cache"})).blob();p=await new Promise(I=>{let D=new FileReader;D.onload=()=>I(D.result),D.readAsDataURL(k)})}catch{}let l=is(i,{margin:c,pageW:d,personName:s?.personName||"",startLocal:s?.startLocal||"",endLocal:s?.endLocal||"",nameColor:St});try{let y=await rs();if(y){let k=i.getImageProperties(y),I=m.tableWidth,D=k.height*I/k.width;i.addImage(y,"JPEG",m.left,l,I,D),l+=D+8}}catch(y){console.warn("No se pudo capturar el mapa:",y)}i.autoTable({head:[[u("metric")||"M\xE9trica",u("value")||"Valor"]],body:(t||[]).map(y=>[y.label,y.value]),startY:l,theme:"grid",tableWidth:m.tableWidth,margin:{left:m.left,right:m.left},styles:{font:"helvetica",fontSize:10,cellPadding:4,overflow:"linebreak"},headStyles:{fillColor:St,textColor:nn,fontStyle:"bold",halign:"left"},columnStyles:{0:{cellWidth:170,fontStyle:"bold"},1:{cellWidth:m.tableWidth-170}}}),l=i.lastAutoTable.finalY+8;{let y=!!_t,k=100,I=60,D=60,z=60,C=k+D+z+(y?I:0),F=Math.max(160,m.tableWidth-C),O=[{key:"zone",header:u("zone")||"Zona",width:F,halign:"left"},{key:"time",header:u("time")||"Tiempo",width:k,halign:"center"}];y&&O.push({key:"visits",header:u("visits")||"Visitas",width:I,halign:"center"}),O.push({key:"stops",header:u("stops")||"Paradas",width:D,halign:"center"},{key:"distance",header:u("distance")||"Distancia",width:z,halign:"center"});let P=[O.map(j=>j.header)],q=(n||[]).map(j=>O.map(A=>A.key==="distance"?ds(j):A.key==="stops"||A.key==="visits"?String(j[A.key]??""):j[A.key]||"")),V=O.reduce((j,A,ce)=>(j[ce]={cellWidth:A.width,halign:A.halign},j),{});i.autoTable({head:P,body:q,startY:l,theme:"grid",tableWidth:m.tableWidth,margin:{left:m.left,right:m.left},styles:{font:"helvetica",fontSize:10,cellPadding:4,overflow:"linebreak"},headStyles:{fillColor:St,textColor:nn,fontStyle:"bold",halign:"left"},columnStyles:V,didParseCell:j=>{if(j.section==="body"){let A=n[j.row.index];A?._fillColor&&(j.cell.styles.fillColor=A._fillColor)}}}),l=i.lastAutoTable.finalY+8}let{wDate:h,wStop:f,wZone:g,wSpeed:b,wBatt:_,wAddr:T}=cs(m.tableWidth),S=(o||[]).some(y=>/\bmph\b/i.test(String(y.speed||"")))?`${u("speed")||"Velocidad"} (${u("mi_per_hour")||"mph"})`:`${u("speed")||"Velocidad"} (${u("km_per_hour")||"km/h"})`,v=(o||[]).map(y=>[y.whenLocal||"","",y.zone||"",y.speed||"",(y.battery??"")===""?"":`${y.battery}%`,(y.address||"").replace(/\u00A0/g," ")]);i.autoTable({head:[[u("date")||"Fecha/Hora","",u("zone")||"Zona",S,u("battery")||"Bater\xEDa",u("address")||"Direcci\xF3n"]],body:v,startY:l,theme:"grid",tableWidth:m.tableWidth,margin:{left:m.left,right:m.left},styles:{font:"helvetica",fontSize:9,cellPadding:{top:3,right:3,bottom:3,left:3},halign:"left",valign:"top",overflow:"linebreak",cellWidth:"wrap"},headStyles:{fillColor:St,textColor:nn,fontStyle:"bold",halign:"left"},columnStyles:{0:{cellWidth:h},1:{cellWidth:f,halign:"center"},2:{cellWidth:g},3:{cellWidth:b,halign:"center"},4:{cellWidth:_,halign:"center"},5:{cellWidth:T}},didParseCell:y=>{if(y.section==="body"){let k=o[y.row.index];k?._fillColor&&(y.cell.styles.fillColor=k._fillColor)}},didDrawCell:y=>{if(y.section==="body"&&y.column.index===1&&p&&o[y.row.index]?.isStop){let D=y.cell.x+(y.cell.width-10)/2,z=y.cell.y+(y.cell.height-10)/2;try{i.addImage(p,"PNG",D,z,10,10)}catch{}}},pageBreak:"auto"});let E=e?.endsWith(".pdf")?e:`${e||"export"}.pdf`;i.save(E)}function ds(e){if(!e)return"";if(e.distance!=null&&e.distance!=="")return String(e.distance);let t=Number(e.distanceMeters??e.meters??NaN);return Number.isFinite(t)?`${((e._unitShort==="mi"||e._unitShort==="km"?e._unitShort:"km")==="mi"?t/1609.344:t/1e3).toFixed(0)}`:""}var Ct=[],Ve=null,J=null,Lt="zone",we=!0,sn=16,us="/local/ha-tracker/images/filter.png",ms="/local/ha-tracker/images/stop16x16.png",So="/local/ha-tracker/images/stop24x24.png",ue=e=>String(e).padStart(2,"0"),wo=document.getElementById("combo-select");wo&&wo.addEventListener("change",()=>$t());function _o(){let e=document.querySelector('.tab-button[data-tab="positions"]');e&&Lo({currentTarget:e},"positions")}function Lo(e,t){document.querySelectorAll(".tab").forEach(n=>n.classList.remove("active")),document.querySelectorAll(".tab-button").forEach(n=>n.classList.remove("active")),document.getElementById(t).classList.add("active"),e?.currentTarget&&e.currentTarget.classList.add("active")}async function ko(){it(!1),_s(),xt();let e=document.getElementById("person-select");e&&(e.addEventListener("focus",async()=>{try{await Jt()}catch(n){console.error(n)}}),e.addEventListener("change",()=>{try{$t(!0,!1),Kt(e.value),xt(),it(!1)}catch(n){console.error(n)}})),document.querySelectorAll(".tab-button").forEach(n=>{n.addEventListener("click",o=>{try{let r=n.getAttribute("data-tab");Lo(o,r)}catch(r){console.error(r)}})}),await oo({onApplyFilter:()=>$o().catch(console.error)})}function fs(){if(!J)return;document.querySelectorAll("#filter-table-body tr").forEach(t=>{let n=t.dataset.zone||"",o=n&&J.zonePositions?.[n]||null,r=n?{name:n,color:o?.color||null}:null;Tt(t,r,U)})}async function Co(e){try{let t=Array.isArray(e)?e:e?.positions||[],n=Array.isArray(e)?null:e?.summary||null,o=Array.isArray(e)?null:e?.zones||null;t.length>0?(console.log("Positions:",t),await $t(!1,!1),o&&ys(o),await ps(t),n&&gs(n),await Do(),fs(),await bs(t),await xs(t,void 0,void 0,void 0,void 0,void 0,{curved:!0,curveAlg:"catmull",subdivisions:6,alpha:.5}),it(!0)):($t(!0,!1),it(!1),B(u("no_positions"),{title:u("filter")}))}catch(t){console.error("Error getting filtered positions:",t),B(u("filter_problem"),{title:u("filter")})}}async function ps(e){let t=document.getElementById("filter-table-body");if(!e||e.length===0)return;let n=[],o=null,r=0,s=[];e.forEach((l,h)=>{let f=ke(l.attributes.latitude,l.attributes.longitude),g=f?f.name:"";s[h]={zone:f,zn:g},h===0?(o=g,r=0):g!==o&&(n.push({start:r,end:h-1}),o=g,r=h),h===e.length-1&&n.push({start:r,end:h})});let a=Ms(),i=null,d=0,c=!1,m=document.createDocumentFragment();if(e.forEach((l,h)=>{let{zone:f,zn:g}=s[h];g!==i?(d++,i=g,c=!0):c=!1;let b=`group-${d}`,_=l?.stop?`<img src="${ms}" alt="" style="width:16px;height:16px;">`:"",T=re(l.last_updated),x=Math.round((l.attributes.speed||0)*(M?2.23694:3.6)),S=K(x),v=`${l.entity_id}_${new Date(l.last_updated).toISOString()}`,E=document.createElement("tr");if(Tt(E,f,U),E.classList.add(b,"pos-main-row"),E.dataset.entityId=v,E.dataset.latitude=l.attributes.latitude,E.dataset.longitude=l.attributes.longitude,E.dataset.lastUpdated=l.last_updated,E.dataset.speed=String(x),E.dataset.battery=(ks(l?.attributes)??"").toString(),E.dataset.isStop=l&&l.stop?"1":"0",E.dataset.entity=l?.entity_id||"",E.dataset.zone=g||"",E.dataset.address="",E.style.cursor="pointer",c){let y=n[d-1],k=new Date(e[y.start].last_updated),I=new Date(e[y.end].last_updated),D=new Date(I.getTime()+1e3),z=vo(k),C=vo(D);E.classList.add("group-header"),E.innerHTML=`
				<td><button class="toggle-btn">\u25BA</button></td>
				<td>${_}</td>
				<td>${T}</td>
				<td>${g}</td>
				<td>${S}</td>
				<td>
				  <button class="group-filter-btn" title="${u("filter")||"Filtrar"}"
						  style="background:none;border:none;cursor:pointer;padding:0;line-height:0;">
						  <img src="${us}" alt="" style="width:16px;height:16px;">
				  </button>
				</td>
			  `;let F=E.querySelector(".toggle-btn");F.addEventListener("click",P=>{P.stopPropagation(),To(b,F)}),E.querySelector(".group-filter-btn").addEventListener("click",async P=>{P.stopPropagation();try{let[q,V="00:00:00"]=z.split("T"),[j,A="23:59:59"]=C.split("T"),ce=ee=>{let[Ge,Ke,Pt]=ee.split("-").map(Number);return new Date(Ge,Ke-1,Pt,0,0,0,0)};wt(V,A),en([ce(q),ce(j)],!0),await $o()}catch(q){console.error("No se pudo aplicar el rango al calendario",q)}})}else l&&l.stop?(E.style.display="table-row",E.classList.add("pin-visible")):E.style.display="none",E.innerHTML=`
				<td></td>
				<td>${_}</td>
				<td>${T}</td>
				<td>${g}</td>
				<td>${S}</td>
				<td></td>
			  `;if(E.onclick=()=>kt(E),m.appendChild(E),l&&l.stop){E.classList.add("has-address");let y=document.createElement("tr");y.dataset.address="",y.classList.add(b,"position-address-row","pin-visible"),y.style.cursor="pointer",y.dataset.entityId=v,y.style.display="table-row",y.dataset.zone=g||"";let k=new Date(l.last_updated).getTime();y.dataset.latitude=String(+l.attributes.latitude),y.dataset.longitude=String(+l.attributes.longitude),y.dataset.lastUpdated=String(k),y.innerHTML=`
        <td class="addr-spacer"></td>
        <td class="addr-cell" colspan="5" style="padding:4px 8px;">\u2026</td>
      `,y.onclick=()=>kt(E),m.appendChild(y),Tt(y,f,U),a.observe(y)}}),t.innerHTML="",t.appendChild(m),e.length>0){let l=t.querySelector("tr");l&&kt(l)}t.querySelectorAll(".group-header").forEach(l=>{let h=Array.from(l.classList).find(x=>x.startsWith("group-"));if(!h)return;let f=t.querySelectorAll(`tr.${h}:not(.group-header):not(.pin-visible)`),g=f.length>0,b=g&&Array.from(f).some(x=>x.style.display==="none"),_=l.querySelector(".toggle-btn"),T=l.querySelector(".group-filter-btn");_&&(_.style.display=g?"":"none",_.textContent=b?"\u25BA":"\u25BC"),T&&(T.style.display=g?"":"none")})}function hs(){let e=document.getElementById("filter-table-body");if(!e)return;let t=Array.from(e.querySelectorAll("tr.pos-main-row"));if(!t.length)return;let n=null;for(let o of t){let r=Number(o.dataset.speed)||0,s=Date.parse(o.dataset.lastUpdated)||0;(!n||r>n.s||r===n.s&&s>n.ts)&&(n={id:o.dataset.entityId,s:r,ts:s})}n&&n.id?No(n.id):B(u("no_positions")||"No hay posiciones.",{title:u("filter")})}function gs(e){let t=M?2.23694:3.6,n=M?e.distance_m/1609.344:e.distance_m/1e3,o=s=>cn(s*1e3);document.getElementById("positions-count").textContent=K(e.positions_count),document.getElementById("total-time").textContent=o(e.total_time_s),document.getElementById("distance").textContent=`${ln(n)} ${u(M?"miles":"kilometres")}`,document.getElementById("max-speed").textContent=`${K(e.max_speed_mps*t)} ${u(M?"mi_per_hour":"km_per_hour")}`,document.getElementById("average-speed").textContent=`${ln(e.average_speed_mps*t)} ${u(M?"mi_per_hour":"km_per_hour")}`,document.getElementById("stops-count").textContent=K(e.stops_count),document.getElementById("stopped-time").textContent=o(e.stopped_time_s);let r=document.querySelector("#summary table tbody tr:nth-child(4)");r&&(r.style.cursor="pointer",r.title=u("go_to_max_speed")||"Ir a la posici\xF3n de velocidad m\xE1xima",r.onclick=hs)}function ys(e){J={zoneDurations:{},zoneVisits:{},zonePositions:{},zoneStops:{},zoneDistanceMeters:{}};for(let t of e){let n=t.zone||"";if(J.zoneDurations[n]=(t.time_s||0)*1e3,J.zoneVisits[n]=t.visits||0,J.zoneStops[n]=t.stops||0,J.zoneDistanceMeters[n]=t.distance_m||0,t.id!=null){let o=zn(t.id);o&&(J.zonePositions[n]={id:o.id,name:o.name||n,lat:o.lat,lon:o.lon,color:o.color||null})}}}async function bs(e){w.getPane("filterMarkers")||(w.createPane("filterMarkers"),w.getPane("filterMarkers").style.zIndex=400);let t=sn;e.forEach(n=>{let o=Number(n?.attributes?.latitude),r=Number(n?.attributes?.longitude);if(!Number.isFinite(o)||!Number.isFinite(r))return;let s=n.stop?L.icon({iconUrl:So,iconSize:[24,24],iconAnchor:[12,12]}):L.divIcon({className:"",html:`<div style="
            width:10px;height:10px;border:1px solid rgba(0,0,255,0.8);
            border-radius:50%;background-color: rgba(0,0,255,0.5);
          "></div>`,iconSize:[10,10],iconAnchor:[5,5]}),a=L.marker([o,r],{icon:s,pane:"filterMarkers"});a.isStop=!!n.stop,(n.stop||w.getZoom()>=t)&&a.addTo(w),n.stop&&a.setZIndexOffset(50),a.on("click",()=>{let i=`${n.entity_id}_${new Date(n.last_updated).toISOString()}`;No(i)}),Ct.push(a)}),Nt||(w.on("zoomend",an),Nt=!0),an()}async function $o(){let e=document.getElementById("person-select").value,{startLocal:t,endLocal:n}=vt();if(!e){B(u("select_user_filter"),{title:u("filter")}),at();return}if(!t||!n){B(u("select_dates"),{title:u("filter")});return}let o=xo(t,!1),r=xo(n,!n.includes("T"));if(!o||!r){B(u("select_dates"),{title:u("filter")});return}let s=Date.parse(o),a=Date.parse(r);if(!Number.isFinite(s)||!Number.isFinite(a)||s>=a){B(u("invalid_dates"),{title:u("filter")}),at();return}let i=744*60*60*1e3;if(a-s>i){B(u("date_range"),{title:u("filter")}),at();return}mt(u("running_filter"));try{await Mo(e,o,r)}catch(d){console.error("Error during filter:",d),B(u("filter_error"),{title:u("filter")})}finally{ft()}}async function $t(e=!0,t=!0){if(e&&at(),t){let n=document.getElementById("person-select");n&&(n.value="",n.dispatchEvent(new Event("change",{bubbles:!0})))}if(vs(),_o(),document.getElementById("filter-table-body").innerHTML="",document.getElementById("positions-count").textContent="--",document.getElementById("total-time").textContent="--",document.getElementById("distance").textContent="--",document.getElementById("max-speed").textContent="--",document.getElementById("average-speed").textContent="--",document.getElementById("stops-count").textContent="--",document.getElementById("stopped-time").textContent="--",document.getElementById("summary-zones-table-body").innerHTML="",Ct.forEach(n=>{try{w.removeLayer(n)}catch{}}),Ct=[],window.routeLineSegments&&(window.routeLineSegments.forEach(n=>{try{w.removeLayer(n)}catch{}}),window.routeLineSegments=[]),window.routeOutline){try{w.removeLayer(window.routeOutline)}catch{}window.routeOutline=null}Nt&&(w.off("zoomend",an),Nt=!1),$e&&($e.disconnect(),$e=null),xt(),it(!1)}async function To(e,t){let n=document.querySelectorAll(`tr.${e}:not(.group-header):not(.pin-visible)`);if(!n.length){t.textContent=t.textContent==="\u25BA"?"\u25BC":"\u25BA";return}let o=n[0].style.display==="none";n.forEach(r=>{r.style.display=o?"table-row":"none"}),t.textContent=o?"\u25BC":"\u25BA",o&&queueMicrotask(()=>{let r="#filter-table-body",s=document.querySelector(`${r} tr.${e}.selected`);if(s&&s.classList.contains("position-address-row")){let a=s.previousElementSibling;a&&a.classList.contains("pos-main-row")&&(s=a)}s||(s=document.querySelector(`${r} tr.${e}:not(.group-header)`)),s&&s.scrollIntoView({behavior:"smooth",block:"center"})})}async function kt(e){document.querySelectorAll("#filter-table-body tr").forEach(d=>d.classList.remove("selected")),e.classList.add("selected");let n=e.nextElementSibling;n&&n.classList.contains("position-address-row")&&n.classList.add("selected");let o=parseFloat(e.dataset.latitude),r=parseFloat(e.dataset.longitude),s=e.dataset.lastUpdated,a=Math.round(e.dataset.speed||0),i=e.dataset.isStop==="1";ws(o,r,s,a,i)}function ws(e,t,n,o,r=!1){let s=`https://www.google.com/maps/search/?api=1&query=${e},${t}`,i=`
	  ${r?`<strong>${u("stop")||"Stop"}</strong><br>`:""}
	  ${re(n)}<br>${u("speed")}: ${K(o)} ${u(M?"mi_per_hour":"km_per_hour")}
	  <br><br><a href="${s}" target="_blank" rel="noopener noreferrer"><strong>${u("open_location")}</strong></a>
	`;Ve&&Ve.remove(),Ve=L.popup({autoPan:!0}).setLatLng([e,t]).setContent(i).openOn(w),w.invalidateSize(),w.setView([e,t],w.getZoom())}function vs(){Ve&&(Ve.remove(),Ve=null)}async function No(e){let t=document.getElementById("filter-table-body");if(!t){console.error("Filter table tbody not found.");return}let n=t.querySelector(`tr[data-entity-id="${e}"]`);if(!n){console.error("Row not found for position:",e);return}let o=getComputedStyle(n).display==="none"||n.style.display==="none",r=[...n.classList].find(a=>a.startsWith("group-"));if(!r){console.error("The row does not belong to any group:",n);return}if(o){let a=document.querySelector(`tr.${r}.group-header`);if(a){let i=a.querySelector(".toggle-btn");i&&To(r,i)}}let s=document.getElementById("combo-select");if(s&&s.value!=="filter"){s.value="filter";let a=new Event("change",{bubbles:!0});s.dispatchEvent(a)}kt(n),_o(),n.scrollIntoView({behavior:"smooth",block:"center"})}async function xs(e,t=[0,200,0,.8],n=[100,100,255,.8],o="#ffffff",r=9,s=6,a={}){let{curved:i=!1,curveAlg:d="catmull",subdivisions:c=8,alpha:m=.5}=a;if(!e||e.length<2)return;let p=e.map(h=>h.attributes.latitude&&h.attributes.longitude?[h.attributes.latitude,h.attributes.longitude]:null).filter(Boolean);if(p.length<2)return;if(i&&d==="catmull"){let g=(p.length-1)*c>4e3?Math.max(1,Math.floor(4e3/Math.max(p.length-1,1))):c;p=Es(p,g,m)}if(window.routeLineSegments&&window.routeLineSegments.forEach(h=>{try{w.removeLayer(h)}catch{}}),window.routeLineSegments=[],window.routeOutline){try{w.removeLayer(window.routeOutline)}catch{}window.routeOutline=null}w.getPane("routeOutline")||w.createPane("routeOutline"),w.getPane("routeColor")||w.createPane("routeColor"),w.getPane("routeOutline").style.zIndex=390,w.getPane("routeColor").style.zIndex=391;let l=p.length-1;for(let h=0;h<l;h++){let f=h/l,g=Math.round(t[0]+f*(n[0]-t[0])),b=Math.round(t[1]+f*(n[1]-t[1])),_=Math.round(t[2]+f*(n[2]-t[2])),T=t[3]+f*(n[3]-t[3]),x=`rgba(${g},${b},${_},${T})`,S=p[h],v=p[h+1],E=L.polyline([S,v],{color:o,weight:r,opacity:1,lineCap:"round",lineJoin:"round",pane:"routeOutline"}).addTo(w);window.routeLineSegments.push(E);let y=L.polyline([S,v],{color:x,weight:s,opacity:1,lineCap:"round",lineJoin:"round",pane:"routeColor"}).addTo(w);window.routeLineSegments.push(y)}w.fitBounds(L.latLngBounds(p))}function Es(e,t=8,n=.5){let r=e.map(d=>[Number(d[0]),Number(d[1])]).filter(d=>Number.isFinite(d[0])&&Number.isFinite(d[1]));if(r.length<2)return r;let s=[],a=(d,c,m)=>[d[0]+(c[0]-d[0])*m,d[1]+(c[1]-d[1])*m],i=(d,c)=>Math.pow(Math.hypot(c[0]-d[0],c[1]-d[1])||1e-6,n);s.push(r[0]);for(let d=0;d<r.length-1;d++){let c=d>0?r[d-1]:r[d],m=r[d],p=r[d+1],l=d+2<r.length?r[d+2]:r[d+1],h=0,f=h+i(c,m),g=f+i(m,p),b=g+i(p,l);for(let T=1;T<=t;T++){let x=f+T*(g-f)/t,S=a(c,m,(x-h)/(f-h+1e-6)),v=a(m,p,(x-f)/(g-f+1e-6)),E=a(p,l,(x-g)/(b-g+1e-6)),y=a(S,v,(x-h)/(g-h+1e-6)),k=a(v,E,(x-f)/(b-f+1e-6)),I=a(y,k,(x-f)/(g-f+1e-6)),D=s[s.length-1];(!D||Math.hypot(I[0]-D[0],I[1]-D[1])>1e-6)&&s.push(I)}let _=s[s.length-1];(!_||Math.hypot(p[0]-_[0],p[1]-_[1])>1e-6)&&s.push(p)}return s}async function Do(){let e=document.getElementById("summary-zones-table-body");if(!J){console.error("There are no saved statistics for zones. Make sure to apply the filter first.");return}let{zoneDurations:t,zoneVisits:n,zonePositions:o,zoneStops:r,zoneDistanceMeters:s}=J,d=[...new Set([...Object.keys(t||{}),...Object.keys(n||{}),...Object.keys(r||{}),...Object.keys(s||{})])].sort((c,m)=>{switch(Lt){case"zone":return we?c.localeCompare(m):m.localeCompare(c);case"time":return we?(t?.[c]||0)-(t?.[m]||0):(t?.[m]||0)-(t?.[c]||0);case"visits":return we?(n?.[c]||0)-(n?.[m]||0):(n?.[m]||0)-(n?.[c]||0);case"stops":return we?(r?.[c]||0)-(r?.[m]||0):(r?.[m]||0)-(r?.[c]||0);case"distance":return we?(s?.[c]||0)-(s?.[m]||0):(s?.[m]||0)-(s?.[c]||0);default:return 0}});e.innerHTML="";for(let c of d){let m=t?.[c]||0,p=n?.[c]||0,l=r?.[c]||0,h=s?.[c]||0,f=M?h/1609.344:h/1e3,g=`${K(f)}`,b=c,_=document.createElement("tr");_.innerHTML=`
		  <td>${b}</td>
		  <td>${cn(m)}</td>
		  <td>${K(p)}</td>
		  <td>${K(l)}</td>
		  <td>${g}</td>
		`;let T=o[c];T&&T.id!=null?(_.style.cursor="pointer",_.title=u("show_zone")||"",_.addEventListener("click",()=>Ut(T.id))):_.style.cursor="",_.addEventListener("click",()=>{let S=o[c];S&&Ut(S.id)});let x=o[c];if(c){let S={name:c,color:x?.color||null};Tt(_,S,U)}else _.classList.remove("zone-tinted"),_.style.removeProperty("--color-bg");e.appendChild(_)}Ss()}function Ss(){let e=document.querySelector("#summary-zones-table");if(!e){console.error("Zone summary table not found.");return}e.querySelectorAll("thead th").forEach(n=>{let o=n.getAttribute("data-i18n"),r="";switch(o){case"zone":r="zone";break;case"time":r="time";break;case"visits":r="visits";break;case"stops":r="stops";break;case"distance":r="distance";break}if(!r)return;n.style.cursor="pointer",n.onclick=()=>{Lt===r?we=!we:(Lt=r,we=!0),Do()};let s=Lt===r?we?"\u25B2":"\u25BC":"",a=o==="distance"?M?u("miles"):u("kilometres"):u(o);n.innerHTML=`
            <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:30px;">
                <span class="hdr-label">${a}</span>
                <span class="hdr-arrow" style="font-size:12px;">${s}</span>
            </div>`})}function _s(){if(document.getElementById("zone-tint-css"))return;let e=document.createElement("style");e.id="zone-tint-css",e.textContent=`
		/* Aplica tinte solo si la fila NO est\xE1 seleccionada */
		#filter-table-body tr.zone-tinted:not(.selected),
		#summary-zones-table-body tr.zone-tinted:not(.selected) {
		  background-color: var(--color-bg);
		}
	  `,document.head.appendChild(e)}function Tt(e,t,n=U){if(!(!!t&&(t.name??"")!=="")){e.classList.remove("zone-tinted"),e.style.removeProperty("--color-bg");return}let r=Ls(t,n);r?(e.classList.add("zone-tinted"),e.style.setProperty("--color-bg",r)):(e.classList.remove("zone-tinted"),e.style.removeProperty("--color-bg"))}function Ls(e,t=U){if(!e)return null;let n=e.color;return!n&&e.name&&J?.zonePositions?.[e.name]?.color&&(n=J.zonePositions[e.name].color),n?Se(n,t):null}function cn(e){let t=Math.floor(e/1e3),n=Math.floor(t/(24*3600)),o=Math.floor(t%(24*3600)/3600),r=Math.floor(t%3600/60),s=t%60;return`${n>0?`${n} ${n===1?u("day"):u("days")} `:""}${String(o).padStart(2,"0")}:${String(r).padStart(2,"0")}:${String(s).padStart(2,"0")}`}function vo(e){return`${e.getFullYear()}-${ue(e.getMonth()+1)}-${ue(e.getDate())}T${ue(e.getHours())}:${ue(e.getMinutes())}:${ue(e.getSeconds())}`}function xo(e,t=!1){if(!e)return null;let n=e.match(/\d+/g)?.map(Number);if(!n||n.length<3)return null;let[o,r,s]=n,a=0,i=0,d=0,c=0;return n.length>=5?(a=n[3],i=n[4],d=n[5]??0):t&&(a=23,i=59,d=59,c=999),new Date(o,r-1,s,a,i,d,c).toISOString()}function it(e){let t=document.getElementById("export-filter"),n=t?.closest(".group");!n||!t||(n.style.display=e?"":"none",t.disabled=!e,n.setAttribute("aria-hidden",e?"false":"true"))}function ks(e){if(!e||typeof e!="object")return null;let t=["battery","battery_level","battery_percent","battery_percentage","battery_level_pct","batteryLevel"],n=null;for(let o of t)if(o in e){n=e[o];break}if(n==null)return null;if(typeof n=="string"){let o=n.match(/(\d+(?:\.\d+)?)\s*%?/);o&&(n=Number(o[1]))}return n=Number(n),Number.isFinite(n)?n>0&&n<=1?Math.round(n*100):n>=1&&n<=100?Math.round(n):null:null}function Dt(){let e=document.getElementById("filter-table-body");if(!e)return[];let t=Array.from(e.querySelectorAll("tr.pos-main-row")),n=[];for(let o of t){let r=Number(o.dataset.latitude),s=Number(o.dataset.longitude);if(!Number.isFinite(r)||!Number.isFinite(s))continue;let a=o.dataset.lastUpdated,i=o.dataset.isStop==="1",d=o.dataset.entity||"",c=o.dataset.zone||"";if(!c&&typeof ke=="function")try{c=ke(r,s)?.name||""}catch{}let m=o.dataset.address||"";if(!m&&i){let f=o.nextElementSibling;if(f&&f.classList.contains("position-address-row")){let b=((f.querySelector("td.addr-cell")||f.querySelector("td"))?.textContent||"").trim();b&&b!=="\u2026"&&(m=b)}}let p=Number(o.dataset.speed),l=null;Number.isFinite(p)&&(l=(M?p*1.609344:p)/3.6);let h=o.dataset.battery&&Number.isFinite(Number(o.dataset.battery))?Number(o.dataset.battery):null;n.push({entity_id:d,last_updated:a,stop:i,zone:c,address:m,battery:h,attributes:{latitude:r,longitude:s,speed:l}})}return n}function Eo(e){if(!e)return"unknown";let t=e.match(/\d+/g)?.map(Number);if(!t||t.length<3)return"unknown";let[n,o,r,s=0,a=0]=t;return e.includes("T")?`${n}-${ue(o)}-${ue(r)}_${ue(s)}-${ue(a)}`:`${n}-${ue(o)}-${ue(r)}`}function Cs(e){return String(e).normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[\\/:*?"<>|]/g,"").trim().replace(/\s+/g,"_")}function Mt(e="kml"){let t=document.getElementById("person-select"),n=Cs(t?.selectedOptions?.[0]?.text||t?.value||"person"),{startLocal:o,endLocal:r}=vt();return`${n}_${Eo(o)}_${Eo(r)}.${e}`}document.getElementById("export-filter")?.addEventListener("change",e=>{let t=e.target.value;t==="export-kml"?$s():t==="export-csv"?Ts():t==="export-xlsx"?Ns():t==="export-pdf"&&Ds(),e.target.value="export-file"});function $s(){let e=Dt();if(!e.length){B(u("no_positions"),{title:"KML"});return}let t=Mt("kml");lo(e,{filename:t,stopIconHref:new URL(So,window.location.origin).href,includeRoute:!0,nameStop:n=>`${re(n.last_updated)}`,describeStop:n=>{let o=Math.round((n?.attributes?.speed||0)*(M?2.23694:3.6)),r=u(M?"mi_per_hour":"km_per_hour"),s=Number.isFinite(n?.battery)?`${n.battery}%`:"";return`<table cellspacing="0" cellpadding="0" style="border-collapse:collapse">
        ${n.zone?`<tr><td>\u25CF ${n.zone}</td></tr>`:""}
        ${n.address?`<tr><td>\u25CF ${n.address}</td></tr>`:""}
        <tr><td>\u25CF ${o} ${r}</td></tr>
		${s?`<tr><td>\u25CF ${u("battery")}: ${s}</td></tr>`:""}
      </table>`},formatLocal:n=>re(n),unitLabel:u(M?"mi_per_hour":"km_per_hour"),batteryLabel:u("battery")})}function Ts(){let e=Dt();if(!e.length){B(u("no_positions"),{title:"CSV"});return}let t=Mt("csv");fo(e,{filename:t,useImperial:!!M,formatLocal:n=>re(n),delimiter:";",usePicker:!1})}async function Ns(){let e=Dt();if(!e.length){B(u("no_positions")||"No hay posiciones para exportar.",{title:"Excel"});return}let t=Mt("xlsx");await ho(e,{filename:t,useImperial:!!M,formatLocal:n=>re(n),sheetName:"Posiciones"})}async function Ds(){let e=Dt();if(!e.length){B(u("no_positions"),{title:"PDF"});return}let t=[{label:u("positions"),value:document.getElementById("positions-count")?.textContent||""},{label:u("total_time"),value:document.getElementById("total-time")?.textContent||""},{label:u("distance"),value:document.getElementById("distance")?.textContent||""},{label:u("max_speed"),value:document.getElementById("max-speed")?.textContent||""},{label:u("average_speed"),value:document.getElementById("average-speed")?.textContent||""},{label:u("stops_count"),value:document.getElementById("stops-count")?.textContent||""},{label:u("stopped_time"),value:document.getElementById("stopped-time")?.textContent||""}],n=[],o=J?.zonePositions||{};if(J){let{zoneDurations:h,zoneVisits:f,zoneStops:g,zoneDistanceMeters:b}=J,T=[...new Set([...Object.keys(h||{}),...Object.keys(b||{})])].sort((S,v)=>S.localeCompare(v)),x=M?"mi":"km";for(let S of T){let v=h?.[S]||0,E=f?.[S]||0,y=g?.[S]||0,k=b?.[S]||0,I=M?k/1609.344:k/1e3,D=`${K(I)} ${x}`;n.push({zone:S,time:cn(v),visits:E,stops:y,distance:D,_unitShort:x,_fillColor:rn(S,o,{alpha:U})})}}let r=yo(e),s=u(M?"mi_per_hour":"km_per_hour")||(M?"mph":"km/h"),a=r.map(h=>{let f=Math.round((h?.attributes?.speed||0)*(M?2.23694:3.6));return{whenLocal:re(h.last_updated),isStop:!!h.stop,zone:h.zone||"",speed:Number.isFinite(f)?`${f} ${s}`:"",battery:Number.isFinite(h?.battery)?h.battery:"",address:h.address||"",_fillColor:h.zone?rn(h.zone,o,{alpha:U}):null}}),i=document.getElementById("person-select"),d=i?.selectedOptions?.[0]?.text?.trim()||i?.value?.trim()||"\u2014",{startLocal:c,endLocal:m}=vt()||{};c&&(c=re(c)),m&&(m=re(m));let p={personName:d,startLocal:c,endLocal:m},l=Mt("pdf");await bo({filename:l,summaryRows:t,zonesRows:n,positionsRows:a,stopIconUrl:new URL("/local/ha-tracker/images/stop16x16.png",window.location.origin).href,header:p})}var $e=null;function Ms(){if($e)return $e;let e=document.querySelector("#positions .table-wrapper")||null;return $e=new IntersectionObserver(t=>{for(let n of t){if(!n.isIntersecting)continue;let o=n.target;$e.unobserve(o);let r=o.dataset.entityId,s=Number(o.dataset.latitude),a=Number(o.dataset.longitude),i=Number(o.dataset.lastUpdated);if(!(Number.isFinite(s)&&Number.isFinite(a)&&Number.isFinite(i)))continue;let d=o.querySelector("td.addr-cell")||o.querySelector("td");d&&d.textContent!=="\u2026"&&(d.textContent="\u2026"),nt(r,s,a,i,c=>{let m=document.querySelector(`tr.position-address-row[data-entity-id="${r}"] td.addr-cell`)||document.querySelector(`tr.position-address-row[data-entity-id="${r}"] td`);m&&(m.textContent=c||"")})}},{root:e,rootMargin:"200px"}),$e}var Nt=!1;function an(){let e=w.getZoom();Ct.forEach(t=>{if(!t.isStop){let n=w.hasLayer(t);e>=sn&&!n?t.addTo(w):e<sn&&n&&w.removeLayer(t)}})}async function se(e,{method:t="GET",headers:n={},body:o,timeoutMs:r=15e3}={},s=!0){let a=new AbortController,i=setTimeout(()=>a.abort("timeout"),r);try{let d;if(s){if(d=await hn(),!d||!d.trim())throw new Error("Invalid token.");n={...n,Authorization:`Bearer ${d}`}}let c={method:t,headers:n,signal:a.signal,cache:"no-store"};t!=="GET"&&o!==void 0&&(c.body=o,!(o instanceof FormData)&&!(o instanceof Blob)&&!(o instanceof ArrayBuffer)&&(c.headers={"Content-Type":"application/json",...n}));let m=await fetch(e,c),p=m.status,l=Number(m.headers.get("Retry-After")),h=(m.headers.get("content-type")||"").toLowerCase();if(p===202){if(h.includes("application/json"))try{return await m.json()??{error:"queued",retry_after:Number.isFinite(l)?l:1.5}}catch{return{error:"queued",retry_after:Number.isFinite(l)?l:1.5}}return{error:"queued",retry_after:Number.isFinite(l)?l:1.5}}if(p===204)return null;if(!m.ok){let g=await m.text().catch(()=>""),b=new Error(`Error HTTP: ${p} - ${g}`);throw b.status=p,Number.isFinite(l)&&(b.retry_after=l),b}if(h.includes("application/json"))return await m.json();let f=await m.text();return f||null}catch(d){throw console.error("Error in fetchData:",d),d}finally{clearTimeout(i)}}async function Un(e,t){if(!Number.isFinite(Number(e))||!Number.isFinite(Number(t)))throw new Error("latitude and longitude must be finite numbers.");let n=new URL(`${H}/api/ha_tracker/reverse_geocode`);n.searchParams.set("lat",String(e)),n.searchParams.set("lon",String(t)),n.searchParams.set("nowait","1"),n.searchParams.set("brief","1");try{return await se(n.toString(),{timeoutMs:15e3})}catch(o){throw console.error("Error getting reverse geocode:",o),o}}async function Io(){try{let e=`${H}/manifest.json`;return await se(e,{method:"GET"},!1)}catch(e){throw console.error("Error getting manifest:",e),e}}async function Po(){let e=`${H}/api/ha_tracker/config`;try{return await se(e)}catch(t){throw console.error("Error getting configuration:",t),t}}async function Ao(){let e=`${H}/api/ha_tracker/is_admin`;try{return(await se(e))?.is_admin??!1}catch(t){throw console.error("Error checking admin status:",t),t}}async function Jn(){let e=`${H}/api/ha_tracker/devices`;try{let t=await se(e);await Vn(t)}catch(t){throw console.error("Error getting Devices:",t),t}}async function Yn(){let e=`${H}/api/ha_tracker/persons`;try{let t=await se(e);await Gn(t)}catch(t){throw console.error("Error getting Persons:",t),t}}async function Le(){let e=`${H}/api/ha_tracker/zones`;try{let t=await se(e);await In(t)}catch(t){throw console.error("Error getting zones:",t),t}}async function Fn(e){if(!e)return console.error("Zone ID is required."),null;let t=JSON.stringify({id:e}),n=`${H}/api/ha_tracker/zones`;try{let o=await se(n,{method:"DELETE",body:t});return o&&o.success?(console.log(`Zone with ID ${e} deleted successfully.`),!0):(console.error(`Error deleting zone: ${o?.error||"Unknown error"}`),!1)}catch(o){return console.error("Error trying to delete zone:",o),!1}}async function jt(e,t,n,o,r,s=Z,a=!0){if(!e||!t||!n||!o||!r)return console.error("Parameters: zoneId, name, radius, latitude and longitude are mandatory."),null;let i=`${H}/api/ha_tracker/zones`,d=JSON.stringify({id:e,name:t,radius:n,latitude:o,longitude:r,color:s,visible:a});try{let c=await se(i,{method:"PUT",body:d});return c&&c.success?(console.log(`Zone with ID ${e} updated successfully.`),c):(console.error(`Error updating zone: ${c?.error||"Unknown error"}`),null)}catch(c){return console.error("Error trying to update the zone:",c),null}}async function Bn(e,t,n,o,r="mdi:map-marker",s=!1,a=!0,i=Z){if(!e||!t||!n||!o)return console.error("All parameters (name, radius, latitude, longitude) are mandatory."),null;let d=`${H}/api/ha_tracker/zones`,c=JSON.stringify({name:e,radius:t,latitude:n,longitude:o,icon:r,passive:s,custom:a,color:i});try{let m=await se(d,{method:"POST",body:c});return m&&m.success?(console.log(`Zone created successfully. ID: ${m.id}`),m.id):(console.error(`Error creating zone: ${m?.error||"Unknown error"}`),null)}catch(m){return console.error("Error trying to create zone:",m),null}}async function Mo(e,t,n){if(!e||!t||!n){console.error("The person_id, startDate and endDate parameters are required.");return}let o=`${H}/api/ha_tracker/filtered_positions?person_id=${encodeURIComponent(e)}&start_date=${encodeURIComponent(t)}&end_date=${encodeURIComponent(n)}`;try{let r=await se(o);await Co(r)}catch(r){throw console.error("Error getting filtered positions:",r),r}}async function gn(e){if(!e){console.error("No authorization code found in the URL.");return}try{let t=`${H}/auth/token`,n=new URLSearchParams({grant_type:"authorization_code",code:e,client_id:`${H}/`}),o=await se(t,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n},!1);if(!o){console.error("Error getting token");return}console.log("************ Token Obtained ************",o);let r={...o,hassUrl:H,clientId:`${H}/`,expires:Date.now()+o.expires_in*1e3};try{localStorage.setItem("hassTokens",JSON.stringify(r))}catch(a){console.error("Error saving token to localStorage:",a);return}let s=`${H}/local/ha-tracker/index.html`;window.history.replaceState({},document.title,s)}catch(t){console.error("Error while obtaining token",t)}}async function yn(e){try{if(!H||!e)return console.error(`The base URL or refresh_token is not defined correctly.	haUrl: ${H}	refreshToken: ${e}`),null;let t=`${H}/auth/token`,n=new URLSearchParams({grant_type:"refresh_token",refresh_token:e,client_id:`${H}/`}),o=await se(t,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n},!1);if(!o){console.error("Error renewing token");return}return console.log("************ Renewed Token ************",o),o}catch(t){return console.error("Error en la solicitud de renovaci\xF3n del token:",t),null}}var H=location.origin,_t=!1,Z="#008000",U=.25,K=Oo({max:0}),ln=Oo({min:2,max:2}),Oe=!1;var lt="",dn=10,Yt=30,Xt=20;var zo=!1,M=!1,Fe={log:console.log,debug:console.debug,info:console.info,warn:console.warn,error:console.error};async function Fo(){try{Oe=await Ao()}catch(e){throw console.error("Error checking admin set:",e),e}}async function Bo(){try{let e=await Po();e&&(lt=e.version,typeof e.update_interval=="number"&&e.update_interval>=10&&(dn=e.update_interval),typeof e.geocode_time=="number"&&e.geocode_time>=10&&(Yt=e.geocode_time),typeof e.geocode_distance=="number"&&e.geocode_distance>=20&&(Xt=e.geocode_distance),typeof e.enable_debug=="boolean"&&(zo=e.enable_debug),typeof e.use_imperial=="boolean"&&(M=e.use_imperial)),await Is(),console.log("Configuration: ",e)}catch(e){throw console.error("Error checking admin set: ",e),e}}async function Ro(){try{return await Io(),!0}catch{return console.warn("HA is Inactive"),!1}}async function Is(){if(!zo)console.log=()=>{},console.debug=()=>{},console.info=()=>{},console.warn=(...e)=>Fe.warn("[WARNING]:",...e),console.error=(...e)=>Fe.error("[ERROR]:",...e);else{let e=()=>{let t=new Date,n=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0"),r=String(t.getSeconds()).padStart(2,"0"),s=String(t.getMilliseconds()).padStart(3,"0");return`[${n}:${o}:${r}:${s}]`};console.log=(...t)=>Fe.log(e(),...t),console.debug=(...t)=>Fe.debug(e(),...t),console.info=(...t)=>Fe.info(e(),...t),console.warn=(...t)=>Fe.warn(e(),"[WARNING]:",...t),console.error=(...t)=>Fe.error(e(),"[ERROR]:",...t)}}function re(e){let t=new Date(e),n={weekday:"short",day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1};return t.toLocaleString(zt||"en",n)}function Oo({locale:e,min:t=0,max:n=0,grouping:o=!0}={}){let r=e??(typeof navigator<"u"&&(navigator.languages?.[0]||navigator.language)||"en-GB"),s=new Intl.NumberFormat(r,{style:"decimal",minimumFractionDigits:t,maximumFractionDigits:n,useGrouping:o});return a=>s.format(Number(a)||0)}var jo=()=>requestAnimationFrame(()=>w?.invalidateSize(!0));async function Zo(){try{un(document.getElementById("combo-select"));let e=document.getElementById("person-select");e&&(e.dataset.defaultIcon="users",un(e));let t=document.getElementById("export-filter");t&&(t.dataset.defaultIcon="export",un(t));let n=document.getElementById("forms-container");window.innerWidth<=600?(n.classList.add("hidden"),n.classList.remove("visible")):(n.classList.add("visible"),n.classList.remove("hidden")),As(),document.body.classList.contains("loaded")||document.body.classList.add("loaded")}catch(e){console.error("Error during load:",e)}}window.addEventListener("resize",()=>{document.querySelectorAll(".table-container").forEach(It)});async function qo(){let e=document.getElementById("visits-col-css");e||(e=document.createElement("style"),e.id="visits-col-css",document.head.appendChild(e)),e.textContent=_t?"":`
        #summary-zones-table thead th[data-i18n="visits"] { display: none !important; }
        #summary-zones-table-body tr > td:nth-child(3) { display: none !important; }
    `;let t=M?u("mi_per_hour"):u("km_per_hour"),n=M?u("miles"):u("kilometres"),o=M?u("feet"):u("meters");document.querySelectorAll('#positions-table thead th[data-i18n="speed"], #positions thead th[data-i18n="speed"]').forEach(r=>{let s=r.querySelector(".hdr-label");s?s.textContent=t:r.textContent=t}),document.querySelectorAll('#summary-zones-table thead th[data-i18n="distance"]').forEach(r=>{let s=r.querySelector(".hdr-label");s?s.textContent=n:r.textContent=n}),document.querySelectorAll('#zones-table thead th[data-i18n="radius"] .hdr-label').forEach(r=>{r.textContent=`${o}`}),document.querySelectorAll('#persons-table thead th[data-i18n="speed"] .hdr-label').forEach(r=>{r.textContent=`${t}`})}window.addEventListener("message",e=>{if(e.data?.type==="ping")try{e.source?.postMessage({type:"pong",id:e.data.id},e.origin||"*")}catch{}});document.getElementById("hamburger-button").addEventListener("click",async()=>{try{await Ps(),jo()}catch(e){console.error("Error handling menu button:",e)}});document.getElementById("combo-select").addEventListener("change",function(){try{let e=this.value,t=document.getElementById("filter-container"),n=document.getElementById("zones-container"),o=document.getElementById("persons-container");if(e==="filter")t.style.display="block",n.style.display="none",o.style.display="none";else if(e==="zones"){t.style.display="none",n.style.display="block",o.style.display="none";let r=document.getElementById("zones-table-body");r&&r.querySelectorAll("tr.selected").forEach(s=>s.classList.remove("selected")),De()}else if(e==="users"){t.style.display="none",n.style.display="none",o.style.display="block";let r=document.getElementById("persons-table-body");r&&r.querySelectorAll("tr.selected").forEach(s=>s.classList.remove("selected")),typeof updatePersonsTable=="function"&&updatePersonsTable()}typeof w<"u"&&w&&typeof w.closePopup=="function"&&w.closePopup(),jo()}catch(e){console.error("Error during combo-select:",e)}});async function Ps(){try{let e=document.getElementById("forms-container");e.classList.contains("hidden")?(e.classList.remove("hidden"),e.classList.add("visible")):(e.classList.add("hidden"),e.classList.remove("visible"))}catch(e){console.error("Error during toggleContainer:",e)}}async function It(e){try{let t=window.innerHeight,n=e.getBoundingClientRect().top,o=Math.max(t-n-20,150);Math.abs(e.clientHeight-o)>2&&requestAnimationFrame(()=>{e.style.height=`${o}px`})}catch(t){console.error("Error adjusting table height:",t)}}async function As(){try{let e=document.querySelectorAll(".table-container"),t=document.getElementById("forms-container"),n=new ResizeObserver(s=>{requestAnimationFrame(()=>{s.forEach(a=>It(a.target))})}),o=new IntersectionObserver(s=>{requestAnimationFrame(()=>{s.forEach(a=>{a.isIntersecting&&It(a.target)})})}),r=new MutationObserver(()=>{requestAnimationFrame(()=>{document.querySelectorAll(".table-container").forEach(It)})});e.forEach(s=>{o.observe(s),n.observe(s)}),t&&r.observe(t,{childList:!0,subtree:!0})}catch(e){console.error("Error in observeTableContainers:",e)}}var Ho={users:'<path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5z"/>',zones:'<path d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7zm0 9.5A2.5 2.5 0 1 1 14.5 9 2.5 2.5 0 0 1 12 11.5z"/>',filter:'<path d="M3 4h18l-7 8v6l-4 2v-8z"/>',export:'<path d="M12 3v10"/><path d="M8 7l4-4 4 4"/><path d="M4 21h16v-2a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v2z"/>',dot:'<circle cx="12" cy="12" r="5"/>'},Uo=e=>`<svg class="id-icon" viewBox="0 0 24 24" aria-hidden="true">${Ho[e]||Ho.dot}</svg>`;function un(e){if(!e||e.dataset.enhanced==="1")return;let t=document.createElement("div");t.className="id-wrap";let n=document.createElement("button");n.type="button",n.className="id-toggle",n.setAttribute("aria-haspopup","listbox"),n.setAttribute("aria-expanded","false"),n.setAttribute("aria-controls",e.id+"-menu");let o=document.createElement("div");o.className="id-menu",o.id=e.id+"-menu",o.setAttribute("role","listbox"),o.setAttribute("aria-hidden","true"),o.hidden=!0,e.classList.add("id-visually-hidden"),e.parentNode.insertBefore(t,e.nextSibling),t.appendChild(n),t.appendChild(o);function r(){return e.selectedOptions[0]||e.options[0]}function s(f){return f?.dataset.icon||e.dataset.defaultIcon||f?.value||"dot"}function a(){let f=r(),g=s(f);n.innerHTML=`${Uo(g)}<span class="id-text">${f?.text||""}</span><span class="id-caret" aria-hidden="true">\u25BE</span>`}function i(){o.innerHTML="",Array.from(e.options).forEach((f,g)=>{let b=document.createElement("button");b.type="button",b.className="id-option",b.setAttribute("role","option"),b.dataset.value=f.value,b.setAttribute("aria-selected",String(f.selected)),b.innerHTML=`${Uo(s(f))}<span>${f.text}</span>`,f.disabled&&(b.disabled=!0,b.style.opacity=.5,b.style.cursor="not-allowed"),b.addEventListener("click",()=>{f.disabled||(e.value=f.value,e.dispatchEvent(new Event("change",{bubbles:!0})),c(),n.focus())}),o.appendChild(b),b.tabIndex=f.selected||!e.value&&g===0?0:-1})}function d(){i(),o.hidden=!1,o.setAttribute("aria-hidden","false"),n.setAttribute("aria-expanded","true"),(o.querySelector('.id-option[aria-selected="true"]')||o.querySelector(".id-option"))?.focus(),document.addEventListener("click",p),document.addEventListener("keydown",l)}function c(){o.hidden=!0,o.setAttribute("aria-hidden","true"),n.setAttribute("aria-expanded","false"),document.removeEventListener("click",p),document.removeEventListener("keydown",l)}function m(){o.hidden?d():c()}function p(f){t.contains(f.target)||c()}function l(f){let g=Array.from(o.querySelectorAll(".id-option:not([disabled])")),b=g.indexOf(document.activeElement);f.key==="Escape"?(f.preventDefault(),c(),n.focus()):f.key==="ArrowDown"?(f.preventDefault(),(g[b+1]||g[0])?.focus()):f.key==="ArrowUp"?(f.preventDefault(),(g[b-1]||g.at(-1))?.focus()):f.key==="Home"?(f.preventDefault(),g[0]?.focus()):f.key==="End"?(f.preventDefault(),g.at(-1)?.focus()):(f.key==="Enter"||f.key===" ")&&document.activeElement?.classList.contains("id-option")&&(f.preventDefault(),document.activeElement.click())}e.addEventListener("change",()=>{a(),o.querySelectorAll(".id-option").forEach(f=>{f.setAttribute("aria-selected",String(f.dataset.value===e.value))})}),n.addEventListener("click",m),n.addEventListener("keydown",f=>{(f.key==="ArrowDown"||f.key==="Enter"||f.key===" ")&&(f.preventDefault(),d())}),new MutationObserver(()=>{a(),o.hidden||i()}).observe(e,{childList:!0,subtree:!0,characterData:!0}),a(),e.dataset.enhanced="1"}document.addEventListener("DOMContentLoaded",async()=>{try{await pn(),await zs()}catch(e){console.error("Error during DOMContentLoaded:",e)}});async function zs(){try{await En(),await ko(),await Dn(),await Sn(),await Wo(),await Kn(),await Zo(),Fs()}catch(e){console.error("Error during init:",e)}}function Fs(){let e=performance.now();async function t(n){let o=(dn??10)*1e3;if(n-e>=o){e=n;try{await Wo()}catch(r){console.error("update() failed:",r)}}requestAnimationFrame(t)}requestAnimationFrame(t)}async function Wo(){try{await Ro()?(await Bo(),await Bs(),await Fo(),await Wn(),await Mn(),await qo(),ft()):mt(u("disconnected"),"rgba(255, 0, 0, 0.5)","white","rgba(200, 0, 0, 0.8)")}catch(e){console.error("Error during major update:",e)}}async function Bs(){try{if(!(window.self!==window.top)&&lt){let t=new URL(window.location.href);if(t.searchParams.get("v")!==lt){t.searchParams.set("v",lt);let o=t.toString();o!==window.location.href&&window.location.replace(o)}}}catch(e){console.error("Error during updateVersion:",e)}}
