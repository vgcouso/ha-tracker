var it=null;async function dn(){try{let e=new URLSearchParams(window.location.search);if(e.has("code")){let t=e.get("code");await mn(t)}}catch(e){throw console.error("Error during authentication:",e),e}}async function un(){return it||(it=(async()=>{if(window!==window.parent){let{token:t,exp:n}=await qo();if(!t||!t.trim())throw new Error("Empty token from parent");return t}else{await Wo();let t=localStorage.getItem("hassTokens"),n=t?JSON.parse(t):null;if(!n?.access_token)throw new Error("No access_token in hassTokens");let o=typeof n.expires=="number"?n.expires:0,r=Date.now();if(o&&r>=o)throw new Error("Token has expired");return n.access_token}})().finally(()=>{it=null})),it}function qo(e=7e3){return new Promise((t,n)=>{let o=Math.random().toString(36).slice(2),r=window.parent,s="";try{s=new URL(document.referrer).origin}catch{}s||(s=window.location.origin);let a=setTimeout(()=>{window.removeEventListener("message",i),n(new Error("Token not returned"))},e);function i(c){if(c.source!==r||c.origin!==s&&c.origin!==window.location.origin)return;let d=c.data||{};if(d.type==="auth-token"&&d.reqId===o&&d.token){clearTimeout(a),window.removeEventListener("message",i);let p=typeof d.exp=="number"&&isFinite(d.exp)?d.exp:0;t({token:d.token,exp:p})}}window.addEventListener("message",i),window.parent.postMessage({type:"request-token",reqId:o},s||"*")})}async function Wo(){let e=localStorage.getItem("hassTokens");try{if(e){let o=JSON.parse(e),r=Number(o.expires||0);if(r&&Date.now()<r-900*1e3||(console.log("The token has expired. Trying to renew it..."),await Vo(o.refresh_token)))return}console.log("No valid token found. Redirecting to authorize...");let t=`${B}/local/ha-tracker/index.html`,n=`${B}/auth/authorize?client_id=${encodeURIComponent(`${B}/`)}&redirect_uri=${encodeURIComponent(t)}`;window.location.href=n}catch(t){console.error("Error during authenticate:",t)}}async function Vo(e){try{let t=await fn(e);if(!t)return console.error("Failed to renew token."),!1;let n=localStorage.getItem("hassTokens");if(!n)return console.error("No existing token found in local storage."),!1;let o=JSON.parse(n);return t.refresh_token=o.refresh_token,t.hassUrl=o.hassUrl,t.clientId=o.clientId,t.ha_auth_provider=o.ha_auth_provider,t.expires=Date.now()+t.expires_in*1e3,localStorage.setItem("hassTokens",JSON.stringify(t)),console.log("Token renewed and stored:",t),!0}catch(t){return console.error("Error processing renewed token:",t),!1}}var V=typeof window<"u"?window:globalThis;V.__assetLoader??(V.__assetLoader={js:new Map,css:new Map});function pn(e){return new Promise((t,n)=>{if(e.dataset.loaded==="true"||e.readyState==="complete")return t();e.addEventListener("load",()=>t(),{once:!0}),e.addEventListener("error",()=>n(new Error("Resource failed: "+(e.src||e.href))),{once:!0})})}function Oe(e,{attrs:t={},matchPrefix:n=!0}={}){let o=e;if(V.__assetLoader.css.has(o))return V.__assetLoader.css.get(o);let r=n?`link[rel="stylesheet"][href^="${e}"]`:`link[rel="stylesheet"][href="${e}"]`,s=document.querySelector(r);if(s){let i=pn(s);return V.__assetLoader.css.set(o,i),i.finally(()=>V.__assetLoader.css.delete(o))}let a=new Promise((i,c)=>{let d=document.createElement("link");d.rel="stylesheet",d.href=e;for(let[p,m]of Object.entries(t))d.setAttribute(p,m);d.onload=()=>{d.dataset.loaded="true",i()},d.onerror=()=>c(new Error("CSS not loaded: "+e)),document.head.appendChild(d)});return V.__assetLoader.css.set(o,a),a.finally(()=>V.__assetLoader.css.delete(o))}function _e(e,{attrs:t={},matchPrefix:n=!0,test:o=null}={}){try{if(typeof o=="function"&&o())return Promise.resolve()}catch{}let r=e;if(V.__assetLoader.js.has(r))return V.__assetLoader.js.get(r);let s=n?`script[src^="${e}"]`:`script[src="${e}"]`,a=document.querySelector(s);if(a){let c=pn(a).then(()=>{if(typeof o=="function"&&!o())throw new Error("Script present but test() failed: "+e)});return V.__assetLoader.js.set(r,c),c.finally(()=>V.__assetLoader.js.delete(r))}let i=new Promise((c,d)=>{let p=document.createElement("script");p.src=e,p.async=!0;for(let[m,u]of Object.entries(t))p.setAttribute(m,u);p.onload=()=>{p.dataset.loaded="true";try{typeof o=="function"&&!o()?d(new Error("Script loaded but test() failed: "+e)):c()}catch(m){d(m)}},p.onerror=()=>d(new Error("Script not loaded: "+e)),document.head.appendChild(p)});return V.__assetLoader.js.set(r,i),i.finally(()=>V.__assetLoader.js.delete(r))}var At="en",hn={};async function gn(e){try{let t=await fetch(`locales/${e}.json`);if(!t.ok)throw new Error(`Translation not found for ${e}`);hn=await t.json(),At=e,Go()}catch(t){if(console.error(`Error loading translations for ${e}.`,t),e==="en"){console.error("The English translation file could not be loaded. No changes will be made to the texts.");return}else console.error("Trying to load english as fallback."),await gn("en")}}function l(e){return hn[e]||e}function yn(e,t={}){let n=l(e);for(let[o,r]of Object.entries(t))n=n.replace(`{${o}}`,r);return n}function Go(){document.querySelectorAll("[data-i18n]").forEach(e=>{let t=e.getAttribute("data-i18n");e.textContent=l(t)}),document.querySelectorAll("[data-i18n-placeholder]").forEach(e=>{let t=e.getAttribute("data-i18n-placeholder"),n=l(t);n&&n!==t&&(e.placeholder=n)})}async function bn(){let e=navigator.language.slice(0,2);document.documentElement.setAttribute("lang",e),await gn(e)}var w,Ke={leafletCSS:"https://unpkg.com/leaflet@1.9.4/dist/leaflet.css",leafletJS:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js",geocoderCSS:"https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css",geocoderJS:"https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js",editableJS:"https://cdnjs.cloudflare.com/ajax/libs/leaflet-editable/1.3.0/Leaflet.Editable.min.js"};async function Ko(){await Oe(Ke.leafletCSS),await Oe(Ke.geocoderCSS),await _e(Ke.leafletJS,{test:()=>!!window.L}),await _e(Ke.editableJS,{test:()=>!!(window.L&&L.Editable)}),await _e(Ke.geocoderJS,{test:()=>!!(window.L&&L.Control&&L.Control.Geocoder)})}async function wn(){try{let m=function(){let u=w.getBounds();p.options.geocoder.options.geocodingQueryParams.viewbox=[u.getWest(),u.getSouth(),u.getEast(),u.getNorth()].join(","),p.options.geocoder.options.geocodingQueryParams.bounded=1};await Ko();let e={center:[40.4168,-3.7038],zoom:6,editable:!0,preferCanvas:!0};w=L.map("map",e);let t={maxZoom:19,minZoom:1,crossOrigin:!0},n={OpenStreetMap:L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{...t,attribution:"\xA9 OpenStreetMap contributors"}),"Esri Sat\xE9lite":L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{...t,attribution:"\xA9 Esri, Maxar, Earthstar Geographics"})};n.OpenStreetMap.addTo(w),L.control.layers(n,null,{position:"topleft"}).addTo(w);let r=L.control.scale({position:"bottomleft"}).addTo(w),s=document.querySelector(".leaflet-control-layers"),a=document.querySelector(".leaflet-control-zoom");if(s&&a){let u=a.getBoundingClientRect();s.style.position="absolute",s.style.left=`${u.right}px`}let i=()=>w&&w.invalidateSize(!0);document.body.addEventListener("transitionend",u=>{u.target===document.body&&u.propertyName==="opacity"&&setTimeout(i,0)},{once:!0});let c=document.getElementById("map");c&&"ResizeObserver"in window&&new ResizeObserver(()=>i()).observe(c),window.addEventListener("resize",i),document.addEventListener("visibilitychange",()=>{document.hidden||setTimeout(i,0)}),setTimeout(i,350);let d=navigator.languages&&navigator.languages.length?navigator.languages.join(","):navigator.language||"en",p=L.Control.geocoder({position:"bottomleft",placeholder:l("search_place"),collapsed:!1,defaultMarkGeocode:!1,geocoder:L.Control.Geocoder.nominatim({geocodingQueryParams:{"accept-language":d,limit:5}})}).on("markgeocode",u=>{let{center:h,name:f,bbox:y}=u.geocode;y?w.fitBounds(y):w.setView(h,16),L.popup({autoClose:!0,closeOnClick:!0,keepInView:!0}).setLatLng(h).setContent(f).openOn(w)}).addTo(w);w.on("moveend",m),m(),setTimeout(()=>w.invalidateSize(!0),0)}catch(e){console.error("Error starting map:",e)}}function Pt(e,t){return e!=null&&t!=null&&!isNaN(e)&&!isNaN(t)}function lt(e,t,n,o){let s=ct(n-e),a=ct(o-t),i=Math.sin(s/2)*Math.sin(s/2)+Math.cos(ct(e))*Math.cos(ct(n))*Math.sin(a/2)*Math.sin(a/2);return 6371e3*(2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)))}function ct(e){return e*(Math.PI/180)}var Jo=["#008000","#09CB09","#946F24","#333333","#999999","#BBB31A","#ECAA77","#981052","#D265E4","#854CD7","#2196F3","#28A289","#0000FF","#42DFD3"],Le=null,G=null,ne=null,vn=!1;function Yo(){if(vn)return;let e=document.createElement("style");e.id="window-overlay-styles",e.textContent=`
    #window-overlay{
      position: fixed; inset: 0; display: none;
      align-items: center; justify-content: center;
      background: rgba(0,0,0,.35);
      z-index: 2147483647;
    }
    #window-message{
      padding: 14px 18px;
      border-radius: 12px;
      border: 2px solid transparent;
      font: 600 15px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      box-shadow: 0 8px 30px rgba(0,0,0,.2);
      user-select: none;
    }`,document.head.appendChild(e),vn=!0}function Xo(){G&&ne||(Yo(),G=document.getElementById("window-overlay"),ne=document.getElementById("window-message"),G||(G=document.createElement("div"),G.id="window-overlay",document.body.appendChild(G)),ne||(ne=document.createElement("div"),ne.id="window-message",ne.dataset.i18n="loading",ne.textContent="Loading",G.appendChild(ne)))}function dt(e="Mensaje",t="rgba(0, 0, 255, 0.5)",n="white",o="rgba(0, 0, 200, 0.8)",r="rgba(0,0,0,.35)"){Xo(),G.style.display!=="flex"&&(G.style.background=r,ne.textContent=e,ne.style.backgroundColor=t,ne.style.color=n,ne.style.border=`2px solid ${o}`,G.style.display="flex")}function ut(){G&&(G.style.display==="none"||G.style.display===""||(G.style.display="none"))}function _n(e,t={}){return Le?Promise.resolve(!1):(Le="confirm",new Promise(n=>{let o=zt({title:t.title??l("confirmation"),message:e,type:t.type??"info",okLabel:t.okLabel??l("accept"),cancelLabel:t.cancelLabel??l("cancel")});Ot(o,{withInput:!1,resolve:n}),o.focusDefault()}))}function Ft(e,t="",n={}){return Le?Promise.resolve(null):(Le="prompt",new Promise(o=>{let r=zt({title:n.title??l("enter_value"),message:e,type:n.type??"info",withInput:!0,inputValue:t,placeholder:n.placeholder??"",withColor:n.withColor===!0,colorValue:n.defaultColor??U,colorLabel:n.colorLabel,okLabel:n.okLabel??l("save"),cancelLabel:n.cancelLabel??l("cancel"),colorOptions:n.colorOptions});Ot(r,{withInput:!0,withColor:n.withColor===!0,resolve:o}),r.focusDefault()}))}function F(e,t={}){return Le?Promise.resolve():(Le="alert",new Promise(n=>{let o=zt({title:t.title??l("information"),message:e,type:t.type??"info",okLabel:t.okLabel??l("accept"),cancelLabel:l("close")});(t.hideCancel??!0)&&o.modal.querySelector(".btn-secondary")?.remove(),Ot(o,{withInput:!1,resolve:n}),o.focusDefault()}))}function he(e,t=DEFAULT_ALPHA){let n=String(e||"").trim().toLowerCase(),o=/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i.exec(n),r=/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i.exec(n),s=/^#([0-9a-f]{8})$/i.exec(n),a,i,c;if(o)a=parseInt(o[1]+o[1],16),i=parseInt(o[2]+o[2],16),c=parseInt(o[3]+o[3],16);else if(r)a=parseInt(r[1],16),i=parseInt(r[2],16),c=parseInt(r[3],16);else if(s)a=parseInt(s[1].slice(0,2),16),i=parseInt(s[1].slice(2,4),16),c=parseInt(s[1].slice(4,6),16);else return null;let d=Math.min(1,Math.max(0,Number(t)||0));return`rgba(${a},${i},${c},${d})`}function Qo(e){let t=String(e||"").trim().toLowerCase(),n=/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i.exec(t),o=/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i.exec(t),r=/^#([0-9a-f]{8})$/i.exec(t),s,a,i;if(n)s=parseInt(n[1]+n[1],16),a=parseInt(n[2]+n[2],16),i=parseInt(n[3]+n[3],16);else if(o)s=parseInt(o[1],16),a=parseInt(o[2],16),i=parseInt(o[3],16);else if(r)s=parseInt(r[1].slice(0,2),16),a=parseInt(r[1].slice(2,4),16),i=parseInt(r[1].slice(4,6),16);else return null;return{r:s,g:a,b:i}}function er(){let e=document.getElementById("ui-modal-root");e||(e=document.createElement("div"),e.id="ui-modal-root",document.body.appendChild(e));let t=document.getElementById("ui-toast-root");return t||(t=document.createElement("div"),t.id="ui-toast-root",document.body.appendChild(t)),{modalRoot:e,toastRoot:t}}function tr(e){let t=["a[href]","button:not([disabled])","textarea:not([disabled])","input:not([disabled])","select:not([disabled])",'[tabindex]:not([tabindex="-1"])'],n=e.querySelectorAll(t.join(",")),o=n[0],r=n[n.length-1];function s(a){a.key==="Tab"&&n.length&&(a.shiftKey&&document.activeElement===o?(a.preventDefault(),r.focus()):!a.shiftKey&&document.activeElement===r&&(a.preventDefault(),o.focus()))}return e.addEventListener("keydown",s),()=>e.removeEventListener("keydown",s)}function zt({title:e,message:t,type:n="info",withInput:o=!1,inputValue:r="",placeholder:s="",withColor:a=!1,colorValue:i=U,colorLabel:c,okLabel:d,cancelLabel:p,colorOptions:m={}}){let{modalRoot:u}=er(),h=document.createElement("div");h.className="modal-overlay",h.setAttribute("role","dialog"),h.setAttribute("aria-modal","true");let f=document.createElement("div");f.className=`modal modal-${n}`;let y=document.createElement("div");y.className="modal-header",y.innerHTML=`<span class="modal-title">${e||""}</span>`;let g=document.createElement("button");g.className="modal-close",g.setAttribute("aria-label",l("close")),g.textContent="\xD7",y.appendChild(g);let S=document.createElement("div");S.className="modal-body";let k=document.createElement("div");k.className="modal-message",k.textContent=t||"",S.appendChild(k);let E=null;o&&(E=document.createElement("input"),E.className="modal-input",E.type="text",E.value=r??"",s&&(E.placeholder=s),S.appendChild(E));let x=null;if(a){let D=document.createElement("div");D.className="modal-message",D.textContent=c??(l?l("select_color"):"Seleccione un color"),S.appendChild(D);let{palette:I=[],allowAlpha:R=!1,showNative:H=!1}=m||{},P=nr({initial:i||U,palette:I,allowAlpha:R,showNative:H});x=P.hiddenInput,S.appendChild(P.root)}let v=document.createElement("div");v.className="modal-actions";let N=document.createElement("button");N.className="btn btn-secondary",N.textContent=p??l("cancel");let b=document.createElement("button");b.className="btn "+(n==="danger"?"btn-danger":"btn-primary"),b.textContent=d??l("accept"),v.append(N,b),f.append(y,S,v),h.appendChild(f),u.appendChild(h);let _=tr(f),A=()=>{_(),h.remove(),document.body.classList.remove("no-scroll"),Le=null};return document.body.classList.add("no-scroll"),{overlay:h,modal:f,ok:b,cancel:N,closeBtn:g,inputEl:E,colorEl:x,focusDefault:()=>o?E?.focus():b.focus(),destroy:A}}function Ot(e,{withInput:t,withColor:n=!1,resolve:o,reject:r}){let{overlay:s,modal:a,ok:i,cancel:c,closeBtn:d,inputEl:p,colorEl:m,destroy:u}=e,h=S=>{if(Le){if(S.key==="Escape"){S.preventDefault(),g();return}if(S.key==="Enter"){let k=(document.activeElement?.tagName||"").toLowerCase();k==="input"||k==="textarea"||document.activeElement?.isContentEditable||y()}}};function f(){a.removeEventListener("keydown",h)}function y(){let S=t?p?.value??"":!0,k=n?m?.value??"":void 0;f(),u(),o(n?t?{value:S,color:k}:{color:k}:S)}function g(){f(),u(),o(t?null:!1)}i.addEventListener("click",y),c.addEventListener("click",g),d.addEventListener("click",g),s.addEventListener("click",S=>{S.target===s&&g()}),a.addEventListener("keydown",h)}function nr({initial:e=U,palette:t=[],allowAlpha:n=!1,showNative:o=!1}={}){let r=document.createElement("div");r.className="modal-color";let s=document.createElement("div");s.className="cp";let a=document.createElement("div");a.className="cp-left";let i=document.createElement("div");i.className="cp-right";let c=document.createElement("div");c.className="cp-sv",c.tabIndex=0;let d=document.createElement("div");d.className="cp-cursor",c.appendChild(d);let p=document.createElement("div");p.className="cp-hue",p.tabIndex=0;let m=document.createElement("div");m.className="cp-cursor h",p.appendChild(m);let u=document.createElement("div");u.className="cp-alpha",u.tabIndex=0;let h=document.createElement("div");h.className="cp-cursor h",u.appendChild(h),n||(u.style.display="none"),a.appendChild(c);let f=document.createElement("div");f.style.display="flex",f.style.flexDirection="column",f.style.gap="12px",f.appendChild(p),f.appendChild(u),a.appendChild(f);let y=document.createElement("div");y.className="cp-fields";let g=document.createElement("div");g.className="cp-preview";let S=document.createElement("span");g.appendChild(S);let k=document.createElement("div");k.className="cp-row";let E=document.createElement("label");E.textContent="HEX";let x=document.createElement("input");x.type="text",x.placeholder="#RRGGBB",x.autocomplete="off",k.append(E,x);let v=document.createElement("div");v.className="cp-row";let N=document.createElement("label");N.textContent="Alpha";let b=document.createElement("input");b.type="text",b.placeholder="0\u20131",b.value="1",v.append(N,b),n||(v.style.display="none");let _=document.createElement("div");_.className="cp-palette",(t.length?t:Jo).forEach($=>{let C=document.createElement("button");C.type="button",C.className="cp-swatch",C.title=$,C.style.background=$,C.addEventListener("click",()=>de($)),_.appendChild(C)});let D=document.createElement("div");if(D.className="cp-native",o){let $=document.createElement("details"),C=document.createElement("summary");C.textContent="Selector del sistema";let O=document.createElement("input");O.type="color",O.addEventListener("input",()=>de(O.value)),$.append(C,O),D.appendChild($)}y.append(g,k,v,_,D),i.appendChild(y),s.append(a,i),r.appendChild(s);let I=document.createElement("input");I.type="text",I.className="modal-input-color",I.style.display="none",r.appendChild(I);let R=120,H=1,P=.5,M=1,W=!1;x.addEventListener("focus",()=>{W=!0}),x.addEventListener("blur",()=>{W=!1,z()}),x.addEventListener("keydown",$=>{$.key==="Enter"&&$.preventDefault(),$.stopPropagation()});function le(){c.style.background=`hsl(${R}, 100%, 50%)`}function j(){let{r:$,g:C,b:O}=En(R,H,P);u.style.background=`conic-gradient(#ccc 25%, #fff 0 50%, #ccc 0 75%, #fff 0) 0 0/12px 12px,
       linear-gradient(to bottom, rgba(${$},${C},${O},0), rgba(${$},${C},${O},1))`}function z(){d.style.left=`${H*100}%`,d.style.top=`${(1-P)*100}%`,m.style.top=`${R/360*100}%`,h.style.top=`${(1-M)*100}%`;let{r:$,g:C,b:O}=En(R,H,P),X=or({r:$,g:C,b:O});S.style.background=`rgba(${$},${C},${O},${M})`,W||(x.value=X),I.value=n?`rgba(${$}, ${C}, ${O}, ${M})`:X,le(),j()}function de($){let C=Sn($);if(!C)return;let O=xn(C.r,C.g,C.b);R=O.h,H=O.s,P=O.v,C.a!==void 0&&(M=Y(+C.a,0,1)),z()}function Y($,C,O){return Math.min(O,Math.max(C,$))}function Ve($,C){let O=ue=>{let Me=$.getBoundingClientRect(),De=Y(((ue.touches?ue.touches[0].clientX:ue.clientX)-Me.left)/Me.width,0,1),Ge=Y(((ue.touches?ue.touches[0].clientY:ue.clientY)-Me.top)/Me.height,0,1);C(De,Ge)},X=()=>{window.removeEventListener("mousemove",O),window.removeEventListener("touchmove",O),window.removeEventListener("mouseup",X),window.removeEventListener("touchend",X)},Se=ue=>{ue.preventDefault(),O(ue),window.addEventListener("mousemove",O),window.addEventListener("touchmove",O,{passive:!1}),window.addEventListener("mouseup",X,{once:!0}),window.addEventListener("touchend",X,{once:!0})};$.addEventListener("mousedown",Se),$.addEventListener("touchstart",Se,{passive:!1})}Ve(c,($,C)=>{H=$,P=1-C,z()}),Ve(p,($,C)=>{R=Y(C,0,1)*360,z()}),Ve(u,($,C)=>{M=1-C,z()});function Nt($,C){$.addEventListener("keydown",O=>{let X=O.key.toLowerCase(),Se=.02;X==="arrowup"&&C(0,-Se),X==="arrowdown"&&C(0,Se),X==="arrowleft"&&C(-Se,0),X==="arrowright"&&C(Se,0)})}Nt(c,($,C)=>{H=Y(H+$,0,1),P=Y(P-C,0,1),z()}),Nt(p,($,C)=>{R=Y(R+C*360,0,360),z()}),Nt(u,($,C)=>{M=Y(M-C,0,1),z()}),[c,p,u].forEach($=>{$.addEventListener("keydown",C=>{C.key==="Enter"&&C.stopPropagation()})}),x.addEventListener("input",()=>{let $=Sn(x.value);if($){let C=xn($.r,$.g,$.b);R=C.h,H=C.s,P=C.v,z()}}),b.addEventListener("input",()=>{let $=parseFloat(b.value.replace(",","."));isNaN($)||(M=Y($,0,1),z())}),de(e||U);function Ho(){s.style.minWidth=a.style.minWidth=i.style.minWidth=y.style.minWidth="0";let Me=()=>{let De=1+(n?1:0),Ge=s.clientWidth||r.clientWidth,jo=110+De*14+20+180+10,cn=Ge<jo;s.style.display="grid",s.style.gap="10px",s.style.alignItems="start",s.style.gridTemplateColumns=cn?"1fr":"minmax(0, 1fr) minmax(180px, 28ch)";let Zo=(cn?Ge:Ge-180-10)-De*14-20,ln=Math.max(110,Math.min(Zo,210)),It=Math.max(0,Math.round(ln*.62));c.style.width=Math.max(0,Math.floor(ln))+"px",c.style.height=It+"px",p.style.height=It+"px",u.style.height=It+"px"};requestAnimationFrame(()=>{Me();let De=new ResizeObserver(Me);De.observe(s),De.observe(a)})}return Ho(),{root:r,hiddenInput:I,getValue:()=>I.value,setValue:de}}function or({r:e,g:t,b:n}){let o=r=>r.toString(16).padStart(2,"0");return`#${o(e)}${o(t)}${o(n)}`.toUpperCase()}function xn(e,t,n){e/=255,t/=255,n/=255;let o=Math.max(e,t,n),r=Math.min(e,t,n),s=o-r,a=0,i=o?s/o:0,c=o;if(s!==0){switch(o){case e:a=(t-n)/s+(t<n?6:0);break;case t:a=(n-e)/s+2;break;case n:a=(e-t)/s+4;break}a*=60}return{h:a,s:i,v:c}}function En(e,t,n){let o=n*t,r=o*(1-Math.abs(e/60%2-1)),s=n-o,a=0,i=0,c=0;return 0<=e&&e<60?(a=o,i=r):60<=e&&e<120?(a=r,i=o):120<=e&&e<180?(i=o,c=r):180<=e&&e<240?(i=r,c=o):240<=e&&e<300?(a=r,c=o):(a=o,c=r),{r:Math.round((a+s)*255),g:Math.round((i+s)*255),b:Math.round((c+s)*255)}}function Sn(e){if(!e)return null;let t=String(e).trim();if(t.startsWith("#")){let o=Qo(t);return o?{...o,a:1}:null}let n=t.match(/rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*([.\d]+))?\)/i);return n?{r:+n[1],g:+n[2],b:+n[3],a:n[4]!==void 0?+n[4]:1}:null}var re=[],oe={},Be="name",ge=!0,Ln="",Cn=!0,mt={},rr=30,sr=/\p{Diacritic}/gu;async function kn(){let e=document.getElementById("add-zone-button"),t=document.getElementById("delete-zone-button"),n=document.getElementById("edit-zone-button");e&&e.addEventListener("click",async()=>{try{await cr()}catch(o){console.error("Error adding a zone:",o)}}),t&&t.addEventListener("click",async()=>{try{await ar()}catch(o){console.error("Error deleting a zone:",o)}}),n&&n.addEventListener("click",async()=>{try{await ir()}catch(o){console.error("Error when modifying a zone:",o)}})}async function $n(){try{await Ce(),await Ie(),await Xe()}catch(e){throw console.error("Error updating zones:",e),e}}async function Tn(e){try{e&&Array.isArray(e)?(re=e,console.log("Zones:",re)):(console.log("No valid zones were obtained from the server."),re=[])}catch(t){console.error("Error getting zones:",t),re=[]}}async function Xe(){w.getPane("circlePane")||(w.createPane("circlePane"),w.getPane("circlePane").style.zIndex=400);let e=re.map(t=>t.id);Object.keys(oe).forEach(t=>{e.includes(t)||(w.removeLayer(oe[t]),delete oe[t],delete mt[t])}),re.forEach(t=>{let{latitude:n,longitude:o,radius:r,name:s,custom:a}=t;if(!n||!o||!r){console.error("Invalid zone:",t.id);return}if(mt[t.id])return;let i=`https://www.google.com/maps/search/?api=1&query=${n},${o}`,c=oe[t.id],d=!c||c.getLatLng().lat!==n||c.getLatLng().lng!==o||c.getRadius()!==r,p=a?t.color||U:me,m=p,u=he(p,.25);if(c){let g=`
			  <strong>${s||l("zone_without_name")}</strong><br>
			  ${l("radius")}: ${T?Z(r*3.28084):Z(r)} ${T?l("feets"):l("meters")}
			  <br><br><a href="${i}" target="_blank" rel="noopener noreferrer"><strong>${l("open_location")}</strong></a>
		    `;c.getPopup().getContent()!==g&&c.setPopupContent(g),(c.options.color!==m||c.options.fillColor!==u)&&c.setStyle({color:m,fillColor:u,fillOpacity:1})}if(!d)return;let h=!1;if(oe[t.id]){let g=oe[t.id],S=g.isPopupOpen();w.removeLayer(g),delete oe[t.id]}let f=L.circle([n,o],{radius:r,color:m,fillColor:u,fillOpacity:1,opacity:.8,pane:"circlePane"}).addTo(w);Ye&&a&&f.enableEdit();let y=`
		  <strong>${s||l("zone_without_name")}</strong><br>
		  ${l("radius")}: ${T?Z(r*3.28084):Z(r)} ${T?l("feets"):l("meters")}
		  <br><br><a href="${i}" target="_blank" rel="noopener noreferrer"><strong>${l("open_location")}</strong></a>
		`;f.bindPopup(y,{autoPan:!1}),h&&f.openPopup(),f.on("click",async()=>{try{w.fitBounds(f.getBounds()),f.openPopup(),await ft(t.id)}catch(g){console.error("Error handling zone row selection:",g)}}),f.on("editable:vertex:dragstart",()=>{mt[t.id]=!0,w.closePopup()}),f.on("editable:vertex:dragend",async()=>{mt[t.id]=!1;let g=f.getLatLng(),S=f.getRadius();t.latitude=g.lat,t.longitude=g.lng,t.radius=S;let k=`
				<strong>${t.name||l("zone_without_name")}</strong><br>
				${l("radius")}: ${T?Z(S*3.28084):Z(S)} ${T?l("feets"):l("meters")}
			`;if(f.bindPopup(k,{autoPan:!1}),f.openPopup(),await Ie(),Ye&&a)try{let E=await Bt(t.id,t.name,S,g.lat,g.lng,t.color);E&&E.success?(await Ce(),await Ie(),await Xe(),await ft(t.id),console.log(`Zone with ID ${t.id} updated on server.`)):console.error(`Error updating zone with ID ${t.id} on server.`)}catch(E){console.error("Error in zone update request:",E)}}),oe[t.id]=f})}async function ft(e){let t=document.getElementById("zones-table-body");if(!t){console.error("The zone table tbody was not found.");return}let n=t.querySelector(`tr[data-zone-id="${e}"]`);if(!n){console.error("No row found for the zone:",e);return}let o=document.getElementById("combo-select");if(o&&o.value!=="zones"){o.value="zones";let r=new Event("change",{bubbles:!0});o.dispatchEvent(r)}t.querySelectorAll("tr").forEach(r=>r.classList.remove("selected")),n.classList.add("selected"),n.scrollIntoView({behavior:"smooth",block:"center"}),typeof Ne=="function"&&Ne()}async function Ne(){let e=document.getElementById("zones-table-body");if(!e){console.error("Zone table body not found.");return}let t=e.querySelectorAll("tr"),n=document.getElementById("add-zone-button"),o=document.getElementById("delete-zone-button"),r=document.getElementById("edit-zone-button"),s=document.getElementById("zone-actions");if([n,o,r].forEach(i=>i.classList.add("hidden")),Ye)s.style.display="flex";else{s.style.display="none";return}if(t.length===0)n.classList.remove("hidden");else{let i=e.querySelector("tr.selected");i&&i.dataset.custom==="true"?(n.classList.remove("hidden"),o.classList.remove("hidden"),r.classList.remove("hidden")):n.classList.remove("hidden")}let a=[n,o,r].filter(i=>!i.classList.contains("hidden"));a.length===1?(s.classList.add("single-button"),a[0].style.flex="1"):(s.classList.remove("single-button"),a.forEach(i=>i.style.flex="1"))}async function ar(){let t=document.getElementById("zones-table-body").querySelector("tr.selected");if(!t){F(l("select_delete_zone"),{title:l("zones")});return}let n=t.dataset.zoneId,o=t.dataset.name;if(!n){console.error("The selected zone ID was not found.");return}if(await _n(yn("confirm_delete_zone",{name:o}),{type:"danger",okLabel:l("delete"),title:l("zones")}))try{await In(n),await Ce(),await Ie(),await Xe()}catch(s){console.error("Error trying to delete zone:",s),F(l("error_deleting_zone"),{title:l("zones")})}}async function ir(){let e=document.getElementById("zones-table-body");if(!e){console.error("Zone table body not found.");return}let t=e.querySelector("tr.selected");if(!t){F(l("select_zone"),{title:l("zones")});return}let n=t.dataset.zoneId,o=re.find(i=>i.id===n);if(!o){F(l("error_finding_zone"),{title:l("zones")});return}let r=await Ft(l("enter_zone_name"),o.name||l("zone_without_name"),{title:l("zones"),withColor:!0,defaultColor:o.color,colorLabel:l("select_color"),colorOptions:{palette:[],allowAlpha:!1,showNative:!1}});if(r===null)return;let s=Dn(r.value);if(s===null)return;let a=r.color||o.color||U;if(!(pt(s)===pt(o.name)&&a===(o.color||U))){if(await Ce(),Nn(s,{excludeId:o.id})){F(l("zone_name_exists"),{title:l("zones")});return}try{let i=await Bt(o.id,s,o.radius,o.latitude,o.longitude,a);i&&i.success?(o.name=s,o.color=a,await Ce(),await Ie(),await Xe(),await ft(o.id)):F(l("error_updating_zone"),{title:l("zones")})}catch(i){console.error("Error in zone update request:",i),F(l("error_updating_zone"),{title:l("zones")})}}}async function cr(){if(!w)return console.error("The map is not initialized."),null;let e=await Ft(l("enter_zone_name"),"",{title:l("zones"),withColor:!0,defaultColor:U,colorLabel:l("select_color"),colorOptions:{palette:[],allowAlpha:!1,showNative:!1}});if(e===null)return;let t=Dn(e.value);if(t===null)return;if(await Ce(),Nn(t)){F(l("zone_name_exists"),{title:l("zones")});return}let n=w.getCenter(),o=n.lat,r=n.lng,s=100;try{let a=e.color||U,i=await An(t,s,o,r,"mdi:map-marker",!1,!0,a);return i?(await Ce(),await Ie(),await Xe(),await ft(i),console.log(`Zone created successfully. ID: ${i}`),i):(console.error("Failed to create zone."),F(l("error_creating_zone"),{title:l("zones")}),null)}catch(a){console.error("Error in zone update request:",a),F(l("error_creating_zone"),{title:l("zones")})}}function ye(e,t,n={}){let{accuracy:o=0,includePassive:r=!1,epsilonM:s=.5,epsilonDeg:a=1e-5}=n,i=u=>Math.round(u/a),c=(u,h)=>`${i(u)},${i(h)}`;if(e==null||t==null||Number.isNaN(e)||Number.isNaN(t))return null;let d=[];for(let u=0;u<re.length;u++){let h=re[u];if(!h||h.passive&&!r)continue;let f=lt(e,t,h.latitude,h.longitude),y=(Number(h.radius)||0)+(Number(o)||0);f<=y&&d.push({zone:h,idx:u,distanceToCenter:f,key:c(h.latitude,h.longitude),radius:Number(h.radius)||0,id:h.entity_id||h.id||h.name||`idx:${u}`})}if(d.length===0)return null;if(d.length===1)return d[0].zone;let p=new Map;for(let u of d){let h=p.get(u.key);(!h||u.radius<h.radius-s||Math.abs(u.radius-h.radius)<=s&&String(u.id)<String(h.id))&&p.set(u.key,u)}let m=Array.from(p.values());return m.length===1||m.sort((u,h)=>{let f=u.distanceToCenter-h.distanceToCenter;if(Math.abs(f)>s)return f;let y=u.radius-h.radius;return Math.abs(y)>s?y:String(u.id).localeCompare(String(h.id))}),m[0].zone}async function Mn(e){if(e)if(oe[e]){let t=oe[e];w.setView(t.getLatLng(),w.getZoom()),t.openPopup()}else console.error("Marker for zone not found: ",e)}async function Ie(){let e=document.getElementById("zones-table-body");if(!e){console.error("Zone table body not found."),Je(),Ne();return}let t=e.querySelector("tr.selected"),n=t?t.dataset.zoneId:null,o=[...re].sort((a,i)=>{let c,d;switch(Be){case"type":return c=a.custom?1:0,d=i.custom?1:0,ge?c-d:d-c;case"radius":return c=Number(a.radius)||0,d=Number(i.radius)||0,ge?c-d:d-c;case"name":default:return c=(a.name||"").toLowerCase(),d=(i.name||"").toLowerCase(),ge?c.localeCompare(d):d.localeCompare(c)}}),r=Array.from(e.querySelectorAll("tr")),s=r.map(a=>a.dataset.zoneId);o.forEach((a,i)=>{let{id:c,latitude:d,longitude:p,name:m,custom:u}=a;if(!d||!p){console.error("Invalid coordinates for the zone:",c);return}let h=r.find(k=>k.dataset.zoneId===c);h||(h=document.createElement("tr"),h.dataset.zoneId=c,h.dataset.custom=u,h.dataset.name=m,h.style.cursor="pointer",e.appendChild(h));let f=u?a.color||U:me;h.style.setProperty("--color-bg",he(f,se));let y=`<div style="
		  width:10px; height:10px; border:2px solid ${f};
		  border-radius:50%;
		  background-color:${he(f,.3)};
		  margin:auto;"></div>`,g=`${T?Z(a.radius*3.28084):Z(a.radius)}`,S=`
		  <td>${y}</td>
		  <td>${m||l("zone_without_name")}</td>
		  <td>${g}</td>
		`;h.innerHTML!==S&&(h.innerHTML=S,h.dataset.name=m),h.onclick=()=>{let k=oe[c];if(k){let E=k.getBounds();w.fitBounds(E),k.openPopup()}else console.error("No marker found for the zone:",c);e.querySelectorAll("tr").forEach(E=>E.classList.remove("selected")),h.classList.add("selected"),Ne()},e.children[i]!==h&&e.insertBefore(h,e.children[i]),c===n&&h.classList.add("selected")}),r.forEach(a=>{o.some(i=>i.id===a.dataset.zoneId)||a.remove()}),Ne(),Je(),(Ln!==Be||Cn!==ge)&&(lr(),Ln=Be,Cn=ge)}function lr(){let e=document.querySelector("#zones-table");if(!e){console.error("Zone summary table not found.");return}e.querySelectorAll("thead th").forEach(n=>{let o=n.getAttribute("data-i18n"),r="";switch(o){case"type":r="type";break;case"name":r="name";break;case"radius":r="radius";break}if(!r)return;n.style.cursor="pointer",n.onclick=()=>{Be===r?ge=!ge:(Be=r,ge=!0),Ie()};let s="";Be===r&&(s=ge?"\u25B2":"\u25BC");let a=o==="radius"?`${T?l("feets"):l("meters")}`:l(o);n.innerHTML=`
		  <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:30px;">
			<span class="hdr-label">${a}</span>
			<span style="font-size:12px;">${s}</span>
		  </div>
		`})}function Dn(e){let t=(e||"").trim();return t===""?(F(l("empty_name"),{title:l("zones")}),null):t.length>rr?(F(l("long_zone"),{title:l("zones")}),null):t}function pt(e){return(e??"").toLocaleLowerCase().normalize("NFD").replace(sr,"").replace(/\s+/g," ").trim()}function Nn(e,{excludeId:t=null}={}){let n=pt(e);return n?re.some(o=>o&&pt(o.name)===n&&(t==null||String(o.id)!==String(t))):!1}var dr=400,ur=4,Pn=2;var mr=(e,t,n)=>`${Number(e).toFixed(6)},${Number(t).toFixed(6)},${Number(n)}`,fr=(e,t)=>`${Number(e).toFixed(6)},${Number(t).toFixed(6)}`,Ae=new Map,Rt=new Map,ht=new Map,Q=new Map,Pe=new Map,Qe=new Map;function Ut(e,t){if(Ae.has(e)&&Ae.delete(e),Ae.set(e,t),Ae.size>dr){let n=Ae.keys().next().value;Ae.delete(n)}}function Fe(e){Qe.delete(e)}function pr(e,t,n){let o=(Qe.get(e)||0)+1;Qe.set(e,o);let r=Math.floor(Math.random()*250),s=Math.min(8e3,Math.max(300,t)*Math.pow(1.6,o))+r;setTimeout(n,s)}var Ht=0,jt=[];function hr(e){return new Promise((t,n)=>{jt.push({task:e,res:t,rej:n}),Fn()})}function Fn(){for(;Ht<ur&&jt.length;){let{task:e,res:t,rej:n}=jt.shift();Ht++,e().then(t,n).finally(()=>{Ht--,Fn()})}}function Re(e,t){try{let n=document.querySelector(`tr.pos-main-row[data-entity-id="${e}"]`);n&&(n.dataset.address=t||"");let o=document.querySelector(`tr.position-address-row[data-entity-id="${e}"]`);o&&(o.dataset.address=t||"")}catch{}}async function et(e,t,n,o,r){if(!Number.isFinite(t)||!Number.isFinite(n)||!Number.isFinite(o))return;let s=mr(t,n,o);Q.set(e,s);let a=Ae.get(e);if(a?.key===s){let d=a.address||"";r?.(d),Re(e,d),Q.delete(e),Fe(e);return}if(Pe.get(e)===s)return;Pe.set(e,s);let i=d=>{Pe.get(e)===s&&Pe.delete(e),pr(e,d,()=>{Q.get(e)===s&&et(e,t,n,o,r)})},c=fr(t,n);try{if(Rt.has(c)){let u=Rt.get(c)||"";Ut(e,{key:s,address:u}),Q.get(e)===s&&(r?.(u),Re(e,u),Q.delete(e),Fe(e));return}if(ht.has(c)){let u=await ht.get(c);if(Q.get(e)!==s)return;if(!u){if((Qe.get(e)||0)<Pn){i(600);return}r?.(""),Re(e,""),Q.delete(e),Fe(e);return}Ut(e,{key:s,address:u}),r?.(u),Re(e,u),Q.delete(e),Fe(e);return}let d=hr(()=>On(t,n));ht.set(c,d.then(u=>(u?.address?.display_name||"").trim()));let p=await d;if(Q.get(e)!==s)return;if(p?.error==="queued"&&Number.isFinite(p?.retry_after)){i(p.retry_after*1e3);return}if(["temporarily_unavailable","rate_limited","busy"].includes(p?.error)){let u=Number.isFinite(p?.retry_after)?p.retry_after:1.5;i(u*1e3);return}let m=(p?.address?.display_name||"").trim();if(!m){if((Qe.get(e)||0)<Pn){i(600);return}r?.(""),Re(e,""),Q.delete(e),Fe(e);return}Rt.set(c,m),Ut(e,{key:s,address:m}),r?.(m),Re(e,m),Q.delete(e),Fe(e)}catch{Q.get(e)===s&&i(1200)}finally{ht.delete(c),Pe.get(e)===s&&Pe.delete(e)}}function zn(e){Q.delete(e),Pe.delete(e),Fe(e)}var gr="/local/ha-tracker/images/location-red.png",ke=[],gt=[],K={},fe={},Ue="name",ae=!0,Bn="",Rn=!0,Zt={},tt=null;function yr(){if(tt)return tt;let e=document.querySelector("#users .table-wrapper")||null;return tt=new IntersectionObserver(t=>{for(let n of t){if(!n.isIntersecting)continue;let o=n.target;tt.unobserve(o);let r=o.dataset.personId,s=Number(o.dataset.latitude),a=Number(o.dataset.longitude),i=Number(o.dataset.lastUpdated),c=`${r}_${i}`,d=o.querySelector("td");!Number.isFinite(s)||!Number.isFinite(a)||!d||et(c,s,a,i,p=>{Zt[r]={lat:s,lon:a,timestamp:i,address:p||""};let m=document.querySelector(`tr.person-address-row[data-person-id="${r}"]`);if(m&&m.dataset.lastUpdated===String(i)){let u=m.querySelector("td");u&&(u.textContent=p||"")}})}},{root:e,rootMargin:"200px"}),tt}async function Un(){try{await Wn(),await qn(),await br(),await Je(),await wr(),await Wt()}catch(e){throw console.error("Error updating devices:",e),e}}async function Hn(e){try{gt=Array.isArray(e)?e.filter(t=>t.entity_id&&t.attributes):[],console.log("Devices:",gt)}catch(t){console.error("Error processing devices:",t),gt=[]}}async function jn(e){try{ke=Array.isArray(e)?e.filter(t=>t.attributes?.friendly_name):[],console.log("Persons:",ke)}catch(t){console.error("Error processing persons:",t),ke=[]}}async function qt(e){if(!e)return;let t=fe[e];if(!t)return;let n=K[e];if(!n){console.error(`No device was found for the person with ID: ${e}`);return}Object.values(fe).forEach(s=>s.setZIndexOffset(500)),t.setZIndexOffset(600);let{latitude:o,longitude:r}=n.attributes||{};if(!Pt(o,r)){console.error(`Invalid coordinates for ${e}: lat=${o}, lng=${r}`);return}t.openPopup(),w.invalidateSize(),w.setView([o,r],w.getZoom())}function Wt(){let e=document.getElementById("person-select"),t=e.value,n=document.createDocumentFragment(),o=document.createElement("option");o.value="",o.textContent=l("select_user"),n.appendChild(o),ke.filter(a=>!!K[a.entity_id]).forEach(a=>{let i=document.createElement("option");i.value=a.entity_id;let c=a.attributes.friendly_name||a.attributes.id||a.entity_id;i.textContent=(c||"").trim(),n.appendChild(i)}),e.innerHTML="",e.appendChild(n);let r=e.options.length>1,s=!!(t&&K[t]);r&&s?e.value=t:(e.value="",e.dispatchEvent(new Event("change",{bubbles:!0})))}async function Zn(){try{let e=Object.values(K).filter(n=>n.attributes.latitude&&n.attributes.longitude).map(n=>[n.attributes.latitude,n.attributes.longitude]);if(!e.length){console.log("There are no devices with coordinates to adjust the map."),w.fitWorld();return}let t=L.latLngBounds(e);w.fitBounds(t)}catch(e){console.error("Error doing fitMapToAllDevices:",e)}}async function br(){K={},ke.forEach(e=>{let t=e.attributes?.source;if(!t||typeof t!="string"||t.trim()===""){console.log(`The person ${e.attributes.friendly_name||e.entity_id} does not have a valid 'source'.`);return}let n=gt.find(o=>o.entity_id===t);if(!n){console.error(`The 'source' (${t}) of ${e.attributes.friendly_name||e.entity_id} is not in device_trackers.`);return}if(!n.attributes.latitude||!n.attributes.longitude){console.log(`The device_tracker ${t} of ${e.attributes.friendly_name||e.entity_id} does not have lat/lng.`);return}K[e.entity_id]=n}),console.log("Devices to persons:",K)}async function wr(){if(!w.getPane("personsMarkers")){let t=w.createPane("personsMarkers");t.style.zIndex=600,t.style.pointerEvents="auto"}let e=Object.keys(K);Object.keys(fe).forEach(t=>{e.includes(t)||(w.removeLayer(fe[t]),delete fe[t])}),e.forEach(t=>{let n=K[t],{latitude:o,longitude:r,friendly_name:s,speed:a}=n.attributes,i=n.battery_level?`<br>${l("battery")}: ${n.battery_level}${l("percentage")}`:"";if(!Pt(o,r))return;let c=ee(n.last_updated||l("date_unavailable")),d=ke.find(f=>f.entity_id===t)?.attributes.friendly_name||"",p=ke.find(f=>f.entity_id===t)?.attributes.entity_picture||gr,m=`https://www.google.com/maps/search/?api=1&query=${o},${r}`,u=`
		  <strong>${d}</strong> (${s})<br>
		  ${c}<br>
		  ${l("speed")}: ${Math.round((a||0)*(T?2.23694:3.6))} ${l(T?"mi_per_hour":"km_per_hour")}
		  ${i}
		  <br><br><a href="${m}" target="_blank" rel="noopener noreferrer"><strong>${l("open_location")}</strong></a>
		`,h=L.divIcon({className:"",html:`<img src="${p}" style="width:48px;height:48px;border-radius:50%;object-fit:cover;" />`,iconSize:[48,48],iconAnchor:[24,24],popupAnchor:[0,-24]});if(fe[t]){let f=fe[t];f.setLatLng([o,r]),f.setIcon(h),f.getPopup().setContent(u)}else fe[t]=L.marker([o,r],{icon:h,pane:"personsMarkers"}).addTo(w).bindPopup(u,{autoPan:!1}).on("click",async()=>{await vr(t),w.invalidateSize();let f=fe[t].getLatLng();w.setView(f,w.getZoom()),fe[t].openPopup()})})}async function vr(e){let t=document.getElementById("combo-select");t&&t.value!=="users"&&(t.value="users",t.dispatchEvent(new Event("change",{bubbles:!0})),await new Promise(i=>requestAnimationFrame(i)));let o=document.getElementById("persons-table-body");if(o||(await new Promise(i=>requestAnimationFrame(i)),o=document.getElementById("persons-table-body")),!o){console.error("Person table tbody not found.");return}let r=window.CSS&&CSS.escape?CSS.escape(e):e.replace(/"/g,'\\"'),s=o.querySelector(`tr[data-person-id="${r}"]`);if(s||(s=Array.from(o.querySelectorAll("tr")).find(i=>i.dataset.personId===e)),!s)return;let a=s.nextElementSibling&&s.nextElementSibling.classList.contains("person-address-row")?s.nextElementSibling:null;o.querySelectorAll("tr.selected").forEach(i=>i.classList.remove("selected")),s.classList.add("selected"),a&&a.classList.add("selected"),s.scrollIntoView({behavior:"smooth",block:"center"})}function xr(){let e=document.querySelector("#persons-table");if(!e){console.error("Zone summary table not found.");return}e.querySelectorAll("thead th").forEach(n=>{let o=n.getAttribute("data-i18n"),r="";switch(o){case"name":r="name";break;case"date":r="date";break;case"speed":r="speed";break;case"percentage":r="percentage";break;case"zone":r="zone";break}if(!r)return;n.style.cursor="pointer",n.onclick=()=>{Ue===r?ae=!ae:(Ue=r,ae=!0),Je()};let s=Ue===r?ae?"\u25B2":"\u25BC":"",a=o==="speed"?T?l("mi_per_hour"):l("km_per_hour"):l(o);n.innerHTML=`
		  <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:30px;">
			<span class="hdr-label">${a}</span>
			<span class="hdr-arrow" style="font-size:12px;">${s}</span>
		  </div>
		`})}async function Je(){try{let e=document.getElementById("persons-table-body");if(!e){console.error("Person table tbody not found.");return}let t=e.querySelector("tr.selected"),n=t?t.dataset.personId:null,r=[...ke.filter(i=>K[i.entity_id])].sort((i,c)=>{let d=K[i.entity_id]||{},p=K[c.entity_id]||{},m,u;switch(Ue){case"name":return m=i.attributes.friendly_name||i.entity_id,u=c.attributes.friendly_name||c.entity_id,ae?m.localeCompare(u):u.localeCompare(m);case"date":return m=d.last_updated?new Date(d.last_updated).getTime():0,u=p.last_updated?new Date(p.last_updated).getTime():0,ae?m-u:u-m;case"speed":return m=parseFloat(d.attributes?.speed)||0,u=parseFloat(p.attributes?.speed)||0,ae?m-u:u-m;case"percentage":return m=parseFloat(d.battery_level)||0,u=parseFloat(p.battery_level)||0,ae?m-u:u-m;case"zone":return m=ye(d.attributes?.latitude,d.attributes?.longitude)?.name||"",u=ye(p.attributes?.latitude,p.attributes?.longitude)?.name||"",ae?m.localeCompare(u):u.localeCompare(m);default:return 0}}),s=Array.from(e.querySelectorAll("tr")),a=yr();r.forEach((i,c)=>{let d=i.entity_id,p=i.attributes.friendly_name||d,m=i.attributes.source||null,u="",h="",f="",y="",g="",S="",k=null,E,x,v,N=!1;if(m&&K[d]){let M=K[d];u=M.attributes.friendly_name?`(${M.attributes.friendly_name})`:"",y=M.battery_level,h=ee(M.last_updated),f=Math.round((M.attributes.speed||0)*(T?2.23694:3.6)),k=ye(M.attributes.latitude,M.attributes.longitude),g=k?k.name:"",E=Number(M.attributes.latitude),x=Number(M.attributes.longitude),v=new Date(M.last_updated).getTime();let W=Zt[d];if(S=W?.address||"",!W)N=!0;else{let le=lt(W.lat,W.lon,E,x),j=(v-(W.timestamp||0))/1e3;le>=Gt&&j>=Vt&&(S="",N=!0)}}let b=s.find(M=>M.dataset.personId===d&&!M.classList.contains("person-address-row")),_=b?b.nextElementSibling:null;if(!b){b=document.createElement("tr"),b.dataset.personId=d,b.style.cursor="pointer",_=document.createElement("tr"),_.dataset.personId=d,_.classList.add("person-address-row"),_.style.cursor="pointer";let M=document.createElement("td");M.setAttribute("colspan","5"),M.textContent=S||"",M.style.borderBottom="1px solid rgba(0,0,0,0.1)",_.appendChild(M),e.appendChild(b),e.appendChild(_)}let A=`
				<td><p style="font-weight:bold;color:#003366;margin:0;">${p}</p>${u}</td>
				<td>${h}</td>
				<td>${g}</td>
				<td>${f}</td>
				<td>${y}</td>
			  `;b.innerHTML!==A&&(b.innerHTML=A);let D=Er(k,se);b.style.setProperty("--color-bg",D||""),_&&_.style.setProperty("--color-bg",D||"");let I=_.querySelector("td");_.dataset.latitude=Number.isFinite(E)?String(E):"",_.dataset.longitude=Number.isFinite(x)?String(x):"",_.dataset.lastUpdated=Number.isFinite(v)?String(v):"0";let R=!!Zt[d];N||!R&&Number.isFinite(E)&&Number.isFinite(x)?(I&&I.textContent!=="\u2026"&&(I.textContent="\u2026"),a.observe(_)):(zn(`${d}_${_.dataset.lastUpdated}`),I&&I.textContent!==S&&(I.textContent=S||""));let P=()=>{e.querySelectorAll("tr.selected").forEach(M=>M.classList.remove("selected")),b.classList.add("selected"),_&&_.classList.add("selected"),qt(d)};b.onclick=P,_&&(_.onclick=P),e.children[c*2]!==b&&(e.insertBefore(b,e.children[c*2]),e.insertBefore(_,b.nextSibling)),d===n&&(b.classList.add("selected"),_&&_.classList.add("selected"))}),Array.from(e.querySelectorAll("tr")).forEach(i=>{let c=i.dataset.personId;r.some(d=>d.entity_id===c)||(i.nextElementSibling&&i.nextElementSibling.classList.contains("person-address-row")&&i.nextElementSibling.remove(),i.remove())}),(Bn!==Ue||Rn!==ae)&&(xr(),Bn=Ue,Rn=ae)}catch(e){console.error("Error updating people table:",e)}}function Er(e,t=se){if(!e)return null;let n=e?.custom?e.color||U:me,o=Math.min(1,Math.max(0,Number(t)||0));return he(n,o)||he(me,o)}var Vn=" \u21D2 ",nt={coreJS:"https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js",coreCSS:"https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css",confirmJS:"https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/plugins/confirmDate/confirmDate.js",confirmCSS:"https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/plugins/confirmDate/confirmDate.css",l10nBase:"https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n"},yt,be=null,Yn=null;function Kt(){let e=new Set(["ar","de","en","es","fr","hi","it","ja","pt","zh"]),t=(navigator.languages?.length?navigator.languages:[navigator.language||"en"]).map(n=>String(n).toLowerCase());for(let n of t){let o=n.slice(0,2);if(e.has(o))return o}return"en"}async function Sr(){return yt||(yt=(async()=>{await Oe(nt.coreCSS),await Oe(nt.confirmCSS),await _e(nt.coreJS,{test:()=>!!window.flatpickr}),await _e(nt.confirmJS,{test:()=>!!window.confirmDatePlugin});let e=Kt();e!=="en"&&await _e(`${nt.l10nBase}/${e}.js`,{test:()=>!!window.flatpickr?.l10ns?.[e]}).catch(()=>{}),be=window.flatpickr,Yn=window.confirmDatePlugin,console.log("[flatpickr] v",be?.version,"locale:",e)})(),yt)}var je=[],ot=null,Ze,qe,q,we="00:00:00",ve="23:59:59",pe=e=>String(e).padStart(2,"0"),He=e=>`${e.getFullYear()}-${pe(e.getMonth()+1)}-${pe(e.getDate())}T${pe(e.getHours())}:${pe(e.getMinutes())}:${pe(e.getSeconds())}`;function _r(e,t){return e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate()}function Gn(e){let[t="00",n="00"]=String(e||"").split(":");return`${pe(t)}:${pe(n)}`}async function Xn(e={}){if(ot=typeof e.onApplyFilter=="function"?e.onApplyFilter:null,window.__rangePickerInitDone)return;try{await Sr(),Nr()}catch(r){console.error("[calendar] no se pudo cargar flatpickr:",r);return}let t=document.getElementById("daterange");if(!t){console.error("[calendar] #daterange no existe");return}let n=Kt(),o=be?.l10ns?.[n]||be?.l10ns?.default;q=be(t,{mode:"range",enableTime:!1,closeOnSelect:!1,dateFormat:"Y-m-d",allowInput:!1,locale:o,plugins:[new Yn({confirmText:l("accept"),showAlways:!0,theme:"light"})],onDayCreate(r,s,a,i){i.addEventListener("click",()=>{we="00:00:00",ve="23:59:59",Ze?.setDate(we,!1),qe?.setDate(ve,!1),setTimeout(()=>$e(a),0)})},onReady(r,s,a){Kn(a),$e(a)},onOpen(r,s,a){a._prevTextboxValue=a.input.value,a.calendarContainer.classList.add("fp-at-top"),Kn(a),je.length===2?a.setDate(je,!0):$e(a)},onClose(r,s,a){a.calendarContainer.classList.remove("fp-at-top")},onValueUpdate(){$e(q)},onChange(){$e(q)}}),window.addEventListener("resize",()=>{let r=q?.calendarContainer;r&&Qn(r)}),window.__rangePickerInitDone=!0}function wt(){let e,t;if(q&&Array.isArray(q.selectedDates)){let n=q.selectedDates.length;if(n===2){let[o,r]=q.selectedDates,[s,a,i]=(we||"00:00:00").split(":").map(h=>+h||0),[c,d,p]=(ve||"23:59:59").split(":").map(h=>+h||0),m=new Date(o);m.setHours(s,a,i,0);let u=new Date(r);u.setHours(c,d,p,0),e=He(m),t=He(u)}else if(n===1){let o=q.selectedDates[0],[r,s,a]=(we||"00:00:00").split(":").map(u=>+u||0),[i,c,d]=(ve||"23:59:59").split(":").map(u=>+u||0),p=new Date(o);p.setHours(r,s,a,0);let m=new Date(o);m.setHours(i,c,d,0),e=He(p),t=He(m)}}else if(Array.isArray(je)&&je.length===2){let[n,o]=je;e=He(n),t=He(o)}return{startLocal:e,endLocal:t}}function bt(e="00:00:00",t="23:59:59"){we=e||"00:00:00",ve=t||"23:59:59",Ze?.setDate(we,!1),qe?.setDate(ve,!1),q&&$e(q)}function Jt([e,t],n=!0){q&&(q.setDate([e,t],!!n),n||$e(q))}function rt(){je=[],q&&(q.clear(!1),q.input.value="")}function vt(){let e=document.getElementById("person-select"),t=document.getElementById("daterange"),n=t?.closest(".group")||t;if(!e||!n)return;let o=e.value===""||e.selectedIndex===-1;n.style.display=o?"none":"",o&&(t.value="",q?.clear(!1))}function $e(e){if(!e)return;let t=new Intl.DateTimeFormat(void 0,{year:"2-digit",month:"2-digit",day:"2-digit"}),[n,o]=e.selectedDates||[],r=Gn(we||"00:00:00"),s=Gn(ve||"23:59:59");if(n&&!o){e.input.value=`${t.format(n)} ${r}`;return}if(n&&o){_r(n,o)?e.input.value=`${t.format(n)} ${r}${Vn}${s}`:e.input.value=`${t.format(n)} ${r}${Vn}${t.format(o)} ${s}`;return}e.input.value=""}function Lr(e){let t=e.selectedDates||[];if(t.length===1){let n=t[0];e.setDate([n,n],!1)}$e(e),e.close(),ot&&ot()}function Qn(e){let t=e.getBoundingClientRect().width+"px";Ze?.calendarContainer&&(Ze.calendarContainer.style.width=t),qe?.calendarContainer&&(qe.calendarContainer.style.width=t)}function Cr(e){let t=document.createElement("div");t.className="fp-quickbar";let n=o=>`${pe(o.getHours())}:${pe(o.getMinutes())}:${pe(o.getSeconds())}`;return["today","yesterday","last_24h","last_7_days","this_week"].forEach(o=>{let r=document.createElement("button");r.type="button",r.textContent=l(o),r.addEventListener("click",()=>{let{start:s,end:a}=Dr(o);if(s&&a){if(o==="last_24h"){let i=new Date(a.getTime()-1e3);bt(n(s),n(i))}else bt("00:00:00","23:59:59");Jt([s,a],!0),e.close(),ot&&ot()}}),t.appendChild(r)}),t}function Kn(e){let t=e.calendarContainer;t.querySelector(".fp-quickbar")||t.appendChild(Cr(e));let n=t.querySelector(".fp-timepanel");if(!n){n=document.createElement("div"),n.className="fp-timepanel";let s=document.createElement("div");s.className="fp-timeblock";let a=document.createElement("div");a.className="fp-timehost",s.appendChild(a);let i=document.createElement("div");i.className="fp-timeblock";let c=document.createElement("div");c.className="fp-timehost",i.appendChild(c),n.append(s,i),t.appendChild(n);let d=Kt(),p=be?.l10ns?.[d]||be?.l10ns?.default,m=!new Intl.DateTimeFormat(void 0,{hour:"numeric"}).formatToParts(new Date).some(f=>f.type==="dayPeriod"),u=document.createElement("input");u.type="hidden";let h=document.createElement("input");h.type="hidden",document.body.appendChild(u),document.body.appendChild(h),Ze=be(u,{inline:!0,noCalendar:!0,enableTime:!0,enableSeconds:!0,time_24hr:m,dateFormat:"H:i:S",defaultDate:we,locale:p,onChange:(f,y)=>{we=y||"00:00:00"}}),qe=be(h,{inline:!0,noCalendar:!0,enableTime:!0,enableSeconds:!0,time_24hr:m,dateFormat:"H:i:S",defaultDate:ve,locale:p,onChange:(f,y)=>{ve=y||"23:59:59"}}),a.appendChild(Ze.calendarContainer),c.appendChild(qe.calendarContainer)}let o=t.querySelector(".fp-actionbar");o||(o=document.createElement("div"),o.className="fp-actionbar",t.appendChild(o));let r=t.querySelector(".flatpickr-confirm");if(r&&!o.contains(r)&&(r.textContent=l("accept"),r.classList.add("fp-btn"),o.appendChild(r),r.dataset._bound||(r.addEventListener("click",()=>Lr(e)),r.dataset._bound="1")),!o.querySelector(".flatpickr-cancel")){let s=document.createElement("button");s.type="button",s.className="fp-btn flatpickr-cancel",s.textContent=l("cancel"),o.insertBefore(s,o.querySelector(".flatpickr-confirm")||null),s.addEventListener("click",()=>{Array.isArray(e._prevSelectedDates)?e.setDate(e._prevSelectedDates,!1):e.clear(!1),typeof e._prevTextboxValue=="string"?e.input.value=e._prevTextboxValue:e.input.value="",e.close()})}Qn(t)}function kr(e){let t=new Date(e);return t.setHours(0,0,0,0),t}function Jn(e,t){let n=new Date(e);return n.setDate(n.getDate()+t),n}function $r(e){let t=new Date(e.getFullYear(),e.getMonth(),1);return t.setHours(0,0,0,0),t}function Tr(e){let t=new Date(e.getFullYear(),e.getMonth()+1,1);return t.setHours(0,0,0,0),t}function eo(e){let t=new Date(e),n=t.getDay(),o=n===0?-6:1-n;return t.setDate(t.getDate()+o),t.setHours(0,0,0,0),t}function Mr(e){let t=eo(e),n=new Date(t);return n.setDate(t.getDate()+7),new Date(n.getTime()-1e3)}function Dr(e){let t=new Date,n=kr(t);switch(e){case"today":return{start:n,end:n};case"yesterday":return{start:Jn(n,-1),end:Jn(n,-1)};case"last_24h":return{start:new Date(t-1440*60*1e3),end:new Date(t-1e3)};case"last_7_days":return{start:new Date(t-10080*60*1e3),end:t};case"this_month":return{start:$r(t),end:Tr(t)};case"last_month":{let o=new Date(t.getFullYear(),t.getMonth()-1,1,0,0,0,0),r=new Date(t.getFullYear(),t.getMonth(),1,0,0,0,0),s=new Date(r.getTime()-1e3);return{start:o,end:s}}case"this_week":return{start:eo(t),end:Mr(t)};default:return{start:null,end:null}}}function Nr(){if(document.getElementById("fp-shadow-patch"))return;let e=document.createElement("style");e.id="fp-shadow-patch",e.textContent=`
    .flatpickr-calendar{
      background:#fff !important;
      border:1px solid rgba(0,0,0,.12) !important;
      border-radius:12px !important;
      box-shadow:0 12px 28px rgba(0,0,0,.30) !important;
      overflow:hidden;
    }
    @media (max-width: 600px){
      .flatpickr-calendar.fp-at-top{
        left: 8px !important;
        right: 8px !important;
        width: auto !important;
        max-width: calc(100% - 16px) !important;
        margin: 0 auto !important;
      }
    }
  `,document.head.appendChild(e)}function Yt(e){return(e instanceof Date?e:new Date(e)).toISOString()}function J(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Ir(e=""){return`<![CDATA[${e}]]>`}function Ar(e){return Number.isFinite(e)?Math.round(e*3.6):0}function Pr(e){let t=[];for(let n of e||[]){let o=Number(n?.attributes?.latitude),r=Number(n?.attributes?.longitude);!Number.isFinite(o)||!Number.isFinite(r)||t.push(`${r},${o},0`)}return t}function Fr(e,t={}){let{stopIconHref:n,includeRoute:o=!0,routeColor:r="ff0000ff",routeWidth:s=6,describeStop:a,nameStop:i,unitLabel:c="km/h",formatLocal:d,batteryLabel:p="Battery"}=t;if(!e||!e.length)throw new Error("No hay posiciones para exportar.");let m=Yt(e[0].last_updated),u=Yt(e[e.length-1].last_updated),h=`
    <Style id="stopStyle">
      <IconStyle>
        <scale>1.2</scale>
        ${n?`<Icon><href>${J(n)}</href></Icon>`:""}
      </IconStyle>
      <LabelStyle><scale>0</scale></LabelStyle>
    </Style>
    <Style id="routeStyle">
      <LineStyle>
        <color>${J(r)}</color>
        <width>${Number(s)||6}</width>
      </LineStyle>
    </Style>
  `,f=o?Pr(e):[],y=o&&f.length>=2?`
    <Placemark>
      <name>Route</name>
      <styleUrl>#routeStyle</styleUrl>
      <LineString>
        <tessellate>1</tessellate>
        <coordinates>${f.join(" ")}</coordinates>
      </LineString>
    </Placemark>
  `:"",g=(e||[]).filter(E=>!!E?.stop).map((E,x)=>{let v=Number(E?.attributes?.latitude),N=Number(E?.attributes?.longitude);if(!Number.isFinite(v)||!Number.isFinite(N))return"";let b=Yt(E.last_updated),_=d?d(E.last_updated):b,A=Ar(Number(E?.attributes?.speed)),D=`${E?.entity_id||"position"} #${x+1}`,I=i?i(E):D,R=Number.isFinite(E?.battery)?Math.round(E.battery):null,H="\u2022",P=(E?.zone||"").trim(),M=(E?.address||"").trim(),W=`${A} ${c}`,le=R!=null?`${p}: ${R}%`:"",z=[P,W,le,M].filter(Boolean).map(Y=>`${H} ${Y}`).join(`
`).trim(),de=a?a(E):`<table cellspacing="0" cellpadding="0" style="border-collapse:collapse">
			  <tr><td><b>${J(_)}</b></td></tr>
			  ${P?`<tr><td>${J(P)}</td></tr>`:""}
			  ${M?`<tr><td>${J(M)}</td></tr>`:""}
			  <tr><td>${J(W)}</td></tr>
			  ${R!=null?`<tr><td>${J(le)}</td></tr>`:""}
			 </table>`;return`
		  <Placemark>
			<name>${J(I)}</name>
			<Snippet maxLines="6"><![CDATA[${z}]]></Snippet>
			<styleUrl>#stopStyle</styleUrl>
			<TimeStamp><when>${b}</when></TimeStamp>
			<ExtendedData>
			  <Data name="entity_id"><value>${J(E?.entity_id||"")}</value></Data>
			  <Data name="speed_kmh"><value>${A}</value></Data>
			  <Data name="is_stop"><value>true</value></Data>
			  <Data name="zone"><value>${J(P)}</value></Data>
			  <Data name="address"><value>${J(M)}</value></Data>
			  <Data name="when_local"><value>${J(_)}</value></Data>
			  <Data name="unit"><value>${J(c)}</value></Data>
			  ${R!=null?`<Data name="battery_pct"><value>${R}</value></Data>`:""}
			</ExtendedData>
			<description>${Ir(de)}</description>
			<Point><coordinates>${N},${v},0</coordinates></Point>
		  </Placemark>
		`}).join(`
`),S=`HA Tracker ${m} - ${u}`;return`<?xml version="1.0" encoding="UTF-8"?>
  <kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
      <name>${J(S)}</name>
      ${h}
      ${y}
      <Folder>
        <name>Stops</name>
        ${g}
      </Folder>
    </Document>
  </kml>`}function no(e,t){let n=new Blob([t],{type:"application/vnd.google-earth.kml+xml"}),o=URL.createObjectURL(n),r=document.createElement("a");r.href=o,r.download=e.endsWith(".kml")?e:`${e}.kml`,document.body.appendChild(r),r.click(),r.remove(),URL.revokeObjectURL(o)}async function zr(e,t){let n=new Blob([t],{type:"application/vnd.google-earth.kml+xml"});if("showSaveFilePicker"in window){let r=await(await window.showSaveFilePicker({suggestedName:e.endsWith(".kml")?e:`${e}.kml`,types:[{description:"KML file",accept:{"application/vnd.google-earth.kml+xml":[".kml"]}}]})).createWritable();await r.write(n),await r.close()}else no(e,t)}function xt(e){return String(e).padStart(2,"0")}function to(e){let t=e instanceof Date?e:new Date(e);return`${t.getFullYear()}-${xt(t.getMonth()+1)}-${xt(t.getDate())}_${xt(t.getHours())}-${xt(t.getMinutes())}`}function Or(e,t="person"){if(!e||!e.length)return`ha-tracker_${t}.kml`;let n=e[0]?.last_updated,o=e[e.length-1]?.last_updated;return`ha-tracker_${t}_${to(n)}_${to(o)}.kml`}async function oo(e,t={}){let{personId:n="person",filename:o,usePicker:r=!1,...s}=t,a=Fr(e,s),i=o||Or(e,n);r?await zr(i,a):no(i,a)}function ro(e){return e==null?"":`"${String(e).replace(/\r?\n/g," ").trim().replace(/"/g,'""')}"`}function so(e){let t=Number(e);return Number.isFinite(t)?t.toFixed(6):""}function Br(e,t){if(!Number.isFinite(e))return"";let n=e*3.6,o=n*.621371192;return Math.round(t?o:n)}function Rr(e,{useImperial:t,formatLocal:n,delimiter:o=";"}={}){let r=t?l("mi_per_hour"):l("km_per_hour"),a=[[l("date"),l("stops"),l("latitude"),l("longitude"),r,l("battery"),l("zone"),l("address")].map(ro).join(o)];for(let i of e||[]){let c=i?.attributes?.latitude,d=i?.attributes?.longitude,p=n?n(i?.last_updated):i?.last_updated||"",m=i?.stop?l("stop"):"",u=Br(Number(i?.attributes?.speed),t),h=Number.isFinite(i?.battery)?i.battery:"",f=[p,m,so(c),so(d),u,h,i?.zone||"",i?.address||""].map(ro).join(o);a.push(f)}return a.join(`
`)}function ao(e,t){let n=new Blob(["\uFEFF"+t],{type:"text/csv;charset=utf-8"}),o=URL.createObjectURL(n),r=document.createElement("a");r.href=o,r.download=e.endsWith(".csv")?e:`${e}.csv`,document.body.appendChild(r),r.click(),r.remove(),URL.revokeObjectURL(o)}async function Ur(e,t){let n=new Blob(["\uFEFF"+t],{type:"text/csv;charset=utf-8"});if("showSaveFilePicker"in window){let r=await(await window.showSaveFilePicker({suggestedName:e.endsWith(".csv")?e:`${e}.csv`,types:[{description:"CSV",accept:{"text/csv":[".csv"]}}]})).createWritable();await r.write(n),await r.close()}else ao(e,t)}async function io(e,{filename:t,useImperial:n,formatLocal:o,delimiter:r=";",usePicker:s=!1}={}){let a=Rr(e,{useImperial:n,formatLocal:o,delimiter:r});s?await Ur(t,a):ao(t,a)}var Hr="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js";async function jr(){window.ExcelJS||await new Promise((e,t)=>{let n=document.createElement("script");n.src=Hr,n.async=!0,n.onload=()=>e(),n.onerror=o=>t(o),document.head.appendChild(n)})}function co(e){let t=Number(e);return Number.isFinite(t)?Number(t.toFixed(6)):null}function Zr(e,t){if(!Number.isFinite(e))return null;let n=e*3.6,o=n*.621371192;return Math.round(t?o:n)}function xe(e){return String(e||"").split(`
`).reduce((t,n)=>Math.max(t,n.length),0)}function qr(e,t){let n=[19,6,11,11,12,8,18,30],o=[40,10,16,16,16,10,50,80],r=t.map(s=>xe(s));for(let s of e)r[0]=Math.max(r[0],xe(s.date)),r[1]=Math.max(r[1],xe(s.stop)),r[2]=Math.max(r[2],xe(s.latStr)),r[3]=Math.max(r[3],xe(s.lonStr)),r[4]=Math.max(r[4],xe(s.speedStr)),r[5]=Math.max(r[5],xe(s.battStr)),r[6]=Math.max(r[6],xe(s.zone)),r[7]=Math.max(r[7],xe(s.address));return r.map((s,a)=>Math.min(o[a],Math.max(n[a],s+2)))}async function lo(e,{filename:t="ha-tracker.xlsx",useImperial:n=!1,formatLocal:o=s=>new Date(s).toLocaleString(),sheetName:r=l("positions")}={}){await jr();let s=window.ExcelJS,a=new s.Workbook,i=a.addWorksheet(r),c={name:"Verdana",size:9},d={vertical:"middle",horizontal:"left"},p=n?l("mi_per_hour"):l("km_per_hour"),m=[l("date"),l("stops"),l("latitude"),l("longitude"),p,l("battery"),l("zone"),l("address")],u=(e||[]).map(v=>{let N=o?o(v?.last_updated):v?.last_updated||"",b=v?.stop?l("stop"):"",_=co(v?.attributes?.latitude),A=co(v?.attributes?.longitude),D=Zr(Number(v?.attributes?.speed),n),I=Number.isFinite(v?.battery)?v.battery:null,R=v?.zone||"",H=(v?.address||"").replace(/\u00A0/g," ");return{date:N,stop:b,lat:_,lon:A,speed:D,batt:I,latStr:_==null?"":String(_),lonStr:A==null?"":String(A),speedStr:D==null?"":String(D),battStr:I==null?"":String(I),zone:R,address:H}}),h={type:"pattern",pattern:"solid",fgColor:{argb:"FF003E78"}},f={...c,bold:!0,color:{argb:"FFFFFFFF"}},y={...d,wrapText:!0};i.addRow(m);let g=i.getRow(1);g.height=18,g.font=f,g.alignment=y,g.eachCell(v=>{v.fill=h,v.font=f,v.alignment=y});for(let v of u){let N=i.addRow([v.date,v.stop,v.lat,v.lon,v.speed,v.batt,v.zone,v.address]);N.font=c,N.alignment=d}i.views=[{state:"frozen",ySplit:1}];let S=qr(u,m);i.columns=S.map((v,N)=>({width:v,style:{font:c,alignment:{...d,wrapText:N===7}}})),i.getRow(1).eachCell(v=>{v.font=f,v.alignment=y,v.fill=h});let k=await a.xlsx.writeBuffer(),E=new Blob([k],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),x=document.createElement("a");x.href=URL.createObjectURL(E),x.download=t.endsWith(".xlsx")?t:`${t}.xlsx`,document.body.appendChild(x),x.click(),x.remove(),URL.revokeObjectURL(x.href)}var Wr="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js",Vr="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js",Gr="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js",Et=[0,62,120],Xt=[255,255,255];function Qt(e){return new Promise((t,n)=>{if([...document.scripts].some(r=>r.src===e))return t();let o=document.createElement("script");o.src=e,o.async=!0,o.onload=()=>t(),o.onerror=r=>n(r),document.head.appendChild(o)})}async function Kr(){window.jspdf?.jsPDF&&window.jspdf?.autoTable||(await Qt(Wr),await Qt(Vr))}async function Jr(){window.html2canvas||await Qt(Gr)}async function Yr(){await Jr();let e=document.getElementById("map");return e?(await window.html2canvas(e,{useCORS:!0,backgroundColor:"#ffffff",logging:!1,scale:2})).toDataURL("image/jpeg",.92):null}function Xr(e,t=.25){let n=/^#?([0-9a-f]{6})$/i.exec(e||"");if(!n)return null;let o=parseInt(n[1],16),r=o>>16&255,s=o>>8&255,a=o&255,i=c=>Math.round((1-t)*255+t*c);return[i(r),i(s),i(a)]}function Qr(e,{customDefault:t="#0088ff",noCustomDefault:n="#c0c0c0"}={}){return e&&(typeof e.is_custom=="boolean"?e.is_custom:typeof e.custom=="boolean"?e.custom:!!e.color)?e.color||t:n}function en(e,t={},{alpha:n=.25,customDefault:o="#0088ff",noCustomDefault:r="#c0c0c0"}={}){if(!e)return null;let s=t[e],a=Qr(s,{customDefault:o,noCustomDefault:r});return Xr(a,n)}function mo(e=[]){let t=[],n=null;for(let o of e){let r=(o.zone||"").trim(),s=r!==n;(o.stop||s)&&t.push(o),n=r}return t}function uo(e,t,n,o,r,s,{font:a="helvetica",labelStyle:i="bold",valueStyle:c="normal",lineHeight:d=14}={}){e.setFont(a,i);let p=e.getTextWidth(r);e.setFont(a,c);let m=e.splitTextToSize(String(s||""),Math.max(20,o-p));e.setFont(a,i),e.text(r,t,n),e.setFont(a,c),e.text(m[0]||"",t+p,n);for(let u=1;u<m.length;u++)n+=d,e.text(m[u],t+p,n);return n+d}function es(e,{margin:t,pageW:n,personName:o,startLocal:r,endLocal:s,nameColor:a=[0,62,120]}){let i=n-t*2,c=t;e.setFont("helvetica","bold"),e.setFontSize(16),e.setTextColor(a[0],a[1],a[2]);let d=e.splitTextToSize(o||"",i);return e.text(d,t,c),c+=d.length*18,e.setFontSize(11),e.setTextColor(a[0],a[1],a[2]),c=uo(e,t,c,i,`${l("start")||"Inicio"}: `,r||"",{lineHeight:14,labelStyle:"bold",valueStyle:"normal"}),c=uo(e,t,c,i,`${l("end")||"Fin"}: `,s||"",{lineHeight:14,labelStyle:"bold",valueStyle:"normal"}),c+=6,c}function ts(e,t,n=.9){let o=e.internal.pageSize.getWidth(),r=o-t*2,s=Math.floor(r*n),a=t+Math.round((r-s)/2);return{tableWidth:s,left:a,pageW:o}}function ns(e){let t={date:.22,stop:.03,zone:.24,speed:.12,batt:.09,addr:.3},n={date:90,stop:12,zone:90,speed:54,batt:40,addr:90},o=Math.max(n.date,Math.floor(e*t.date)),r=Math.max(n.stop,Math.floor(e*t.stop)),s=Math.max(n.zone,Math.floor(e*t.zone)),a=Math.max(n.speed,Math.floor(e*t.speed)),i=Math.max(n.batt,Math.floor(e*t.batt)),c=Math.max(n.addr,Math.floor(e*t.addr)),d=o+r+s+a+i+c,p=e-d;return p!==0&&(c=Math.max(n.addr,c+p)),{wDate:o,wStop:r,wZone:s,wSpeed:a,wBatt:i,wAddr:c}}async function fo({filename:e,summaryRows:t,zonesRows:n,positionsRows:o,stopIconUrl:r,header:s}){await Kr();let{jsPDF:a}=window.jspdf,i=new a({unit:"pt",format:"a4",compress:!0}),c=i.internal.pageSize.getWidth(),d=36,p=ts(i,d,.9),m=null;if(r)try{let _=await(await fetch(r,{cache:"force-cache"})).blob();m=await new Promise(A=>{let D=new FileReader;D.onload=()=>A(D.result),D.readAsDataURL(_)})}catch{}let u=es(i,{margin:d,pageW:c,personName:s?.personName||"",startLocal:s?.startLocal||"",endLocal:s?.endLocal||"",nameColor:Et});try{let b=await Yr();if(b){let _=i.getImageProperties(b),A=p.tableWidth,D=_.height*A/_.width;i.addImage(b,"JPEG",p.left,u,A,D),u+=D+8}}catch(b){console.warn("No se pudo capturar el mapa:",b)}i.autoTable({head:[[l("metric")||"M\xE9trica",l("value")||"Valor"]],body:(t||[]).map(b=>[b.label,b.value]),startY:u,theme:"grid",tableWidth:p.tableWidth,margin:{left:p.left,right:p.left},styles:{font:"helvetica",fontSize:10,cellPadding:4,overflow:"linebreak"},headStyles:{fillColor:Et,textColor:Xt,fontStyle:"bold",halign:"left"},columnStyles:{0:{cellWidth:170,fontStyle:"bold"},1:{cellWidth:p.tableWidth-170}}}),u=i.lastAutoTable.finalY+8;{let b=!!St,_=100,A=60,D=60,I=60,R=_+D+I+(b?A:0),H=Math.max(160,p.tableWidth-R),P=[{key:"zone",header:l("zone")||"Zona",width:H,halign:"left"},{key:"time",header:l("time")||"Tiempo",width:_,halign:"center"}];b&&P.push({key:"visits",header:l("visits")||"Visitas",width:A,halign:"center"}),P.push({key:"stops",header:l("stops")||"Paradas",width:D,halign:"center"},{key:"distance",header:l("distance")||"Distancia",width:I,halign:"center"});let M=[P.map(j=>j.header)],W=(n||[]).map(j=>P.map(z=>z.key==="distance"?os(j):z.key==="stops"||z.key==="visits"?String(j[z.key]??""):j[z.key]||"")),le=P.reduce((j,z,de)=>(j[de]={cellWidth:z.width,halign:z.halign},j),{});i.autoTable({head:M,body:W,startY:u,theme:"grid",tableWidth:p.tableWidth,margin:{left:p.left,right:p.left},styles:{font:"helvetica",fontSize:10,cellPadding:4,overflow:"linebreak"},headStyles:{fillColor:Et,textColor:Xt,fontStyle:"bold",halign:"left"},columnStyles:le,didParseCell:j=>{if(j.section==="body"){let z=n[j.row.index];z?._fillColor&&(j.cell.styles.fillColor=z._fillColor)}}}),u=i.lastAutoTable.finalY+8}let{wDate:h,wStop:f,wZone:y,wSpeed:g,wBatt:S,wAddr:k}=ns(p.tableWidth),x=(o||[]).some(b=>/\bmph\b/i.test(String(b.speed||"")))?`${l("speed")||"Velocidad"} (${l("mi_per_hour")||"mph"})`:`${l("speed")||"Velocidad"} (${l("km_per_hour")||"km/h"})`,v=(o||[]).map(b=>[b.whenLocal||"","",b.zone||"",b.speed||"",(b.battery??"")===""?"":`${b.battery}%`,(b.address||"").replace(/\u00A0/g," ")]);i.autoTable({head:[[l("date")||"Fecha/Hora","",l("zone")||"Zona",x,l("battery")||"Bater\xEDa",l("address")||"Direcci\xF3n"]],body:v,startY:u,theme:"grid",tableWidth:p.tableWidth,margin:{left:p.left,right:p.left},styles:{font:"helvetica",fontSize:9,cellPadding:{top:3,right:3,bottom:3,left:3},halign:"left",valign:"top",overflow:"linebreak",cellWidth:"wrap"},headStyles:{fillColor:Et,textColor:Xt,fontStyle:"bold",halign:"left"},columnStyles:{0:{cellWidth:h},1:{cellWidth:f,halign:"center"},2:{cellWidth:y},3:{cellWidth:g,halign:"center"},4:{cellWidth:S,halign:"center"},5:{cellWidth:k}},didParseCell:b=>{if(b.section==="body"){let _=o[b.row.index];_?._fillColor&&(b.cell.styles.fillColor=_._fillColor)}},didDrawCell:b=>{if(b.section==="body"&&b.column.index===1&&m&&o[b.row.index]?.isStop){let D=b.cell.x+(b.cell.width-10)/2,I=b.cell.y+(b.cell.height-10)/2;try{i.addImage(m,"PNG",D,I,10,10)}catch{}}},pageBreak:"auto"});let N=e?.endsWith(".pdf")?e:`${e||"export"}.pdf`;i.save(N)}function os(e){if(!e)return"";if(e.distance!=null&&e.distance!=="")return String(e.distance);let t=Number(e.distanceMeters??e.meters??NaN);return Number.isFinite(t)?`${((e._unitShort==="mi"||e._unitShort==="km"?e._unitShort:"km")==="mi"?t/1609.344:t/1e3).toFixed(0)}`:""}var Ct=[],We=null,ie=null,_t="zone",Ee=!0,St=!1,rs="/local/ha-tracker/images/filter.png",ss="/local/ha-tracker/images/stop16x16.png",yo="/local/ha-tracker/images/stop24x24.png",ce=e=>String(e).padStart(2,"0");document.getElementById("combo-select").addEventListener("change",function(){kt()});function bo(){let e=document.querySelector('.tab-button[data-tab="positions"]');e&&wo({currentTarget:e},"positions")}function wo(e,t){document.querySelectorAll(".tab").forEach(n=>n.classList.remove("active")),document.querySelectorAll(".tab-button").forEach(n=>n.classList.remove("active")),document.getElementById(t).classList.add("active"),e.currentTarget.classList.add("active")}async function vo(){st(!1),hs(),vt();let e=document.getElementById("person-select");e.addEventListener("focus",async()=>{try{await Wt()}catch(n){console.error(n)}}),e.addEventListener("change",()=>{try{kt(!0,!1),qt(document.getElementById("person-select").value),vt(),st(!1)}catch(n){console.error(n)}}),document.querySelectorAll(".tab-button").forEach(n=>{n.addEventListener("click",o=>{try{let r=n.getAttribute("data-tab");wo(o,r)}catch(r){console.error(r)}})}),await Xn({onApplyFilter:()=>Eo().catch(console.error)})}async function xo(e){try{let t=Array.isArray(e)?e:e?.positions||[],n=Array.isArray(e)?null:e?.summary||null,o=Array.isArray(e)?null:e?.zones||null;t.length>0?(console.log("Positions:",t),await kt(!1,!1),await as(t),n&&cs(n),o&&ls(o),await Co(),await ds(t),await ms(t,void 0,void 0,void 0,void 0,void 0,{curved:!0,curveAlg:"catmull",subdivisions:6,alpha:.5}),st(!0)):(kt(!0,!1),st(!1),F(l("no_positions"),{title:l("filter")}))}catch(t){console.error("Error getting filtered positions:",t),F(l("filter_problem"),{title:l("filter")})}}async function as(e){let t=document.getElementById("filter-table-body");if(!e||e.length===0)return;let n=[],o=null,r=0;e.forEach((m,u)=>{let h=ye(m.attributes.latitude,m.attributes.longitude),f=h?h.name:"";u===0?(o=f,r=0):f!==o&&(n.push({start:r,end:u-1}),o=f,r=u),u===e.length-1&&n.push({start:r,end:u})});let s=_s(),a=null,i=0,c=!1,d=document.createDocumentFragment();if(e.forEach(m=>{let u=ye(m.attributes.latitude,m.attributes.longitude),h=u?u.name:"";h!==a?(i++,a=h,c=!0):c=!1;let f=`group-${i}`,y=m?.stop?`<img src="${ss}" alt="" style="width:16px;height:16px;">`:"",g=ee(m.last_updated),S=Math.round((m.attributes.speed||0)*(T?2.23694:3.6)),k=Z(S),E=`${m.entity_id}_${new Date(m.last_updated).toISOString()}`,x=document.createElement("tr");if(tn(x,u,se),x.classList.add(f,"pos-main-row"),x.dataset.entityId=E,x.dataset.latitude=m.attributes.latitude,x.dataset.longitude=m.attributes.longitude,x.dataset.lastUpdated=m.last_updated,x.dataset.speed=String(S),x.dataset.battery=(bs(m?.attributes)??"").toString(),x.dataset.isStop=m&&m.stop?"1":"0",x.dataset.entity=m?.entity_id||"",x.dataset.zone=h||"",x.dataset.address="",x.style.cursor="pointer",c){let v=n[i-1],N=new Date(e[v.start].last_updated),b=new Date(e[v.end].last_updated),_=new Date(b.getTime()+1e3),A=po(N),D=po(_);x.classList.add("group-header"),x.innerHTML=`
				<td><button class="toggle-btn">\u25BA</button></td>
				<td>${y}</td>
				<td>${g}</td>
				<td>${h}</td>
				<td>${k}</td>
				<td>
				  <button class="group-filter-btn" title="${l("filter")||"Filtrar"}"
						  style="background:none;border:none;cursor:pointer;padding:0;line-height:0;">
						  <img src="${rs}" alt="" style="width:16px;height:16px;">
				  </button>
				</td>
			  `;let I=x.querySelector(".toggle-btn");I.addEventListener("click",H=>{H.stopPropagation(),So(f,I)}),x.querySelector(".group-filter-btn").addEventListener("click",async H=>{H.stopPropagation();try{let[P,M="00:00:00"]=A.split("T"),[W,le="23:59:59"]=D.split("T"),j=z=>{let[de,Y,Ve]=z.split("-").map(Number);return new Date(de,Y-1,Ve,0,0,0,0)};bt(M,le),Jt([j(P),j(W)],!0),await Eo()}catch(P){console.error("No se pudo aplicar el rango al calendario",P)}})}else m&&m.stop?(x.style.display="table-row",x.classList.add("pin-visible")):x.style.display="none",x.innerHTML=`
				<td></td>
				<td>${y}</td>
				<td>${g}</td>
				<td>${h}</td>
				<td>${k}</td>
				<td></td>
			  `;if(x.onclick=()=>Lt(x),d.appendChild(x),m&&m.stop){x.classList.add("has-address");let v=document.createElement("tr");v.dataset.address="",v.classList.add(f,"position-address-row","pin-visible"),v.style.cursor="pointer",v.dataset.entityId=E,v.style.display="table-row";let N=new Date(m.last_updated).getTime();v.dataset.latitude=String(+m.attributes.latitude),v.dataset.longitude=String(+m.attributes.longitude),v.dataset.lastUpdated=String(N),v.innerHTML=`
        <td class="addr-spacer"></td>
        <td class="addr-cell" colspan="5" style="padding:4px 8px;">\u2026</td>
      `,v.onclick=()=>Lt(x),d.appendChild(v),tn(v,u,se),s.observe(v)}}),t.innerHTML="",t.appendChild(d),e.length>0){let m=t.querySelector("tr");m&&Lt(m)}t.querySelectorAll(".group-header").forEach(m=>{let u=Array.from(m.classList).find(k=>k.startsWith("group-"));if(!u)return;let h=t.querySelectorAll(`tr.${u}:not(.group-header):not(.pin-visible)`),f=h.length>0,y=f&&Array.from(h).some(k=>k.style.display==="none"),g=m.querySelector(".toggle-btn"),S=m.querySelector(".group-filter-btn");g&&(g.style.display=f?"":"none",g.textContent=y?"\u25BA":"\u25BC"),S&&(S.style.display=f?"":"none")})}function is(){let e=document.getElementById("filter-table-body");if(!e)return;let t=Array.from(e.querySelectorAll("tr.pos-main-row"));if(!t.length)return;let n=null;for(let o of t){let r=Number(o.dataset.speed)||0,s=Date.parse(o.dataset.lastUpdated)||0;(!n||r>n.s||r===n.s&&s>n.ts)&&(n={id:o.dataset.entityId,s:r,ts:s})}n&&n.id?Lo(n.id):F(l("no_positions")||"No hay posiciones.",{title:l("filter")})}function cs(e){let t=T?2.23694:3.6,n=T?e.distance_m/1609.344:e.distance_m/1e3,o=s=>rn(s*1e3);document.getElementById("positions-count").textContent=Z(e.positions_count),document.getElementById("total-time").textContent=o(e.total_time_s),document.getElementById("distance").textContent=`${on(n)} ${l(T?"miles":"kilometres")}`,document.getElementById("max-speed").textContent=`${Z(e.max_speed_mps*t)} ${l(T?"mi_per_hour":"km_per_hour")}`,document.getElementById("average-speed").textContent=`${on(e.average_speed_mps*t)} ${l(T?"mi_per_hour":"km_per_hour")}`,document.getElementById("stops-count").textContent=Z(e.stops_count),document.getElementById("stopped-time").textContent=o(e.stopped_time_s);let r=document.querySelector("#summary table tbody tr:nth-child(4)");r&&(r.style.cursor="pointer",r.title=l("go_to_max_speed")||"Ir a la posici\xF3n de velocidad m\xE1xima",r.onclick=is)}function ls(e){ie={zoneDurations:{},zoneVisits:{},zonePositions:{},zoneStops:{},zoneDistanceMeters:{}};for(let t of e){let n=t.zone||"";ie.zoneDurations[n]=(t.time_s||0)*1e3,ie.zoneVisits[n]=t.visits||0,ie.zoneStops[n]=t.stops||0,ie.zoneDistanceMeters[n]=t.distance_m||0,t.meta&&(ie.zonePositions[n]={id:t.meta.id,name:t.meta.name||n,lat:t.meta.latitude,lon:t.meta.longitude,color:t.meta.color||null,custom:!!t.meta.is_custom,is_custom:!!t.meta.is_custom})}}async function ds(e){w.getPane("filterMarkers")||(w.createPane("filterMarkers"),w.getPane("filterMarkers").style.zIndex=400);let t=18;e.forEach(n=>{let o=Number(n?.attributes?.latitude),r=Number(n?.attributes?.longitude);if(!Number.isFinite(o)||!Number.isFinite(r))return;let s=n.stop?L.icon({iconUrl:yo,iconSize:[24,24],iconAnchor:[12,12]}):L.divIcon({className:"",html:`<div style="
            width:10px;height:10px;border:1px solid rgba(0,0,255,0.8);
            border-radius:50%;background-color: rgba(0,0,255,0.5);
          "></div>`,iconSize:[10,10],iconAnchor:[5,5]}),a=L.marker([o,r],{icon:s,pane:"filterMarkers"});a.isStop=!!n.stop,(n.stop||w.getZoom()>=t)&&a.addTo(w),n.stop&&a.setZIndexOffset(50),a.on("click",()=>{let i=`${n.entity_id}_${new Date(n.last_updated).toISOString()}`;Lo(i)}),Ct.push(a)}),$t||(w.on("zoomend",nn),$t=!0),nn()}async function Eo(){let e=document.getElementById("person-select").value,{startLocal:t,endLocal:n}=wt();if(!e){F(l("select_user_filter"),{title:l("filter")}),rt();return}if(!t||!n){F(l("select_dates"),{title:l("filter")});return}let o=ho(t,!1),r=ho(n,!n.includes("T"));if(!o||!r){F(l("select_dates"),{title:l("filter")});return}let s=Date.parse(o),a=Date.parse(r);if(!Number.isFinite(s)||!Number.isFinite(a)||s>=a){F(l("invalid_dates"),{title:l("filter")}),rt();return}let i=744*60*60*1e3;if(a-s>i){F(l("date_range"),{title:l("filter")}),rt();return}dt(l("running_filter"));try{await ko(e,o,r)}catch(c){console.error("Error during filter:",c),F(l("filter_error"),{title:l("filter")})}finally{ut()}}async function kt(e=!0,t=!0){if(e&&rt(),t){let n=document.getElementById("person-select");n.value="",n.dispatchEvent(new Event("change",{bubbles:!0}))}if(us(),bo(),document.getElementById("filter-table-body").innerHTML="",document.getElementById("positions-count").textContent="--",document.getElementById("total-time").textContent="--",document.getElementById("distance").textContent="--",document.getElementById("max-speed").textContent="--",document.getElementById("average-speed").textContent="--",document.getElementById("stops-count").textContent="--",document.getElementById("stopped-time").textContent="--",document.getElementById("summary-zones-table-body").innerHTML="",Ct.forEach(n=>{try{w.removeLayer(n)}catch{}}),Ct=[],window.routeLineSegments&&(window.routeLineSegments.forEach(n=>{try{w.removeLayer(n)}catch{}}),window.routeLineSegments=[]),window.routeOutline){try{w.removeLayer(window.routeOutline)}catch{}window.routeOutline=null}$t&&(w.off("zoomend",nn),$t=!1),Te&&(Te.disconnect(),Te=null),vt(),st(!1)}async function So(e,t){let n=document.querySelectorAll(`tr.${e}:not(.group-header):not(.pin-visible)`);if(!n.length){t.textContent=t.textContent==="\u25BA"?"\u25BC":"\u25BA";return}let o=n[0].style.display==="none";n.forEach(r=>{r.style.display=o?"table-row":"none"}),t.textContent=o?"\u25BC":"\u25BA",o&&queueMicrotask(()=>{let r="#filter-table-body",s=document.querySelector(`${r} tr.${e}.selected`);if(s&&s.classList.contains("position-address-row")){let a=s.previousElementSibling;a&&a.classList.contains("pos-main-row")&&(s=a)}s||(s=document.querySelector(`${r} tr.${e}:not(.group-header)`)),s&&s.scrollIntoView({behavior:"smooth",block:"center"})})}async function Lt(e){document.querySelectorAll("#filter-table-body tr").forEach(c=>c.classList.remove("selected")),e.classList.add("selected");let n=e.nextElementSibling;n&&n.classList.contains("position-address-row")&&n.classList.add("selected");let o=parseFloat(e.dataset.latitude),r=parseFloat(e.dataset.longitude),s=e.dataset.lastUpdated,a=Math.round(e.dataset.speed||0),i=e.dataset.isStop==="1";_o(o,r,s,a,i)}function _o(e,t,n,o,r=!1){let s=`https://www.google.com/maps/search/?api=1&query=${e},${t}`,i=`
	  ${r?`<strong>${l("stop")||"Stop"}</strong><br>`:""}
	  ${ee(n)}<br>${l("speed")}: ${Z(o)} ${l(T?"mi_per_hour":"km_per_hour")}
	  <br><br><a href="${s}" target="_blank" rel="noopener noreferrer"><strong>${l("open_location")}</strong></a>
	`;We&&We.remove(),We=L.popup({autoPan:!0}).setLatLng([e,t]).setContent(i).openOn(w),w.invalidateSize(),w.setView([e,t],w.getZoom())}function us(){We&&(We.remove(),We=null)}async function Lo(e){let t=document.getElementById("filter-table-body");if(!t){console.error("Filter table tbody not found.");return}let n=t.querySelector(`tr[data-entity-id="${e}"]`);if(!n){console.error("Row not found for position:",e);return}let o=getComputedStyle(n).display==="none"||n.style.display==="none",r=[...n.classList].find(m=>m.startsWith("group-"));if(!r){console.error("The row does not belong to any group:",n);return}if(o){let m=document.querySelector(`tr.${r}.group-header`);if(m){let u=m.querySelector(".toggle-btn");u&&So(r,u)}}let s=document.getElementById("combo-select");if(s&&s.value!=="filter"){s.value="filter";let m=new Event("change",{bubbles:!0});s.dispatchEvent(m)}Lt(n),bo();let a=parseFloat(n.dataset.latitude),i=parseFloat(n.dataset.longitude),c=n.dataset.lastUpdated,d=Math.round(n.dataset.speed||0),p=n.dataset.isStop==="1";_o(a,i,c,d,p),n.scrollIntoView({behavior:"smooth",block:"center"})}async function ms(e,t=[0,200,0,.8],n=[100,100,255,.8],o="#ffffff",r=9,s=6,a={}){let{curved:i=!1,curveAlg:c="catmull",subdivisions:d=8,alpha:p=.5}=a;if(!e||e.length<2)return;let m=e.map(h=>h.attributes.latitude&&h.attributes.longitude?[h.attributes.latitude,h.attributes.longitude]:null).filter(Boolean);if(m.length<2)return;if(i&&c==="catmull"){let y=(m.length-1)*d>4e3?Math.max(1,Math.floor(4e3/Math.max(m.length-1,1))):d;m=fs(m,y,p)}if(window.routeLineSegments&&window.routeLineSegments.forEach(h=>{try{w.removeLayer(h)}catch{}}),window.routeLineSegments=[],window.routeOutline){try{w.removeLayer(window.routeOutline)}catch{}window.routeOutline=null}w.getPane("routeOutline")||w.createPane("routeOutline"),w.getPane("routeColor")||w.createPane("routeColor"),w.getPane("routeOutline").style.zIndex=390,w.getPane("routeColor").style.zIndex=391;let u=m.length-1;for(let h=0;h<u;h++){let f=h/u,y=Math.round(t[0]+f*(n[0]-t[0])),g=Math.round(t[1]+f*(n[1]-t[1])),S=Math.round(t[2]+f*(n[2]-t[2])),k=t[3]+f*(n[3]-t[3]),E=`rgba(${y},${g},${S},${k})`,x=m[h],v=m[h+1],N=L.polyline([x,v],{color:o,weight:r,opacity:1,lineCap:"round",lineJoin:"round",pane:"routeOutline"}).addTo(w);window.routeLineSegments.push(N);let b=L.polyline([x,v],{color:E,weight:s,opacity:1,lineCap:"round",lineJoin:"round",pane:"routeColor"}).addTo(w);window.routeLineSegments.push(b)}w.fitBounds(L.latLngBounds(m))}function fs(e,t=8,n=.5){let r=e.map(c=>[Number(c[0]),Number(c[1])]).filter(c=>Number.isFinite(c[0])&&Number.isFinite(c[1]));if(r.length<2)return r;let s=[],a=(c,d,p)=>[c[0]+(d[0]-c[0])*p,c[1]+(d[1]-c[1])*p],i=(c,d)=>Math.pow(Math.hypot(d[0]-c[0],d[1]-c[1])||1e-6,n);s.push(r[0]);for(let c=0;c<r.length-1;c++){let d=c>0?r[c-1]:r[c],p=r[c],m=r[c+1],u=c+2<r.length?r[c+2]:r[c+1],h=0,f=h+i(d,p),y=f+i(p,m),g=y+i(m,u);for(let k=1;k<=t;k++){let E=f+k*(y-f)/t,x=a(d,p,(E-h)/(f-h+1e-6)),v=a(p,m,(E-f)/(y-f+1e-6)),N=a(m,u,(E-y)/(g-y+1e-6)),b=a(x,v,(E-h)/(y-h+1e-6)),_=a(v,N,(E-f)/(g-f+1e-6)),A=a(b,_,(E-f)/(y-f+1e-6)),D=s[s.length-1];(!D||Math.hypot(A[0]-D[0],A[1]-D[1])>1e-6)&&s.push(A)}let S=s[s.length-1];(!S||Math.hypot(m[0]-S[0],m[1]-S[1])>1e-6)&&s.push(m)}return s}async function Co(){let e=document.getElementById("summary-zones-table-body");if(!ie){console.error("There are no saved statistics for zones. Make sure to apply the filter first.");return}let{zoneDurations:t,zoneVisits:n,zonePositions:o,zoneStops:r,zoneDistanceMeters:s}=ie,c=[...new Set([...Object.keys(t||{}),...Object.keys(n||{}),...Object.keys(r||{}),...Object.keys(s||{})])].sort((d,p)=>{switch(_t){case"zone":return Ee?d.localeCompare(p):p.localeCompare(d);case"time":return Ee?(t?.[d]||0)-(t?.[p]||0):(t?.[p]||0)-(t?.[d]||0);case"visits":return Ee?(n?.[d]||0)-(n?.[p]||0):(n?.[p]||0)-(n?.[d]||0);case"stops":return Ee?(r?.[d]||0)-(r?.[p]||0):(r?.[p]||0)-(r?.[d]||0);case"distance":return Ee?(s?.[d]||0)-(s?.[p]||0):(s?.[p]||0)-(s?.[d]||0);default:return 0}});e.innerHTML="";for(let d of c){let p=t?.[d]||0,m=n?.[d]||0,u=r?.[d]||0,h=s?.[d]||0,f=T?h/1609.344:h/1e3,y=`${Z(f)}`,g=d,S=document.createElement("tr");S.style.cursor="pointer",S.innerHTML=`
            <td>${g}</td>
            <td>${rn(p)}</td>
            <td>${Z(m)}</td>
            <td>${Z(u)}</td>
            <td>${y}</td>
        `,S.addEventListener("click",()=>{let E=o[d];E&&Mn(E.id)});let k=o[d];if(d&&k){let E={name:d,color:k.color,custom:k.custom,is_custom:k.custom};tn(S,E,se)}else S.classList.remove("zone-tinted"),S.style.removeProperty("--color-bg");e.appendChild(S)}ps()}function ps(){let e=document.querySelector("#summary-zones-table");if(!e){console.error("Zone summary table not found.");return}e.querySelectorAll("thead th").forEach(n=>{let o=n.getAttribute("data-i18n"),r="";switch(o){case"zone":r="zone";break;case"time":r="time";break;case"visits":r="visits";break;case"stops":r="stops";break;case"distance":r="distance";break}if(!r)return;n.style.cursor="pointer",n.onclick=()=>{_t===r?Ee=!Ee:(_t=r,Ee=!0),Co()};let s=_t===r?Ee?"\u25B2":"\u25BC":"",a=o==="distance"?T?l("miles"):l("kilometres"):l(o);n.innerHTML=`
            <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:30px;">
                <span class="hdr-label">${a}</span>
                <span class="hdr-arrow" style="font-size:12px;">${s}</span>
            </div>`})}function hs(){if(document.getElementById("zone-tint-css"))return;let e=document.createElement("style");e.id="zone-tint-css",e.textContent=`
		/* Aplica tinte solo si la fila NO est\xE1 seleccionada */
		#filter-table-body tr.zone-tinted:not(.selected),
		#summary-zones-table-body tr.zone-tinted:not(.selected) {
		  background-color: var(--color-bg);
		}
	  `,document.head.appendChild(e)}function tn(e,t,n=se){if(!(!!t&&(t.name??"")!=="")){e.classList.remove("zone-tinted"),e.style.removeProperty("--color-bg");return}let r=ys(t,n);r?(e.classList.add("zone-tinted"),e.style.setProperty("--color-bg",r)):(e.classList.remove("zone-tinted"),e.style.removeProperty("--color-bg"))}function gs(e){return e?typeof e.is_custom=="boolean"?e.is_custom:typeof e.custom=="boolean"?e.custom:!!e.color:!1}function ys(e,t=se){if(!e)return null;let n=gs(e)?e.color||U:me;return he(n,t)}function rn(e){let t=Math.floor(e/1e3),n=Math.floor(t/(24*3600)),o=Math.floor(t%(24*3600)/3600),r=Math.floor(t%3600/60),s=t%60;return`${n>0?`${n} ${n===1?l("day"):l("days")} `:""}${String(o).padStart(2,"0")}:${String(r).padStart(2,"0")}:${String(s).padStart(2,"0")}`}function po(e){return`${e.getFullYear()}-${ce(e.getMonth()+1)}-${ce(e.getDate())}T${ce(e.getHours())}:${ce(e.getMinutes())}:${ce(e.getSeconds())}`}function ho(e,t=!1){if(!e)return null;let n=e.match(/\d+/g)?.map(Number);if(!n||n.length<3)return null;let[o,r,s]=n,a=0,i=0,c=0,d=0;return n.length>=5?(a=n[3],i=n[4],c=n[5]??0):t&&(a=23,i=59,c=59,d=999),new Date(o,r-1,s,a,i,c,d).toISOString()}function st(e){let t=document.getElementById("export-filter"),n=t?.closest(".group");!n||!t||(n.style.display=e?"":"none",t.disabled=!e,n.setAttribute("aria-hidden",e?"false":"true"))}function bs(e){if(!e||typeof e!="object")return null;let t=["battery","battery_level","battery_percent","battery_percentage","battery_level_pct","batteryLevel"],n=null;for(let o of t)if(o in e){n=e[o];break}if(n==null)return null;if(typeof n=="string"){let o=n.match(/(\d+(?:\.\d+)?)\s*%?/);o&&(n=Number(o[1]))}return n=Number(n),Number.isFinite(n)?n>0&&n<=1?Math.round(n*100):n>=1&&n<=100?Math.round(n):null:null}function Tt(){let e=document.getElementById("filter-table-body");if(!e)return[];let t=Array.from(e.querySelectorAll("tr.pos-main-row")),n=[];for(let o of t){let r=Number(o.dataset.latitude),s=Number(o.dataset.longitude);if(!Number.isFinite(r)||!Number.isFinite(s))continue;let a=o.dataset.lastUpdated,i=o.dataset.isStop==="1",c=o.dataset.entity||"",d=o.dataset.zone||"";if(!d&&typeof ye=="function")try{d=ye(r,s)?.name||""}catch{}let p=o.dataset.address||"";if(!p&&i){let f=o.nextElementSibling;if(f&&f.classList.contains("position-address-row")){let g=((f.querySelector("td.addr-cell")||f.querySelector("td"))?.textContent||"").trim();g&&g!=="\u2026"&&(p=g)}}let m=Number(o.dataset.speed),u=null;Number.isFinite(m)&&(u=(T?m*1.609344:m)/3.6);let h=o.dataset.battery&&Number.isFinite(Number(o.dataset.battery))?Number(o.dataset.battery):null;n.push({entity_id:c,last_updated:a,stop:i,zone:d,address:p,battery:h,attributes:{latitude:r,longitude:s,speed:u}})}return n}function go(e){if(!e)return"unknown";let t=e.match(/\d+/g)?.map(Number);if(!t||t.length<3)return"unknown";let[n,o,r,s=0,a=0]=t;return e.includes("T")?`${n}-${ce(o)}-${ce(r)}_${ce(s)}-${ce(a)}`:`${n}-${ce(o)}-${ce(r)}`}function ws(e){return String(e).normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[\\/:*?"<>|]/g,"").trim().replace(/\s+/g,"_")}function Mt(e="kml"){let t=document.getElementById("person-select"),n=ws(t?.selectedOptions?.[0]?.text||t?.value||"person"),{startLocal:o,endLocal:r}=wt();return`${n}_${go(o)}_${go(r)}.${e}`}document.getElementById("export-filter")?.addEventListener("change",e=>{let t=e.target.value;t==="export-kml"?vs():t==="export-csv"?xs():t==="export-xlsx"?Es():t==="export-pdf"&&Ss(),e.target.value="export-file"});function vs(){let e=Tt();if(!e.length){F(l("no_positions"),{title:"KML"});return}let t=Mt("kml");oo(e,{filename:t,stopIconHref:new URL(yo,window.location.origin).href,includeRoute:!0,nameStop:n=>`${ee(n.last_updated)}`,describeStop:n=>{let o=Math.round((n?.attributes?.speed||0)*(T?2.23694:3.6)),r=l(T?"mi_per_hour":"km_per_hour"),s=Number.isFinite(n?.battery)?`${n.battery}%`:"";return`<table cellspacing="0" cellpadding="0" style="border-collapse:collapse">
        ${n.zone?`<tr><td>\u25CF ${n.zone}</td></tr>`:""}
        ${n.address?`<tr><td>\u25CF ${n.address}</td></tr>`:""}
        <tr><td>\u25CF ${o} ${r}</td></tr>
		${s?`<tr><td>\u25CF ${l("battery")}: ${s}</td></tr>`:""}
      </table>`},formatLocal:n=>ee(n),unitLabel:l(T?"mi_per_hour":"km_per_hour"),batteryLabel:l("battery")})}function xs(){let e=Tt();if(!e.length){F(l("no_positions"),{title:"CSV"});return}let t=Mt("csv");io(e,{filename:t,useImperial:!!T,formatLocal:n=>ee(n),delimiter:";",usePicker:!1})}async function Es(){let e=Tt();if(!e.length){F(l("no_positions")||"No hay posiciones para exportar.",{title:"Excel"});return}let t=Mt("xlsx");await lo(e,{filename:t,useImperial:!!T,formatLocal:n=>ee(n),sheetName:"Posiciones"})}async function Ss(){let e=Tt();if(!e.length){F(l("no_positions"),{title:"PDF"});return}let t=[{label:l("positions"),value:document.getElementById("positions-count")?.textContent||""},{label:l("total_time"),value:document.getElementById("total-time")?.textContent||""},{label:l("distance"),value:document.getElementById("distance")?.textContent||""},{label:l("max_speed"),value:document.getElementById("max-speed")?.textContent||""},{label:l("average_speed"),value:document.getElementById("average-speed")?.textContent||""},{label:l("stops_count"),value:document.getElementById("stops-count")?.textContent||""},{label:l("stopped_time"),value:document.getElementById("stopped-time")?.textContent||""}],n=[],o=ie?.zonePositions||{};if(ie){let{zoneDurations:h,zoneVisits:f,zoneStops:y,zoneDistanceMeters:g}=ie,k=[...new Set([...Object.keys(h||{}),...Object.keys(g||{})])].sort((x,v)=>x.localeCompare(v)),E=T?"mi":"km";for(let x of k){let v=h?.[x]||0,N=f?.[x]||0,b=y?.[x]||0,_=g?.[x]||0,A=T?_/1609.344:_/1e3,D=`${Z(A)} ${E}`;n.push({zone:x,time:rn(v),visits:N,stops:b,distance:D,_unitShort:E,_fillColor:en(x,o,{alpha:.25,customDefault:U,noCustomDefault:me})})}}let r=mo(e),s=l(T?"mi_per_hour":"km_per_hour")||(T?"mph":"km/h"),a=r.map(h=>{let f=Math.round((h?.attributes?.speed||0)*(T?2.23694:3.6));return{whenLocal:ee(h.last_updated),isStop:!!h.stop,zone:h.zone||"",speed:Number.isFinite(f)?`${f} ${s}`:"",battery:Number.isFinite(h?.battery)?h.battery:"",address:h.address||"",_fillColor:h.zone?en(h.zone,o,{alpha:.25,customDefault:U,noCustomDefault:me}):null}}),i=document.getElementById("person-select"),c=i?.selectedOptions?.[0]?.text?.trim()||i?.value?.trim()||"\u2014",{startLocal:d,endLocal:p}=wt()||{};d&&(d=ee(d)),p&&(p=ee(p));let m={personName:c,startLocal:d,endLocal:p},u=Mt("pdf");await fo({filename:u,summaryRows:t,zonesRows:n,positionsRows:a,stopIconUrl:new URL("/local/ha-tracker/images/stop16x16.png",window.location.origin).href,header:m})}var Te=null;function _s(){if(Te)return Te;let e=document.querySelector("#positions .table-wrapper")||null;return Te=new IntersectionObserver(t=>{for(let n of t){if(!n.isIntersecting)continue;let o=n.target;Te.unobserve(o);let r=o.dataset.entityId,s=Number(o.dataset.latitude),a=Number(o.dataset.longitude),i=Number(o.dataset.lastUpdated);if(!(Number.isFinite(s)&&Number.isFinite(a)&&Number.isFinite(i)))continue;let c=o.querySelector("td.addr-cell")||o.querySelector("td");c&&c.textContent!=="\u2026"&&(c.textContent="\u2026"),et(r,s,a,i,d=>{let p=document.querySelector(`tr.position-address-row[data-entity-id="${r}"] td.addr-cell`)||document.querySelector(`tr.position-address-row[data-entity-id="${r}"] td`);p&&(p.textContent=d||"")})}},{root:e,rootMargin:"200px"}),Te}var $t=!1;function nn(){let e=w.getZoom();Ct.forEach(t=>{if(!t.isStop){let n=w.hasLayer(t);e>=18&&!n?t.addTo(w):e<18&&n&&w.removeLayer(t)}})}async function te(e,{method:t="GET",headers:n={},body:o,timeoutMs:r=15e3}={},s=!0){let a=new AbortController,i=setTimeout(()=>a.abort("timeout"),r);try{let c;if(s){if(c=await un(),!c||!c.trim())throw new Error("Invalid token.");n={...n,Authorization:`Bearer ${c}`}}let d={method:t,headers:n,signal:a.signal,cache:"no-store"};t!=="GET"&&o!==void 0&&(d.body=o,!(o instanceof FormData)&&!(o instanceof Blob)&&!(o instanceof ArrayBuffer)&&(d.headers={"Content-Type":"application/json",...n}));let p=await fetch(e,d),m=p.status,u=Number(p.headers.get("Retry-After")),h=(p.headers.get("content-type")||"").toLowerCase();if(m===202){if(h.includes("application/json"))try{return await p.json()??{error:"queued",retry_after:Number.isFinite(u)?u:1.5}}catch{return{error:"queued",retry_after:Number.isFinite(u)?u:1.5}}return{error:"queued",retry_after:Number.isFinite(u)?u:1.5}}if(m===204)return null;if(!p.ok){let y=await p.text().catch(()=>""),g=new Error(`Error HTTP: ${m} - ${y}`);throw g.status=m,Number.isFinite(u)&&(g.retry_after=u),g}if(h.includes("application/json"))return await p.json();let f=await p.text();return f||null}catch(c){throw console.error("Error in fetchData:",c),c}finally{clearTimeout(i)}}async function On(e,t){if(!Number.isFinite(Number(e))||!Number.isFinite(Number(t)))throw new Error("latitude and longitude must be finite numbers.");let n=new URL(`${B}/api/ha_tracker/reverse_geocode`);n.searchParams.set("lat",String(e)),n.searchParams.set("lon",String(t)),n.searchParams.set("nowait","1"),n.searchParams.set("brief","1");try{return await te(n.toString(),{timeoutMs:15e3})}catch(o){throw console.error("Error getting reverse geocode:",o),o}}async function $o(){try{let e=`${B}/manifest.json`;return await te(e,{method:"GET"},!1)}catch(e){throw console.error("Error getting manifest:",e),e}}async function To(){let e=`${B}/api/ha_tracker/config`;try{return await te(e)}catch(t){throw console.error("Error getting configuration:",t),t}}async function Mo(){let e=`${B}/api/ha_tracker/is_admin`;try{return(await te(e))?.is_admin??!1}catch(t){throw console.error("Error checking admin status:",t),t}}async function qn(){let e=`${B}/api/ha_tracker/devices`;try{let t=await te(e);await Hn(t)}catch(t){throw console.error("Error getting Devices:",t),t}}async function Wn(){let e=`${B}/api/ha_tracker/persons`;try{let t=await te(e);await jn(t)}catch(t){throw console.error("Error getting Persons:",t),t}}async function Ce(){let e=`${B}/api/ha_tracker/zones`;try{let t=await te(e);await Tn(t)}catch(t){throw console.error("Error getting zones:",t),t}}async function In(e){if(!e)return console.error("Zone ID is required."),null;let t=JSON.stringify({id:e}),n=`${B}/api/ha_tracker/zones`;try{let o=await te(n,{method:"DELETE",body:t});return o&&o.success?(console.log(`Zone with ID ${e} deleted successfully.`),!0):(console.error(`Error deleting zone: ${o?.error||"Unknown error"}`),!1)}catch(o){return console.error("Error trying to delete zone:",o),!1}}async function Bt(e,t,n,o,r,s=U){if(!e||!t||!n||!o||!r)return console.error("All parameters (zoneId, name, radius, latitude, longitude) are mandatory."),null;let a=`${B}/api/ha_tracker/zones`,i=JSON.stringify({id:e,name:t,radius:n,latitude:o,longitude:r,color:s});try{let c=await te(a,{method:"PUT",body:i});return c&&c.success?(console.log(`Zone with ID ${e} updated successfully.`),c):(console.error(`Error updating zone: ${c?.error||"Unknown error"}`),null)}catch(c){return console.error("Error trying to update the zone:",c),null}}async function An(e,t,n,o,r="mdi:map-marker",s=!1,a=!0,i=U){if(!e||!t||!n||!o)return console.error("All parameters (name, radius, latitude, longitude) are mandatory."),null;let c=`${B}/api/ha_tracker/zones`,d=JSON.stringify({name:e,radius:t,latitude:n,longitude:o,icon:r,passive:s,custom:a,color:i});try{let p=await te(c,{method:"POST",body:d});return p&&p.success?(console.log(`Zone created successfully. ID: ${p.id}`),p.id):(console.error(`Error creating zone: ${p?.error||"Unknown error"}`),null)}catch(p){return console.error("Error trying to create zone:",p),null}}async function ko(e,t,n){if(!e||!t||!n){console.error("The person_id, startDate and endDate parameters are required.");return}let o=`${B}/api/ha_tracker/filtered_positions?person_id=${encodeURIComponent(e)}&start_date=${encodeURIComponent(t)}&end_date=${encodeURIComponent(n)}`;try{let r=await te(o);await xo(r)}catch(r){throw console.error("Error getting filtered positions:",r),r}}async function mn(e){if(!e){console.error("No authorization code found in the URL.");return}try{let t=`${B}/auth/token`,n=new URLSearchParams({grant_type:"authorization_code",code:e,client_id:`${B}/`}),o=await te(t,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n},!1);if(!o){console.error("Error getting token");return}console.log("************ Token Obtained ************",o);let r={...o,hassUrl:B,clientId:`${B}/`,expires:Date.now()+o.expires_in*1e3};try{localStorage.setItem("hassTokens",JSON.stringify(r))}catch(a){console.error("Error saving token to localStorage:",a);return}let s=`${B}/local/ha-tracker/index.html`;window.history.replaceState({},document.title,s)}catch(t){console.error("Error while obtaining token",t)}}async function fn(e){try{if(!B||!e)return console.error(`The base URL or refresh_token is not defined correctly.	haUrl: ${B}	refreshToken: ${e}`),null;let t=`${B}/auth/token`,n=new URLSearchParams({grant_type:"refresh_token",refresh_token:e,client_id:`${B}/`}),o=await te(t,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n},!1);if(!o){console.error("Error renewing token");return}return console.log("************ Renewed Token ************",o),o}catch(t){return console.error("Error en la solicitud de renovaci\xF3n del token:",t),null}}var B=location.origin,U="#008000",me="#FF5555",se=.25,Z=Po({max:0}),on=Po({min:2,max:2}),Ye=!1;var at="",sn=10,Vt=30,Gt=20;var Do=!1,T=!1,ze={log:console.log,debug:console.debug,info:console.info,warn:console.warn,error:console.error};async function No(){try{Ye=await Mo()}catch(e){throw console.error("Error checking admin set:",e),e}}async function Io(){try{let e=await To();e&&(at=e.version,typeof e.update_interval=="number"&&e.update_interval>=10&&(sn=e.update_interval),typeof e.geocode_time=="number"&&e.geocode_time>=10&&(Vt=e.geocode_time),typeof e.geocode_distance=="number"&&e.geocode_distance>=20&&(Gt=e.geocode_distance),typeof e.enable_debug=="boolean"&&(Do=e.enable_debug),typeof e.use_imperial=="boolean"&&(T=e.use_imperial)),await Ls(),console.log("Configuration: ",e)}catch(e){throw console.error("Error checking admin set: ",e),e}}async function Ao(){try{return await $o(),!0}catch{return console.warn("HA is Inactive"),!1}}async function Ls(){if(!Do)console.log=()=>{},console.debug=()=>{},console.info=()=>{},console.warn=(...e)=>ze.warn("[WARNING]:",...e),console.error=(...e)=>ze.error("[ERROR]:",...e);else{let e=()=>{let t=new Date,n=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0"),r=String(t.getSeconds()).padStart(2,"0"),s=String(t.getMilliseconds()).padStart(3,"0");return`[${n}:${o}:${r}:${s}]`};console.log=(...t)=>ze.log(e(),...t),console.debug=(...t)=>ze.debug(e(),...t),console.info=(...t)=>ze.info(e(),...t),console.warn=(...t)=>ze.warn(e(),"[WARNING]:",...t),console.error=(...t)=>ze.error(e(),"[ERROR]:",...t)}}function ee(e){let t=new Date(e),n={weekday:"short",day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1};return t.toLocaleString(At||"en",n)}function Po({locale:e,min:t=0,max:n=0,grouping:o=!0}={}){let r=e??(typeof navigator<"u"&&(navigator.languages?.[0]||navigator.language)||"en-GB"),s=new Intl.NumberFormat(r,{style:"decimal",minimumFractionDigits:t,maximumFractionDigits:n,useGrouping:o});return a=>s.format(Number(a)||0)}var Oo=()=>requestAnimationFrame(()=>w?.invalidateSize(!0));async function Bo(){try{an(document.getElementById("combo-select"));let e=document.getElementById("person-select");e&&(e.dataset.defaultIcon="users",an(e));let t=document.getElementById("export-filter");t&&(t.dataset.defaultIcon="export",an(t));let n=document.getElementById("forms-container");window.innerWidth<=600?(n.classList.add("hidden"),n.classList.remove("visible")):(n.classList.add("visible"),n.classList.remove("hidden")),ks(),document.body.classList.contains("loaded")||document.body.classList.add("loaded")}catch(e){console.error("Error during load:",e)}}window.addEventListener("resize",()=>{document.querySelectorAll(".table-container").forEach(Dt)});async function Ro(){let e=document.getElementById("visits-col-css");e||(e=document.createElement("style"),e.id="visits-col-css",document.head.appendChild(e)),e.textContent=St?"":`
        #summary-zones-table thead th[data-i18n="visits"] { display: none !important; }
        #summary-zones-table-body tr > td:nth-child(3) { display: none !important; }
    `;let t=T?l("mi_per_hour"):l("km_per_hour"),n=T?l("miles"):l("kilometres"),o=T?l("feets"):l("meters");document.querySelectorAll('#positions-table thead th[data-i18n="speed"], #positions thead th[data-i18n="speed"]').forEach(r=>{let s=r.querySelector(".hdr-label");s?s.textContent=t:r.textContent=t}),document.querySelectorAll('#summary-zones-table thead th[data-i18n="distance"]').forEach(r=>{let s=r.querySelector(".hdr-label");s?s.textContent=n:r.textContent=n}),document.querySelectorAll('#zones-table thead th[data-i18n="radius"] .hdr-label').forEach(r=>{r.textContent=`${o}`}),document.querySelectorAll('#persons-table thead th[data-i18n="speed"] .hdr-label').forEach(r=>{r.textContent=`${t}`})}window.addEventListener("message",e=>{if(e.data?.type==="ping")try{e.source?.postMessage({type:"pong",id:e.data.id},e.origin||"*")}catch{}});document.getElementById("hamburger-button").addEventListener("click",async()=>{try{await Cs(),Oo()}catch(e){console.error("Error handling menu button:",e)}});document.getElementById("combo-select").addEventListener("change",function(){try{let e=this.value,t=document.getElementById("filter-container"),n=document.getElementById("zones-container"),o=document.getElementById("persons-container");if(e==="filter")t.style.display="block",n.style.display="none",o.style.display="none";else if(e==="zones"){t.style.display="none",n.style.display="block",o.style.display="none";let r=document.getElementById("zones-table-body");r&&r.querySelectorAll("tr.selected").forEach(s=>s.classList.remove("selected")),Ne()}else if(e==="users"){t.style.display="none",n.style.display="none",o.style.display="block";let r=document.getElementById("persons-table-body");r&&r.querySelectorAll("tr.selected").forEach(s=>s.classList.remove("selected")),typeof updatePersonsTable=="function"&&updatePersonsTable()}typeof w<"u"&&w&&typeof w.closePopup=="function"&&w.closePopup(),Oo()}catch(e){console.error("Error during combo-select:",e)}});async function Cs(){try{let e=document.getElementById("forms-container");e.classList.contains("hidden")?(e.classList.remove("hidden"),e.classList.add("visible")):(e.classList.add("hidden"),e.classList.remove("visible"))}catch(e){console.error("Error during toggleContainer:",e)}}async function Dt(e){try{let t=window.innerHeight,n=e.getBoundingClientRect().top,o=Math.max(t-n-20,150);Math.abs(e.clientHeight-o)>2&&requestAnimationFrame(()=>{e.style.height=`${o}px`})}catch(t){console.error("Error adjusting table height:",t)}}async function ks(){try{let e=document.querySelectorAll(".table-container"),t=document.getElementById("forms-container"),n=new ResizeObserver(s=>{requestAnimationFrame(()=>{s.forEach(a=>Dt(a.target))})}),o=new IntersectionObserver(s=>{requestAnimationFrame(()=>{s.forEach(a=>{a.isIntersecting&&Dt(a.target)})})}),r=new MutationObserver(()=>{requestAnimationFrame(()=>{document.querySelectorAll(".table-container").forEach(Dt)})});e.forEach(s=>{o.observe(s),n.observe(s)}),t&&r.observe(t,{childList:!0,subtree:!0})}catch(e){console.error("Error in observeTableContainers:",e)}}var Fo={users:'<path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5z"/>',zones:'<path d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7zm0 9.5A2.5 2.5 0 1 1 14.5 9 2.5 2.5 0 0 1 12 11.5z"/>',filter:'<path d="M3 4h18l-7 8v6l-4 2v-8z"/>',export:'<path d="M12 3v10"/><path d="M8 7l4-4 4 4"/><path d="M4 21h16v-2a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v2z"/>',dot:'<circle cx="12" cy="12" r="5"/>'},zo=e=>`<svg class="id-icon" viewBox="0 0 24 24" aria-hidden="true">${Fo[e]||Fo.dot}</svg>`;function an(e){if(!e||e.dataset.enhanced==="1")return;let t=document.createElement("div");t.className="id-wrap";let n=document.createElement("button");n.type="button",n.className="id-toggle",n.setAttribute("aria-haspopup","listbox"),n.setAttribute("aria-expanded","false"),n.setAttribute("aria-controls",e.id+"-menu");let o=document.createElement("div");o.className="id-menu",o.id=e.id+"-menu",o.setAttribute("role","listbox"),o.setAttribute("aria-hidden","true"),o.hidden=!0,e.classList.add("id-visually-hidden"),e.parentNode.insertBefore(t,e.nextSibling),t.appendChild(n),t.appendChild(o);function r(){return e.selectedOptions[0]||e.options[0]}function s(f){return f?.dataset.icon||e.dataset.defaultIcon||f?.value||"dot"}function a(){let f=r(),y=s(f);n.innerHTML=`${zo(y)}<span class="id-text">${f?.text||""}</span><span class="id-caret" aria-hidden="true">\u25BE</span>`}function i(){o.innerHTML="",Array.from(e.options).forEach((f,y)=>{let g=document.createElement("button");g.type="button",g.className="id-option",g.setAttribute("role","option"),g.dataset.value=f.value,g.setAttribute("aria-selected",String(f.selected)),g.innerHTML=`${zo(s(f))}<span>${f.text}</span>`,f.disabled&&(g.disabled=!0,g.style.opacity=.5,g.style.cursor="not-allowed"),g.addEventListener("click",()=>{f.disabled||(e.value=f.value,e.dispatchEvent(new Event("change",{bubbles:!0})),d(),n.focus())}),o.appendChild(g),g.tabIndex=f.selected||!e.value&&y===0?0:-1})}function c(){i(),o.hidden=!1,o.setAttribute("aria-hidden","false"),n.setAttribute("aria-expanded","true"),(o.querySelector('.id-option[aria-selected="true"]')||o.querySelector(".id-option"))?.focus(),document.addEventListener("click",m),document.addEventListener("keydown",u)}function d(){o.hidden=!0,o.setAttribute("aria-hidden","true"),n.setAttribute("aria-expanded","false"),document.removeEventListener("click",m),document.removeEventListener("keydown",u)}function p(){o.hidden?c():d()}function m(f){t.contains(f.target)||d()}function u(f){let y=Array.from(o.querySelectorAll(".id-option:not([disabled])")),g=y.indexOf(document.activeElement);f.key==="Escape"?(f.preventDefault(),d(),n.focus()):f.key==="ArrowDown"?(f.preventDefault(),(y[g+1]||y[0])?.focus()):f.key==="ArrowUp"?(f.preventDefault(),(y[g-1]||y.at(-1))?.focus()):f.key==="Home"?(f.preventDefault(),y[0]?.focus()):f.key==="End"?(f.preventDefault(),y.at(-1)?.focus()):(f.key==="Enter"||f.key===" ")&&document.activeElement?.classList.contains("id-option")&&(f.preventDefault(),document.activeElement.click())}e.addEventListener("change",()=>{a(),o.querySelectorAll(".id-option").forEach(f=>{f.setAttribute("aria-selected",String(f.dataset.value===e.value))})}),n.addEventListener("click",p),n.addEventListener("keydown",f=>{(f.key==="ArrowDown"||f.key==="Enter"||f.key===" ")&&(f.preventDefault(),c())}),new MutationObserver(()=>{a(),o.hidden||i()}).observe(e,{childList:!0,subtree:!0,characterData:!0}),a(),e.dataset.enhanced="1"}document.addEventListener("DOMContentLoaded",async()=>{try{await dn(),await $s()}catch(e){console.error("Error during DOMContentLoaded:",e)}});async function $s(){try{await bn(),await vo(),await kn(),await wn(),await Uo(),await Zn(),await Bo(),Ts()}catch(e){console.error("Error during init:",e)}}function Ts(){let e=performance.now();async function t(n){let o=(sn??10)*1e3;if(n-e>=o){e=n;try{await Uo()}catch(r){console.error("update() failed:",r)}}requestAnimationFrame(t)}requestAnimationFrame(t)}async function Uo(){try{await Ao()?(await Io(),await Ms(),await No(),await Un(),await $n(),await Ro(),ut()):dt(l("disconnected"),"rgba(255, 0, 0, 0.5)","white","rgba(200, 0, 0, 0.8)")}catch(e){console.error("Error during major update:",e)}}async function Ms(){try{if(!(window.self!==window.top)&&at){let t=new URL(window.location.href);if(t.searchParams.get("v")!==at){t.searchParams.set("v",at);let o=t.toString();o!==window.location.href&&window.location.replace(o)}}}catch(e){console.error("Error during updateVersion:",e)}}
