var st=null;async function dn(){try{let e=new URLSearchParams(window.location.search);if(e.has("code")){let t=e.get("code");await mn(t)}}catch(e){throw console.error("Error during authentication:",e),e}}async function un(){return st||(st=(async()=>{if(window!==window.parent){let{token:t,exp:n}=await qo();if(!t||!t.trim())throw new Error("Empty token from parent");return t}else{await Wo();let t=localStorage.getItem("hassTokens"),n=t?JSON.parse(t):null;if(!n?.access_token)throw new Error("No access_token in hassTokens");let o=typeof n.expires=="number"?n.expires:0,r=Date.now();if(o&&r>=o)throw new Error("Token has expired");return n.access_token}})().finally(()=>{st=null})),st}function qo(e=7e3){return new Promise((t,n)=>{let o=Math.random().toString(36).slice(2),r=window.parent,s="";try{s=new URL(document.referrer).origin}catch{}s||(s=window.location.origin);let a=setTimeout(()=>{window.removeEventListener("message",i),n(new Error("Token not returned"))},e);function i(c){if(c.source!==r||c.origin!==s&&c.origin!==window.location.origin)return;let d=c.data||{};if(d.type==="auth-token"&&d.reqId===o&&d.token){clearTimeout(a),window.removeEventListener("message",i);let f=typeof d.exp=="number"&&isFinite(d.exp)?d.exp:0;t({token:d.token,exp:f})}}window.addEventListener("message",i),window.parent.postMessage({type:"request-token",reqId:o},s||"*")})}async function Wo(){let e=localStorage.getItem("hassTokens");try{if(e){let o=JSON.parse(e),r=Number(o.expires||0);if(r&&Date.now()<r-900*1e3||(console.log("The token has expired. Trying to renew it..."),await Vo(o.refresh_token)))return}console.log("No valid token found. Redirecting to authorize...");let t=`${B}/local/ha-tracker/index.html`,n=`${B}/auth/authorize?client_id=${encodeURIComponent(`${B}/`)}&redirect_uri=${encodeURIComponent(t)}`;window.location.href=n}catch(t){console.error("Error during authenticate:",t)}}async function Vo(e){try{let t=await fn(e);if(!t)return console.error("Failed to renew token."),!1;let n=localStorage.getItem("hassTokens");if(!n)return console.error("No existing token found in local storage."),!1;let o=JSON.parse(n);return t.refresh_token=o.refresh_token,t.hassUrl=o.hassUrl,t.clientId=o.clientId,t.ha_auth_provider=o.ha_auth_provider,t.expires=Date.now()+t.expires_in*1e3,localStorage.setItem("hassTokens",JSON.stringify(t)),console.log("Token renewed and stored:",t),!0}catch(t){return console.error("Error processing renewed token:",t),!1}}var V=typeof window<"u"?window:globalThis;V.__assetLoader??(V.__assetLoader={js:new Map,css:new Map});function pn(e){return new Promise((t,n)=>{if(e.dataset.loaded==="true"||e.readyState==="complete")return t();e.addEventListener("load",()=>t(),{once:!0}),e.addEventListener("error",()=>n(new Error("Resource failed: "+(e.src||e.href))),{once:!0})})}function Fe(e,{attrs:t={},matchPrefix:n=!0}={}){let o=e;if(V.__assetLoader.css.has(o))return V.__assetLoader.css.get(o);let r=n?`link[rel="stylesheet"][href^="${e}"]`:`link[rel="stylesheet"][href="${e}"]`,s=document.querySelector(r);if(s){let i=pn(s);return V.__assetLoader.css.set(o,i),i.finally(()=>V.__assetLoader.css.delete(o))}let a=new Promise((i,c)=>{let d=document.createElement("link");d.rel="stylesheet",d.href=e;for(let[f,m]of Object.entries(t))d.setAttribute(f,m);d.onload=()=>{d.dataset.loaded="true",i()},d.onerror=()=>c(new Error("CSS not loaded: "+e)),document.head.appendChild(d)});return V.__assetLoader.css.set(o,a),a.finally(()=>V.__assetLoader.css.delete(o))}function _e(e,{attrs:t={},matchPrefix:n=!0,test:o=null}={}){try{if(typeof o=="function"&&o())return Promise.resolve()}catch{}let r=e;if(V.__assetLoader.js.has(r))return V.__assetLoader.js.get(r);let s=n?`script[src^="${e}"]`:`script[src="${e}"]`,a=document.querySelector(s);if(a){let c=pn(a).then(()=>{if(typeof o=="function"&&!o())throw new Error("Script present but test() failed: "+e)});return V.__assetLoader.js.set(r,c),c.finally(()=>V.__assetLoader.js.delete(r))}let i=new Promise((c,d)=>{let f=document.createElement("script");f.src=e,f.async=!0;for(let[m,u]of Object.entries(t))f.setAttribute(m,u);f.onload=()=>{f.dataset.loaded="true";try{typeof o=="function"&&!o()?d(new Error("Script loaded but test() failed: "+e)):c()}catch(m){d(m)}},f.onerror=()=>d(new Error("Script not loaded: "+e)),document.head.appendChild(f)});return V.__assetLoader.js.set(r,i),i.finally(()=>V.__assetLoader.js.delete(r))}var It="en",hn={};async function yn(e){try{let t=await fetch(`locales/${e}.json`);if(!t.ok)throw new Error(`Translation not found for ${e}`);hn=await t.json(),It=e,Go()}catch(t){if(console.error(`Error loading translations for ${e}.`,t),e==="en"){console.error("The English translation file could not be loaded. No changes will be made to the texts.");return}else console.error("Trying to load english as fallback."),await yn("en")}}function l(e){return hn[e]||e}function gn(e,t={}){let n=l(e);for(let[o,r]of Object.entries(t))n=n.replace(`{${o}}`,r);return n}function Go(){document.querySelectorAll("[data-i18n]").forEach(e=>{let t=e.getAttribute("data-i18n");e.textContent=l(t)}),document.querySelectorAll("[data-i18n-placeholder]").forEach(e=>{let t=e.getAttribute("data-i18n-placeholder"),n=l(t);n&&n!==t&&(e.placeholder=n)})}async function bn(){let e=navigator.language.slice(0,2);document.documentElement.setAttribute("lang",e),await yn(e)}var b,Ge={leafletCSS:"https://unpkg.com/leaflet@1.9.4/dist/leaflet.css",leafletJS:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js",geocoderCSS:"https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css",geocoderJS:"https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js",editableJS:"https://cdnjs.cloudflare.com/ajax/libs/leaflet-editable/1.3.0/Leaflet.Editable.min.js"};async function Ko(){await Fe(Ge.leafletCSS),await Fe(Ge.geocoderCSS),await _e(Ge.leafletJS,{test:()=>!!window.L}),await _e(Ge.editableJS,{test:()=>!!(window.L&&L.Editable)}),await _e(Ge.geocoderJS,{test:()=>!!(window.L&&L.Control&&L.Control.Geocoder)})}async function wn(){try{let m=function(){let u=b.getBounds();f.options.geocoder.options.geocodingQueryParams.viewbox=[u.getWest(),u.getSouth(),u.getEast(),u.getNorth()].join(","),f.options.geocoder.options.geocodingQueryParams.bounded=1};await Ko();let e={center:[40.4168,-3.7038],zoom:6,editable:!0,preferCanvas:!0};b=L.map("map",e);let t={maxZoom:19,minZoom:1,crossOrigin:!0},n={OpenStreetMap:L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{...t,attribution:"\xA9 OpenStreetMap contributors"}),"Esri Sat\xE9lite":L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{...t,attribution:"\xA9 Esri, Maxar, Earthstar Geographics"})};n.OpenStreetMap.addTo(b),L.control.layers(n,null,{position:"topleft"}).addTo(b);let r=L.control.scale({position:"bottomleft"}).addTo(b),s=document.querySelector(".leaflet-control-layers"),a=document.querySelector(".leaflet-control-zoom");if(s&&a){let u=a.getBoundingClientRect();s.style.position="absolute",s.style.left=`${u.right}px`}let i=()=>b&&b.invalidateSize(!0);document.body.addEventListener("transitionend",u=>{u.target===document.body&&u.propertyName==="opacity"&&setTimeout(i,0)},{once:!0});let c=document.getElementById("map");c&&"ResizeObserver"in window&&new ResizeObserver(()=>i()).observe(c),window.addEventListener("resize",i),document.addEventListener("visibilitychange",()=>{document.hidden||setTimeout(i,0)}),setTimeout(i,350);let d=navigator.languages&&navigator.languages.length?navigator.languages.join(","):navigator.language||"en",f=L.Control.geocoder({position:"bottomleft",placeholder:l("search_place"),collapsed:!1,defaultMarkGeocode:!1,geocoder:L.Control.Geocoder.nominatim({geocodingQueryParams:{"accept-language":d,limit:5}})}).on("markgeocode",u=>{let{center:p,name:h,bbox:y}=u.geocode;y?b.fitBounds(y):b.setView(p,16),L.popup({autoClose:!0,closeOnClick:!0,keepInView:!0}).setLatLng(p).setContent(h).openOn(b)}).addTo(b);b.on("moveend",m),m(),setTimeout(()=>b.invalidateSize(!0),0)}catch(e){console.error("Error starting map:",e)}}function At(e,t){return e!=null&&t!=null&&!isNaN(e)&&!isNaN(t)}function it(e,t,n,o){let s=at(n-e),a=at(o-t),i=Math.sin(s/2)*Math.sin(s/2)+Math.cos(at(e))*Math.cos(at(n))*Math.sin(a/2)*Math.sin(a/2);return 6371e3*(2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)))}function at(e){return e*(Math.PI/180)}var Jo=["#008000","#09CB09","#946F24","#333333","#999999","#BBB31A","#ECAA77","#981052","#D265E4","#854CD7","#2196F3","#28A289","#0000FF","#42DFD3"],Le=null,G=null,ne=null,vn=!1;function Yo(){if(vn)return;let e=document.createElement("style");e.id="window-overlay-styles",e.textContent=`
    #window-overlay{
      position: fixed; inset: 0; display: none;
      align-items: center; justify-content: center;
      background: rgba(0,0,0,.35);
      z-index: 2147483647;
    }
    #window-message{
      padding: 14px 18px;
      border-radius: 12px;
      border: 2px solid transparent;
      font: 600 15px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      box-shadow: 0 8px 30px rgba(0,0,0,.2);
      user-select: none;
    }`,document.head.appendChild(e),vn=!0}function Xo(){G&&ne||(Yo(),G=document.getElementById("window-overlay"),ne=document.getElementById("window-message"),G||(G=document.createElement("div"),G.id="window-overlay",document.body.appendChild(G)),ne||(ne=document.createElement("div"),ne.id="window-message",ne.dataset.i18n="loading",ne.textContent="Loading",G.appendChild(ne)))}function ct(e="Mensaje",t="rgba(0, 0, 255, 0.5)",n="white",o="rgba(0, 0, 200, 0.8)",r="rgba(0,0,0,.35)"){Xo(),G.style.display!=="flex"&&(G.style.background=r,ne.textContent=e,ne.style.backgroundColor=t,ne.style.color=n,ne.style.border=`2px solid ${o}`,G.style.display="flex")}function lt(){G&&(G.style.display==="none"||G.style.display===""||(G.style.display="none"))}function _n(e,t={}){return Le?Promise.resolve(!1):(Le="confirm",new Promise(n=>{let o=zt({title:t.title??l("confirmation"),message:e,type:t.type??"info",okLabel:t.okLabel??l("accept"),cancelLabel:t.cancelLabel??l("cancel")});Ft(o,{withInput:!1,resolve:n}),o.focusDefault()}))}function Pt(e,t="",n={}){return Le?Promise.resolve(null):(Le="prompt",new Promise(o=>{let r=zt({title:n.title??l("enter_value"),message:e,type:n.type??"info",withInput:!0,inputValue:t,placeholder:n.placeholder??"",withColor:n.withColor===!0,colorValue:n.defaultColor??U,colorLabel:n.colorLabel,okLabel:n.okLabel??l("save"),cancelLabel:n.cancelLabel??l("cancel"),colorOptions:n.colorOptions});Ft(r,{withInput:!0,withColor:n.withColor===!0,resolve:o}),r.focusDefault()}))}function z(e,t={}){return Le?Promise.resolve():(Le="alert",new Promise(n=>{let o=zt({title:t.title??l("information"),message:e,type:t.type??"info",okLabel:t.okLabel??l("accept"),cancelLabel:l("close")});(t.hideCancel??!0)&&o.modal.querySelector(".btn-secondary")?.remove(),Ft(o,{withInput:!1,resolve:n}),o.focusDefault()}))}function he(e,t=DEFAULT_ALPHA){let n=String(e||"").trim().toLowerCase(),o=/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i.exec(n),r=/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i.exec(n),s=/^#([0-9a-f]{8})$/i.exec(n),a,i,c;if(o)a=parseInt(o[1]+o[1],16),i=parseInt(o[2]+o[2],16),c=parseInt(o[3]+o[3],16);else if(r)a=parseInt(r[1],16),i=parseInt(r[2],16),c=parseInt(r[3],16);else if(s)a=parseInt(s[1].slice(0,2),16),i=parseInt(s[1].slice(2,4),16),c=parseInt(s[1].slice(4,6),16);else return null;let d=Math.min(1,Math.max(0,Number(t)||0));return`rgba(${a},${i},${c},${d})`}function Qo(e){let t=String(e||"").trim().toLowerCase(),n=/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i.exec(t),o=/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i.exec(t),r=/^#([0-9a-f]{8})$/i.exec(t),s,a,i;if(n)s=parseInt(n[1]+n[1],16),a=parseInt(n[2]+n[2],16),i=parseInt(n[3]+n[3],16);else if(o)s=parseInt(o[1],16),a=parseInt(o[2],16),i=parseInt(o[3],16);else if(r)s=parseInt(r[1].slice(0,2),16),a=parseInt(r[1].slice(2,4),16),i=parseInt(r[1].slice(4,6),16);else return null;return{r:s,g:a,b:i}}function er(){let e=document.getElementById("ui-modal-root");e||(e=document.createElement("div"),e.id="ui-modal-root",document.body.appendChild(e));let t=document.getElementById("ui-toast-root");return t||(t=document.createElement("div"),t.id="ui-toast-root",document.body.appendChild(t)),{modalRoot:e,toastRoot:t}}function tr(e){let t=["a[href]","button:not([disabled])","textarea:not([disabled])","input:not([disabled])","select:not([disabled])",'[tabindex]:not([tabindex="-1"])'],n=e.querySelectorAll(t.join(",")),o=n[0],r=n[n.length-1];function s(a){a.key==="Tab"&&n.length&&(a.shiftKey&&document.activeElement===o?(a.preventDefault(),r.focus()):!a.shiftKey&&document.activeElement===r&&(a.preventDefault(),o.focus()))}return e.addEventListener("keydown",s),()=>e.removeEventListener("keydown",s)}function zt({title:e,message:t,type:n="info",withInput:o=!1,inputValue:r="",placeholder:s="",withColor:a=!1,colorValue:i=U,colorLabel:c,okLabel:d,cancelLabel:f,colorOptions:m={}}){let{modalRoot:u}=er(),p=document.createElement("div");p.className="modal-overlay",p.setAttribute("role","dialog"),p.setAttribute("aria-modal","true");let h=document.createElement("div");h.className=`modal modal-${n}`;let y=document.createElement("div");y.className="modal-header",y.innerHTML=`<span class="modal-title">${e||""}</span>`;let v=document.createElement("button");v.className="modal-close",v.setAttribute("aria-label",l("close")),v.textContent="\xD7",y.appendChild(v);let S=document.createElement("div");S.className="modal-body";let _=document.createElement("div");_.className="modal-message",_.textContent=t||"",S.appendChild(_);let E=null;o&&(E=document.createElement("input"),E.className="modal-input",E.type="text",E.value=r??"",s&&(E.placeholder=s),S.appendChild(E));let x=null;if(a){let D=document.createElement("div");D.className="modal-message",D.textContent=c??(l?l("select_color"):"Seleccione un color"),S.appendChild(D);let{palette:I=[],allowAlpha:R=!1,showNative:H=!1}=m||{},P=nr({initial:i||U,palette:I,allowAlpha:R,showNative:H});x=P.hiddenInput,S.appendChild(P.root)}let w=document.createElement("div");w.className="modal-actions";let N=document.createElement("button");N.className="btn btn-secondary",N.textContent=f??l("cancel");let g=document.createElement("button");g.className="btn "+(n==="danger"?"btn-danger":"btn-primary"),g.textContent=d??l("accept"),w.append(N,g),h.append(y,S,w),p.appendChild(h),u.appendChild(p);let C=tr(h),A=()=>{C(),p.remove(),document.body.classList.remove("no-scroll"),Le=null};return document.body.classList.add("no-scroll"),{overlay:p,modal:h,ok:g,cancel:N,closeBtn:v,inputEl:E,colorEl:x,focusDefault:()=>o?E?.focus():g.focus(),destroy:A}}function Ft(e,{withInput:t,withColor:n=!1,resolve:o,reject:r}){let{overlay:s,modal:a,ok:i,cancel:c,closeBtn:d,inputEl:f,colorEl:m,destroy:u}=e,p=S=>{if(Le){if(S.key==="Escape"){S.preventDefault(),v();return}if(S.key==="Enter"){let _=(document.activeElement?.tagName||"").toLowerCase();_==="input"||_==="textarea"||document.activeElement?.isContentEditable||y()}}};function h(){a.removeEventListener("keydown",p)}function y(){let S=t?f?.value??"":!0,_=n?m?.value??"":void 0;h(),u(),o(n?t?{value:S,color:_}:{color:_}:S)}function v(){h(),u(),o(t?null:!1)}i.addEventListener("click",y),c.addEventListener("click",v),d.addEventListener("click",v),s.addEventListener("click",S=>{S.target===s&&v()}),a.addEventListener("keydown",p)}function nr({initial:e=U,palette:t=[],allowAlpha:n=!1,showNative:o=!1}={}){let r=document.createElement("div");r.className="modal-color";let s=document.createElement("div");s.className="cp";let a=document.createElement("div");a.className="cp-left";let i=document.createElement("div");i.className="cp-right";let c=document.createElement("div");c.className="cp-sv",c.tabIndex=0;let d=document.createElement("div");d.className="cp-cursor",c.appendChild(d);let f=document.createElement("div");f.className="cp-hue",f.tabIndex=0;let m=document.createElement("div");m.className="cp-cursor h",f.appendChild(m);let u=document.createElement("div");u.className="cp-alpha",u.tabIndex=0;let p=document.createElement("div");p.className="cp-cursor h",u.appendChild(p),n||(u.style.display="none"),a.appendChild(c);let h=document.createElement("div");h.style.display="flex",h.style.flexDirection="column",h.style.gap="12px",h.appendChild(f),h.appendChild(u),a.appendChild(h);let y=document.createElement("div");y.className="cp-fields";let v=document.createElement("div");v.className="cp-preview";let S=document.createElement("span");v.appendChild(S);let _=document.createElement("div");_.className="cp-row";let E=document.createElement("label");E.textContent="HEX";let x=document.createElement("input");x.type="text",x.placeholder="#RRGGBB",x.autocomplete="off",_.append(E,x);let w=document.createElement("div");w.className="cp-row";let N=document.createElement("label");N.textContent="Alpha";let g=document.createElement("input");g.type="text",g.placeholder="0\u20131",g.value="1",w.append(N,g),n||(w.style.display="none");let C=document.createElement("div");C.className="cp-palette",(t.length?t:Jo).forEach($=>{let k=document.createElement("button");k.type="button",k.className="cp-swatch",k.title=$,k.style.background=$,k.addEventListener("click",()=>de($)),C.appendChild(k)});let D=document.createElement("div");if(D.className="cp-native",o){let $=document.createElement("details"),k=document.createElement("summary");k.textContent="Selector del sistema";let O=document.createElement("input");O.type="color",O.addEventListener("input",()=>de(O.value)),$.append(k,O),D.appendChild($)}y.append(v,_,w,C,D),i.appendChild(y),s.append(a,i),r.appendChild(s);let I=document.createElement("input");I.type="text",I.className="modal-input-color",I.style.display="none",r.appendChild(I);let R=120,H=1,P=.5,M=1,W=!1;x.addEventListener("focus",()=>{W=!0}),x.addEventListener("blur",()=>{W=!1,F()}),x.addEventListener("keydown",$=>{$.key==="Enter"&&$.preventDefault(),$.stopPropagation()});function le(){c.style.background=`hsl(${R}, 100%, 50%)`}function j(){let{r:$,g:k,b:O}=En(R,H,P);u.style.background=`conic-gradient(#ccc 25%, #fff 0 50%, #ccc 0 75%, #fff 0) 0 0/12px 12px,
       linear-gradient(to bottom, rgba(${$},${k},${O},0), rgba(${$},${k},${O},1))`}function F(){d.style.left=`${H*100}%`,d.style.top=`${(1-P)*100}%`,m.style.top=`${R/360*100}%`,p.style.top=`${(1-M)*100}%`;let{r:$,g:k,b:O}=En(R,H,P),X=or({r:$,g:k,b:O});S.style.background=`rgba(${$},${k},${O},${M})`,W||(x.value=X),I.value=n?`rgba(${$}, ${k}, ${O}, ${M})`:X,le(),j()}function de($){let k=Sn($);if(!k)return;let O=xn(k.r,k.g,k.b);R=O.h,H=O.s,P=O.v,k.a!==void 0&&(M=Y(+k.a,0,1)),F()}function Y($,k,O){return Math.min(O,Math.max(k,$))}function We($,k){let O=ue=>{let Me=$.getBoundingClientRect(),De=Y(((ue.touches?ue.touches[0].clientX:ue.clientX)-Me.left)/Me.width,0,1),Ve=Y(((ue.touches?ue.touches[0].clientY:ue.clientY)-Me.top)/Me.height,0,1);k(De,Ve)},X=()=>{window.removeEventListener("mousemove",O),window.removeEventListener("touchmove",O),window.removeEventListener("mouseup",X),window.removeEventListener("touchend",X)},Se=ue=>{ue.preventDefault(),O(ue),window.addEventListener("mousemove",O),window.addEventListener("touchmove",O,{passive:!1}),window.addEventListener("mouseup",X,{once:!0}),window.addEventListener("touchend",X,{once:!0})};$.addEventListener("mousedown",Se),$.addEventListener("touchstart",Se,{passive:!1})}We(c,($,k)=>{H=$,P=1-k,F()}),We(f,($,k)=>{R=Y(k,0,1)*360,F()}),We(u,($,k)=>{M=1-k,F()});function Dt($,k){$.addEventListener("keydown",O=>{let X=O.key.toLowerCase(),Se=.02;X==="arrowup"&&k(0,-Se),X==="arrowdown"&&k(0,Se),X==="arrowleft"&&k(-Se,0),X==="arrowright"&&k(Se,0)})}Dt(c,($,k)=>{H=Y(H+$,0,1),P=Y(P-k,0,1),F()}),Dt(f,($,k)=>{R=Y(R+k*360,0,360),F()}),Dt(u,($,k)=>{M=Y(M-k,0,1),F()}),[c,f,u].forEach($=>{$.addEventListener("keydown",k=>{k.key==="Enter"&&k.stopPropagation()})}),x.addEventListener("input",()=>{let $=Sn(x.value);if($){let k=xn($.r,$.g,$.b);R=k.h,H=k.s,P=k.v,F()}}),g.addEventListener("input",()=>{let $=parseFloat(g.value.replace(",","."));isNaN($)||(M=Y($,0,1),F())}),de(e||U);function Ho(){s.style.minWidth=a.style.minWidth=i.style.minWidth=y.style.minWidth="0";let Me=()=>{let De=1+(n?1:0),Ve=s.clientWidth||r.clientWidth,jo=110+De*14+20+180+10,cn=Ve<jo;s.style.display="grid",s.style.gap="10px",s.style.alignItems="start",s.style.gridTemplateColumns=cn?"1fr":"minmax(0, 1fr) minmax(180px, 28ch)";let Zo=(cn?Ve:Ve-180-10)-De*14-20,ln=Math.max(110,Math.min(Zo,210)),Nt=Math.max(0,Math.round(ln*.62));c.style.width=Math.max(0,Math.floor(ln))+"px",c.style.height=Nt+"px",f.style.height=Nt+"px",u.style.height=Nt+"px"};requestAnimationFrame(()=>{Me();let De=new ResizeObserver(Me);De.observe(s),De.observe(a)})}return Ho(),{root:r,hiddenInput:I,getValue:()=>I.value,setValue:de}}function or({r:e,g:t,b:n}){let o=r=>r.toString(16).padStart(2,"0");return`#${o(e)}${o(t)}${o(n)}`.toUpperCase()}function xn(e,t,n){e/=255,t/=255,n/=255;let o=Math.max(e,t,n),r=Math.min(e,t,n),s=o-r,a=0,i=o?s/o:0,c=o;if(s!==0){switch(o){case e:a=(t-n)/s+(t<n?6:0);break;case t:a=(n-e)/s+2;break;case n:a=(e-t)/s+4;break}a*=60}return{h:a,s:i,v:c}}function En(e,t,n){let o=n*t,r=o*(1-Math.abs(e/60%2-1)),s=n-o,a=0,i=0,c=0;return 0<=e&&e<60?(a=o,i=r):60<=e&&e<120?(a=r,i=o):120<=e&&e<180?(i=o,c=r):180<=e&&e<240?(i=r,c=o):240<=e&&e<300?(a=r,c=o):(a=o,c=r),{r:Math.round((a+s)*255),g:Math.round((i+s)*255),b:Math.round((c+s)*255)}}function Sn(e){if(!e)return null;let t=String(e).trim();if(t.startsWith("#")){let o=Qo(t);return o?{...o,a:1}:null}let n=t.match(/rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*([.\d]+))?\)/i);return n?{r:+n[1],g:+n[2],b:+n[3],a:n[4]!==void 0?+n[4]:1}:null}var re=[],oe={},Oe="name",ye=!0,Ln="",Cn=!0,dt={},rr=30,sr=/\p{Diacritic}/gu;async function kn(){let e=document.getElementById("add-zone-button"),t=document.getElementById("delete-zone-button"),n=document.getElementById("edit-zone-button");e&&e.addEventListener("click",async()=>{try{await cr()}catch(o){console.error("Error adding a zone:",o)}}),t&&t.addEventListener("click",async()=>{try{await ar()}catch(o){console.error("Error deleting a zone:",o)}}),n&&n.addEventListener("click",async()=>{try{await ir()}catch(o){console.error("Error when modifying a zone:",o)}})}async function $n(){try{await Ce(),await Ye(),await ft()}catch(e){throw console.error("Error updating zones:",e),e}}async function Tn(e){try{e&&Array.isArray(e)?(re=e,console.log("Zones:",re)):(console.log("No valid zones were obtained from the server."),re=[])}catch(t){console.error("Error getting zones:",t),re=[]}}async function ft(){b.getPane("circlePane")||(b.createPane("circlePane"),b.getPane("circlePane").style.zIndex=400);let e=re.map(t=>t.id);Object.keys(oe).forEach(t=>{e.includes(t)||(b.removeLayer(oe[t]),delete oe[t],delete dt[t])}),re.forEach(t=>{let{latitude:n,longitude:o,radius:r,name:s,custom:a}=t;if(!n||!o||!r){console.error("Invalid zone:",t.id);return}if(dt[t.id])return;let i=oe[t.id],c=!i||i.getLatLng().lat!==n||i.getLatLng().lng!==o||i.getRadius()!==r,d=a?t.color||U:me,f=d,m=he(d,.25);if(i){let y=`
			<strong>${s||l("zone_without_name")}</strong><br>
			 ${l("radius")}: ${T?Z(r*3.28084):Z(r)} ${T?l("feets"):l("meters")}
		    `;i.getPopup().getContent()!==y&&i.setPopupContent(y),(i.options.color!==f||i.options.fillColor!==m)&&i.setStyle({color:f,fillColor:m,fillOpacity:1})}if(!c)return;let u=!1;if(oe[t.id]){let y=oe[t.id],v=y.isPopupOpen();b.removeLayer(y),delete oe[t.id]}let p=L.circle([n,o],{radius:r,color:f,fillColor:m,fillOpacity:1,opacity:.8,pane:"circlePane"}).addTo(b);Je&&a&&p.enableEdit();let h=`
		 <strong>${s||l("zone_without_name")}</strong><br>
		 ${l("radius")}: ${T?Z(r*3.28084):Z(r)} ${T?l("feets"):l("meters")}
		`;p.bindPopup(h,{autoPan:!1}),u&&p.openPopup(),p.on("click",async()=>{try{b.fitBounds(p.getBounds()),p.openPopup(),await ut(t.id)}catch(y){console.error("Error handling zone row selection:",y)}}),p.on("editable:vertex:dragstart",()=>{dt[t.id]=!0,b.closePopup()}),p.on("editable:vertex:dragend",async()=>{dt[t.id]=!1;let y=p.getLatLng(),v=p.getRadius(),S=`
			<strong>${t.name||""}</strong><br>
			 ${l("radius")}: ${T?Z(r*3.28084):Z(r)} ${T?l("feets"):l("meters")}
		    `;if(p.bindPopup(S,{autoPan:!1}),p.openPopup(),Je&&a)try{let _=await Ot(t.id,t.name,v,y.lat,y.lng);await Ce(),await ut(t.id),_&&_.success?console.log(`Zone with ID ${t.id} updated on server.`):console.error(`Error updating zone with ID ${t.id} on server.`)}catch(_){console.error("Error in zone update request:",_)}}),oe[t.id]=p})}async function ut(e){let t=document.getElementById("zones-table-body");if(!t){console.error("The zone table tbody was not found.");return}let n=t.querySelector(`tr[data-zone-id="${e}"]`);if(!n){console.error("No row found for the zone:",e);return}let o=document.getElementById("combo-select");if(o&&o.value!=="zones"){o.value="zones";let r=new Event("change",{bubbles:!0});o.dispatchEvent(r)}t.querySelectorAll("tr").forEach(r=>r.classList.remove("selected")),n.classList.add("selected"),n.scrollIntoView({behavior:"smooth",block:"center"}),typeof Ne=="function"&&Ne()}async function Ne(){let e=document.getElementById("zones-table-body");if(!e){console.error("Zone table body not found.");return}let t=e.querySelectorAll("tr"),n=document.getElementById("add-zone-button"),o=document.getElementById("delete-zone-button"),r=document.getElementById("edit-zone-button"),s=document.getElementById("zone-actions");if([n,o,r].forEach(i=>i.classList.add("hidden")),Je)s.style.display="flex";else{s.style.display="none";return}if(t.length===0)n.classList.remove("hidden");else{let i=e.querySelector("tr.selected");i&&i.dataset.custom==="true"?(n.classList.remove("hidden"),o.classList.remove("hidden"),r.classList.remove("hidden")):n.classList.remove("hidden")}let a=[n,o,r].filter(i=>!i.classList.contains("hidden"));a.length===1?(s.classList.add("single-button"),a[0].style.flex="1"):(s.classList.remove("single-button"),a.forEach(i=>i.style.flex="1"))}async function ar(){let t=document.getElementById("zones-table-body").querySelector("tr.selected");if(!t){z(l("select_delete_zone"),{title:l("zones")});return}let n=t.dataset.zoneId,o=t.dataset.name;if(!n){console.error("The selected zone ID was not found.");return}if(await _n(gn("confirm_delete_zone",{name:o}),{type:"danger",okLabel:l("delete"),title:l("zones")}))try{await In(n),await Ce(),await Ye(),await ft()}catch(s){console.error("Error trying to delete zone:",s),z(l("error_deleting_zone"),{title:l("zones")})}}async function ir(){let e=document.getElementById("zones-table-body");if(!e){console.error("Zone table body not found.");return}let t=e.querySelector("tr.selected");if(!t){z(l("select_zone"),{title:l("zones")});return}let n=t.dataset.zoneId,o=re.find(i=>i.id===n);if(!o){z(l("error_finding_zone"),{title:l("zones")});return}let r=await Pt(l("enter_zone_name"),o.name||l("zone_without_name"),{title:l("zones"),withColor:!0,defaultColor:o.color,colorLabel:l("select_color"),colorOptions:{palette:[],allowAlpha:!1,showNative:!1}});if(r===null)return;let s=Dn(r.value);if(s===null)return;let a=r.color||o.color||U;if(!(mt(s)===mt(o.name)&&a===(o.color||U))){if(await Ce(),Nn(s,{excludeId:o.id})){z(l("zone_name_exists"),{title:l("zones")});return}try{let i=await Ot(o.id,s,o.radius,o.latitude,o.longitude,a);i&&i.success?(o.name=s,o.color=a,await Ce(),await Ye(),await ft(),await ut(o.id)):z(l("error_updating_zone"),{title:l("zones")})}catch(i){console.error("Error in zone update request:",i),z(l("error_updating_zone"),{title:l("zones")})}}}async function cr(){if(!b)return console.error("The map is not initialized."),null;let e=await Pt(l("enter_zone_name"),"",{title:l("zones"),withColor:!0,defaultColor:U,colorLabel:l("select_color"),colorOptions:{palette:[],allowAlpha:!1,showNative:!1}});if(e===null)return;let t=Dn(e.value);if(t===null)return;if(await Ce(),Nn(t)){z(l("zone_name_exists"),{title:l("zones")});return}let n=b.getCenter(),o=n.lat,r=n.lng,s=100;try{let a=e.color||U,i=await An(t,s,o,r,"mdi:map-marker",!1,!0,a);return i?(await Ce(),await Ye(),await ft(),await ut(i),console.log(`Zone created successfully. ID: ${i}`),i):(console.error("Failed to create zone."),z(l("error_creating_zone"),{title:l("zones")}),null)}catch(a){console.error("Error in zone update request:",a),z(l("error_creating_zone"),{title:l("zones")})}}function ge(e,t,n={}){let{accuracy:o=0,includePassive:r=!1,epsilonM:s=.5,epsilonDeg:a=1e-5}=n,i=u=>Math.round(u/a),c=(u,p)=>`${i(u)},${i(p)}`;if(e==null||t==null||Number.isNaN(e)||Number.isNaN(t))return null;let d=[];for(let u=0;u<re.length;u++){let p=re[u];if(!p||p.passive&&!r)continue;let h=it(e,t,p.latitude,p.longitude),y=(Number(p.radius)||0)+(Number(o)||0);h<=y&&d.push({zone:p,idx:u,distanceToCenter:h,key:c(p.latitude,p.longitude),radius:Number(p.radius)||0,id:p.entity_id||p.id||p.name||`idx:${u}`})}if(d.length===0)return null;if(d.length===1)return d[0].zone;let f=new Map;for(let u of d){let p=f.get(u.key);(!p||u.radius<p.radius-s||Math.abs(u.radius-p.radius)<=s&&String(u.id)<String(p.id))&&f.set(u.key,u)}let m=Array.from(f.values());return m.length===1||m.sort((u,p)=>{let h=u.distanceToCenter-p.distanceToCenter;if(Math.abs(h)>s)return h;let y=u.radius-p.radius;return Math.abs(y)>s?y:String(u.id).localeCompare(String(p.id))}),m[0].zone}async function Mn(e){if(e)if(oe[e]){let t=oe[e];b.setView(t.getLatLng(),b.getZoom()),t.openPopup()}else console.error("Marker for zone not found: ",e)}async function Ye(){let e=document.getElementById("zones-table-body");if(!e){console.error("Zone table body not found."),Ke(),Ne();return}let t=e.querySelector("tr.selected"),n=t?t.dataset.zoneId:null,o=[...re].sort((a,i)=>{let c,d;switch(Oe){case"type":return c=a.custom?1:0,d=i.custom?1:0,ye?c-d:d-c;case"radius":return c=Number(a.radius)||0,d=Number(i.radius)||0,ye?c-d:d-c;case"name":default:return c=(a.name||"").toLowerCase(),d=(i.name||"").toLowerCase(),ye?c.localeCompare(d):d.localeCompare(c)}}),r=Array.from(e.querySelectorAll("tr")),s=r.map(a=>a.dataset.zoneId);o.forEach((a,i)=>{let{id:c,latitude:d,longitude:f,name:m,custom:u}=a;if(!d||!f){console.error("Invalid coordinates for the zone:",c);return}let p=r.find(_=>_.dataset.zoneId===c);p||(p=document.createElement("tr"),p.dataset.zoneId=c,p.dataset.custom=u,p.dataset.name=m,p.style.cursor="pointer",e.appendChild(p));let h=u?a.color||U:me;p.style.setProperty("--color-bg",he(h,se));let y=`<div style="
		  width:10px; height:10px; border:2px solid ${h};
		  border-radius:50%;
		  background-color:${he(h,.3)};
		  margin:auto;"></div>`,v=`${T?Z(a.radius*3.28084):Z(a.radius)}`,S=`
		  <td>${y}</td>
		  <td>${m||l("zone_without_name")}</td>
		  <td>${v}</td>
		`;p.innerHTML!==S&&(p.innerHTML=S,p.dataset.name=m),p.onclick=()=>{let _=oe[c];if(_){let E=_.getBounds();b.fitBounds(E),_.openPopup()}else console.error("No marker found for the zone:",c);e.querySelectorAll("tr").forEach(E=>E.classList.remove("selected")),p.classList.add("selected"),Ne()},e.children[i]!==p&&e.insertBefore(p,e.children[i]),c===n&&p.classList.add("selected")}),r.forEach(a=>{o.some(i=>i.id===a.dataset.zoneId)||a.remove()}),Ne(),Ke(),(Ln!==Oe||Cn!==ye)&&(lr(),Ln=Oe,Cn=ye)}function lr(){let e=document.querySelector("#zones-table");if(!e){console.error("Zone summary table not found.");return}e.querySelectorAll("thead th").forEach(n=>{let o=n.getAttribute("data-i18n"),r="";switch(o){case"type":r="type";break;case"name":r="name";break;case"radius":r="radius";break}if(!r)return;n.style.cursor="pointer",n.onclick=()=>{Oe===r?ye=!ye:(Oe=r,ye=!0),Ye()};let s="";Oe===r&&(s=ye?"\u25B2":"\u25BC");let a=o==="radius"?`${T?l("feets"):l("meters")}`:l(o);n.innerHTML=`
		  <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:30px;">
			<span class="hdr-label">${a}</span>
			<span style="font-size:12px;">${s}</span>
		  </div>
		`})}function Dn(e){let t=(e||"").trim();return t===""?(z(l("empty_name"),{title:l("zones")}),null):t.length>rr?(z(l("long_zone"),{title:l("zones")}),null):t}function mt(e){return(e??"").toLocaleLowerCase().normalize("NFD").replace(sr,"").replace(/\s+/g," ").trim()}function Nn(e,{excludeId:t=null}={}){let n=mt(e);return n?re.some(o=>o&&mt(o.name)===n&&(t==null||String(o.id)!==String(t))):!1}var dr=400,ur=4,Pn=2;var mr=(e,t,n)=>`${Number(e).toFixed(6)},${Number(t).toFixed(6)},${Number(n)}`,fr=(e,t)=>`${Number(e).toFixed(6)},${Number(t).toFixed(6)}`,Ie=new Map,Bt=new Map,pt=new Map,Q=new Map,Ae=new Map,Xe=new Map;function Rt(e,t){if(Ie.has(e)&&Ie.delete(e),Ie.set(e,t),Ie.size>dr){let n=Ie.keys().next().value;Ie.delete(n)}}function Pe(e){Xe.delete(e)}function pr(e,t,n){let o=(Xe.get(e)||0)+1;Xe.set(e,o);let r=Math.floor(Math.random()*250),s=Math.min(8e3,Math.max(300,t)*Math.pow(1.6,o))+r;setTimeout(n,s)}var Ut=0,Ht=[];function hr(e){return new Promise((t,n)=>{Ht.push({task:e,res:t,rej:n}),zn()})}function zn(){for(;Ut<ur&&Ht.length;){let{task:e,res:t,rej:n}=Ht.shift();Ut++,e().then(t,n).finally(()=>{Ut--,zn()})}}function Be(e,t){try{let n=document.querySelector(`tr.pos-main-row[data-entity-id="${e}"]`);n&&(n.dataset.address=t||"");let o=document.querySelector(`tr.position-address-row[data-entity-id="${e}"]`);o&&(o.dataset.address=t||"")}catch{}}async function Qe(e,t,n,o,r){if(!Number.isFinite(t)||!Number.isFinite(n)||!Number.isFinite(o))return;let s=mr(t,n,o);Q.set(e,s);let a=Ie.get(e);if(a?.key===s){let d=a.address||"";r?.(d),Be(e,d),Q.delete(e),Pe(e);return}if(Ae.get(e)===s)return;Ae.set(e,s);let i=d=>{Ae.get(e)===s&&Ae.delete(e),pr(e,d,()=>{Q.get(e)===s&&Qe(e,t,n,o,r)})},c=fr(t,n);try{if(Bt.has(c)){let u=Bt.get(c)||"";Rt(e,{key:s,address:u}),Q.get(e)===s&&(r?.(u),Be(e,u),Q.delete(e),Pe(e));return}if(pt.has(c)){let u=await pt.get(c);if(Q.get(e)!==s)return;if(!u){if((Xe.get(e)||0)<Pn){i(600);return}r?.(""),Be(e,""),Q.delete(e),Pe(e);return}Rt(e,{key:s,address:u}),r?.(u),Be(e,u),Q.delete(e),Pe(e);return}let d=hr(()=>On(t,n));pt.set(c,d.then(u=>(u?.address?.display_name||"").trim()));let f=await d;if(Q.get(e)!==s)return;if(f?.error==="queued"&&Number.isFinite(f?.retry_after)){i(f.retry_after*1e3);return}if(["temporarily_unavailable","rate_limited","busy"].includes(f?.error)){let u=Number.isFinite(f?.retry_after)?f.retry_after:1.5;i(u*1e3);return}let m=(f?.address?.display_name||"").trim();if(!m){if((Xe.get(e)||0)<Pn){i(600);return}r?.(""),Be(e,""),Q.delete(e),Pe(e);return}Bt.set(c,m),Rt(e,{key:s,address:m}),r?.(m),Be(e,m),Q.delete(e),Pe(e)}catch{Q.get(e)===s&&i(1200)}finally{pt.delete(c),Ae.get(e)===s&&Ae.delete(e)}}function Fn(e){Q.delete(e),Ae.delete(e),Pe(e)}var yr="/local/ha-tracker/images/location-red.png",ke=[],ht=[],K={},fe={},Re="name",ae=!0,Bn="",Rn=!0,jt={},et=null;function gr(){if(et)return et;let e=document.querySelector("#users .table-wrapper")||null;return et=new IntersectionObserver(t=>{for(let n of t){if(!n.isIntersecting)continue;let o=n.target;et.unobserve(o);let r=o.dataset.personId,s=Number(o.dataset.latitude),a=Number(o.dataset.longitude),i=Number(o.dataset.lastUpdated),c=`${r}_${i}`,d=o.querySelector("td");!Number.isFinite(s)||!Number.isFinite(a)||!d||Qe(c,s,a,i,f=>{jt[r]={lat:s,lon:a,timestamp:i,address:f||""};let m=document.querySelector(`tr.person-address-row[data-person-id="${r}"]`);if(m&&m.dataset.lastUpdated===String(i)){let u=m.querySelector("td");u&&(u.textContent=f||"")}})}},{root:e,rootMargin:"200px"}),et}async function Un(){try{await Wn(),await qn(),await br(),await Ke(),await wr(),await qt()}catch(e){throw console.error("Error updating devices:",e),e}}async function Hn(e){try{ht=Array.isArray(e)?e.filter(t=>t.entity_id&&t.attributes):[],console.log("Devices:",ht)}catch(t){console.error("Error processing devices:",t),ht=[]}}async function jn(e){try{ke=Array.isArray(e)?e.filter(t=>t.attributes?.friendly_name):[],console.log("Persons:",ke)}catch(t){console.error("Error processing persons:",t),ke=[]}}async function Zt(e){if(!e)return;let t=fe[e];if(!t)return;let n=K[e];if(!n){console.error(`No device was found for the person with ID: ${e}`);return}Object.values(fe).forEach(s=>s.setZIndexOffset(500)),t.setZIndexOffset(600);let{latitude:o,longitude:r}=n.attributes||{};if(!At(o,r)){console.error(`Invalid coordinates for ${e}: lat=${o}, lng=${r}`);return}t.openPopup(),b.invalidateSize(),b.setView([o,r],b.getZoom())}function qt(){let e=document.getElementById("person-select"),t=e.value,n=document.createDocumentFragment(),o=document.createElement("option");o.value="",o.textContent=l("select_user"),n.appendChild(o),ke.filter(r=>!!K[r.entity_id]).forEach(r=>{let s=document.createElement("option");s.value=r.entity_id;let a=r.attributes.friendly_name||r.attributes.id||r.entity_id;s.textContent=(a||"").trim(),n.appendChild(s)}),e.innerHTML="",e.appendChild(n),t&&K[t]&&(e.value=t)}async function Zn(){try{let e=Object.values(K).filter(n=>n.attributes.latitude&&n.attributes.longitude).map(n=>[n.attributes.latitude,n.attributes.longitude]);if(!e.length){console.log("There are no devices with coordinates to adjust the map."),b.fitWorld();return}let t=L.latLngBounds(e);b.fitBounds(t)}catch(e){console.error("Error doing fitMapToAllDevices:",e)}}async function br(){K={},ke.forEach(e=>{let t=e.attributes?.source;if(!t||typeof t!="string"||t.trim()===""){console.log(`The person ${e.attributes.friendly_name||e.entity_id} does not have a valid 'source'.`);return}let n=ht.find(o=>o.entity_id===t);if(!n){console.error(`The 'source' (${t}) of ${e.attributes.friendly_name||e.entity_id} is not in device_trackers.`);return}if(!n.attributes.latitude||!n.attributes.longitude){console.log(`The device_tracker ${t} of ${e.attributes.friendly_name||e.entity_id} does not have lat/lng.`);return}K[e.entity_id]=n}),console.log("Devices to persons:",K)}async function wr(){if(!b.getPane("personsMarkers")){let t=b.createPane("personsMarkers");t.style.zIndex=600,t.style.pointerEvents="auto"}let e=Object.keys(K);Object.keys(fe).forEach(t=>{e.includes(t)||(b.removeLayer(fe[t]),delete fe[t])}),e.forEach(t=>{let n=K[t],{latitude:o,longitude:r,friendly_name:s,speed:a}=n.attributes,i=n.battery_level?`<br>${l("battery")}: ${n.battery_level}${l("percentage")}`:"";if(!At(o,r))return;let c=ee(n.last_updated||l("date_unavailable")),d=ke.find(h=>h.entity_id===t)?.attributes.friendly_name||"",f=ke.find(h=>h.entity_id===t)?.attributes.entity_picture||yr,m=`https://www.google.com/maps/search/?api=1&query=${o},${r}`,u=`
      <strong>${d}</strong> (${s})<br>
      ${c}<br>
      ${l("speed")}: ${Math.round((a||0)*(T?2.23694:3.6))} ${l(T?"mi_per_hour":"km_per_hour")}
      ${i}<br><br>
      <a href="${m}" target="_blank" rel="noopener noreferrer"><strong>${l("open_location")}</strong></a>
    `,p=L.divIcon({className:"",html:`<img src="${f}" style="width:48px;height:48px;border-radius:50%;object-fit:cover;" />`,iconSize:[48,48],iconAnchor:[24,24],popupAnchor:[0,-24]});if(fe[t]){let h=fe[t];h.setLatLng([o,r]),h.setIcon(p),h.getPopup().setContent(u)}else fe[t]=L.marker([o,r],{icon:p,pane:"personsMarkers"}).addTo(b).bindPopup(u,{autoPan:!1}).on("click",async()=>{await vr(t),b.invalidateSize();let h=fe[t].getLatLng();b.setView(h,b.getZoom()),fe[t].openPopup()})})}async function vr(e){let t=document.getElementById("combo-select");t&&t.value!=="users"&&(t.value="users",t.dispatchEvent(new Event("change",{bubbles:!0})),await new Promise(i=>requestAnimationFrame(i)));let o=document.getElementById("persons-table-body");if(o||(await new Promise(i=>requestAnimationFrame(i)),o=document.getElementById("persons-table-body")),!o){console.error("Person table tbody not found.");return}let r=window.CSS&&CSS.escape?CSS.escape(e):e.replace(/"/g,'\\"'),s=o.querySelector(`tr[data-person-id="${r}"]`);if(s||(s=Array.from(o.querySelectorAll("tr")).find(i=>i.dataset.personId===e)),!s)return;let a=s.nextElementSibling&&s.nextElementSibling.classList.contains("person-address-row")?s.nextElementSibling:null;o.querySelectorAll("tr.selected").forEach(i=>i.classList.remove("selected")),s.classList.add("selected"),a&&a.classList.add("selected"),s.scrollIntoView({behavior:"smooth",block:"center"})}function xr(){let e=document.querySelector("#persons-table");if(!e){console.error("Zone summary table not found.");return}e.querySelectorAll("thead th").forEach(n=>{let o=n.getAttribute("data-i18n"),r="";switch(o){case"name":r="name";break;case"date":r="date";break;case"speed":r="speed";break;case"percentage":r="percentage";break;case"zone":r="zone";break}if(!r)return;n.style.cursor="pointer",n.onclick=()=>{Re===r?ae=!ae:(Re=r,ae=!0),Ke()};let s=Re===r?ae?"\u25B2":"\u25BC":"",a=o==="speed"?T?l("mi_per_hour"):l("km_per_hour"):l(o);n.innerHTML=`
		  <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:30px;">
			<span class="hdr-label">${a}</span>
			<span class="hdr-arrow" style="font-size:12px;">${s}</span>
		  </div>
		`})}async function Ke(){try{let e=document.getElementById("persons-table-body");if(!e){console.error("Person table tbody not found.");return}let t=e.querySelector("tr.selected"),n=t?t.dataset.personId:null,r=[...ke.filter(i=>K[i.entity_id])].sort((i,c)=>{let d=K[i.entity_id]||{},f=K[c.entity_id]||{},m,u;switch(Re){case"name":return m=i.attributes.friendly_name||i.entity_id,u=c.attributes.friendly_name||c.entity_id,ae?m.localeCompare(u):u.localeCompare(m);case"date":return m=d.last_updated?new Date(d.last_updated).getTime():0,u=f.last_updated?new Date(f.last_updated).getTime():0,ae?m-u:u-m;case"speed":return m=parseFloat(d.attributes?.speed)||0,u=parseFloat(f.attributes?.speed)||0,ae?m-u:u-m;case"percentage":return m=parseFloat(d.battery_level)||0,u=parseFloat(f.battery_level)||0,ae?m-u:u-m;case"zone":return m=ge(d.attributes?.latitude,d.attributes?.longitude)?.name||"",u=ge(f.attributes?.latitude,f.attributes?.longitude)?.name||"",ae?m.localeCompare(u):u.localeCompare(m);default:return 0}}),s=Array.from(e.querySelectorAll("tr")),a=gr();r.forEach((i,c)=>{let d=i.entity_id,f=i.attributes.friendly_name||d,m=i.attributes.source||null,u="",p="",h="",y="",v="",S="",_=null,E,x,w,N=!1;if(m&&K[d]){let M=K[d];u=M.attributes.friendly_name?`(${M.attributes.friendly_name})`:"",y=M.battery_level,p=ee(M.last_updated),h=Math.round((M.attributes.speed||0)*(T?2.23694:3.6)),_=ge(M.attributes.latitude,M.attributes.longitude),v=_?_.name:"",E=Number(M.attributes.latitude),x=Number(M.attributes.longitude),w=new Date(M.last_updated).getTime();let W=jt[d];if(S=W?.address||"",!W)N=!0;else{let le=it(W.lat,W.lon,E,x),j=(w-(W.timestamp||0))/1e3;le>=Vt&&j>=Wt&&(S="",N=!0)}}let g=s.find(M=>M.dataset.personId===d&&!M.classList.contains("person-address-row")),C=g?g.nextElementSibling:null;if(!g){g=document.createElement("tr"),g.dataset.personId=d,g.style.cursor="pointer",C=document.createElement("tr"),C.dataset.personId=d,C.classList.add("person-address-row"),C.style.cursor="pointer";let M=document.createElement("td");M.setAttribute("colspan","5"),M.textContent=S||"",M.style.borderBottom="1px solid rgba(0,0,0,0.1)",C.appendChild(M),e.appendChild(g),e.appendChild(C)}let A=`
				<td><p style="font-weight:bold;color:#003366;margin:0;">${f}</p>${u}</td>
				<td>${p}</td>
				<td>${v}</td>
				<td>${h}</td>
				<td>${y}</td>
			  `;g.innerHTML!==A&&(g.innerHTML=A);let D=Er(_,se);g.style.setProperty("--color-bg",D||""),C&&C.style.setProperty("--color-bg",D||"");let I=C.querySelector("td");C.dataset.latitude=Number.isFinite(E)?String(E):"",C.dataset.longitude=Number.isFinite(x)?String(x):"",C.dataset.lastUpdated=Number.isFinite(w)?String(w):"0";let R=!!jt[d];N||!R&&Number.isFinite(E)&&Number.isFinite(x)?(I&&I.textContent!=="\u2026"&&(I.textContent="\u2026"),a.observe(C)):(Fn(`${d}_${C.dataset.lastUpdated}`),I&&I.textContent!==S&&(I.textContent=S||""));let P=()=>{e.querySelectorAll("tr.selected").forEach(M=>M.classList.remove("selected")),g.classList.add("selected"),C&&C.classList.add("selected"),Zt(d)};g.onclick=P,C&&(C.onclick=P),e.children[c*2]!==g&&(e.insertBefore(g,e.children[c*2]),e.insertBefore(C,g.nextSibling)),d===n&&(g.classList.add("selected"),C&&C.classList.add("selected"))}),Array.from(e.querySelectorAll("tr")).forEach(i=>{let c=i.dataset.personId;r.some(d=>d.entity_id===c)||(i.nextElementSibling&&i.nextElementSibling.classList.contains("person-address-row")&&i.nextElementSibling.remove(),i.remove())}),(Bn!==Re||Rn!==ae)&&(xr(),Bn=Re,Rn=ae)}catch(e){console.error("Error updating people table:",e)}}function Er(e,t=se){if(!e)return null;let n=e?.custom?e.color||U:me,o=Math.min(1,Math.max(0,Number(t)||0));return he(n,o)||he(me,o)}var Vn=" \u21D2 ",tt={coreJS:"https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js",coreCSS:"https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css",confirmJS:"https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/plugins/confirmDate/confirmDate.js",confirmCSS:"https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/plugins/confirmDate/confirmDate.css",l10nBase:"https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n"},yt,be=null,Yn=null;function Gt(){let e=new Set(["ar","de","en","es","fr","hi","it","ja","pt","zh"]),t=(navigator.languages?.length?navigator.languages:[navigator.language||"en"]).map(n=>String(n).toLowerCase());for(let n of t){let o=n.slice(0,2);if(e.has(o))return o}return"en"}async function Sr(){return yt||(yt=(async()=>{await Fe(tt.coreCSS),await Fe(tt.confirmCSS),await _e(tt.coreJS,{test:()=>!!window.flatpickr}),await _e(tt.confirmJS,{test:()=>!!window.confirmDatePlugin});let e=Gt();e!=="en"&&await _e(`${tt.l10nBase}/${e}.js`,{test:()=>!!window.flatpickr?.l10ns?.[e]}).catch(()=>{}),be=window.flatpickr,Yn=window.confirmDatePlugin,console.log("[flatpickr] v",be?.version,"locale:",e)})(),yt)}var He=[],nt=null,je,Ze,q,we="00:00:00",ve="23:59:59",pe=e=>String(e).padStart(2,"0"),Ue=e=>`${e.getFullYear()}-${pe(e.getMonth()+1)}-${pe(e.getDate())}T${pe(e.getHours())}:${pe(e.getMinutes())}:${pe(e.getSeconds())}`;function _r(e,t){return e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate()}function Gn(e){let[t="00",n="00"]=String(e||"").split(":");return`${pe(t)}:${pe(n)}`}async function Xn(e={}){if(nt=typeof e.onApplyFilter=="function"?e.onApplyFilter:null,window.__rangePickerInitDone)return;try{await Sr(),Nr()}catch(r){console.error("[calendar] no se pudo cargar flatpickr:",r);return}let t=document.getElementById("daterange");if(!t){console.error("[calendar] #daterange no existe");return}let n=Gt(),o=be?.l10ns?.[n]||be?.l10ns?.default;q=be(t,{mode:"range",enableTime:!1,closeOnSelect:!1,dateFormat:"Y-m-d",allowInput:!1,locale:o,plugins:[new Yn({confirmText:l("accept"),showAlways:!0,theme:"light"})],onDayCreate(r,s,a,i){i.addEventListener("click",()=>{we="00:00:00",ve="23:59:59",je?.setDate(we,!1),Ze?.setDate(ve,!1),setTimeout(()=>$e(a),0)})},onReady(r,s,a){Kn(a),$e(a)},onOpen(r,s,a){a._prevTextboxValue=a.input.value,a.calendarContainer.classList.add("fp-at-top"),Kn(a),He.length===2?a.setDate(He,!0):$e(a)},onClose(r,s,a){a.calendarContainer.classList.remove("fp-at-top")},onValueUpdate(){$e(q)},onChange(){$e(q)}}),window.addEventListener("resize",()=>{let r=q?.calendarContainer;r&&Qn(r)}),window.__rangePickerInitDone=!0}function bt(){let e,t;if(q&&Array.isArray(q.selectedDates)){let n=q.selectedDates.length;if(n===2){let[o,r]=q.selectedDates,[s,a,i]=(we||"00:00:00").split(":").map(p=>+p||0),[c,d,f]=(ve||"23:59:59").split(":").map(p=>+p||0),m=new Date(o);m.setHours(s,a,i,0);let u=new Date(r);u.setHours(c,d,f,0),e=Ue(m),t=Ue(u)}else if(n===1){let o=q.selectedDates[0],[r,s,a]=(we||"00:00:00").split(":").map(u=>+u||0),[i,c,d]=(ve||"23:59:59").split(":").map(u=>+u||0),f=new Date(o);f.setHours(r,s,a,0);let m=new Date(o);m.setHours(i,c,d,0),e=Ue(f),t=Ue(m)}}else if(Array.isArray(He)&&He.length===2){let[n,o]=He;e=Ue(n),t=Ue(o)}return{startLocal:e,endLocal:t}}function gt(e="00:00:00",t="23:59:59"){we=e||"00:00:00",ve=t||"23:59:59",je?.setDate(we,!1),Ze?.setDate(ve,!1),q&&$e(q)}function Kt([e,t],n=!0){q&&(q.setDate([e,t],!!n),n||$e(q))}function ot(){He=[],q&&(q.clear(!1),q.input.value="")}function Jt(){let e=document.getElementById("person-select"),t=document.getElementById("daterange"),n=t?.closest(".group")||t;if(!e||!n)return;let o=e.value===""||e.selectedIndex===-1;n.style.display=o?"none":"",o&&(t.value="",q?.clear(!1))}function $e(e){if(!e)return;let t=new Intl.DateTimeFormat(void 0,{year:"2-digit",month:"2-digit",day:"2-digit"}),[n,o]=e.selectedDates||[],r=Gn(we||"00:00:00"),s=Gn(ve||"23:59:59");if(n&&!o){e.input.value=`${t.format(n)} ${r}`;return}if(n&&o){_r(n,o)?e.input.value=`${t.format(n)} ${r}${Vn}${s}`:e.input.value=`${t.format(n)} ${r}${Vn}${t.format(o)} ${s}`;return}e.input.value=""}function Lr(e){let t=e.selectedDates||[];if(t.length===1){let n=t[0];e.setDate([n,n],!1)}$e(e),e.close(),nt&&nt()}function Qn(e){let t=e.getBoundingClientRect().width+"px";je?.calendarContainer&&(je.calendarContainer.style.width=t),Ze?.calendarContainer&&(Ze.calendarContainer.style.width=t)}function Cr(e){let t=document.createElement("div");t.className="fp-quickbar";let n=o=>`${pe(o.getHours())}:${pe(o.getMinutes())}:${pe(o.getSeconds())}`;return["today","yesterday","last_24h","last_7_days","this_week"].forEach(o=>{let r=document.createElement("button");r.type="button",r.textContent=l(o),r.addEventListener("click",()=>{let{start:s,end:a}=Dr(o);if(s&&a){if(o==="last_24h"){let i=new Date(a.getTime()-1e3);gt(n(s),n(i))}else gt("00:00:00","23:59:59");Kt([s,a],!0),e.close(),nt&&nt()}}),t.appendChild(r)}),t}function Kn(e){let t=e.calendarContainer;t.querySelector(".fp-quickbar")||t.appendChild(Cr(e));let n=t.querySelector(".fp-timepanel");if(!n){n=document.createElement("div"),n.className="fp-timepanel";let s=document.createElement("div");s.className="fp-timeblock";let a=document.createElement("div");a.className="fp-timehost",s.appendChild(a);let i=document.createElement("div");i.className="fp-timeblock";let c=document.createElement("div");c.className="fp-timehost",i.appendChild(c),n.append(s,i),t.appendChild(n);let d=Gt(),f=be?.l10ns?.[d]||be?.l10ns?.default,m=!new Intl.DateTimeFormat(void 0,{hour:"numeric"}).formatToParts(new Date).some(h=>h.type==="dayPeriod"),u=document.createElement("input");u.type="hidden";let p=document.createElement("input");p.type="hidden",document.body.appendChild(u),document.body.appendChild(p),je=be(u,{inline:!0,noCalendar:!0,enableTime:!0,enableSeconds:!0,time_24hr:m,dateFormat:"H:i:S",defaultDate:we,locale:f,onChange:(h,y)=>{we=y||"00:00:00"}}),Ze=be(p,{inline:!0,noCalendar:!0,enableTime:!0,enableSeconds:!0,time_24hr:m,dateFormat:"H:i:S",defaultDate:ve,locale:f,onChange:(h,y)=>{ve=y||"23:59:59"}}),a.appendChild(je.calendarContainer),c.appendChild(Ze.calendarContainer)}let o=t.querySelector(".fp-actionbar");o||(o=document.createElement("div"),o.className="fp-actionbar",t.appendChild(o));let r=t.querySelector(".flatpickr-confirm");if(r&&!o.contains(r)&&(r.textContent=l("accept"),r.classList.add("fp-btn"),o.appendChild(r),r.dataset._bound||(r.addEventListener("click",()=>Lr(e)),r.dataset._bound="1")),!o.querySelector(".flatpickr-cancel")){let s=document.createElement("button");s.type="button",s.className="fp-btn flatpickr-cancel",s.textContent=l("cancel"),o.insertBefore(s,o.querySelector(".flatpickr-confirm")||null),s.addEventListener("click",()=>{Array.isArray(e._prevSelectedDates)?e.setDate(e._prevSelectedDates,!1):e.clear(!1),typeof e._prevTextboxValue=="string"?e.input.value=e._prevTextboxValue:e.input.value="",e.close()})}Qn(t)}function kr(e){let t=new Date(e);return t.setHours(0,0,0,0),t}function Jn(e,t){let n=new Date(e);return n.setDate(n.getDate()+t),n}function $r(e){let t=new Date(e.getFullYear(),e.getMonth(),1);return t.setHours(0,0,0,0),t}function Tr(e){let t=new Date(e.getFullYear(),e.getMonth()+1,1);return t.setHours(0,0,0,0),t}function eo(e){let t=new Date(e),n=t.getDay(),o=n===0?-6:1-n;return t.setDate(t.getDate()+o),t.setHours(0,0,0,0),t}function Mr(e){let t=eo(e),n=new Date(t);return n.setDate(t.getDate()+7),new Date(n.getTime()-1e3)}function Dr(e){let t=new Date,n=kr(t);switch(e){case"today":return{start:n,end:n};case"yesterday":return{start:Jn(n,-1),end:Jn(n,-1)};case"last_24h":return{start:new Date(t-1440*60*1e3),end:new Date(t-1e3)};case"last_7_days":return{start:new Date(t-10080*60*1e3),end:t};case"this_month":return{start:$r(t),end:Tr(t)};case"last_month":{let o=new Date(t.getFullYear(),t.getMonth()-1,1,0,0,0,0),r=new Date(t.getFullYear(),t.getMonth(),1,0,0,0,0),s=new Date(r.getTime()-1e3);return{start:o,end:s}}case"this_week":return{start:eo(t),end:Mr(t)};default:return{start:null,end:null}}}function Nr(){if(document.getElementById("fp-shadow-patch"))return;let e=document.createElement("style");e.id="fp-shadow-patch",e.textContent=`
    .flatpickr-calendar{
      background:#fff !important;
      border:1px solid rgba(0,0,0,.12) !important;
      border-radius:12px !important;
      box-shadow:0 12px 28px rgba(0,0,0,.30) !important;
      overflow:hidden;
    }
    @media (max-width: 600px){
      .flatpickr-calendar.fp-at-top{
        left: 8px !important;
        right: 8px !important;
        width: auto !important;
        max-width: calc(100% - 16px) !important;
        margin: 0 auto !important;
      }
    }
  `,document.head.appendChild(e)}function Yt(e){return(e instanceof Date?e:new Date(e)).toISOString()}function J(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Ir(e=""){return`<![CDATA[${e}]]>`}function Ar(e){return Number.isFinite(e)?Math.round(e*3.6):0}function Pr(e){let t=[];for(let n of e||[]){let o=Number(n?.attributes?.latitude),r=Number(n?.attributes?.longitude);!Number.isFinite(o)||!Number.isFinite(r)||t.push(`${r},${o},0`)}return t}function zr(e,t={}){let{stopIconHref:n,includeRoute:o=!0,routeColor:r="ff0000ff",routeWidth:s=6,describeStop:a,nameStop:i,unitLabel:c="km/h",formatLocal:d,batteryLabel:f="Battery"}=t;if(!e||!e.length)throw new Error("No hay posiciones para exportar.");let m=Yt(e[0].last_updated),u=Yt(e[e.length-1].last_updated),p=`
    <Style id="stopStyle">
      <IconStyle>
        <scale>1.2</scale>
        ${n?`<Icon><href>${J(n)}</href></Icon>`:""}
      </IconStyle>
      <LabelStyle><scale>0</scale></LabelStyle>
    </Style>
    <Style id="routeStyle">
      <LineStyle>
        <color>${J(r)}</color>
        <width>${Number(s)||6}</width>
      </LineStyle>
    </Style>
  `,h=o?Pr(e):[],y=o&&h.length>=2?`
    <Placemark>
      <name>Route</name>
      <styleUrl>#routeStyle</styleUrl>
      <LineString>
        <tessellate>1</tessellate>
        <coordinates>${h.join(" ")}</coordinates>
      </LineString>
    </Placemark>
  `:"",v=(e||[]).filter(E=>!!E?.stop).map((E,x)=>{let w=Number(E?.attributes?.latitude),N=Number(E?.attributes?.longitude);if(!Number.isFinite(w)||!Number.isFinite(N))return"";let g=Yt(E.last_updated),C=d?d(E.last_updated):g,A=Ar(Number(E?.attributes?.speed)),D=`${E?.entity_id||"position"} #${x+1}`,I=i?i(E):D,R=Number.isFinite(E?.battery)?Math.round(E.battery):null,H="\u2022",P=(E?.zone||"").trim(),M=(E?.address||"").trim(),W=`${A} ${c}`,le=R!=null?`${f}: ${R}%`:"",F=[P,W,le,M].filter(Boolean).map(Y=>`${H} ${Y}`).join(`
`).trim(),de=a?a(E):`<table cellspacing="0" cellpadding="0" style="border-collapse:collapse">
			  <tr><td><b>${J(C)}</b></td></tr>
			  ${P?`<tr><td>${J(P)}</td></tr>`:""}
			  ${M?`<tr><td>${J(M)}</td></tr>`:""}
			  <tr><td>${J(W)}</td></tr>
			  ${R!=null?`<tr><td>${J(le)}</td></tr>`:""}
			 </table>`;return`
		  <Placemark>
			<name>${J(I)}</name>
			<Snippet maxLines="6"><![CDATA[${F}]]></Snippet>
			<styleUrl>#stopStyle</styleUrl>
			<TimeStamp><when>${g}</when></TimeStamp>
			<ExtendedData>
			  <Data name="entity_id"><value>${J(E?.entity_id||"")}</value></Data>
			  <Data name="speed_kmh"><value>${A}</value></Data>
			  <Data name="is_stop"><value>true</value></Data>
			  <Data name="zone"><value>${J(P)}</value></Data>
			  <Data name="address"><value>${J(M)}</value></Data>
			  <Data name="when_local"><value>${J(C)}</value></Data>
			  <Data name="unit"><value>${J(c)}</value></Data>
			  ${R!=null?`<Data name="battery_pct"><value>${R}</value></Data>`:""}
			</ExtendedData>
			<description>${Ir(de)}</description>
			<Point><coordinates>${N},${w},0</coordinates></Point>
		  </Placemark>
		`}).join(`
`),S=`HA Tracker ${m} - ${u}`;return`<?xml version="1.0" encoding="UTF-8"?>
  <kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
      <name>${J(S)}</name>
      ${p}
      ${y}
      <Folder>
        <name>Stops</name>
        ${v}
      </Folder>
    </Document>
  </kml>`}function no(e,t){let n=new Blob([t],{type:"application/vnd.google-earth.kml+xml"}),o=URL.createObjectURL(n),r=document.createElement("a");r.href=o,r.download=e.endsWith(".kml")?e:`${e}.kml`,document.body.appendChild(r),r.click(),r.remove(),URL.revokeObjectURL(o)}async function Fr(e,t){let n=new Blob([t],{type:"application/vnd.google-earth.kml+xml"});if("showSaveFilePicker"in window){let r=await(await window.showSaveFilePicker({suggestedName:e.endsWith(".kml")?e:`${e}.kml`,types:[{description:"KML file",accept:{"application/vnd.google-earth.kml+xml":[".kml"]}}]})).createWritable();await r.write(n),await r.close()}else no(e,t)}function wt(e){return String(e).padStart(2,"0")}function to(e){let t=e instanceof Date?e:new Date(e);return`${t.getFullYear()}-${wt(t.getMonth()+1)}-${wt(t.getDate())}_${wt(t.getHours())}-${wt(t.getMinutes())}`}function Or(e,t="person"){if(!e||!e.length)return`ha-tracker_${t}.kml`;let n=e[0]?.last_updated,o=e[e.length-1]?.last_updated;return`ha-tracker_${t}_${to(n)}_${to(o)}.kml`}async function oo(e,t={}){let{personId:n="person",filename:o,usePicker:r=!1,...s}=t,a=zr(e,s),i=o||Or(e,n);r?await Fr(i,a):no(i,a)}function ro(e){return e==null?"":`"${String(e).replace(/\r?\n/g," ").trim().replace(/"/g,'""')}"`}function so(e){let t=Number(e);return Number.isFinite(t)?t.toFixed(6):""}function Br(e,t){if(!Number.isFinite(e))return"";let n=e*3.6,o=n*.621371192;return Math.round(t?o:n)}function Rr(e,{useImperial:t,formatLocal:n,delimiter:o=";"}={}){let r=t?l("mi_per_hour"):l("km_per_hour"),a=[[l("date"),l("stops"),l("latitude"),l("longitude"),r,l("battery"),l("zone"),l("address")].map(ro).join(o)];for(let i of e||[]){let c=i?.attributes?.latitude,d=i?.attributes?.longitude,f=n?n(i?.last_updated):i?.last_updated||"",m=i?.stop?l("stop"):"",u=Br(Number(i?.attributes?.speed),t),p=Number.isFinite(i?.battery)?i.battery:"",h=[f,m,so(c),so(d),u,p,i?.zone||"",i?.address||""].map(ro).join(o);a.push(h)}return a.join(`
`)}function ao(e,t){let n=new Blob(["\uFEFF"+t],{type:"text/csv;charset=utf-8"}),o=URL.createObjectURL(n),r=document.createElement("a");r.href=o,r.download=e.endsWith(".csv")?e:`${e}.csv`,document.body.appendChild(r),r.click(),r.remove(),URL.revokeObjectURL(o)}async function Ur(e,t){let n=new Blob(["\uFEFF"+t],{type:"text/csv;charset=utf-8"});if("showSaveFilePicker"in window){let r=await(await window.showSaveFilePicker({suggestedName:e.endsWith(".csv")?e:`${e}.csv`,types:[{description:"CSV",accept:{"text/csv":[".csv"]}}]})).createWritable();await r.write(n),await r.close()}else ao(e,t)}async function io(e,{filename:t,useImperial:n,formatLocal:o,delimiter:r=";",usePicker:s=!1}={}){let a=Rr(e,{useImperial:n,formatLocal:o,delimiter:r});s?await Ur(t,a):ao(t,a)}var Hr="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js";async function jr(){window.ExcelJS||await new Promise((e,t)=>{let n=document.createElement("script");n.src=Hr,n.async=!0,n.onload=()=>e(),n.onerror=o=>t(o),document.head.appendChild(n)})}function co(e){let t=Number(e);return Number.isFinite(t)?Number(t.toFixed(6)):null}function Zr(e,t){if(!Number.isFinite(e))return null;let n=e*3.6,o=n*.621371192;return Math.round(t?o:n)}function xe(e){return String(e||"").split(`
`).reduce((t,n)=>Math.max(t,n.length),0)}function qr(e,t){let n=[19,6,11,11,12,8,18,30],o=[40,10,16,16,16,10,50,80],r=t.map(s=>xe(s));for(let s of e)r[0]=Math.max(r[0],xe(s.date)),r[1]=Math.max(r[1],xe(s.stop)),r[2]=Math.max(r[2],xe(s.latStr)),r[3]=Math.max(r[3],xe(s.lonStr)),r[4]=Math.max(r[4],xe(s.speedStr)),r[5]=Math.max(r[5],xe(s.battStr)),r[6]=Math.max(r[6],xe(s.zone)),r[7]=Math.max(r[7],xe(s.address));return r.map((s,a)=>Math.min(o[a],Math.max(n[a],s+2)))}async function lo(e,{filename:t="ha-tracker.xlsx",useImperial:n=!1,formatLocal:o=s=>new Date(s).toLocaleString(),sheetName:r=l("positions")}={}){await jr();let s=window.ExcelJS,a=new s.Workbook,i=a.addWorksheet(r),c={name:"Verdana",size:9},d={vertical:"middle",horizontal:"left"},f=n?l("mi_per_hour"):l("km_per_hour"),m=[l("date"),l("stops"),l("latitude"),l("longitude"),f,l("battery"),l("zone"),l("address")],u=(e||[]).map(w=>{let N=o?o(w?.last_updated):w?.last_updated||"",g=w?.stop?l("stop"):"",C=co(w?.attributes?.latitude),A=co(w?.attributes?.longitude),D=Zr(Number(w?.attributes?.speed),n),I=Number.isFinite(w?.battery)?w.battery:null,R=w?.zone||"",H=(w?.address||"").replace(/\u00A0/g," ");return{date:N,stop:g,lat:C,lon:A,speed:D,batt:I,latStr:C==null?"":String(C),lonStr:A==null?"":String(A),speedStr:D==null?"":String(D),battStr:I==null?"":String(I),zone:R,address:H}}),p={type:"pattern",pattern:"solid",fgColor:{argb:"FF003E78"}},h={...c,bold:!0,color:{argb:"FFFFFFFF"}},y={...d,wrapText:!0};i.addRow(m);let v=i.getRow(1);v.height=18,v.font=h,v.alignment=y,v.eachCell(w=>{w.fill=p,w.font=h,w.alignment=y});for(let w of u){let N=i.addRow([w.date,w.stop,w.lat,w.lon,w.speed,w.batt,w.zone,w.address]);N.font=c,N.alignment=d}i.views=[{state:"frozen",ySplit:1}];let S=qr(u,m);i.columns=S.map((w,N)=>({width:w,style:{font:c,alignment:{...d,wrapText:N===7}}})),i.getRow(1).eachCell(w=>{w.font=h,w.alignment=y,w.fill=p});let _=await a.xlsx.writeBuffer(),E=new Blob([_],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),x=document.createElement("a");x.href=URL.createObjectURL(E),x.download=t.endsWith(".xlsx")?t:`${t}.xlsx`,document.body.appendChild(x),x.click(),x.remove(),URL.revokeObjectURL(x.href)}var Wr="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js",Vr="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js",Gr="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js",vt=[0,62,120],Xt=[255,255,255];function Qt(e){return new Promise((t,n)=>{if([...document.scripts].some(r=>r.src===e))return t();let o=document.createElement("script");o.src=e,o.async=!0,o.onload=()=>t(),o.onerror=r=>n(r),document.head.appendChild(o)})}async function Kr(){window.jspdf?.jsPDF&&window.jspdf?.autoTable||(await Qt(Wr),await Qt(Vr))}async function Jr(){window.html2canvas||await Qt(Gr)}async function Yr(){await Jr();let e=document.getElementById("map");return e?(await window.html2canvas(e,{useCORS:!0,backgroundColor:"#ffffff",logging:!1,scale:2})).toDataURL("image/jpeg",.92):null}function Xr(e,t=.25){let n=/^#?([0-9a-f]{6})$/i.exec(e||"");if(!n)return null;let o=parseInt(n[1],16),r=o>>16&255,s=o>>8&255,a=o&255,i=c=>Math.round((1-t)*255+t*c);return[i(r),i(s),i(a)]}function Qr(e,{customDefault:t="#0088ff",noCustomDefault:n="#c0c0c0"}={}){return e&&(typeof e.is_custom=="boolean"?e.is_custom:typeof e.custom=="boolean"?e.custom:!!e.color)?e.color||t:n}function en(e,t={},{alpha:n=.25,customDefault:o="#0088ff",noCustomDefault:r="#c0c0c0"}={}){if(!e)return null;let s=t[e],a=Qr(s,{customDefault:o,noCustomDefault:r});return Xr(a,n)}function mo(e=[]){let t=[],n=null;for(let o of e){let r=(o.zone||"").trim(),s=r!==n;(o.stop||s)&&t.push(o),n=r}return t}function uo(e,t,n,o,r,s,{font:a="helvetica",labelStyle:i="bold",valueStyle:c="normal",lineHeight:d=14}={}){e.setFont(a,i);let f=e.getTextWidth(r);e.setFont(a,c);let m=e.splitTextToSize(String(s||""),Math.max(20,o-f));e.setFont(a,i),e.text(r,t,n),e.setFont(a,c),e.text(m[0]||"",t+f,n);for(let u=1;u<m.length;u++)n+=d,e.text(m[u],t+f,n);return n+d}function es(e,{margin:t,pageW:n,personName:o,startLocal:r,endLocal:s,nameColor:a=[0,62,120]}){let i=n-t*2,c=t;e.setFont("helvetica","bold"),e.setFontSize(16),e.setTextColor(a[0],a[1],a[2]);let d=e.splitTextToSize(o||"",i);return e.text(d,t,c),c+=d.length*18,e.setFontSize(11),e.setTextColor(a[0],a[1],a[2]),c=uo(e,t,c,i,`${l("start")||"Inicio"}: `,r||"",{lineHeight:14,labelStyle:"bold",valueStyle:"normal"}),c=uo(e,t,c,i,`${l("end")||"Fin"}: `,s||"",{lineHeight:14,labelStyle:"bold",valueStyle:"normal"}),c+=6,c}function ts(e,t,n=.9){let o=e.internal.pageSize.getWidth(),r=o-t*2,s=Math.floor(r*n),a=t+Math.round((r-s)/2);return{tableWidth:s,left:a,pageW:o}}function ns(e){let t={date:.22,stop:.03,zone:.24,speed:.12,batt:.09,addr:.3},n={date:90,stop:12,zone:90,speed:54,batt:40,addr:90},o=Math.max(n.date,Math.floor(e*t.date)),r=Math.max(n.stop,Math.floor(e*t.stop)),s=Math.max(n.zone,Math.floor(e*t.zone)),a=Math.max(n.speed,Math.floor(e*t.speed)),i=Math.max(n.batt,Math.floor(e*t.batt)),c=Math.max(n.addr,Math.floor(e*t.addr)),d=o+r+s+a+i+c,f=e-d;return f!==0&&(c=Math.max(n.addr,c+f)),{wDate:o,wStop:r,wZone:s,wSpeed:a,wBatt:i,wAddr:c}}async function fo({filename:e,summaryRows:t,zonesRows:n,positionsRows:o,stopIconUrl:r,header:s}){await Kr();let{jsPDF:a}=window.jspdf,i=new a({unit:"pt",format:"a4",compress:!0}),c=i.internal.pageSize.getWidth(),d=36,f=ts(i,d,.9),m=null;if(r)try{let C=await(await fetch(r,{cache:"force-cache"})).blob();m=await new Promise(A=>{let D=new FileReader;D.onload=()=>A(D.result),D.readAsDataURL(C)})}catch{}let u=es(i,{margin:d,pageW:c,personName:s?.personName||"",startLocal:s?.startLocal||"",endLocal:s?.endLocal||"",nameColor:vt});try{let g=await Yr();if(g){let C=i.getImageProperties(g),A=f.tableWidth,D=C.height*A/C.width;i.addImage(g,"JPEG",f.left,u,A,D),u+=D+8}}catch(g){console.warn("No se pudo capturar el mapa:",g)}i.autoTable({head:[[l("metric")||"M\xE9trica",l("value")||"Valor"]],body:(t||[]).map(g=>[g.label,g.value]),startY:u,theme:"grid",tableWidth:f.tableWidth,margin:{left:f.left,right:f.left},styles:{font:"helvetica",fontSize:10,cellPadding:4,overflow:"linebreak"},headStyles:{fillColor:vt,textColor:Xt,fontStyle:"bold",halign:"left"},columnStyles:{0:{cellWidth:170,fontStyle:"bold"},1:{cellWidth:f.tableWidth-170}}}),u=i.lastAutoTable.finalY+8;{let g=!!xt,C=100,A=60,D=60,I=60,R=C+D+I+(g?A:0),H=Math.max(160,f.tableWidth-R),P=[{key:"zone",header:l("zone")||"Zona",width:H,halign:"left"},{key:"time",header:l("time")||"Tiempo",width:C,halign:"center"}];g&&P.push({key:"visits",header:l("visits")||"Visitas",width:A,halign:"center"}),P.push({key:"stops",header:l("stops")||"Paradas",width:D,halign:"center"},{key:"distance",header:l("distance")||"Distancia",width:I,halign:"center"});let M=[P.map(j=>j.header)],W=(n||[]).map(j=>P.map(F=>F.key==="distance"?os(j):F.key==="stops"||F.key==="visits"?String(j[F.key]??""):j[F.key]||"")),le=P.reduce((j,F,de)=>(j[de]={cellWidth:F.width,halign:F.halign},j),{});i.autoTable({head:M,body:W,startY:u,theme:"grid",tableWidth:f.tableWidth,margin:{left:f.left,right:f.left},styles:{font:"helvetica",fontSize:10,cellPadding:4,overflow:"linebreak"},headStyles:{fillColor:vt,textColor:Xt,fontStyle:"bold",halign:"left"},columnStyles:le,didParseCell:j=>{if(j.section==="body"){let F=n[j.row.index];F?._fillColor&&(j.cell.styles.fillColor=F._fillColor)}}}),u=i.lastAutoTable.finalY+8}let{wDate:p,wStop:h,wZone:y,wSpeed:v,wBatt:S,wAddr:_}=ns(f.tableWidth),x=(o||[]).some(g=>/\bmph\b/i.test(String(g.speed||"")))?`${l("speed")||"Velocidad"} (${l("mi_per_hour")||"mph"})`:`${l("speed")||"Velocidad"} (${l("km_per_hour")||"km/h"})`,w=(o||[]).map(g=>[g.whenLocal||"","",g.zone||"",g.speed||"",(g.battery??"")===""?"":`${g.battery}%`,(g.address||"").replace(/\u00A0/g," ")]);i.autoTable({head:[[l("date")||"Fecha/Hora","",l("zone")||"Zona",x,l("battery")||"Bater\xEDa",l("address")||"Direcci\xF3n"]],body:w,startY:u,theme:"grid",tableWidth:f.tableWidth,margin:{left:f.left,right:f.left},styles:{font:"helvetica",fontSize:9,cellPadding:{top:3,right:3,bottom:3,left:3},halign:"left",valign:"top",overflow:"linebreak",cellWidth:"wrap"},headStyles:{fillColor:vt,textColor:Xt,fontStyle:"bold",halign:"left"},columnStyles:{0:{cellWidth:p},1:{cellWidth:h,halign:"center"},2:{cellWidth:y},3:{cellWidth:v,halign:"center"},4:{cellWidth:S,halign:"center"},5:{cellWidth:_}},didParseCell:g=>{if(g.section==="body"){let C=o[g.row.index];C?._fillColor&&(g.cell.styles.fillColor=C._fillColor)}},didDrawCell:g=>{if(g.section==="body"&&g.column.index===1&&m&&o[g.row.index]?.isStop){let D=g.cell.x+(g.cell.width-10)/2,I=g.cell.y+(g.cell.height-10)/2;try{i.addImage(m,"PNG",D,I,10,10)}catch{}}},pageBreak:"auto"});let N=e?.endsWith(".pdf")?e:`${e||"export"}.pdf`;i.save(N)}function os(e){if(!e)return"";if(e.distance!=null&&e.distance!=="")return String(e.distance);let t=Number(e.distanceMeters??e.meters??NaN);return Number.isFinite(t)?`${((e._unitShort==="mi"||e._unitShort==="km"?e._unitShort:"km")==="mi"?t/1609.344:t/1e3).toFixed(0)}`:""}var _t=[],qe=null,ie=null,Et="zone",Ee=!0,xt=!1,rs="/local/ha-tracker/images/filter.png",ss="/local/ha-tracker/images/stop16x16.png",go="/local/ha-tracker/images/stop24x24.png",ce=e=>String(e).padStart(2,"0");document.getElementById("combo-select").addEventListener("change",function(){Lt()});function bo(){let e=document.querySelector('.tab-button[data-tab="positions"]');e&&wo({currentTarget:e},"positions")}function wo(e,t){document.querySelectorAll(".tab").forEach(n=>n.classList.remove("active")),document.querySelectorAll(".tab-button").forEach(n=>n.classList.remove("active")),document.getElementById(t).classList.add("active"),e.currentTarget.classList.add("active")}async function vo(){Ct(!1),hs(),Jt();let e=document.getElementById("person-select");e.addEventListener("focus",async()=>{try{await qt()}catch(n){console.error(n)}}),e.addEventListener("change",()=>{try{Lt(!0,!1),Zt(document.getElementById("person-select").value),Jt(),Ct(!1)}catch(n){console.error(n)}}),document.querySelectorAll(".tab-button").forEach(n=>{n.addEventListener("click",o=>{try{let r=n.getAttribute("data-tab");wo(o,r)}catch(r){console.error(r)}})}),await Xn({onApplyFilter:()=>Eo().catch(console.error)})}async function xo(e){try{let t=Array.isArray(e)?e:e?.positions||[],n=Array.isArray(e)?null:e?.summary||null,o=Array.isArray(e)?null:e?.zones||null;t.length>0?(console.log("Positions:",t),await Lt(!1,!1),await as(t),n&&cs(n),o&&ls(o),await Co(),await ds(t),await ms(t,void 0,void 0,void 0,void 0,void 0,{curved:!0,curveAlg:"catmull",subdivisions:6,alpha:.5}),Ct(!0)):(Lt(!0,!1),Ct(!1),z(l("no_positions"),{title:l("filter")}))}catch(t){console.error("Error getting filtered positions:",t),z(l("filter_problem"),{title:l("filter")})}}async function as(e){let t=document.getElementById("filter-table-body");if(!e||e.length===0)return;let n=[],o=null,r=0;e.forEach((m,u)=>{let p=ge(m.attributes.latitude,m.attributes.longitude),h=p?p.name:"";u===0?(o=h,r=0):h!==o&&(n.push({start:r,end:u-1}),o=h,r=u),u===e.length-1&&n.push({start:r,end:u})});let s=_s(),a=null,i=0,c=!1,d=document.createDocumentFragment();if(e.forEach(m=>{let u=ge(m.attributes.latitude,m.attributes.longitude),p=u?u.name:"";p!==a?(i++,a=p,c=!0):c=!1;let h=`group-${i}`,y=m?.stop?`<img src="${ss}" alt="" style="width:16px;height:16px;">`:"",v=ee(m.last_updated),S=Math.round((m.attributes.speed||0)*(T?2.23694:3.6)),_=Z(S),E=`${m.entity_id}_${new Date(m.last_updated).toISOString()}`,x=document.createElement("tr");if(tn(x,u,se),x.classList.add(h,"pos-main-row"),x.dataset.entityId=E,x.dataset.latitude=m.attributes.latitude,x.dataset.longitude=m.attributes.longitude,x.dataset.lastUpdated=m.last_updated,x.dataset.speed=String(S),x.dataset.battery=(bs(m?.attributes)??"").toString(),x.dataset.isStop=m&&m.stop?"1":"0",x.dataset.entity=m?.entity_id||"",x.dataset.zone=p||"",x.dataset.address="",x.style.cursor="pointer",c){let w=n[i-1],N=new Date(e[w.start].last_updated),g=new Date(e[w.end].last_updated),C=new Date(g.getTime()+1e3),A=po(N),D=po(C);x.classList.add("group-header"),x.innerHTML=`
				<td><button class="toggle-btn">\u25BA</button></td>
				<td>${y}</td>
				<td>${v}</td>
				<td>${p}</td>
				<td>${_}</td>
				<td>
				  <button class="group-filter-btn" title="${l("filter")||"Filtrar"}"
						  style="background:none;border:none;cursor:pointer;padding:0;line-height:0;">
						  <img src="${rs}" alt="" style="width:16px;height:16px;">
				  </button>
				</td>
			  `;let I=x.querySelector(".toggle-btn");I.addEventListener("click",H=>{H.stopPropagation(),So(h,I)}),x.querySelector(".group-filter-btn").addEventListener("click",async H=>{H.stopPropagation();try{let[P,M="00:00:00"]=A.split("T"),[W,le="23:59:59"]=D.split("T"),j=F=>{let[de,Y,We]=F.split("-").map(Number);return new Date(de,Y-1,We,0,0,0,0)};gt(M,le),Kt([j(P),j(W)],!0),await Eo()}catch(P){console.error("No se pudo aplicar el rango al calendario",P)}})}else m&&m.stop?(x.style.display="table-row",x.classList.add("pin-visible")):x.style.display="none",x.innerHTML=`
				<td></td>
				<td>${y}</td>
				<td>${v}</td>
				<td>${p}</td>
				<td>${_}</td>
				<td></td>
			  `;if(x.onclick=()=>St(x),d.appendChild(x),m&&m.stop){x.classList.add("has-address");let w=document.createElement("tr");w.dataset.address="",w.classList.add(h,"position-address-row","pin-visible"),w.style.cursor="pointer",w.dataset.entityId=E,w.style.display="table-row";let N=new Date(m.last_updated).getTime();w.dataset.latitude=String(+m.attributes.latitude),w.dataset.longitude=String(+m.attributes.longitude),w.dataset.lastUpdated=String(N),w.innerHTML=`
        <td class="addr-spacer"></td>
        <td class="addr-cell" colspan="5" style="padding:4px 8px;">\u2026</td>
      `,w.onclick=()=>St(x),d.appendChild(w),tn(w,u,se),s.observe(w)}}),t.innerHTML="",t.appendChild(d),e.length>0){let m=t.querySelector("tr");m&&St(m)}t.querySelectorAll(".group-header").forEach(m=>{let u=Array.from(m.classList).find(_=>_.startsWith("group-"));if(!u)return;let p=t.querySelectorAll(`tr.${u}:not(.group-header):not(.pin-visible)`),h=p.length>0,y=h&&Array.from(p).some(_=>_.style.display==="none"),v=m.querySelector(".toggle-btn"),S=m.querySelector(".group-filter-btn");v&&(v.style.display=h?"":"none",v.textContent=y?"\u25BA":"\u25BC"),S&&(S.style.display=h?"":"none")})}function is(){let e=document.getElementById("filter-table-body");if(!e)return;let t=Array.from(e.querySelectorAll("tr.pos-main-row"));if(!t.length)return;let n=null;for(let o of t){let r=Number(o.dataset.speed)||0,s=Date.parse(o.dataset.lastUpdated)||0;(!n||r>n.s||r===n.s&&s>n.ts)&&(n={id:o.dataset.entityId,s:r,ts:s})}n&&n.id?Lo(n.id):z(l("no_positions")||"No hay posiciones.",{title:l("filter")})}function cs(e){let t=T?2.23694:3.6,n=T?e.distance_m/1609.344:e.distance_m/1e3,o=s=>rn(s*1e3);document.getElementById("positions-count").textContent=Z(e.positions_count),document.getElementById("total-time").textContent=o(e.total_time_s),document.getElementById("distance").textContent=`${on(n)} ${l(T?"miles":"kilometres")}`,document.getElementById("max-speed").textContent=`${Z(e.max_speed_mps*t)} ${l(T?"mi_per_hour":"km_per_hour")}`,document.getElementById("average-speed").textContent=`${on(e.average_speed_mps*t)} ${l(T?"mi_per_hour":"km_per_hour")}`,document.getElementById("stops-count").textContent=Z(e.stops_count),document.getElementById("stopped-time").textContent=o(e.stopped_time_s);let r=document.querySelector("#summary table tbody tr:nth-child(4)");r&&(r.style.cursor="pointer",r.title=l("go_to_max_speed")||"Ir a la posici\xF3n de velocidad m\xE1xima",r.onclick=is)}function ls(e){ie={zoneDurations:{},zoneVisits:{},zonePositions:{},zoneStops:{},zoneDistanceMeters:{}};for(let t of e){let n=t.zone||"";ie.zoneDurations[n]=(t.time_s||0)*1e3,ie.zoneVisits[n]=t.visits||0,ie.zoneStops[n]=t.stops||0,ie.zoneDistanceMeters[n]=t.distance_m||0,t.meta&&(ie.zonePositions[n]={id:t.meta.id,name:t.meta.name||n,lat:t.meta.latitude,lon:t.meta.longitude,color:t.meta.color||null,custom:!!t.meta.is_custom,is_custom:!!t.meta.is_custom})}}async function ds(e){b.getPane("filterMarkers")||(b.createPane("filterMarkers"),b.getPane("filterMarkers").style.zIndex=400);let t=18;e.forEach(n=>{let o=Number(n?.attributes?.latitude),r=Number(n?.attributes?.longitude);if(!Number.isFinite(o)||!Number.isFinite(r))return;let s=n.stop?L.icon({iconUrl:go,iconSize:[24,24],iconAnchor:[12,12]}):L.divIcon({className:"",html:`<div style="
            width:10px;height:10px;border:1px solid rgba(0,0,255,0.8);
            border-radius:50%;background-color: rgba(0,0,255,0.5);
          "></div>`,iconSize:[10,10],iconAnchor:[5,5]}),a=L.marker([o,r],{icon:s,pane:"filterMarkers"});a.isStop=!!n.stop,(n.stop||b.getZoom()>=t)&&a.addTo(b),n.stop&&a.setZIndexOffset(50),a.on("click",()=>{let i=`${n.entity_id}_${new Date(n.last_updated).toISOString()}`;Lo(i)}),_t.push(a)}),kt||(b.on("zoomend",nn),kt=!0),nn()}async function Eo(){let e=document.getElementById("person-select").value,{startLocal:t,endLocal:n}=bt();if(!e){z(l("select_user_filter"),{title:l("filter")}),ot();return}if(!t||!n){z(l("select_dates"),{title:l("filter")});return}let o=ho(t,!1),r=ho(n,!n.includes("T"));if(!o||!r){z(l("select_dates"),{title:l("filter")});return}let s=Date.parse(o),a=Date.parse(r);if(!Number.isFinite(s)||!Number.isFinite(a)||s>=a){z(l("invalid_dates"),{title:l("filter")}),ot();return}let i=744*60*60*1e3;if(a-s>i){z(l("date_range"),{title:l("filter")}),ot();return}ct(l("running_filter"));try{await ko(e,o,r)}catch(c){console.error("Error during filter:",c),z(l("filter_error"),{title:l("filter")})}finally{lt()}}async function Lt(e=!0,t=!0){if(e&&ot(),t){let n=document.getElementById("person-select");n.value="",n.dispatchEvent(new Event("change",{bubbles:!0}))}if(us(),bo(),document.getElementById("filter-table-body").innerHTML="",document.getElementById("positions-count").textContent="--",document.getElementById("total-time").textContent="--",document.getElementById("distance").textContent="--",document.getElementById("max-speed").textContent="--",document.getElementById("average-speed").textContent="--",document.getElementById("stops-count").textContent="--",document.getElementById("stopped-time").textContent="--",document.getElementById("summary-zones-table-body").innerHTML="",_t.forEach(n=>{try{b.removeLayer(n)}catch{}}),_t=[],window.routeLineSegments&&(window.routeLineSegments.forEach(n=>{try{b.removeLayer(n)}catch{}}),window.routeLineSegments=[]),window.routeOutline){try{b.removeLayer(window.routeOutline)}catch{}window.routeOutline=null}kt&&(b.off("zoomend",nn),kt=!1),Te&&(Te.disconnect(),Te=null)}async function So(e,t){let n=document.querySelectorAll(`tr.${e}:not(.group-header):not(.pin-visible)`);if(!n.length){t.textContent=t.textContent==="\u25BA"?"\u25BC":"\u25BA";return}let o=n[0].style.display==="none";n.forEach(r=>{r.style.display=o?"table-row":"none"}),t.textContent=o?"\u25BC":"\u25BA",o&&queueMicrotask(()=>{let r="#filter-table-body",s=document.querySelector(`${r} tr.${e}.selected`);if(s&&s.classList.contains("position-address-row")){let a=s.previousElementSibling;a&&a.classList.contains("pos-main-row")&&(s=a)}s||(s=document.querySelector(`${r} tr.${e}:not(.group-header)`)),s&&s.scrollIntoView({behavior:"smooth",block:"center"})})}async function St(e){document.querySelectorAll("#filter-table-body tr").forEach(c=>c.classList.remove("selected")),e.classList.add("selected");let n=e.nextElementSibling;n&&n.classList.contains("position-address-row")&&n.classList.add("selected");let o=parseFloat(e.dataset.latitude),r=parseFloat(e.dataset.longitude),s=e.dataset.lastUpdated,a=Math.round(e.dataset.speed||0),i=e.dataset.isStop==="1";_o(o,r,s,a,i)}function _o(e,t,n,o,r=!1){let a=`${r?`<strong>${l("stop")||"Stop"}</strong><br>`:""}${ee(n)}<br>${l("speed")}: ${Z(o)} ${l(T?"mi_per_hour":"km_per_hour")}`;qe&&qe.remove(),qe=L.popup({autoPan:!0}).setLatLng([e,t]).setContent(a).openOn(b),b.invalidateSize(),b.setView([e,t],b.getZoom())}function us(){qe&&(qe.remove(),qe=null)}async function Lo(e){let t=document.getElementById("filter-table-body");if(!t){console.error("Filter table tbody not found.");return}let n=t.querySelector(`tr[data-entity-id="${e}"]`);if(!n){console.error("Row not found for position:",e);return}let o=getComputedStyle(n).display==="none"||n.style.display==="none",r=[...n.classList].find(m=>m.startsWith("group-"));if(!r){console.error("The row does not belong to any group:",n);return}if(o){let m=document.querySelector(`tr.${r}.group-header`);if(m){let u=m.querySelector(".toggle-btn");u&&So(r,u)}}let s=document.getElementById("combo-select");if(s&&s.value!=="filter"){s.value="filter";let m=new Event("change",{bubbles:!0});s.dispatchEvent(m)}St(n),bo();let a=parseFloat(n.dataset.latitude),i=parseFloat(n.dataset.longitude),c=n.dataset.lastUpdated,d=Math.round(n.dataset.speed||0),f=n.dataset.isStop==="1";_o(a,i,c,d,f),n.scrollIntoView({behavior:"smooth",block:"center"})}async function ms(e,t=[0,200,0,.8],n=[100,100,255,.8],o="#ffffff",r=9,s=6,a={}){let{curved:i=!1,curveAlg:c="catmull",subdivisions:d=8,alpha:f=.5}=a;if(!e||e.length<2)return;let m=e.map(p=>p.attributes.latitude&&p.attributes.longitude?[p.attributes.latitude,p.attributes.longitude]:null).filter(Boolean);if(m.length<2)return;if(i&&c==="catmull"){let y=(m.length-1)*d>4e3?Math.max(1,Math.floor(4e3/Math.max(m.length-1,1))):d;m=fs(m,y,f)}if(window.routeLineSegments&&window.routeLineSegments.forEach(p=>{try{b.removeLayer(p)}catch{}}),window.routeLineSegments=[],window.routeOutline){try{b.removeLayer(window.routeOutline)}catch{}window.routeOutline=null}b.getPane("routeOutline")||b.createPane("routeOutline"),b.getPane("routeColor")||b.createPane("routeColor"),b.getPane("routeOutline").style.zIndex=390,b.getPane("routeColor").style.zIndex=391;let u=m.length-1;for(let p=0;p<u;p++){let h=p/u,y=Math.round(t[0]+h*(n[0]-t[0])),v=Math.round(t[1]+h*(n[1]-t[1])),S=Math.round(t[2]+h*(n[2]-t[2])),_=t[3]+h*(n[3]-t[3]),E=`rgba(${y},${v},${S},${_})`,x=m[p],w=m[p+1],N=L.polyline([x,w],{color:o,weight:r,opacity:1,lineCap:"round",lineJoin:"round",pane:"routeOutline"}).addTo(b);window.routeLineSegments.push(N);let g=L.polyline([x,w],{color:E,weight:s,opacity:1,lineCap:"round",lineJoin:"round",pane:"routeColor"}).addTo(b);window.routeLineSegments.push(g)}b.fitBounds(L.latLngBounds(m))}function fs(e,t=8,n=.5){let r=e.map(c=>[Number(c[0]),Number(c[1])]).filter(c=>Number.isFinite(c[0])&&Number.isFinite(c[1]));if(r.length<2)return r;let s=[],a=(c,d,f)=>[c[0]+(d[0]-c[0])*f,c[1]+(d[1]-c[1])*f],i=(c,d)=>Math.pow(Math.hypot(d[0]-c[0],d[1]-c[1])||1e-6,n);s.push(r[0]);for(let c=0;c<r.length-1;c++){let d=c>0?r[c-1]:r[c],f=r[c],m=r[c+1],u=c+2<r.length?r[c+2]:r[c+1],p=0,h=p+i(d,f),y=h+i(f,m),v=y+i(m,u);for(let _=1;_<=t;_++){let E=h+_*(y-h)/t,x=a(d,f,(E-p)/(h-p+1e-6)),w=a(f,m,(E-h)/(y-h+1e-6)),N=a(m,u,(E-y)/(v-y+1e-6)),g=a(x,w,(E-p)/(y-p+1e-6)),C=a(w,N,(E-h)/(v-h+1e-6)),A=a(g,C,(E-h)/(y-h+1e-6)),D=s[s.length-1];(!D||Math.hypot(A[0]-D[0],A[1]-D[1])>1e-6)&&s.push(A)}let S=s[s.length-1];(!S||Math.hypot(m[0]-S[0],m[1]-S[1])>1e-6)&&s.push(m)}return s}async function Co(){let e=document.getElementById("summary-zones-table-body");if(!ie){console.error("There are no saved statistics for zones. Make sure to apply the filter first.");return}let{zoneDurations:t,zoneVisits:n,zonePositions:o,zoneStops:r,zoneDistanceMeters:s}=ie,c=[...new Set([...Object.keys(t||{}),...Object.keys(n||{}),...Object.keys(r||{}),...Object.keys(s||{})])].sort((d,f)=>{switch(Et){case"zone":return Ee?d.localeCompare(f):f.localeCompare(d);case"time":return Ee?(t?.[d]||0)-(t?.[f]||0):(t?.[f]||0)-(t?.[d]||0);case"visits":return Ee?(n?.[d]||0)-(n?.[f]||0):(n?.[f]||0)-(n?.[d]||0);case"stops":return Ee?(r?.[d]||0)-(r?.[f]||0):(r?.[f]||0)-(r?.[d]||0);case"distance":return Ee?(s?.[d]||0)-(s?.[f]||0):(s?.[f]||0)-(s?.[d]||0);default:return 0}});e.innerHTML="";for(let d of c){let f=t?.[d]||0,m=n?.[d]||0,u=r?.[d]||0,p=s?.[d]||0,h=T?p/1609.344:p/1e3,y=`${Z(h)}`,v=d,S=document.createElement("tr");S.style.cursor="pointer",S.innerHTML=`
            <td>${v}</td>
            <td>${rn(f)}</td>
            <td>${Z(m)}</td>
            <td>${Z(u)}</td>
            <td>${y}</td>
        `,S.addEventListener("click",()=>{let E=o[d];E&&Mn(E.id)});let _=o[d];if(d&&_){let E={name:d,color:_.color,custom:_.custom,is_custom:_.custom};tn(S,E,se)}else S.classList.remove("zone-tinted"),S.style.removeProperty("--color-bg");e.appendChild(S)}ps()}function ps(){let e=document.querySelector("#summary-zones-table");if(!e){console.error("Zone summary table not found.");return}e.querySelectorAll("thead th").forEach(n=>{let o=n.getAttribute("data-i18n"),r="";switch(o){case"zone":r="zone";break;case"time":r="time";break;case"visits":r="visits";break;case"stops":r="stops";break;case"distance":r="distance";break}if(!r)return;n.style.cursor="pointer",n.onclick=()=>{Et===r?Ee=!Ee:(Et=r,Ee=!0),Co()};let s=Et===r?Ee?"\u25B2":"\u25BC":"",a=o==="distance"?T?l("miles"):l("kilometres"):l(o);n.innerHTML=`
            <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:30px;">
                <span class="hdr-label">${a}</span>
                <span class="hdr-arrow" style="font-size:12px;">${s}</span>
            </div>`})}function hs(){if(document.getElementById("zone-tint-css"))return;let e=document.createElement("style");e.id="zone-tint-css",e.textContent=`
		/* Aplica tinte solo si la fila NO est\xE1 seleccionada */
		#filter-table-body tr.zone-tinted:not(.selected),
		#summary-zones-table-body tr.zone-tinted:not(.selected) {
		  background-color: var(--color-bg);
		}
	  `,document.head.appendChild(e)}function tn(e,t,n=se){if(!(!!t&&(t.name??"")!=="")){e.classList.remove("zone-tinted"),e.style.removeProperty("--color-bg");return}let r=gs(t,n);r?(e.classList.add("zone-tinted"),e.style.setProperty("--color-bg",r)):(e.classList.remove("zone-tinted"),e.style.removeProperty("--color-bg"))}function ys(e){return e?typeof e.is_custom=="boolean"?e.is_custom:typeof e.custom=="boolean"?e.custom:!!e.color:!1}function gs(e,t=se){if(!e)return null;let n=ys(e)?e.color||U:me;return he(n,t)}function rn(e){let t=Math.floor(e/1e3),n=Math.floor(t/(24*3600)),o=Math.floor(t%(24*3600)/3600),r=Math.floor(t%3600/60),s=t%60;return`${n>0?`${n} ${n===1?l("day"):l("days")} `:""}${String(o).padStart(2,"0")}:${String(r).padStart(2,"0")}`}function po(e){return`${e.getFullYear()}-${ce(e.getMonth()+1)}-${ce(e.getDate())}T${ce(e.getHours())}:${ce(e.getMinutes())}:${ce(e.getSeconds())}`}function ho(e,t=!1){if(!e)return null;let n=e.match(/\d+/g)?.map(Number);if(!n||n.length<3)return null;let[o,r,s]=n,a=0,i=0,c=0,d=0;return n.length>=5?(a=n[3],i=n[4],c=n[5]??0):t&&(a=23,i=59,c=59,d=999),new Date(o,r-1,s,a,i,c,d).toISOString()}function Ct(e){let t=document.getElementById("export-filter"),n=t?.closest(".group");!n||!t||(n.style.display=e?"":"none",t.disabled=!e,n.setAttribute("aria-hidden",e?"false":"true"))}function bs(e){if(!e||typeof e!="object")return null;let t=["battery","battery_level","battery_percent","battery_percentage","battery_level_pct","batteryLevel"],n=null;for(let o of t)if(o in e){n=e[o];break}if(n==null)return null;if(typeof n=="string"){let o=n.match(/(\d+(?:\.\d+)?)\s*%?/);o&&(n=Number(o[1]))}return n=Number(n),Number.isFinite(n)?n>0&&n<=1?Math.round(n*100):n>=1&&n<=100?Math.round(n):null:null}function $t(){let e=document.getElementById("filter-table-body");if(!e)return[];let t=Array.from(e.querySelectorAll("tr.pos-main-row")),n=[];for(let o of t){let r=Number(o.dataset.latitude),s=Number(o.dataset.longitude);if(!Number.isFinite(r)||!Number.isFinite(s))continue;let a=o.dataset.lastUpdated,i=o.dataset.isStop==="1",c=o.dataset.entity||"",d=o.dataset.zone||"";if(!d&&typeof ge=="function")try{d=ge(r,s)?.name||""}catch{}let f=o.dataset.address||"";if(!f&&i){let h=o.nextElementSibling;if(h&&h.classList.contains("position-address-row")){let v=((h.querySelector("td.addr-cell")||h.querySelector("td"))?.textContent||"").trim();v&&v!=="\u2026"&&(f=v)}}let m=Number(o.dataset.speed),u=null;Number.isFinite(m)&&(u=(T?m*1.609344:m)/3.6);let p=o.dataset.battery&&Number.isFinite(Number(o.dataset.battery))?Number(o.dataset.battery):null;n.push({entity_id:c,last_updated:a,stop:i,zone:d,address:f,battery:p,attributes:{latitude:r,longitude:s,speed:u}})}return n}function yo(e){if(!e)return"unknown";let t=e.match(/\d+/g)?.map(Number);if(!t||t.length<3)return"unknown";let[n,o,r,s=0,a=0]=t;return e.includes("T")?`${n}-${ce(o)}-${ce(r)}_${ce(s)}-${ce(a)}`:`${n}-${ce(o)}-${ce(r)}`}function ws(e){return String(e).normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[\\/:*?"<>|]/g,"").trim().replace(/\s+/g,"_")}function Tt(e="kml"){let t=document.getElementById("person-select"),n=ws(t?.selectedOptions?.[0]?.text||t?.value||"person"),{startLocal:o,endLocal:r}=bt();return`${n}_${yo(o)}_${yo(r)}.${e}`}document.getElementById("export-filter")?.addEventListener("change",e=>{let t=e.target.value;t==="export-kml"?vs():t==="export-csv"?xs():t==="export-xlsx"?Es():t==="export-pdf"&&Ss(),e.target.value="export-file"});function vs(){let e=$t();if(!e.length){z(l("no_positions"),{title:"KML"});return}let t=Tt("kml");oo(e,{filename:t,stopIconHref:new URL(go,window.location.origin).href,includeRoute:!0,nameStop:n=>`${ee(n.last_updated)}`,describeStop:n=>{let o=Math.round((n?.attributes?.speed||0)*(T?2.23694:3.6)),r=l(T?"mi_per_hour":"km_per_hour"),s=Number.isFinite(n?.battery)?`${n.battery}%`:"";return`<table cellspacing="0" cellpadding="0" style="border-collapse:collapse">
        ${n.zone?`<tr><td>\u25CF ${n.zone}</td></tr>`:""}
        ${n.address?`<tr><td>\u25CF ${n.address}</td></tr>`:""}
        <tr><td>\u25CF ${o} ${r}</td></tr>
		${s?`<tr><td>\u25CF ${l("battery")}: ${s}</td></tr>`:""}
      </table>`},formatLocal:n=>ee(n),unitLabel:l(T?"mi_per_hour":"km_per_hour"),batteryLabel:l("battery")})}function xs(){let e=$t();if(!e.length){z(l("no_positions"),{title:"CSV"});return}let t=Tt("csv");io(e,{filename:t,useImperial:!!T,formatLocal:n=>ee(n),delimiter:";",usePicker:!1})}async function Es(){let e=$t();if(!e.length){z(l("no_positions")||"No hay posiciones para exportar.",{title:"Excel"});return}let t=Tt("xlsx");await lo(e,{filename:t,useImperial:!!T,formatLocal:n=>ee(n),sheetName:"Posiciones"})}async function Ss(){let e=$t();if(!e.length){z(l("no_positions"),{title:"PDF"});return}let t=[{label:l("positions"),value:document.getElementById("positions-count")?.textContent||""},{label:l("total_time"),value:document.getElementById("total-time")?.textContent||""},{label:l("distance"),value:document.getElementById("distance")?.textContent||""},{label:l("max_speed"),value:document.getElementById("max-speed")?.textContent||""},{label:l("average_speed"),value:document.getElementById("average-speed")?.textContent||""},{label:l("stops_count"),value:document.getElementById("stops-count")?.textContent||""},{label:l("stopped_time"),value:document.getElementById("stopped-time")?.textContent||""}],n=[],o=ie?.zonePositions||{};if(ie){let{zoneDurations:p,zoneVisits:h,zoneStops:y,zoneDistanceMeters:v}=ie,_=[...new Set([...Object.keys(p||{}),...Object.keys(v||{})])].sort((x,w)=>x.localeCompare(w)),E=T?"mi":"km";for(let x of _){let w=p?.[x]||0,N=h?.[x]||0,g=y?.[x]||0,C=v?.[x]||0,A=T?C/1609.344:C/1e3,D=`${Z(A)} ${E}`;n.push({zone:x,time:rn(w),visits:N,stops:g,distance:D,_unitShort:E,_fillColor:en(x,o,{alpha:.25,customDefault:U,noCustomDefault:me})})}}let r=mo(e),s=l(T?"mi_per_hour":"km_per_hour")||(T?"mph":"km/h"),a=r.map(p=>{let h=Math.round((p?.attributes?.speed||0)*(T?2.23694:3.6));return{whenLocal:ee(p.last_updated),isStop:!!p.stop,zone:p.zone||"",speed:Number.isFinite(h)?`${h} ${s}`:"",battery:Number.isFinite(p?.battery)?p.battery:"",address:p.address||"",_fillColor:p.zone?en(p.zone,o,{alpha:.25,customDefault:U,noCustomDefault:me}):null}}),i=document.getElementById("person-select"),c=i?.selectedOptions?.[0]?.text?.trim()||i?.value?.trim()||"\u2014",{startLocal:d,endLocal:f}=bt()||{};d&&(d=ee(d)),f&&(f=ee(f));let m={personName:c,startLocal:d,endLocal:f},u=Tt("pdf");await fo({filename:u,summaryRows:t,zonesRows:n,positionsRows:a,stopIconUrl:new URL("/local/ha-tracker/images/stop16x16.png",window.location.origin).href,header:m})}var Te=null;function _s(){if(Te)return Te;let e=document.querySelector("#positions .table-wrapper")||null;return Te=new IntersectionObserver(t=>{for(let n of t){if(!n.isIntersecting)continue;let o=n.target;Te.unobserve(o);let r=o.dataset.entityId,s=Number(o.dataset.latitude),a=Number(o.dataset.longitude),i=Number(o.dataset.lastUpdated);if(!(Number.isFinite(s)&&Number.isFinite(a)&&Number.isFinite(i)))continue;let c=o.querySelector("td.addr-cell")||o.querySelector("td");c&&c.textContent!=="\u2026"&&(c.textContent="\u2026"),Qe(r,s,a,i,d=>{let f=document.querySelector(`tr.position-address-row[data-entity-id="${r}"] td.addr-cell`)||document.querySelector(`tr.position-address-row[data-entity-id="${r}"] td`);f&&(f.textContent=d||"")})}},{root:e,rootMargin:"200px"}),Te}var kt=!1;function nn(){let e=b.getZoom();_t.forEach(t=>{if(!t.isStop){let n=b.hasLayer(t);e>=18&&!n?t.addTo(b):e<18&&n&&b.removeLayer(t)}})}async function te(e,{method:t="GET",headers:n={},body:o,timeoutMs:r=15e3}={},s=!0){let a=new AbortController,i=setTimeout(()=>a.abort("timeout"),r);try{let c;if(s){if(c=await un(),!c||!c.trim())throw new Error("Invalid token.");n={...n,Authorization:`Bearer ${c}`}}let d={method:t,headers:n,signal:a.signal,cache:"no-store"};t!=="GET"&&o!==void 0&&(d.body=o,!(o instanceof FormData)&&!(o instanceof Blob)&&!(o instanceof ArrayBuffer)&&(d.headers={"Content-Type":"application/json",...n}));let f=await fetch(e,d),m=f.status,u=Number(f.headers.get("Retry-After")),p=(f.headers.get("content-type")||"").toLowerCase();if(m===202){if(p.includes("application/json"))try{return await f.json()??{error:"queued",retry_after:Number.isFinite(u)?u:1.5}}catch{return{error:"queued",retry_after:Number.isFinite(u)?u:1.5}}return{error:"queued",retry_after:Number.isFinite(u)?u:1.5}}if(m===204)return null;if(!f.ok){let y=await f.text().catch(()=>""),v=new Error(`Error HTTP: ${m} - ${y}`);throw v.status=m,Number.isFinite(u)&&(v.retry_after=u),v}if(p.includes("application/json"))return await f.json();let h=await f.text();return h||null}catch(c){throw console.error("Error in fetchData:",c),c}finally{clearTimeout(i)}}async function On(e,t){if(!Number.isFinite(Number(e))||!Number.isFinite(Number(t)))throw new Error("latitude and longitude must be finite numbers.");let n=new URL(`${B}/api/ha_tracker/reverse_geocode`);n.searchParams.set("lat",String(e)),n.searchParams.set("lon",String(t)),n.searchParams.set("nowait","1"),n.searchParams.set("brief","1");try{return await te(n.toString(),{timeoutMs:15e3})}catch(o){throw console.error("Error getting reverse geocode:",o),o}}async function $o(){try{let e=`${B}/manifest.json`;return await te(e,{method:"GET"},!1)}catch(e){throw console.error("Error getting manifest:",e),e}}async function To(){let e=`${B}/api/ha_tracker/config`;try{return await te(e)}catch(t){throw console.error("Error getting configuration:",t),t}}async function Mo(){let e=`${B}/api/ha_tracker/is_admin`;try{return(await te(e))?.is_admin??!1}catch(t){throw console.error("Error checking admin status:",t),t}}async function qn(){let e=`${B}/api/ha_tracker/devices`;try{let t=await te(e);await Hn(t)}catch(t){throw console.error("Error getting Devices:",t),t}}async function Wn(){let e=`${B}/api/ha_tracker/persons`;try{let t=await te(e);await jn(t)}catch(t){throw console.error("Error getting Persons:",t),t}}async function Ce(){let e=`${B}/api/ha_tracker/zones`;try{let t=await te(e);await Tn(t)}catch(t){throw console.error("Error getting zones:",t),t}}async function In(e){if(!e)return console.error("Zone ID is required."),null;let t=JSON.stringify({id:e}),n=`${B}/api/ha_tracker/zones`;try{let o=await te(n,{method:"DELETE",body:t});return o&&o.success?(console.log(`Zone with ID ${e} deleted successfully.`),!0):(console.error(`Error deleting zone: ${o?.error||"Unknown error"}`),!1)}catch(o){return console.error("Error trying to delete zone:",o),!1}}async function Ot(e,t,n,o,r,s=U){if(!e||!t||!n||!o||!r)return console.error("All parameters (zoneId, name, radius, latitude, longitude) are mandatory."),null;let a=`${B}/api/ha_tracker/zones`,i=JSON.stringify({id:e,name:t,radius:n,latitude:o,longitude:r,color:s});try{let c=await te(a,{method:"PUT",body:i});return c&&c.success?(console.log(`Zone with ID ${e} updated successfully.`),c):(console.error(`Error updating zone: ${c?.error||"Unknown error"}`),null)}catch(c){return console.error("Error trying to update the zone:",c),null}}async function An(e,t,n,o,r="mdi:map-marker",s=!1,a=!0,i=U){if(!e||!t||!n||!o)return console.error("All parameters (name, radius, latitude, longitude) are mandatory."),null;let c=`${B}/api/ha_tracker/zones`,d=JSON.stringify({name:e,radius:t,latitude:n,longitude:o,icon:r,passive:s,custom:a,color:i});try{let f=await te(c,{method:"POST",body:d});return f&&f.success?(console.log(`Zone created successfully. ID: ${f.id}`),f.id):(console.error(`Error creating zone: ${f?.error||"Unknown error"}`),null)}catch(f){return console.error("Error trying to create zone:",f),null}}async function ko(e,t,n){if(!e||!t||!n){console.error("The person_id, startDate and endDate parameters are required.");return}let o=`${B}/api/ha_tracker/filtered_positions?person_id=${encodeURIComponent(e)}&start_date=${encodeURIComponent(t)}&end_date=${encodeURIComponent(n)}`;try{let r=await te(o);await xo(r)}catch(r){throw console.error("Error getting filtered positions:",r),r}}async function mn(e){if(!e){console.error("No authorization code found in the URL.");return}try{let t=`${B}/auth/token`,n=new URLSearchParams({grant_type:"authorization_code",code:e,client_id:`${B}/`}),o=await te(t,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n},!1);if(!o){console.error("Error getting token");return}console.log("************ Token Obtained ************",o);let r={...o,hassUrl:B,clientId:`${B}/`,expires:Date.now()+o.expires_in*1e3};try{localStorage.setItem("hassTokens",JSON.stringify(r))}catch(a){console.error("Error saving token to localStorage:",a);return}let s=`${B}/local/ha-tracker/index.html`;window.history.replaceState({},document.title,s)}catch(t){console.error("Error while obtaining token",t)}}async function fn(e){try{if(!B||!e)return console.error(`The base URL or refresh_token is not defined correctly.	haUrl: ${B}	refreshToken: ${e}`),null;let t=`${B}/auth/token`,n=new URLSearchParams({grant_type:"refresh_token",refresh_token:e,client_id:`${B}/`}),o=await te(t,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n},!1);if(!o){console.error("Error renewing token");return}return console.log("************ Renewed Token ************",o),o}catch(t){return console.error("Error en la solicitud de renovaci\xF3n del token:",t),null}}var B=location.origin,U="#008000",me="#FF5555",se=.25,Z=Po({max:0}),on=Po({min:2,max:2}),Je=!1;var rt="",sn=10,Wt=30,Vt=20;var Do=!1,T=!1,ze={log:console.log,debug:console.debug,info:console.info,warn:console.warn,error:console.error};async function No(){try{Je=await Mo()}catch(e){throw console.error("Error checking admin set:",e),e}}async function Io(){try{let e=await To();e&&(rt=e.version,typeof e.update_interval=="number"&&e.update_interval>=10&&(sn=e.update_interval),typeof e.geocode_time=="number"&&e.geocode_time>=10&&(Wt=e.geocode_time),typeof e.geocode_distance=="number"&&e.geocode_distance>=20&&(Vt=e.geocode_distance),typeof e.enable_debug=="boolean"&&(Do=e.enable_debug),typeof e.use_imperial=="boolean"&&(T=e.use_imperial)),await Ls(),console.log("Configuration: ",e)}catch(e){throw console.error("Error checking admin set: ",e),e}}async function Ao(){try{return await $o(),!0}catch{return console.warn("HA is Inactive"),!1}}async function Ls(){if(!Do)console.log=()=>{},console.debug=()=>{},console.info=()=>{},console.warn=(...e)=>ze.warn("[WARNING]:",...e),console.error=(...e)=>ze.error("[ERROR]:",...e);else{let e=()=>{let t=new Date,n=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0"),r=String(t.getSeconds()).padStart(2,"0"),s=String(t.getMilliseconds()).padStart(3,"0");return`[${n}:${o}:${r}:${s}]`};console.log=(...t)=>ze.log(e(),...t),console.debug=(...t)=>ze.debug(e(),...t),console.info=(...t)=>ze.info(e(),...t),console.warn=(...t)=>ze.warn(e(),"[WARNING]:",...t),console.error=(...t)=>ze.error(e(),"[ERROR]:",...t)}}function ee(e){let t=new Date(e),n={weekday:"short",day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1};return t.toLocaleString(It||"en",n)}function Po({locale:e,min:t=0,max:n=0,grouping:o=!0}={}){let r=e??(typeof navigator<"u"&&(navigator.languages?.[0]||navigator.language)||"en-GB"),s=new Intl.NumberFormat(r,{style:"decimal",minimumFractionDigits:t,maximumFractionDigits:n,useGrouping:o});return a=>s.format(Number(a)||0)}var Oo=()=>requestAnimationFrame(()=>b?.invalidateSize(!0));async function Bo(){try{an(document.getElementById("combo-select"));let e=document.getElementById("person-select");e&&(e.dataset.defaultIcon="users",an(e));let t=document.getElementById("export-filter");t&&(t.dataset.defaultIcon="export",an(t));let n=document.getElementById("forms-container");window.innerWidth<=600?(n.classList.add("hidden"),n.classList.remove("visible")):(n.classList.add("visible"),n.classList.remove("hidden")),ks(),document.body.classList.contains("loaded")||document.body.classList.add("loaded")}catch(e){console.error("Error during load:",e)}}window.addEventListener("resize",()=>{document.querySelectorAll(".table-container").forEach(Mt)});async function Ro(){let e=document.getElementById("visits-col-css");e||(e=document.createElement("style"),e.id="visits-col-css",document.head.appendChild(e)),e.textContent=xt?"":`
        #summary-zones-table thead th[data-i18n="visits"] { display: none !important; }
        #summary-zones-table-body tr > td:nth-child(3) { display: none !important; }
    `;let t=T?l("mi_per_hour"):l("km_per_hour"),n=T?l("miles"):l("kilometres"),o=T?l("feets"):l("meters");document.querySelectorAll('#positions-table thead th[data-i18n="speed"], #positions thead th[data-i18n="speed"]').forEach(r=>{let s=r.querySelector(".hdr-label");s?s.textContent=t:r.textContent=t}),document.querySelectorAll('#summary-zones-table thead th[data-i18n="distance"]').forEach(r=>{let s=r.querySelector(".hdr-label");s?s.textContent=n:r.textContent=n}),document.querySelectorAll('#zones-table thead th[data-i18n="radius"] .hdr-label').forEach(r=>{r.textContent=`${o}`}),document.querySelectorAll('#persons-table thead th[data-i18n="speed"] .hdr-label').forEach(r=>{r.textContent=`${t}`})}window.addEventListener("message",e=>{if(e.data?.type==="ping")try{e.source?.postMessage({type:"pong",id:e.data.id},e.origin||"*")}catch{}});document.getElementById("hamburger-button").addEventListener("click",async()=>{try{await Cs(),Oo()}catch(e){console.error("Error handling menu button:",e)}});document.getElementById("combo-select").addEventListener("change",function(){try{let e=this.value,t=document.getElementById("filter-container"),n=document.getElementById("zones-container"),o=document.getElementById("persons-container");if(e==="filter")t.style.display="block",n.style.display="none",o.style.display="none";else if(e==="zones"){t.style.display="none",n.style.display="block",o.style.display="none";let r=document.getElementById("zones-table-body");r&&r.querySelectorAll("tr.selected").forEach(s=>s.classList.remove("selected")),Ne()}else if(e==="users"){t.style.display="none",n.style.display="none",o.style.display="block";let r=document.getElementById("persons-table-body");r&&r.querySelectorAll("tr.selected").forEach(s=>s.classList.remove("selected")),typeof updatePersonsTable=="function"&&updatePersonsTable()}typeof b<"u"&&b&&typeof b.closePopup=="function"&&b.closePopup(),Oo()}catch(e){console.error("Error during combo-select:",e)}});async function Cs(){try{let e=document.getElementById("forms-container");e.classList.contains("hidden")?(e.classList.remove("hidden"),e.classList.add("visible")):(e.classList.add("hidden"),e.classList.remove("visible"))}catch(e){console.error("Error during toggleContainer:",e)}}async function Mt(e){try{let t=window.innerHeight,n=e.getBoundingClientRect().top,o=Math.max(t-n-20,150);Math.abs(e.clientHeight-o)>2&&requestAnimationFrame(()=>{e.style.height=`${o}px`})}catch(t){console.error("Error adjusting table height:",t)}}async function ks(){try{let e=document.querySelectorAll(".table-container"),t=document.getElementById("forms-container"),n=new ResizeObserver(s=>{requestAnimationFrame(()=>{s.forEach(a=>Mt(a.target))})}),o=new IntersectionObserver(s=>{requestAnimationFrame(()=>{s.forEach(a=>{a.isIntersecting&&Mt(a.target)})})}),r=new MutationObserver(()=>{requestAnimationFrame(()=>{document.querySelectorAll(".table-container").forEach(Mt)})});e.forEach(s=>{o.observe(s),n.observe(s)}),t&&r.observe(t,{childList:!0,subtree:!0})}catch(e){console.error("Error in observeTableContainers:",e)}}var zo={users:'<path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5z"/>',zones:'<path d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7zm0 9.5A2.5 2.5 0 1 1 14.5 9 2.5 2.5 0 0 1 12 11.5z"/>',filter:'<path d="M3 4h18l-7 8v6l-4 2v-8z"/>',export:'<path d="M12 3v10"/><path d="M8 7l4-4 4 4"/><path d="M4 21h16v-2a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v2z"/>',dot:'<circle cx="12" cy="12" r="5"/>'},Fo=e=>`<svg class="id-icon" viewBox="0 0 24 24" aria-hidden="true">${zo[e]||zo.dot}</svg>`;function an(e){if(!e||e.dataset.enhanced==="1")return;let t=document.createElement("div");t.className="id-wrap";let n=document.createElement("button");n.type="button",n.className="id-toggle",n.setAttribute("aria-haspopup","listbox"),n.setAttribute("aria-expanded","false"),n.setAttribute("aria-controls",e.id+"-menu");let o=document.createElement("div");o.className="id-menu",o.id=e.id+"-menu",o.setAttribute("role","listbox"),o.setAttribute("aria-hidden","true"),o.hidden=!0,e.classList.add("id-visually-hidden"),e.parentNode.insertBefore(t,e.nextSibling),t.appendChild(n),t.appendChild(o);function r(){return e.selectedOptions[0]||e.options[0]}function s(h){return h?.dataset.icon||e.dataset.defaultIcon||h?.value||"dot"}function a(){let h=r(),y=s(h);n.innerHTML=`${Fo(y)}<span class="id-text">${h?.text||""}</span><span class="id-caret" aria-hidden="true">\u25BE</span>`}function i(){o.innerHTML="",Array.from(e.options).forEach((h,y)=>{let v=document.createElement("button");v.type="button",v.className="id-option",v.setAttribute("role","option"),v.dataset.value=h.value,v.setAttribute("aria-selected",String(h.selected)),v.innerHTML=`${Fo(s(h))}<span>${h.text}</span>`,h.disabled&&(v.disabled=!0,v.style.opacity=.5,v.style.cursor="not-allowed"),v.addEventListener("click",()=>{h.disabled||(e.value=h.value,e.dispatchEvent(new Event("change",{bubbles:!0})),d(),n.focus())}),o.appendChild(v),v.tabIndex=h.selected||!e.value&&y===0?0:-1})}function c(){i(),o.hidden=!1,o.setAttribute("aria-hidden","false"),n.setAttribute("aria-expanded","true"),(o.querySelector('.id-option[aria-selected="true"]')||o.querySelector(".id-option"))?.focus(),document.addEventListener("click",m),document.addEventListener("keydown",u)}function d(){o.hidden=!0,o.setAttribute("aria-hidden","true"),n.setAttribute("aria-expanded","false"),document.removeEventListener("click",m),document.removeEventListener("keydown",u)}function f(){o.hidden?c():d()}function m(h){t.contains(h.target)||d()}function u(h){let y=Array.from(o.querySelectorAll(".id-option:not([disabled])")),v=y.indexOf(document.activeElement);h.key==="Escape"?(h.preventDefault(),d(),n.focus()):h.key==="ArrowDown"?(h.preventDefault(),(y[v+1]||y[0])?.focus()):h.key==="ArrowUp"?(h.preventDefault(),(y[v-1]||y.at(-1))?.focus()):h.key==="Home"?(h.preventDefault(),y[0]?.focus()):h.key==="End"?(h.preventDefault(),y.at(-1)?.focus()):(h.key==="Enter"||h.key===" ")&&document.activeElement?.classList.contains("id-option")&&(h.preventDefault(),document.activeElement.click())}e.addEventListener("change",()=>{a(),o.querySelectorAll(".id-option").forEach(h=>{h.setAttribute("aria-selected",String(h.dataset.value===e.value))})}),n.addEventListener("click",f),n.addEventListener("keydown",h=>{(h.key==="ArrowDown"||h.key==="Enter"||h.key===" ")&&(h.preventDefault(),c())}),new MutationObserver(()=>{a(),o.hidden||i()}).observe(e,{childList:!0,subtree:!0,characterData:!0}),a(),e.dataset.enhanced="1"}document.addEventListener("DOMContentLoaded",async()=>{try{await dn(),await $s()}catch(e){console.error("Error during DOMContentLoaded:",e)}});async function $s(){try{await bn(),await vo(),await kn(),await wn(),await Uo(),await Zn(),await Bo(),Ts()}catch(e){console.error("Error during init:",e)}}function Ts(){let e=performance.now();async function t(n){let o=(sn??10)*1e3;if(n-e>=o){e=n;try{await Uo()}catch(r){console.error("update() failed:",r)}}requestAnimationFrame(t)}requestAnimationFrame(t)}async function Uo(){try{await Ao()?(await Io(),await Ms(),await No(),await Un(),await $n(),await Ro(),lt()):ct(l("disconnected"),"rgba(255, 0, 0, 0.5)","white","rgba(200, 0, 0, 0.8)")}catch(e){console.error("Error during major update:",e)}}async function Ms(){try{if(!(window.self!==window.top)&&rt){let t=new URL(window.location.href);if(t.searchParams.get("v")!==rt){t.searchParams.set("v",rt);let o=t.toString();o!==window.location.href&&window.location.replace(o)}}}catch(e){console.error("Error during updateVersion:",e)}}
