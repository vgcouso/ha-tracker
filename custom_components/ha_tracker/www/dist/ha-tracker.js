var pt=null;async function kn(){try{let e=new URLSearchParams(window.location.search);if(e.has("code")){let t=e.get("code");await Cn(t)}}catch(e){throw console.error("Error during authentication:",e),e}}async function Ln(){return pt||(pt=(async()=>{if(window!==window.parent){let{token:t,exp:n}=await cr();if(!t||!t.trim())throw new Error("Empty token from parent");return t}else{await dr();let t=localStorage.getItem("hassTokens"),n=t?JSON.parse(t):null;if(!n?.access_token)throw new Error("No access_token in hassTokens");let o=typeof n.expires=="number"?n.expires:0,r=Date.now();if(o&&r>=o)throw new Error("Token has expired");return n.access_token}})().finally(()=>{pt=null})),pt}function cr(e=7e3){return new Promise((t,n)=>{let o=Math.random().toString(36).slice(2),r=window.parent,s="";try{s=new URL(document.referrer).origin}catch{}s||(s=window.location.origin);let a=setTimeout(()=>{window.removeEventListener("message",i),n(new Error("Token not returned"))},e);function i(d){if(d.source!==r||d.origin!==s&&d.origin!==window.location.origin)return;let c=d.data||{};if(c.type==="auth-token"&&c.reqId===o&&c.token){clearTimeout(a),window.removeEventListener("message",i);let m=typeof c.exp=="number"&&isFinite(c.exp)?c.exp:0;t({token:c.token,exp:m})}}window.addEventListener("message",i),window.parent.postMessage({type:"request-token",reqId:o},s||"*")})}async function dr(){let e=localStorage.getItem("hassTokens");try{if(e){let o=JSON.parse(e),r=Number(o.expires||0);if(r&&Date.now()<r-900*1e3||(console.log("The token has expired. Trying to renew it..."),await ur(o.refresh_token)))return}console.log("No valid token found. Redirecting to authorize...");let t=`${U}/ha-tracker/index.html`,n=`${U}/auth/authorize?client_id=${encodeURIComponent(`${U}/`)}&redirect_uri=${encodeURIComponent(t)}`;window.location.href=n}catch(t){console.error("Error during authenticate:",t)}}async function ur(e){try{let t=await $n(e);if(!t)return console.error("Failed to renew token."),!1;let n=localStorage.getItem("hassTokens");if(!n)return console.error("No existing token found in local storage."),!1;let o=JSON.parse(n);return t.refresh_token=o.refresh_token,t.hassUrl=o.hassUrl,t.clientId=o.clientId,t.ha_auth_provider=o.ha_auth_provider,t.expires=Date.now()+t.expires_in*1e3,localStorage.setItem("hassTokens",JSON.stringify(t)),console.log("Token renewed and stored:",t),!0}catch(t){return console.error("Error processing renewed token:",t),!1}}var X=typeof window<"u"?window:globalThis;X.__assetLoader??(X.__assetLoader={js:new Map,css:new Map});function Tn(e){return new Promise((t,n)=>{if(e.dataset.loaded==="true"||e.readyState==="complete")return t();e.addEventListener("load",()=>t(),{once:!0}),e.addEventListener("error",()=>n(new Error("Resource failed: "+(e.src||e.href))),{once:!0})})}function Ue(e,{attrs:t={},matchPrefix:n=!0}={}){let o=e;if(X.__assetLoader.css.has(o))return X.__assetLoader.css.get(o);let r=n?`link[rel="stylesheet"][href^="${e}"]`:`link[rel="stylesheet"][href="${e}"]`,s=document.querySelector(r);if(s){let i=Tn(s);return X.__assetLoader.css.set(o,i),i.finally(()=>X.__assetLoader.css.delete(o))}let a=new Promise((i,d)=>{let c=document.createElement("link");c.rel="stylesheet",c.href=e;for(let[m,f]of Object.entries(t))c.setAttribute(m,f);c.onload=()=>{c.dataset.loaded="true",i()},c.onerror=()=>d(new Error("CSS not loaded: "+e)),document.head.appendChild(c)});return X.__assetLoader.css.set(o,a),a.finally(()=>X.__assetLoader.css.delete(o))}function ke(e,{attrs:t={},matchPrefix:n=!0,test:o=null}={}){try{if(typeof o=="function"&&o())return Promise.resolve()}catch{}let r=e;if(X.__assetLoader.js.has(r))return X.__assetLoader.js.get(r);let s=n?`script[src^="${e}"]`:`script[src="${e}"]`,a=document.querySelector(s);if(a){let d=Tn(a).then(()=>{if(typeof o=="function"&&!o())throw new Error("Script present but test() failed: "+e)});return X.__assetLoader.js.set(r,d),d.finally(()=>X.__assetLoader.js.delete(r))}let i=new Promise((d,c)=>{let m=document.createElement("script");m.src=e,m.async=!0;for(let[f,l]of Object.entries(t))m.setAttribute(f,l);m.onload=()=>{m.dataset.loaded="true";try{typeof o=="function"&&!o()?c(new Error("Script loaded but test() failed: "+e)):d()}catch(f){c(f)}},m.onerror=()=>c(new Error("Script not loaded: "+e)),document.head.appendChild(m)});return X.__assetLoader.js.set(r,i),i.finally(()=>X.__assetLoader.js.delete(r))}var Ht="en",Dn={};async function Nn(e){try{let t=await fetch(`locales/${e}.json`);if(!t.ok)throw new Error(`Translation not found for ${e}`);Dn=await t.json(),Ht=e,mr()}catch(t){if(console.error(`Error loading translations for ${e}.`,t),e==="en"){console.error("The English translation file could not be loaded. No changes will be made to the texts.");return}else console.error("Trying to load english as fallback."),await Nn("en")}}function u(e){return Dn[e]||e}function Mn(e,t={}){let n=u(e);for(let[o,r]of Object.entries(t))n=n.replace(`{${o}}`,r);return n}function mr(){document.querySelectorAll("[data-i18n]").forEach(e=>{let t=e.getAttribute("data-i18n");e.textContent=u(t)}),document.querySelectorAll("[data-i18n-placeholder]").forEach(e=>{let t=e.getAttribute("data-i18n-placeholder"),n=u(t);n&&n!==t&&(e.placeholder=n)})}async function Pn(){let e=navigator.language.slice(0,2);document.documentElement.setAttribute("lang",e),await Nn(e)}var v,tt="1.9.4",nt={leafletCSS:"/ha-tracker/vendor/leaflet/leaflet.css?v="+tt,leafletJS:"/ha-tracker/vendor/leaflet/leaflet.js?v="+tt,geocoderCSS:"/ha-tracker/vendor/leaflet-control-geocoder/Control.Geocoder.css?v="+tt,geocoderJS:"/ha-tracker/vendor/leaflet-control-geocoder/Control.Geocoder.js?v="+tt,editableJS:"/ha-tracker/vendor/leaflet-editable/Leaflet.Editable.min.js?v="+tt};async function fr(){await Ue(nt.leafletCSS),await Ue(nt.geocoderCSS),await ke(nt.leafletJS,{test:()=>!!window.L}),await ke(nt.editableJS,{test:()=>!!(window.L&&L.Editable)}),await ke(nt.geocoderJS,{test:()=>!!(window.L&&L.Control&&L.Control.Geocoder)})}async function An(){try{let f=function(){let l=v.getBounds();m.options.geocoder.options.geocodingQueryParams.viewbox=[l.getWest(),l.getSouth(),l.getEast(),l.getNorth()].join(","),m.options.geocoder.options.geocodingQueryParams.bounded=1};await fr();let e={center:[40.4168,-3.7038],zoom:6,editable:!0,preferCanvas:!0};v=L.map("map",e);let t={maxZoom:19,minZoom:1,crossOrigin:!0},n={OpenStreetMap:L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{...t,attribution:"\xA9 OpenStreetMap contributors"}),"Esri Sat\xE9lite":L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{...t,attribution:"\xA9 Esri, Maxar, Earthstar Geographics"})};n.OpenStreetMap.addTo(v),v.attributionControl.setPosition("bottomleft"),L.control.layers(n,null,{position:"topleft"}).addTo(v);let r=L.control.scale({position:"bottomleft"}).addTo(v),s=document.querySelector(".leaflet-control-layers"),a=document.querySelector(".leaflet-control-zoom");if(s&&a){let l=a.getBoundingClientRect();s.style.position="absolute",s.style.left=`${l.right}px`}let i=()=>v&&v.invalidateSize(!0);document.body.addEventListener("transitionend",l=>{l.target===document.body&&l.propertyName==="opacity"&&setTimeout(i,0)},{once:!0});let d=document.getElementById("map");d&&"ResizeObserver"in window&&new ResizeObserver(()=>i()).observe(d),window.addEventListener("resize",i),document.addEventListener("visibilitychange",()=>{document.hidden||setTimeout(i,0)}),setTimeout(i,350);let c=navigator.languages&&navigator.languages.length?navigator.languages.join(","):navigator.language||"en",m=L.Control.geocoder({position:"bottomleft",placeholder:u("search_place"),collapsed:!1,defaultMarkGeocode:!1,geocoder:L.Control.Geocoder.nominatim({geocodingQueryParams:{"accept-language":c,limit:5}})}).on("markgeocode",l=>{let{center:h,name:p,bbox:y}=l.geocode;y?v.fitBounds(y):v.setView(h,16),L.popup({autoClose:!0,closeOnClick:!0,keepInView:!0}).setLatLng(h).setContent(p).openOn(v)}).addTo(v);v.on("moveend",f),f(),setTimeout(()=>v.invalidateSize(!0),0)}catch(e){console.error("Error starting map:",e)}}function Ut(e,t){return e!=null&&t!=null&&!isNaN(e)&&!isNaN(t)}function yt(e,t,n,o){let s=ht(n-e),a=ht(o-t),i=Math.sin(s/2)*Math.sin(s/2)+Math.cos(ht(e))*Math.cos(ht(n))*Math.sin(a/2)*Math.sin(a/2);return 6371e3*(2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)))}function ht(e){return e*(Math.PI/180)}var pr=["#008000","#09CB09","#946F24","#333333","#999999","#EEF077","#BBB31A","#ECAA77","#981052","#D265E4","#854CD7","#2196F3","#28A289","#0000FF","#42DFD3","#FF0000","#D2A3A3"],Le=null,te=null,de=null,In=!1;function hr(){if(In)return;let e=document.createElement("style");e.id="window-overlay-styles",e.textContent=`
    #window-overlay{
      position: fixed; inset: 0; display: none;
      align-items: center; justify-content: center;
      background: rgba(0,0,0,.35);
      z-index: 2147483647;
    }
    #window-message{
      padding: 14px 18px;
      border-radius: 12px;
      border: 2px solid transparent;
      font: 600 15px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      box-shadow: 0 8px 30px rgba(0,0,0,.2);
      user-select: none;
    }`,document.head.appendChild(e),In=!0}function yr(){te&&de||(hr(),te=document.getElementById("window-overlay"),de=document.getElementById("window-message"),te||(te=document.createElement("div"),te.id="window-overlay",document.body.appendChild(te)),de||(de=document.createElement("div"),de.id="window-message",de.dataset.i18n="loading",de.textContent="Loading",te.appendChild(de)))}function gt(e="Mensaje",t="rgba(0, 0, 255, 0.5)",n="white",o="rgba(0, 0, 200, 0.8)",r="rgba(0,0,0,.35)"){yr(),te.style.display!=="flex"&&(te.style.background=r,de.textContent=e,de.style.backgroundColor=t,de.style.color=n,de.style.border=`2px solid ${o}`,te.style.display="flex")}function bt(){te&&(te.style.display==="none"||te.style.display===""||(te.style.display="none"))}function Rn(e,t={}){return Le?Promise.resolve(!1):(Le="confirm",new Promise(n=>{let o=jt({title:t.title??u("confirmation"),message:e,type:t.type??"info",okLabel:t.okLabel??u("accept"),cancelLabel:t.cancelLabel??u("cancel")});qt(o,{withInput:!1,resolve:n}),o.focusDefault()}))}function Zt(e,t="",n={}){return Le?Promise.resolve(null):(Le="prompt",new Promise(o=>{let r=jt({title:n.title??u("enter_value"),message:e,type:n.type??"info",withInput:!0,inputValue:t,inputDisabled:n.inputDisabled===!0,placeholder:n.placeholder??"",withColor:n.withColor===!0,colorValue:n.defaultColor??G,colorLabel:n.colorLabel,withVisibility:n.withVisibility===!0,visibilityValue:n.visibilityValue!==!1,visibilityLabel:n.visibilityLabel||"Mostrar en el mapa",okLabel:n.okLabel??u("save"),cancelLabel:n.cancelLabel??u("cancel"),colorOptions:n.colorOptions});qt(r,{withInput:!0,withColor:n.withColor===!0,withVisibility:n.withVisibility===!0,resolve:o}),r.focusDefault()}))}function O(e,t={}){return Le?Promise.resolve():(Le="alert",new Promise(n=>{let o=jt({title:t.title??u("information"),message:e,type:t.type??"info",okLabel:t.okLabel??u("accept"),cancelLabel:u("close")});(t.hideCancel??!0)&&o.modal.querySelector(".btn-secondary")?.remove(),qt(o,{withInput:!1,resolve:n}),o.focusDefault()}))}function Q(e,t=V){let n=String(e||"").trim().toLowerCase(),o=/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i.exec(n),r=/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i.exec(n),s=/^#([0-9a-f]{8})$/i.exec(n),a,i,d;if(o)a=parseInt(o[1]+o[1],16),i=parseInt(o[2]+o[2],16),d=parseInt(o[3]+o[3],16);else if(r)a=parseInt(r[1],16),i=parseInt(r[2],16),d=parseInt(r[3],16);else if(s)a=parseInt(s[1].slice(0,2),16),i=parseInt(s[1].slice(2,4),16),d=parseInt(s[1].slice(4,6),16);else return null;let c=Math.min(1,Math.max(0,Number(t)||0));return`rgba(${a},${i},${d},${c})`}function gr(e){let t=String(e||"").trim().toLowerCase(),n=/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i.exec(t),o=/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i.exec(t),r=/^#([0-9a-f]{8})$/i.exec(t),s,a,i;if(n)s=parseInt(n[1]+n[1],16),a=parseInt(n[2]+n[2],16),i=parseInt(n[3]+n[3],16);else if(o)s=parseInt(o[1],16),a=parseInt(o[2],16),i=parseInt(o[3],16);else if(r)s=parseInt(r[1].slice(0,2),16),a=parseInt(r[1].slice(2,4),16),i=parseInt(r[1].slice(4,6),16);else return null;return{r:s,g:a,b:i}}function br(){let e=document.getElementById("ui-modal-root");e||(e=document.createElement("div"),e.id="ui-modal-root",document.body.appendChild(e));let t=document.getElementById("ui-toast-root");return t||(t=document.createElement("div"),t.id="ui-toast-root",document.body.appendChild(t)),{modalRoot:e,toastRoot:t}}function wr(e){let t=["a[href]","button:not([disabled])","textarea:not([disabled])","input:not([disabled])","select:not([disabled])",'[tabindex]:not([tabindex="-1"])'],n=e.querySelectorAll(t.join(",")),o=n[0],r=n[n.length-1];function s(a){a.key==="Tab"&&n.length&&(a.shiftKey&&document.activeElement===o?(a.preventDefault(),r.focus()):!a.shiftKey&&document.activeElement===r&&(a.preventDefault(),o.focus()))}return e.addEventListener("keydown",s),()=>e.removeEventListener("keydown",s)}function jt({title:e,message:t,type:n="info",withInput:o=!1,inputValue:r="",inputDisabled:s=!1,placeholder:a="",withColor:i=!1,colorValue:d=G,colorLabel:c,withVisibility:m=!1,visibilityValue:f=!0,visibilityLabel:l="Mostrar en el mapa",okLabel:h,cancelLabel:p,colorOptions:y={}}){let{modalRoot:w}=br(),_=document.createElement("div");_.className="modal-overlay",_.setAttribute("role","dialog"),_.setAttribute("aria-modal","true");let T=document.createElement("div");T.className=`modal modal-${n}`;let k=document.createElement("div");k.className="modal-header",k.innerHTML=`<span class="modal-title">${e||""}</span>`;let C=document.createElement("button");C.className="modal-close",C.setAttribute("aria-label",u("close")),C.textContent="\xD7",k.appendChild(C);let x=document.createElement("div");x.className="modal-body";let S=document.createElement("div");S.className="modal-message",S.textContent=t||"",x.appendChild(S);let g=null;o&&(g=document.createElement("input"),g.className="modal-input",g.type="text",g.value=r??"",s&&(g.disabled=!0),a&&(g.placeholder=a),x.appendChild(g));let $=null;if(m){let I=document.createElement("div");I.className="modal-message";let q=document.createElement("label");q.append(document.createTextNode(l+" "));let Z=document.createElement("input");Z.type="checkbox",Z.checked=!!f,Z.autocomplete="off",q.append(Z),I.append(q),x.appendChild(I),$=Z}let B=null;if(i){let I=document.createElement("div");I.className="modal-message",I.textContent=c??(u?u("select_color"):"Seleccione un color"),x.appendChild(I);let{palette:q=[],allowAlpha:Z=!1,showNative:j=!1}=y||{},R=vr({initial:d||G,palette:q,allowAlpha:Z,showNative:j});B=R.hiddenInput,x.appendChild(R.root)}let A=document.createElement("div");A.className="modal-actions";let E=document.createElement("button");E.className="btn btn-secondary",E.textContent=p??u("cancel");let b=document.createElement("button");b.className="btn "+(n==="danger"?"btn-danger":"btn-primary"),b.textContent=h??u("accept"),A.append(E,b),T.append(k,x,A),_.appendChild(T),w.appendChild(_);let N=wr(T),M=()=>{N(),_.remove(),document.body.classList.remove("no-scroll"),Le=null};return document.body.classList.add("no-scroll"),{overlay:_,modal:T,ok:b,cancel:E,closeBtn:C,inputEl:g,colorEl:B,visibleEl:$,focusDefault:()=>{o&&g&&!g.disabled?g.focus():b.focus()},destroy:M}}function qt(e,{withInput:t,withColor:n=!1,withVisibility:o=!1,resolve:r,reject:s}){let{overlay:a,modal:i,ok:d,cancel:c,closeBtn:m,inputEl:f,colorEl:l,visibleEl:h,destroy:p}=e,y=k=>{if(Le){if(k.key==="Escape"){k.preventDefault(),T();return}if(k.key==="Enter"){let C=(document.activeElement?.tagName||"").toLowerCase();C==="input"||C==="textarea"||document.activeElement?.isContentEditable||_()}}};function w(){i.removeEventListener("keydown",y)}function _(){let k=t?f?.value??"":!0,C=n?l?.value??"":void 0,x=o?!!h?.checked:void 0;w(),p();let S=t?{value:k}:{};n&&(S.color=C),o&&(S.visible=x),r(Object.keys(S).length?S:k)}function T(){w(),p(),r(t?null:!1)}d.addEventListener("click",_),c.addEventListener("click",T),m.addEventListener("click",T),a.addEventListener("click",k=>{k.target===a&&T()}),i.addEventListener("keydown",y)}function vr({initial:e=G,palette:t=[],allowAlpha:n=!1,showNative:o=!1}={}){let r=document.createElement("div");r.className="modal-color";let s=document.createElement("div");s.className="cp";let a=document.createElement("div");a.className="cp-left";let i=document.createElement("div");i.className="cp-right";let d=document.createElement("div");d.className="cp-sv",d.tabIndex=0;let c=document.createElement("div");c.className="cp-cursor",d.appendChild(c);let m=document.createElement("div");m.className="cp-hue",m.tabIndex=0;let f=document.createElement("div");f.className="cp-cursor h",m.appendChild(f);let l=document.createElement("div");l.className="cp-alpha",l.tabIndex=0;let h=document.createElement("div");h.className="cp-cursor h",l.appendChild(h),n||(l.style.display="none"),a.appendChild(d);let p=document.createElement("div");p.style.display="flex",p.style.flexDirection="column",p.style.gap="12px",p.appendChild(m),p.appendChild(l),a.appendChild(p);let y=document.createElement("div");y.className="cp-fields";let w=document.createElement("div");w.className="cp-preview";let _=document.createElement("span");w.appendChild(_);let T=document.createElement("div");T.className="cp-row";let k=document.createElement("label");k.textContent="HEX";let C=document.createElement("input");C.type="text",C.placeholder="#RRGGBB",C.autocomplete="off",T.append(k,C);let x=document.createElement("div");x.className="cp-row";let S=document.createElement("label");S.textContent="Alpha";let g=document.createElement("input");g.type="text",g.placeholder="0\u20131",g.value="1",x.append(S,g),n||(x.style.display="none");let $=document.createElement("div");$.className="cp-palette",(t.length?t:pr).forEach(P=>{let D=document.createElement("button");D.type="button",D.className="cp-swatch",D.title=P,D.style.background=P,D.addEventListener("click",()=>he(P)),$.appendChild(D)});let A=document.createElement("div");if(A.className="cp-native",o){let P=document.createElement("details"),D=document.createElement("summary");D.textContent="Selector del sistema";let H=document.createElement("input");H.type="color",H.addEventListener("input",()=>he(H.value)),P.append(D,H),A.appendChild(P)}y.append(w,T,x,$,A),i.appendChild(y),s.append(a,i),r.appendChild(s);let E=document.createElement("input");E.type="text",E.className="modal-input-color",E.style.display="none",r.appendChild(E);let b=120,N=1,M=.5,I=1,q=!1;C.addEventListener("focus",()=>{q=!0}),C.addEventListener("blur",()=>{q=!1,R()}),C.addEventListener("keydown",P=>{P.key==="Enter"&&P.preventDefault(),P.stopPropagation()});function Z(){d.style.background=`hsl(${b}, 100%, 50%)`}function j(){let{r:P,g:D,b:H}=Fn(b,N,M);l.style.background=`conic-gradient(#ccc 25%, #fff 0 50%, #ccc 0 75%, #fff 0) 0 0/12px 12px,
       linear-gradient(to bottom, rgba(${P},${D},${H},0), rgba(${P},${D},${H},1))`}function R(){c.style.left=`${N*100}%`,c.style.top=`${(1-M)*100}%`,f.style.top=`${b/360*100}%`,h.style.top=`${(1-I)*100}%`;let{r:P,g:D,b:H}=Fn(b,N,M),se=xr({r:P,g:D,b:H});_.style.background=`rgba(${P},${D},${H},${I})`,q||(C.value=se),E.value=n?`rgba(${P}, ${D}, ${H}, ${I})`:se,Z(),j()}function he(P){let D=Bn(P);if(!D)return;let H=zn(D.r,D.g,D.b);b=H.h,N=H.s,M=H.v,D.a!==void 0&&(I=re(+D.a,0,1)),R()}function re(P,D,H){return Math.min(H,Math.max(D,P))}function Xe(P,D){let H=ye=>{let Pe=P.getBoundingClientRect(),Ae=re(((ye.touches?ye.touches[0].clientX:ye.clientX)-Pe.left)/Pe.width,0,1),et=re(((ye.touches?ye.touches[0].clientY:ye.clientY)-Pe.top)/Pe.height,0,1);D(Ae,et)},se=()=>{window.removeEventListener("mousemove",H),window.removeEventListener("touchmove",H),window.removeEventListener("mouseup",se),window.removeEventListener("touchend",se)},_e=ye=>{ye.preventDefault(),H(ye),window.addEventListener("mousemove",H),window.addEventListener("touchmove",H,{passive:!1}),window.addEventListener("mouseup",se,{once:!0}),window.addEventListener("touchend",se,{once:!0})};P.addEventListener("mousedown",_e),P.addEventListener("touchstart",_e,{passive:!1})}Xe(d,(P,D)=>{N=P,M=1-D,R()}),Xe(m,(P,D)=>{b=re(D,0,1)*360,R()}),Xe(l,(P,D)=>{I=1-D,R()});function Qe(P,D){P.addEventListener("keydown",H=>{let se=H.key.toLowerCase(),_e=.02;se==="arrowup"&&D(0,-_e),se==="arrowdown"&&D(0,_e),se==="arrowleft"&&D(-_e,0),se==="arrowright"&&D(_e,0)})}Qe(d,(P,D)=>{N=re(N+P,0,1),M=re(M-D,0,1),R()}),Qe(m,(P,D)=>{b=re(b+D*360,0,360),R()}),Qe(l,(P,D)=>{I=re(I-D,0,1),R()}),[d,m,l].forEach(P=>{P.addEventListener("keydown",D=>{D.key==="Enter"&&D.stopPropagation()})}),C.addEventListener("input",()=>{let P=Bn(C.value);if(P){let D=zn(P.r,P.g,P.b);b=D.h,N=D.s,M=D.v,R()}}),g.addEventListener("input",()=>{let P=parseFloat(g.value.replace(",","."));isNaN(P)||(I=re(P,0,1),R())}),he(e||G);function ar(){s.style.minWidth=a.style.minWidth=i.style.minWidth=y.style.minWidth="0";let Pe=()=>{let Ae=1+(n?1:0),et=s.clientWidth||r.clientWidth,ir=110+Ae*14+20+180+10,En=et<ir;s.style.display="grid",s.style.gap="10px",s.style.alignItems="start",s.style.gridTemplateColumns=En?"1fr":"minmax(0, 1fr) minmax(180px, 28ch)";let lr=(En?et:et-180-10)-Ae*14-20,_n=Math.max(110,Math.min(lr,210)),Ot=Math.max(0,Math.round(_n*.62));d.style.width=Math.max(0,Math.floor(_n))+"px",d.style.height=Ot+"px",m.style.height=Ot+"px",l.style.height=Ot+"px"};requestAnimationFrame(()=>{Pe();let Ae=new ResizeObserver(Pe);Ae.observe(s),Ae.observe(a)})}return ar(),{root:r,hiddenInput:E,getValue:()=>E.value,setValue:he}}function xr({r:e,g:t,b:n}){let o=r=>r.toString(16).padStart(2,"0");return`#${o(e)}${o(t)}${o(n)}`.toUpperCase()}function zn(e,t,n){e/=255,t/=255,n/=255;let o=Math.max(e,t,n),r=Math.min(e,t,n),s=o-r,a=0,i=o?s/o:0,d=o;if(s!==0){switch(o){case e:a=(t-n)/s+(t<n?6:0);break;case t:a=(n-e)/s+2;break;case n:a=(e-t)/s+4;break}a*=60}return{h:a,s:i,v:d}}function Fn(e,t,n){let o=n*t,r=o*(1-Math.abs(e/60%2-1)),s=n-o,a=0,i=0,d=0;return 0<=e&&e<60?(a=o,i=r):60<=e&&e<120?(a=r,i=o):120<=e&&e<180?(i=o,d=r):180<=e&&e<240?(i=r,d=o):240<=e&&e<300?(a=r,d=o):(a=o,d=r),{r:Math.round((a+s)*255),g:Math.round((i+s)*255),b:Math.round((d+s)*255)}}function Bn(e){if(!e)return null;let t=String(e).trim();if(t.startsWith("#")){let o=gr(t);return o?{...o,a:1}:null}let n=t.match(/rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*([.\d]+))?\)/i);return n?{r:+n[1],g:+n[2],b:+n[3],a:n[4]!==void 0?+n[4]:1}:null}var me=[],ae={},Ze="name",ue=!0,On="",Hn=!0,ot={},Sr=30,Er=/\p{Diacritic}/gu,_r="/ha-tracker/images/ha-tracker16x16.png",kr="/ha-tracker/images/ha16x16.png";async function Un(){let e=document.getElementById("add-zone-button"),t=document.getElementById("delete-zone-button"),n=document.getElementById("edit-zone-button");e&&e.addEventListener("click",async()=>{try{await $r()}catch(o){console.error("Error adding a zone:",o)}}),t&&t.addEventListener("click",async()=>{try{await Lr()}catch(o){console.error("Error deleting a zone:",o)}}),n&&n.addEventListener("click",async()=>{try{await Cr()}catch(o){console.error("Error when modifying a zone:",o)}})}async function Zn(){try{await $e(),await ze(),await st()}catch(e){throw console.error("Error updating zones:",e),e}}async function jn(e){try{e&&Array.isArray(e)?(me=e,console.log("Zones:",me)):(console.log("No valid zones were obtained from the server."),me=[])}catch(t){console.error("Error getting zones:",t),me=[]}}async function st(){v.getPane("circlePane")||(v.createPane("circlePane"),v.getPane("circlePane").style.zIndex=400);let e=me.map(t=>String(t.id));Object.keys(ae).forEach(t=>{e.includes(String(t))||(v.removeLayer(ae[t]),delete ae[t],delete ot[t])}),me.forEach(t=>{let n=String(t.id),{latitude:o,longitude:r,radius:s,name:a,custom:i,visible:d}=t;if(!Number.isFinite(o)||!Number.isFinite(r)||!Number.isFinite(s)){console.error("Invalid zone (lat/lon/radius):",t.id);return}if(d===!1){ae[n]&&(v.removeLayer(ae[n]),delete ae[n],delete ot[n]);return}if(ot[n])return;let c=ae[n],m=!c||c.getLatLng().lat!==o||c.getLatLng().lng!==r||c.getRadius()!==s,f=t.color||G,l=f,h=Q(f,V);if(c){let w=Wt(t),_=c.getPopup?.();_?_.getContent()!==w&&c.setPopupContent(w):c.bindPopup(w,{autoPan:!1}),(c.options.color!==l||c.options.fillColor!==h)&&c.setStyle({color:l,fillColor:h,fillOpacity:1})}if(!m)return;let p=!1;if(ae[n]){let w=ae[n];p=w.isPopupOpen(),v.removeLayer(w),delete ae[n]}let y=L.circle([o,r],{radius:s,color:l,fillColor:h,fillOpacity:1,opacity:.8,pane:"circlePane"}).addTo(v);je&&i&&typeof y.enableEdit=="function"&&y.enableEdit(),y.bindPopup(Wt(t),{autoPan:!1}),p&&y.openPopup(),y.on("click",async()=>{try{v.fitBounds(y.getBounds(),{padding:[24,24]}),y.openPopup(),await wt(t.id)}catch(w){console.error("Error handling zone row selection:",w)}}),y.on("editable:vertex:dragstart",()=>{ot[n]=!0,v.closePopup()}),y.on("editable:vertex:dragend",async()=>{ot[n]=!1;let w=y.getLatLng(),_=y.getRadius();if(t.latitude=w.lat,t.longitude=w.lng,t.radius=_,y.bindPopup(Wt(t),{autoPan:!1}),y.openPopup(),await ze(),je&&i)try{let T=await Gt(t.id,t.name,_,w.lat,w.lng,t.color,t.visible!==!1);T&&T.success?(await $e(),await ze(),await st(),await wt(t.id),console.log(`Zone with ID ${t.id} updated on server.`)):console.error(`Error updating zone with ID ${t.id} on server.`)}catch(T){console.error("Error in zone update request:",T)}}),ae[n]=y})}async function wt(e){let t=document.getElementById("zones-table-body");if(!t){console.error("The zone table tbody was not found.");return}let n=t.querySelector(`tr[data-zone-id="${String(e)}"]`);if(!n){console.error("No row found for the zone:",e);return}let o=document.getElementById("combo-select");if(o&&o.value!=="zones"){o.value="zones";let r=new Event("change",{bubbles:!0});o.dispatchEvent(r)}t.querySelectorAll("tr").forEach(r=>r.classList.remove("selected")),n.classList.add("selected"),n.scrollIntoView({behavior:"smooth",block:"center"}),typeof Ie=="function"&&Ie()}async function Ie(){let e=document.getElementById("zones-table-body");if(!e){console.error("Zone table body not found.");return}let t=e.querySelectorAll("tr"),n=document.getElementById("add-zone-button"),o=document.getElementById("delete-zone-button"),r=document.getElementById("edit-zone-button"),s=document.getElementById("zone-actions");if(!s||([n,o,r].filter(Boolean).forEach(i=>i.classList.add("hidden")),s.style.display=je?"flex":"none",!je))return;if(t.length===0)n.classList.remove("hidden");else{let i=e.querySelector("tr.selected");if(!i)n.classList.remove("hidden");else{let d=i.dataset.custom==="true";n.classList.remove("hidden"),d&&o.classList.remove("hidden"),r.classList.remove("hidden")}}let a=[n,o,r].filter(Boolean).filter(i=>!i.classList.contains("hidden"));a.length===1?(s.classList.add("single-button"),a[0].style.flex="1"):(s.classList.remove("single-button"),a.forEach(i=>i.style.flex="1"))}async function Lr(){let t=document.getElementById("zones-table-body").querySelector("tr.selected");if(!t){O(u("select_delete_zone"),{title:u("zones")});return}let n=t.dataset.zoneId,o=t.dataset.name;if(!n){console.error("The selected zone ID was not found.");return}if(await Rn(Mn("confirm_delete_zone",{name:o}),{type:"danger",okLabel:u("delete"),title:u("zones")}))try{await Vn(n),await $e(),await ze(),await st()}catch(s){console.error("Error trying to delete zone:",s),O(u("error_deleting_zone"),{title:u("zones")})}}async function Cr(){let e=document.getElementById("zones-table-body");if(!e){console.error("Zone table body not found.");return}let t=e.querySelector("tr.selected");if(!t){O(u("select_zone"),{title:u("zones")});return}let n=t.dataset.zoneId,o=me.find(c=>String(c.id)===String(n));if(!o){O(u("error_finding_zone"),{title:u("zones")});return}let r=!o.custom,s=await Zt(r?u("zone_name_ha"):u("enter_zone_name"),o.name||u("zone_without_name"),{title:u("zones"),withColor:!0,defaultColor:o.color,colorLabel:u("select_color"),withVisibility:!0,visibilityValue:o.visible!==!1,visibilityLabel:u?u("show_on_map"):"Mostrar en el mapa",inputDisabled:r,colorOptions:{palette:[],allowAlpha:!1,showNative:!1}});if(s===null)return;let a=s.visible!==void 0?!!s.visible:o.visible!==!1,i=s.color||o.color||G,d=o.name;if(!(!r&&(d=qn(s.value),d===null))&&!(!r&&Ce(d)===Ce(o.name)&&i===(o.color||G)&&a===(o.visible!==!1))){if(!r&&(await $e(),Wn(d,{excludeId:o.id}))){O(u("zone_name_exists"),{title:u("zones")});return}try{let c=await Gt(o.id,d,o.radius,o.latitude,o.longitude,i,a);c&&c.success?(r||(o.name=d),o.color=i,o.visible=a,await $e(),await ze(),await st(),await wt(o.id)):O(u("error_updating_zone"),{title:u("zones")})}catch(c){console.error("Error in zone update request:",c),O(u("error_updating_zone"),{title:u("zones")})}}}async function $r(){if(!v)return console.error("The map is not initialized."),null;let e=await Zt(u("enter_zone_name"),"",{title:u("zones"),withColor:!0,defaultColor:G,colorLabel:u("select_color"),colorOptions:{palette:[],allowAlpha:!1,showNative:!1}});if(e===null)return;let t=qn(e.value);if(t===null)return;if(await $e(),Wn(t)){O(u("zone_name_exists"),{title:u("zones")});return}let n=v.getCenter(),o=n.lat,r=n.lng,s=100;try{let a=e.color||G,i=await Gn(t,s,o,r,"mdi:map-marker",!1,!0,a);return i?(await $e(),await ze(),await st(),await wt(i),console.log(`Zone created successfully. ID: ${i}`),i):(console.error("Failed to create zone."),O(u("error_creating_zone"),{title:u("zones")}),null)}catch(a){console.error("Error in zone update request:",a),O(u("error_creating_zone"),{title:u("zones")})}}function ge(e,t,n={}){let{accuracy:o=0,includePassive:r=!1,epsilonM:s=.5,epsilonDeg:a=1e-5}=n,i=l=>Math.round(l/a),d=(l,h)=>`${i(l)},${i(h)}`;if(e==null||t==null||Number.isNaN(e)||Number.isNaN(t))return null;let c=[];for(let l=0;l<me.length;l++){let h=me[l];if(!h||h.passive&&!r)continue;let p=yt(e,t,h.latitude,h.longitude),y=(Number(h.radius)||0)+(Number(o)||0);p<=y&&c.push({zone:h,idx:l,distanceToCenter:p,key:d(h.latitude,h.longitude),radius:Number(h.radius)||0,id:h.entity_id||h.id||h.name||`idx:${l}`})}if(c.length===0)return null;if(c.length===1)return c[0].zone;let m=new Map;for(let l of c){let h=m.get(l.key);(!h||l.radius<h.radius-s||Math.abs(l.radius-h.radius)<=s&&String(l.id)<String(h.id))&&m.set(l.key,l)}let f=Array.from(m.values());return f.length===1||f.sort((l,h)=>{let p=l.distanceToCenter-h.distanceToCenter;if(Math.abs(p)>s)return p;let y=l.radius-h.radius;return Math.abs(y)>s?y:String(l.id).localeCompare(String(h.id))}),f[0].zone}async function Vt(e){if(!e)return;let t=String(e),n=ae[t];n?(v.setView(n.getLatLng(),v.getZoom()),n.openPopup()):console.error("Marker for zone not found:",t)}async function ze(){let e=document.getElementById("zones-table-body");if(!e){console.error("Zone table body not found."),rt(),Ie();return}let t=e.querySelector("tr.selected"),n=t?t.dataset.zoneId:null,o=[...me].sort((s,a)=>{let i,d;switch(Ze){case"vmap":{let c=s.visible===!1?1:0,m=a.visible===!1?1:0;if(c!==m)return ue?c-m:m-c;let f=Ce(s.name),l=Ce(a.name);return ue?f.localeCompare(l):l.localeCompare(f)}case"ctype":{let c=s.custom?0:1,m=a.custom?0:1;if(c!==m)return ue?c-m:m-c;let f=Ce(s.name),l=Ce(a.name);return ue?f.localeCompare(l):l.localeCompare(f)}case"radius":return i=Number(s.radius)||0,d=Number(a.radius)||0,ue?i-d:d-i;case"name":default:return i=(s.name||"").toLowerCase(),d=(a.name||"").toLowerCase(),ue?i.localeCompare(d):d.localeCompare(i)}}),r=Array.from(e.querySelectorAll("tr"));o.forEach((s,a)=>{let{id:i,latitude:d,longitude:c,name:m,custom:f}=s;if(!Number.isFinite(d)||!Number.isFinite(c)){console.error("Invalid coordinates for the zone:",i);return}let l=r.find(x=>String(x.dataset.zoneId)===String(i));l||(l=document.createElement("tr"),l.dataset.zoneId=String(i),l.dataset.custom=String(f),l.dataset.name=m,l.style.cursor="pointer",e.appendChild(l));let h=s.color||G,p=s.visible!==!1;l.dataset.visible=String(p),l.style.setProperty("--color-bg",Q(h,V));let y=p?`<div style="
              width:12px; height:12px; border:2px solid ${h};
              border-radius:50%;
              background-color:${Q(h,.3)};
              margin:auto;"></div>`:"",w=s.custom?_r:kr,_=s.custom?"custom":"ha",T=`<img src="${w}" alt="${_}" width="16" height="16" style="display:block;margin:auto;">`,k=`${F?J(s.radius*3.28084):J(s.radius)}`,C=`
		  <td>${y}</td>
          <td>${T}</td>
		  <td>${m||u("zone_without_name")}</td>
		  <td>${k}</td>
		`;l.innerHTML!==C&&(l.innerHTML=C,l.dataset.name=m),l.onclick=()=>{let x=ae[String(i)];if(x){let S=x.getBounds();v.fitBounds(S,{padding:[24,24]}),x.openPopup()}else console.error("No marker found for the zone:",i);e.querySelectorAll("tr").forEach(S=>S.classList.remove("selected")),l.classList.add("selected"),Ie()},e.children[a]!==l&&e.insertBefore(l,e.children[a]),String(i)===String(n)&&l.classList.add("selected")}),r.forEach(s=>{o.some(a=>String(a.id)===String(s.dataset.zoneId))||s.remove()}),Ie(),rt(),(On!==Ze||Hn!==ue)&&(Tr(),On=Ze,Hn=ue)}function Tr(){let e=document.querySelector("#zones-table");if(!e){console.error("Zone summary table not found.");return}e.querySelectorAll("thead th").forEach((n,o)=>{let r=n.getAttribute("data-i18n")||"",s="";switch(r){case"column_map":s="vmap";break;case"column_type":s="ctype";break;case"name":s="name";break;case"radius":s="radius";break}if(!s)return;n.style.cursor="pointer",n.onclick=()=>{Ze===s?ue=!ue:(Ze=s,ue=!0),ze()};let a="";Ze===s&&(a=ue?"\u25B2":"\u25BC");let i=r==="radius"?`${F?u("feet"):u("meters")}`:u(r);n.innerHTML=`
		  <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:30px;">
			<span class="hdr-label">${i}</span>
			<span style="font-size:12px;">${a}</span>
		  </div>
		`})}function qn(e){let t=(e||"").trim();return t===""?(O(u("empty_name"),{title:u("zones")}),null):t.length>Sr?(O(u("long_zone"),{title:u("zones")}),null):t}function Ce(e){return(e??"").toLocaleLowerCase().normalize("NFD").replace(Er,"").replace(/\s+/g," ").trim()}function Wn(e,{excludeId:t=null}={}){let n=Ce(e);return n?me.some(o=>o&&Ce(o.name)===n&&(t==null||String(o.id)!==String(t))):!1}function Wt(e){let{latitude:t,longitude:n,radius:o}=e,r=`https://www.google.com/maps/search/?api=1&query=${t},${n}`,s=F?J(o*3.28084):J(o),a=F?u("feet"):u("meters");return`
    <strong>${e.name||u("zone_without_name")}</strong><br>
    ${u("radius")}: ${s} ${a}
    <br><br><a href="${r}" target="_blank" rel="noopener noreferrer"><strong>${u("open_location")}</strong></a>
  `}function Dr(e){return me.find(t=>String(t?.id)===String(e))||null}function vt(e){let t=Dr(e);if(!t)return null;let n=t.color||G;return{id:t.id,name:t.name,lat:t.latitude,lon:t.longitude,color:n}}var Nr=400,Mr=4,Kn=2;var Pr=(e,t,n)=>`${Number(e).toFixed(6)},${Number(t).toFixed(6)},${Number(n)}`,Ar=(e,t)=>`${Number(e).toFixed(6)},${Number(t).toFixed(6)}`,Fe=new Map,Kt=new Map,xt=new Map,ie=new Map,Be=new Map,at=new Map;function Jt(e,t){if(Fe.has(e)&&Fe.delete(e),Fe.set(e,t),Fe.size>Nr){let n=Fe.keys().next().value;Fe.delete(n)}}function Re(e){at.delete(e)}function Ir(e,t,n){let o=(at.get(e)||0)+1;at.set(e,o);let r=Math.floor(Math.random()*250),s=Math.min(8e3,Math.max(300,t)*Math.pow(1.6,o))+r;setTimeout(n,s)}var Yt=0,Xt=[];function zr(e){return new Promise((t,n)=>{Xt.push({task:e,res:t,rej:n}),Jn()})}function Jn(){for(;Yt<Mr&&Xt.length;){let{task:e,res:t,rej:n}=Xt.shift();Yt++,e().then(t,n).finally(()=>{Yt--,Jn()})}}function qe(e,t){try{let n=document.querySelector(`tr.pos-main-row[data-entity-id="${e}"]`);n&&(n.dataset.address=t||"");let o=document.querySelector(`tr.position-address-row[data-entity-id="${e}"]`);o&&(o.dataset.address=t||"")}catch{}}async function it(e,t,n,o,r){if(!Number.isFinite(t)||!Number.isFinite(n)||!Number.isFinite(o))return;let s=Pr(t,n,o);ie.set(e,s);let a=Fe.get(e);if(a?.key===s){let c=a.address||"";r?.(c),qe(e,c),ie.delete(e),Re(e);return}if(Be.get(e)===s)return;Be.set(e,s);let i=c=>{Be.get(e)===s&&Be.delete(e),Ir(e,c,()=>{ie.get(e)===s&&it(e,t,n,o,r)})},d=Ar(t,n);try{if(Kt.has(d)){let l=Kt.get(d)||"";Jt(e,{key:s,address:l}),ie.get(e)===s&&(r?.(l),qe(e,l),ie.delete(e),Re(e));return}if(xt.has(d)){let l=await xt.get(d);if(ie.get(e)!==s)return;if(!l){if((at.get(e)||0)<Kn){i(600);return}r?.(""),qe(e,""),ie.delete(e),Re(e);return}Jt(e,{key:s,address:l}),r?.(l),qe(e,l),ie.delete(e),Re(e);return}let c=zr(()=>Xn(t,n));xt.set(d,c.then(l=>(l?.address?.display_name||"").trim()));let m=await c;if(ie.get(e)!==s)return;if(m?.error==="queued"&&Number.isFinite(m?.retry_after)){i(m.retry_after*1e3);return}if(["temporarily_unavailable","rate_limited","busy"].includes(m?.error)){let l=Number.isFinite(m?.retry_after)?m.retry_after:1.5;i(l*1e3);return}let f=(m?.address?.display_name||"").trim();if(!f){if((at.get(e)||0)<Kn){i(600);return}r?.(""),qe(e,""),ie.delete(e),Re(e);return}Kt.set(d,f),Jt(e,{key:s,address:f}),r?.(f),qe(e,f),ie.delete(e),Re(e)}catch{ie.get(e)===s&&i(1200)}finally{xt.delete(d),Be.get(e)===s&&Be.delete(e)}}function Yn(e){ie.delete(e),Be.delete(e),Re(e)}var Fr="/ha-tracker/images/location-red.png",Oe=[],St=[],ne={},be={},We="name",fe=!0,Qn="",eo=!0,Qt={};(function(){if(document.getElementById("persons-tint-css"))return;let t=document.createElement("style");t.id="persons-tint-css",t.textContent=`
    #persons-table-body tr.selected > td {
      background-color: transparent !important;
    }
    #persons-table-body tr.zone-tinted:not(.selected) > td {
      background-color: var(--zone-bg) !important;
    }	
  `,document.head.appendChild(t)})();var lt=null;function Br(){if(lt)return lt;let e=document.querySelector("#users .table-wrapper")||null;return lt=new IntersectionObserver(t=>{for(let n of t){if(!n.isIntersecting)continue;let o=n.target;lt.unobserve(o);let r=o.dataset.personId,s=Number(o.dataset.latitude),a=Number(o.dataset.longitude),i=Number(o.dataset.lastUpdated),d=`${r}_${i}`,c=o.querySelector("td");!Number.isFinite(s)||!Number.isFinite(a)||!c||it(d,s,a,i,m=>{Qt[r]={lat:s,lon:a,timestamp:i,address:m||""};let f=document.querySelector(`tr.person-address-row[data-person-id="${r}"]`);if(f&&f.dataset.lastUpdated===String(i)){let l=f.querySelector("td");l&&(l.textContent=m||"")}})}},{root:e,rootMargin:"200px"}),lt}async function no(){try{await io(),await ao(),await Rr(),await rt(),await Or(),await tn()}catch(e){throw console.error("Error updating devices:",e),e}}async function oo(e){try{St=Array.isArray(e)?e.filter(t=>t.entity_id&&t.attributes):[],console.log("Devices:",St)}catch(t){console.error("Error processing devices:",t),St=[]}}async function ro(e){try{Oe=Array.isArray(e)?e.filter(t=>t.attributes?.friendly_name):[],console.log("Persons:",Oe)}catch(t){console.error("Error processing persons:",t),Oe=[]}}async function en(e){if(!e)return;let t=be[e];if(!t)return;let n=ne[e];if(!n){console.error(`No device was found for the person with ID: ${e}`);return}Object.values(be).forEach(s=>s.setZIndexOffset(500)),t.setZIndexOffset(600);let{latitude:o,longitude:r}=n.attributes||{};if(!Ut(o,r)){console.error(`Invalid coordinates for ${e}: lat=${o}, lng=${r}`);return}t.openPopup(),v.invalidateSize(),v.setView([o,r],v.getZoom())}function tn(){let e=document.getElementById("person-select");if(!e)return;let t=e.value,n=document.createDocumentFragment(),o=document.createElement("option");o.value="",o.textContent=u("select_user"),n.appendChild(o),Oe.filter(a=>!!ne[a.entity_id]).forEach(a=>{let i=document.createElement("option");i.value=a.entity_id;let d=a.attributes.friendly_name||a.attributes.id||a.entity_id;i.textContent=(d||"").trim(),n.appendChild(i)}),e.innerHTML="",e.appendChild(n);let r=e.options.length>1,s=!!(t&&ne[t]);r&&s?e.value=t:(e.value="",e.dispatchEvent(new Event("change",{bubbles:!0})))}async function so(){try{let e=Object.values(ne).filter(n=>n.attributes.latitude&&n.attributes.longitude).map(n=>[n.attributes.latitude,n.attributes.longitude]);if(!e.length){console.log("There are no devices with coordinates to adjust the map."),v.fitWorld();return}let t=L.latLngBounds(e);v.fitBounds(t)}catch(e){console.error("Error doing fitMapToAllDevices:",e)}}async function Rr(){ne={},Oe.forEach(e=>{let t=e.attributes?.source;if(!t||typeof t!="string"||t.trim()===""){console.log(`The person ${e.attributes.friendly_name||e.entity_id} does not have a valid 'source'.`);return}let n=St.find(o=>o.entity_id===t);if(!n){console.error(`The 'source' (${t}) of ${e.attributes.friendly_name||e.entity_id} is not in device_trackers.`);return}if(!n.attributes.latitude||!n.attributes.longitude){console.log(`The device_tracker ${t} of ${e.attributes.friendly_name||e.entity_id} does not have lat/lng.`);return}ne[e.entity_id]=n}),console.log("Devices to persons:",ne)}async function Or(){if(!v.getPane("personsMarkers")){let t=v.createPane("personsMarkers");t.style.zIndex=600,t.style.pointerEvents="auto"}let e=Object.keys(ne);Object.keys(be).forEach(t=>{e.includes(t)||(v.removeLayer(be[t]),delete be[t])}),e.forEach(t=>{let n=ne[t],{latitude:o,longitude:r,friendly_name:s,speed:a}=n.attributes,i=Et(n),d=i!=null?`<br>${u("battery")}: ${i}${u("percentage")}`:"";if(!Ut(o,r))return;let c=le(n.last_updated||u("date_unavailable")),m=Oe.find(w=>w.entity_id===t),f=m?.attributes.friendly_name||"",l=m?.attributes.entity_picture||Fr,h=`https://www.google.com/maps/search/?api=1&query=${o},${r}`,p=`
		  <strong>${f}</strong> (${s})<br>
		  ${c}<br>
		  ${u("speed")}: ${Math.round((a||0)*(F?2.23694:3.6))} ${u(F?"mi_per_hour":"km_per_hour")}
		  ${d}
		  <br><br><a href="${h}" target="_blank" rel="noopener noreferrer"><strong>${u("open_location")}</strong></a>
		`,y=L.divIcon({className:"",html:`<img src="${l}" style="width:48px;height:48px;border-radius:50%;object-fit:cover;" />`,iconSize:[48,48],iconAnchor:[24,24],popupAnchor:[0,-24]});if(be[t]){let w=be[t];w.setLatLng([o,r]),w.setIcon(y);let _=w.getPopup?.();_?_.setContent(p):w.bindPopup(p,{autoPan:!1})}else be[t]=L.marker([o,r],{icon:y,pane:"personsMarkers"}).addTo(v).bindPopup(p,{autoPan:!1}).on("click",async()=>{await Hr(t),v.invalidateSize();let w=be[t].getLatLng();v.setView(w,v.getZoom()),be[t].openPopup()})})}async function Hr(e){let t=document.getElementById("combo-select");t&&t.value!=="users"&&(t.value="users",t.dispatchEvent(new Event("change",{bubbles:!0})),await new Promise(i=>requestAnimationFrame(i)));let o=document.getElementById("persons-table-body");if(o||(await new Promise(i=>requestAnimationFrame(i)),o=document.getElementById("persons-table-body")),!o){console.error("Person table tbody not found.");return}let r=window.CSS&&CSS.escape?CSS.escape(e):e.replace(/"/g,'\\"'),s=o.querySelector(`tr[data-person-id="${r}"]`);if(s||(s=Array.from(o.querySelectorAll("tr")).find(i=>i.dataset.personId===e)),!s)return;let a=s.nextElementSibling&&s.nextElementSibling.classList.contains("person-address-row")?s.nextElementSibling:null;o.querySelectorAll("tr.selected").forEach(i=>i.classList.remove("selected")),s.classList.add("selected"),a&&a.classList.add("selected"),s.scrollIntoView({behavior:"smooth",block:"center"})}function Ur(){let e=document.querySelector("#persons-table");if(!e){console.error("Zone summary table not found.");return}e.querySelectorAll("thead th").forEach(n=>{let o=n.getAttribute("data-i18n"),r="";switch(o){case"name":r="name";break;case"date":r="date";break;case"speed":r="speed";break;case"percentage":r="percentage";break;case"zone":r="zone";break}if(!r)return;n.style.cursor="pointer",n.onclick=()=>{We===r?fe=!fe:(We=r,fe=!0),rt()};let s=We===r?fe?"\u25B2":"\u25BC":"",a=o==="speed"?F?u("mi_per_hour"):u("km_per_hour"):u(o);n.innerHTML=`
		  <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:30px;">
			<span class="hdr-label">${a}</span>
			<span class="hdr-arrow" style="font-size:12px;">${s}</span>
		  </div>
		`})}function to(e,t){e&&(t?(e.classList.add("zone-tinted"),e.style.setProperty("--zone-bg",t)):(e.classList.remove("zone-tinted"),e.style.removeProperty("--zone-bg")))}async function rt(){try{let e=document.getElementById("persons-table-body");if(!e){console.error("Person table tbody not found.");return}let t=e.querySelector("tr.selected"),n=t?t.dataset.personId:null,r=[...Oe.filter(i=>ne[i.entity_id])].sort((i,d)=>{let c=ne[i.entity_id]||{},m=ne[d.entity_id]||{},f,l;switch(We){case"name":return f=i.attributes.friendly_name||i.entity_id,l=d.attributes.friendly_name||d.entity_id,fe?f.localeCompare(l):l.localeCompare(f);case"date":return f=c.last_updated?new Date(c.last_updated).getTime():0,l=m.last_updated?new Date(m.last_updated).getTime():0,fe?f-l:l-f;case"speed":return f=parseFloat(c.attributes?.speed)||0,l=parseFloat(m.attributes?.speed)||0,fe?f-l:l-f;case"percentage":return f=Number(Et(c))||0,l=Number(Et(m))||0,fe?f-l:l-f;case"zone":return f=ge(c.attributes?.latitude,c.attributes?.longitude)?.name||"",l=ge(m.attributes?.latitude,m.attributes?.longitude)?.name||"",fe?f.localeCompare(l):l.localeCompare(f);default:return 0}}),s=Array.from(e.querySelectorAll("tr")),a=Br();r.forEach((i,d)=>{let c=i.entity_id,m=i.attributes.friendly_name||c,f=i.attributes.source||null,l="",h="",p="",y=null,w="",_="",T=null,k,C,x,S=!1;if(f&&ne[c]){let b=ne[c];l=b.attributes.friendly_name?`(${b.attributes.friendly_name})`:"",y=Et(b),h=le(b.last_updated),p=Math.round((b.attributes.speed||0)*(F?2.23694:3.6)),T=ge(b.attributes.latitude,b.attributes.longitude),w=T?T.name:"",k=Number(b.attributes.latitude),C=Number(b.attributes.longitude),x=new Date(b.last_updated).getTime();let N=Qt[c];if(_=N?.address||"",!N)S=!0;else{let M=yt(N.lat,N.lon,k,C),I=(x-(N.timestamp||0))/1e3;M>=on&&I>=nn&&(_="",S=!0)}}let g=s.find(b=>b.dataset.personId===c&&!b.classList.contains("person-address-row")),$=g?g.nextElementSibling:null;if(!g){g=document.createElement("tr"),g.dataset.personId=c,g.style.cursor="pointer",$=document.createElement("tr"),$.dataset.personId=c,$.classList.add("person-address-row"),$.style.cursor="pointer";let b=document.createElement("td");b.setAttribute("colspan","5"),b.textContent=_||"",b.style.borderBottom="1px solid rgba(0,0,0,0.1)",$.appendChild(b),e.appendChild(g),e.appendChild($)}let B=`
				<td><p style="font-weight:bold;color:#003366;margin:0;">${m}</p>${l}</td>
				<td>${h}</td>
				<td>${w}</td>
				<td>${p}</td>
				<td>${y??""}</td>
			  `;g.innerHTML!==B&&(g.innerHTML=B);let A=Zr(T,V);if(to(g,A),to($,A),$){let b=$.querySelector("td");$.dataset.latitude=Number.isFinite(k)?String(k):"",$.dataset.longitude=Number.isFinite(C)?String(C):"",$.dataset.lastUpdated=Number.isFinite(x)?String(x):"0";let N=!!Qt[c];S||!N&&Number.isFinite(k)&&Number.isFinite(C)?(b&&b.textContent!=="\u2026"&&(b.textContent="\u2026"),a.observe($)):(Yn(`${c}_${$?.dataset?.lastUpdated??""}`),b&&b.textContent!==_&&(b.textContent=_||""))}let E=()=>{e.querySelectorAll("tr.selected").forEach(b=>b.classList.remove("selected")),g.classList.add("selected"),$&&$.classList.add("selected"),en(c)};g.onclick=E,$&&($.onclick=E),e.children[d*2]!==g&&(e.insertBefore(g,e.children[d*2]),e.insertBefore($,g.nextSibling)),c===n&&(g.classList.add("selected"),$&&$.classList.add("selected"))}),Array.from(e.querySelectorAll("tr")).forEach(i=>{let d=i.dataset.personId;r.some(c=>c.entity_id===d)||(i.nextElementSibling&&i.nextElementSibling.classList.contains("person-address-row")&&i.nextElementSibling.remove(),i.remove())}),(Qn!==We||eo!==fe)&&(Ur(),Qn=We,eo=fe)}catch(e){console.error("Error updating people table:",e)}}function Zr(e,t=V){if(!e||!e.color)return null;let n=Math.min(1,Math.max(0,Number(t)||0));return Q(e.color,n)||e.color}function Et(e){return e?.battery_level??e?.attributes?.battery_level??null}var lo=" \u21D2 ",dt="4.6.13",ct={coreJS:"/ha-tracker/vendor/flatpickr/flatpickr.min.js?v="+dt,coreCSS:"/ha-tracker/vendor/flatpickr/flatpickr.min.css?v="+dt,confirmJS:"/ha-tracker/vendor/flatpickr/plugins/confirmDate/confirmDate.js?v="+dt,confirmCSS:"/ha-tracker/vendor/flatpickr/plugins/confirmDate/confirmDate.css?v="+dt,l10nBase:"/ha-tracker/vendor/flatpickr/l10n"},_t,De=null,fo=null;function rn(){let e=new Set(["ar","de","es","fr","hi","it","ja","pt","ru","zh"]),t=(navigator.languages?.length?navigator.languages:[navigator.language||"en"]).map(n=>String(n).toLowerCase());for(let n of t){let o=n.slice(0,2);if(e.has(o))return o}return"en"}async function jr(){return _t||(_t=(async()=>{await Ue(ct.coreCSS),await Ue(ct.confirmCSS),await ke(ct.coreJS,{test:()=>!!window.flatpickr}),await ke(ct.confirmJS,{test:()=>!!window.confirmDatePlugin});let e=rn();e!=="en"&&await ke(`${ct.l10nBase}/${e}.js?v=${dt}`,{test:()=>!!window.flatpickr?.l10ns?.[e]}).catch(()=>{}),De=window.flatpickr,fo=window.confirmDatePlugin})(),_t)}var Ne=[],ut=null,Ge,Ke,K,ve="00:00:00",xe="23:59:59",we=e=>String(e).padStart(2,"0"),Ve=e=>`${e.getFullYear()}-${we(e.getMonth()+1)}-${we(e.getDate())}T${we(e.getHours())}:${we(e.getMinutes())}:${we(e.getSeconds())}`;function qr(e,t){return e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate()}function co(e){let[t="00",n="00"]=String(e||"").split(":");return`${we(t)}:${we(n)}`}async function po(e={}){if(ut=typeof e.onApplyFilter=="function"?e.onApplyFilter:null,window.__rangePickerInitDone)return;try{await jr(),Qr()}catch(r){console.error("[calendar] flatpickr could not be loaded:",r);return}let t=document.getElementById("daterange");if(!t){console.error("[calendar] #daterange does not exist");return}let n=rn(),o=De?.l10ns?.[n]||De?.l10ns?.default;K=De(t,{mode:"range",enableTime:!1,closeOnSelect:!1,dateFormat:"Y-m-d",allowInput:!1,locale:o,plugins:[new fo({confirmText:u("accept"),showAlways:!0,theme:"light"})],onDayCreate(r,s,a,i){i.addEventListener("click",()=>{ve="00:00:00",xe="23:59:59",Ge?.setDate(ve,!1),Ke?.setDate(xe,!1),setTimeout(()=>Te(a),0)})},onReady(r,s,a){uo(a),Te(a)},onOpen(r,s,a){a._prevTextboxValue=a.input.value,a._prevSelectedDates=Array.isArray(a.selectedDates)?[...a.selectedDates]:[],a.calendarContainer.classList.add("fp-at-top"),uo(a),Ne.length===2?a.setDate(Ne,!0):Te(a)},onClose(r,s,a){a.calendarContainer.classList.remove("fp-at-top")},onValueUpdate(){Te(K)},onChange(){Te(K)}}),window.addEventListener("resize",()=>{let r=K?.calendarContainer;r&&ho(r)}),window.__rangePickerInitDone=!0}function Lt(){let e,t;if(K&&Array.isArray(K.selectedDates)){let n=K.selectedDates.length;if(n===2){let[o,r]=K.selectedDates,[s,a,i]=(ve||"00:00:00").split(":").map(h=>+h||0),[d,c,m]=(xe||"23:59:59").split(":").map(h=>+h||0),f=new Date(o);f.setHours(s,a,i,0);let l=new Date(r);l.setHours(d,c,m,0),e=Ve(f),t=Ve(l)}else if(n===1){let o=K.selectedDates[0],[r,s,a]=(ve||"00:00:00").split(":").map(l=>+l||0),[i,d,c]=(xe||"23:59:59").split(":").map(l=>+l||0),m=new Date(o);m.setHours(r,s,a,0);let f=new Date(o);f.setHours(i,d,c,0),e=Ve(m),t=Ve(f)}}else if(Array.isArray(Ne)&&Ne.length===2){let[n,o]=Ne;e=Ve(n),t=Ve(o)}return{startLocal:e,endLocal:t}}function kt(e="00:00:00",t="23:59:59"){ve=e||"00:00:00",xe=t||"23:59:59",Ge?.setDate(ve,!1),Ke?.setDate(xe,!1),K&&Te(K)}function sn([e,t],n=!0){K&&(K.setDate([e,t],!!n),n||Te(K),n&&(Ne=[new Date(e),new Date(t||e)]))}function mt(){Ne=[],K&&(K.clear(!1),K.input.value="")}function an(){let e=document.getElementById("person-select"),t=document.getElementById("daterange"),n=t?.closest(".group")||t;if(!e||!n)return;let o=e.value===""||e.selectedIndex===-1;n.style.display=o?"none":"",o&&(t.value="",K?.clear(!1))}function Te(e){if(!e)return;let t=new Intl.DateTimeFormat(void 0,{year:"2-digit",month:"2-digit",day:"2-digit"}),[n,o]=e.selectedDates||[],r=co(ve||"00:00:00"),s=co(xe||"23:59:59");if(n&&!o){e.input.value=`${t.format(n)} ${r}`;return}if(n&&o){qr(n,o)?e.input.value=`${t.format(n)} ${r}${lo}${s}`:e.input.value=`${t.format(n)} ${r}${lo}${t.format(o)} ${s}`;return}e.input.value=""}function Wr(e){let t=e.selectedDates||[];if(t.length===1){let n=t[0];e.setDate([n,n],!1)}if(Array.isArray(e.selectedDates)&&e.selectedDates.length){let[n,o=e.selectedDates[0]]=e.selectedDates,[r,s,a]=(ve||"00:00:00").split(":").map(l=>+l||0),[i,d,c]=(xe||"23:59:59").split(":").map(l=>+l||0),m=new Date(n);m.setHours(r,s,a,0);let f=new Date(o);f.setHours(i,d,c,0),Ne=[m,f]}Te(e),e.close(),ut&&ut()}function ho(e){let t=e.getBoundingClientRect().width+"px";Ge?.calendarContainer&&(Ge.calendarContainer.style.width=t),Ke?.calendarContainer&&(Ke.calendarContainer.style.width=t)}function Vr(e){let t=document.createElement("div");t.className="fp-quickbar";let n=o=>`${we(o.getHours())}:${we(o.getMinutes())}:${we(o.getSeconds())}`;return["today","yesterday","last_24h","last_7_days","this_week"].forEach(o=>{let r=document.createElement("button");r.type="button",r.textContent=u(o),r.addEventListener("click",()=>{let{start:s,end:a}=Xr(o);if(s&&a){if(o==="last_24h"){let i=new Date(a.getTime()-1e3);kt(n(s),n(i))}else kt("00:00:00","23:59:59");sn([s,a],!0),e.close(),ut&&ut()}}),t.appendChild(r)}),t}function uo(e){let t=e.calendarContainer;t.querySelector(".fp-quickbar")||t.appendChild(Vr(e));let n=t.querySelector(".fp-timepanel");if(!n){n=document.createElement("div"),n.className="fp-timepanel";let s=document.createElement("div");s.className="fp-timeblock";let a=document.createElement("div");a.className="fp-timehost",s.appendChild(a);let i=document.createElement("div");i.className="fp-timeblock";let d=document.createElement("div");d.className="fp-timehost",i.appendChild(d),n.append(s,i),t.appendChild(n);let c=rn(),m=De?.l10ns?.[c]||De?.l10ns?.default,f=!new Intl.DateTimeFormat(void 0,{hour:"numeric"}).formatToParts(new Date).some(p=>p.type==="dayPeriod"),l=document.createElement("input");l.type="hidden";let h=document.createElement("input");h.type="hidden",document.body.appendChild(l),document.body.appendChild(h),Ge=De(l,{inline:!0,noCalendar:!0,enableTime:!0,enableSeconds:!0,time_24hr:f,dateFormat:"H:i:S",defaultDate:ve,locale:m,onChange:(p,y)=>{ve=y||"00:00:00"}}),Ke=De(h,{inline:!0,noCalendar:!0,enableTime:!0,enableSeconds:!0,time_24hr:f,dateFormat:"H:i:S",defaultDate:xe,locale:m,onChange:(p,y)=>{xe=y||"23:59:59"}}),a.appendChild(Ge.calendarContainer),d.appendChild(Ke.calendarContainer)}let o=t.querySelector(".fp-actionbar");o||(o=document.createElement("div"),o.className="fp-actionbar",t.appendChild(o));let r=t.querySelector(".flatpickr-confirm");if(r&&!o.contains(r)&&(r.textContent=u("accept"),r.classList.add("fp-btn"),o.appendChild(r),r.dataset._bound||(r.addEventListener("click",()=>Wr(e)),r.dataset._bound="1")),!o.querySelector(".flatpickr-cancel")){let s=document.createElement("button");s.type="button",s.className="fp-btn flatpickr-cancel",s.textContent=u("cancel"),o.insertBefore(s,o.querySelector(".flatpickr-confirm")||null),s.addEventListener("click",()=>{Array.isArray(e._prevSelectedDates)?e.setDate(e._prevSelectedDates,!1):e.clear(!1),typeof e._prevTextboxValue=="string"?e.input.value=e._prevTextboxValue:e.input.value="",e.close()})}ho(t)}function Gr(e){let t=new Date(e);return t.setHours(0,0,0,0),t}function mo(e,t){let n=new Date(e);return n.setDate(n.getDate()+t),n}function Kr(e){let t=new Date(e.getFullYear(),e.getMonth(),1);return t.setHours(0,0,0,0),t}function Jr(e){let t=new Date(e.getFullYear(),e.getMonth()+1,1);return t.setHours(0,0,0,0),t}function yo(e){let t=new Date(e),n=t.getDay(),o=n===0?-6:1-n;return t.setDate(t.getDate()+o),t.setHours(0,0,0,0),t}function Yr(e){let t=yo(e),n=new Date(t);return n.setDate(t.getDate()+7),new Date(n.getTime()-1e3)}function Xr(e){let t=new Date,n=Gr(t);switch(e){case"today":return{start:n,end:n};case"yesterday":return{start:mo(n,-1),end:mo(n,-1)};case"last_24h":return{start:new Date(t-1440*60*1e3),end:new Date(t)};case"last_7_days":return{start:new Date(t-10080*60*1e3),end:t};case"this_month":return{start:Kr(t),end:Jr(t)};case"last_month":{let o=new Date(t.getFullYear(),t.getMonth()-1,1,0,0,0,0),r=new Date(t.getFullYear(),t.getMonth(),1,0,0,0,0),s=new Date(r.getTime()-1e3);return{start:o,end:s}}case"this_week":return{start:yo(t),end:Yr(t)};default:return{start:null,end:null}}}function Qr(){if(document.getElementById("fp-shadow-patch"))return;let e=document.createElement("style");e.id="fp-shadow-patch",e.textContent=`
    .flatpickr-calendar{
      background:#fff !important;
      border:1px solid rgba(0,0,0,.12) !important;
      border-radius:12px !important;
      box-shadow:0 12px 28px rgba(0,0,0,.30) !important;
      overflow:hidden;
    }
    @media (max-width: 600px){
      .flatpickr-calendar.fp-at-top{
        left: 8px !important;
        right: 8px !important;
        width: auto !important;
        max-width: calc(100% - 16px) !important;
        margin: 0 auto !important;
      }
    }
  `,document.head.appendChild(e)}function ln(e){return(e instanceof Date?e:new Date(e)).toISOString()}function oe(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function es(e=""){return`<![CDATA[${e}]]>`}function ts(e){return Number.isFinite(e)?Math.round(e*3.6):0}function ns(e){let t=[];for(let n of e||[]){let o=Number(n?.attributes?.latitude),r=Number(n?.attributes?.longitude);!Number.isFinite(o)||!Number.isFinite(r)||t.push(`${r},${o},0`)}return t}function os(e,t={}){let{stopIconHref:n,includeRoute:o=!0,routeColor:r="ff0000ff",routeWidth:s=6,describeStop:a,nameStop:i,unitLabel:d="km/h",formatLocal:c,batteryLabel:m="Battery"}=t;if(!e||!e.length)throw new Error("No hay posiciones para exportar.");let f=ln(e[0].last_updated),l=ln(e[e.length-1].last_updated),h=`
    <Style id="stopStyle">
      <IconStyle>
        <scale>1.2</scale>
        ${n?`<Icon><href>${oe(n)}</href></Icon>`:""}
      </IconStyle>
      <LabelStyle><scale>0</scale></LabelStyle>
    </Style>
    <Style id="routeStyle">
      <LineStyle>
        <color>${oe(r)}</color>
        <width>${Number(s)||6}</width>
      </LineStyle>
    </Style>
  `,p=o?ns(e):[],y=o&&p.length>=2?`
    <Placemark>
      <name>Route</name>
      <styleUrl>#routeStyle</styleUrl>
      <LineString>
        <tessellate>1</tessellate>
        <coordinates>${p.join(" ")}</coordinates>
      </LineString>
    </Placemark>
  `:"",w=(e||[]).filter(k=>!!k?.stop).map((k,C)=>{let x=Number(k?.attributes?.latitude),S=Number(k?.attributes?.longitude);if(!Number.isFinite(x)||!Number.isFinite(S))return"";let g=ln(k.last_updated),$=c?c(k.last_updated):g,B=ts(Number(k?.attributes?.speed)),A=`${k?.entity_id||"position"} #${C+1}`,E=i?i(k):A,b=Number.isFinite(k?.battery)?Math.round(k.battery):null,N="\u2022",M=(k?.zone||"").trim(),I=(k?.address||"").trim(),q=`${B} ${d}`,Z=b!=null?`${m}: ${b}%`:"",R=[M,q,Z,I].filter(Boolean).map(re=>`${N} ${re}`).join(`
`).trim(),he=a?a(k):`<table cellspacing="0" cellpadding="0" style="border-collapse:collapse">
			  <tr><td><b>${oe($)}</b></td></tr>
			  ${M?`<tr><td>${oe(M)}</td></tr>`:""}
			  ${I?`<tr><td>${oe(I)}</td></tr>`:""}
			  <tr><td>${oe(q)}</td></tr>
			  ${b!=null?`<tr><td>${oe(Z)}</td></tr>`:""}
			 </table>`;return`
		  <Placemark>
			<name>${oe(E)}</name>
			<Snippet maxLines="6"><![CDATA[${R}]]></Snippet>
			<styleUrl>#stopStyle</styleUrl>
			<TimeStamp><when>${g}</when></TimeStamp>
			<ExtendedData>
			  <Data name="entity_id"><value>${oe(k?.entity_id||"")}</value></Data>
			  <Data name="speed_kmh"><value>${B}</value></Data>
			  <Data name="is_stop"><value>true</value></Data>
			  <Data name="zone"><value>${oe(M)}</value></Data>
			  <Data name="address"><value>${oe(I)}</value></Data>
			  <Data name="when_local"><value>${oe($)}</value></Data>
			  <Data name="unit"><value>${oe(d)}</value></Data>
			  ${b!=null?`<Data name="battery_pct"><value>${b}</value></Data>`:""}
			</ExtendedData>
			<description>${es(he)}</description>
			<Point><coordinates>${S},${x},0</coordinates></Point>
		  </Placemark>
		`}).join(`
`),_=`HA Tracker ${f} - ${l}`;return`<?xml version="1.0" encoding="UTF-8"?>
  <kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
      <name>${oe(_)}</name>
      ${h}
      ${y}
      <Folder>
        <name>Stops</name>
        ${w}
      </Folder>
    </Document>
  </kml>`}function bo(e,t){let n=new Blob([t],{type:"application/vnd.google-earth.kml+xml"}),o=URL.createObjectURL(n),r=document.createElement("a");r.href=o,r.download=e.endsWith(".kml")?e:`${e}.kml`,document.body.appendChild(r),r.click(),r.remove(),URL.revokeObjectURL(o)}async function rs(e,t){let n=new Blob([t],{type:"application/vnd.google-earth.kml+xml"});if("showSaveFilePicker"in window){let r=await(await window.showSaveFilePicker({suggestedName:e.endsWith(".kml")?e:`${e}.kml`,types:[{description:"KML file",accept:{"application/vnd.google-earth.kml+xml":[".kml"]}}]})).createWritable();await r.write(n),await r.close()}else bo(e,t)}function Ct(e){return String(e).padStart(2,"0")}function go(e){let t=e instanceof Date?e:new Date(e);return`${t.getFullYear()}-${Ct(t.getMonth()+1)}-${Ct(t.getDate())}_${Ct(t.getHours())}-${Ct(t.getMinutes())}`}function ss(e,t="person"){if(!e||!e.length)return`ha-tracker_${t}.kml`;let n=e[0]?.last_updated,o=e[e.length-1]?.last_updated;return`ha-tracker_${t}_${go(n)}_${go(o)}.kml`}async function wo(e,t={}){let{personId:n="person",filename:o,usePicker:r=!1,...s}=t,a=os(e,s),i=o||ss(e,n);r?await rs(i,a):bo(i,a)}function vo(e){return e==null?"":`"${String(e).replace(/\r?\n/g," ").trim().replace(/"/g,'""')}"`}function xo(e){let t=Number(e);return Number.isFinite(t)?t.toFixed(6):""}function as(e,t){if(!Number.isFinite(e))return"";let n=e*3.6,o=n*.621371192;return Math.round(t?o:n)}function is(e,{useImperial:t,formatLocal:n,delimiter:o=";"}={}){let r=t?u("mi_per_hour"):u("km_per_hour"),a=[[u("date"),u("stops"),u("latitude"),u("longitude"),r,u("battery"),u("zone"),u("address")].map(vo).join(o)];for(let i of e||[]){let d=i?.attributes?.latitude,c=i?.attributes?.longitude,m=n?n(i?.last_updated):i?.last_updated||"",f=i?.stop?u("stop"):"",l=as(Number(i?.attributes?.speed),t),h=Number.isFinite(i?.battery)?i.battery:"",p=[m,f,xo(d),xo(c),l,h,i?.zone||"",i?.address||""].map(vo).join(o);a.push(p)}return a.join(`
`)}function So(e,t){let n=new Blob(["\uFEFF"+t],{type:"text/csv;charset=utf-8"}),o=URL.createObjectURL(n),r=document.createElement("a");r.href=o,r.download=e.endsWith(".csv")?e:`${e}.csv`,document.body.appendChild(r),r.click(),r.remove(),URL.revokeObjectURL(o)}async function ls(e,t){let n=new Blob(["\uFEFF"+t],{type:"text/csv;charset=utf-8"});if("showSaveFilePicker"in window){let r=await(await window.showSaveFilePicker({suggestedName:e.endsWith(".csv")?e:`${e}.csv`,types:[{description:"CSV",accept:{"text/csv":[".csv"]}}]})).createWritable();await r.write(n),await r.close()}else So(e,t)}async function Eo(e,{filename:t,useImperial:n,formatLocal:o,delimiter:r=";",usePicker:s=!1}={}){let a=is(e,{useImperial:n,formatLocal:o,delimiter:r});s?await ls(t,a):So(t,a)}var cs="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js";async function ds(){window.ExcelJS||await new Promise((e,t)=>{let n=document.createElement("script");n.src=cs,n.async=!0,n.onload=()=>e(),n.onerror=o=>t(o),document.head.appendChild(n)})}function _o(e){let t=Number(e);return Number.isFinite(t)?Number(t.toFixed(6)):null}function us(e,t){if(!Number.isFinite(e))return null;let n=e*3.6,o=n*.621371192;return Math.round(t?o:n)}function Se(e){return String(e||"").split(`
`).reduce((t,n)=>Math.max(t,n.length),0)}function ms(e,t){let n=[19,6,11,11,12,8,18,30],o=[40,10,16,16,16,10,50,80],r=t.map(s=>Se(s));for(let s of e)r[0]=Math.max(r[0],Se(s.date)),r[1]=Math.max(r[1],Se(s.stop)),r[2]=Math.max(r[2],Se(s.latStr)),r[3]=Math.max(r[3],Se(s.lonStr)),r[4]=Math.max(r[4],Se(s.speedStr)),r[5]=Math.max(r[5],Se(s.battStr)),r[6]=Math.max(r[6],Se(s.zone)),r[7]=Math.max(r[7],Se(s.address));return r.map((s,a)=>Math.min(o[a],Math.max(n[a],s+2)))}async function ko(e,{filename:t="ha-tracker.xlsx",useImperial:n=!1,formatLocal:o=s=>new Date(s).toLocaleString(),sheetName:r=u("positions")}={}){await ds();let s=window.ExcelJS,a=new s.Workbook,i=a.addWorksheet(r),d={name:"Verdana",size:9},c={vertical:"middle",horizontal:"left"},m=n?u("mi_per_hour"):u("km_per_hour"),f=[u("date"),u("stops"),u("latitude"),u("longitude"),m,u("battery"),u("zone"),u("address")],l=(e||[]).map(x=>{let S=o?o(x?.last_updated):x?.last_updated||"",g=x?.stop?u("stop"):"",$=_o(x?.attributes?.latitude),B=_o(x?.attributes?.longitude),A=us(Number(x?.attributes?.speed),n),E=Number.isFinite(x?.battery)?x.battery:null,b=x?.zone||"",N=(x?.address||"").replace(/\u00A0/g," ");return{date:S,stop:g,lat:$,lon:B,speed:A,batt:E,latStr:$==null?"":String($),lonStr:B==null?"":String(B),speedStr:A==null?"":String(A),battStr:E==null?"":String(E),zone:b,address:N}}),h={type:"pattern",pattern:"solid",fgColor:{argb:"FF003E78"}},p={...d,bold:!0,color:{argb:"FFFFFFFF"}},y={...c,wrapText:!0};i.addRow(f);let w=i.getRow(1);w.height=18,w.font=p,w.alignment=y,w.eachCell(x=>{x.fill=h,x.font=p,x.alignment=y});for(let x of l){let S=i.addRow([x.date,x.stop,x.lat,x.lon,x.speed,x.batt,x.zone,x.address]);S.font=d,S.alignment=c}i.views=[{state:"frozen",ySplit:1}];let _=ms(l,f);i.columns=_.map((x,S)=>({width:x,style:{font:d,alignment:{...c,wrapText:S===7}}})),i.getRow(1).eachCell(x=>{x.font=p,x.alignment=y,x.fill=h});let T=await a.xlsx.writeBuffer(),k=new Blob([T],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),C=document.createElement("a");C.href=URL.createObjectURL(k),C.download=t.endsWith(".xlsx")?t:`${t}.xlsx`,document.body.appendChild(C),C.click(),C.remove(),URL.revokeObjectURL(C.href)}var fs="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js",ps="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js",hs="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js",$t=[0,62,120],cn=[255,255,255];function dn(e){return new Promise((t,n)=>{if([...document.scripts].some(r=>r.src===e))return t();let o=document.createElement("script");o.src=e,o.async=!0,o.onload=()=>t(),o.onerror=r=>n(r),document.head.appendChild(o)})}async function ys(){window.jspdf?.jsPDF?.API?.autoTable||(await dn(fs),await dn(ps))}async function gs(){window.html2canvas||await dn(hs)}async function bs(){await gs();let e=document.getElementById("map");return e?(await window.html2canvas(e,{useCORS:!0,backgroundColor:"#ffffff",logging:!1,scale:2})).toDataURL("image/jpeg",.92):null}function ws(e,t=V){let n=/^#?([0-9a-f]{6})$/i.exec(e||"");if(!n)return null;let o=parseInt(n[1],16),r=o>>16&255,s=o>>8&255,a=o&255,i=d=>Math.round((1-t)*255+t*d);return[i(r),i(s),i(a)]}function vs(e,{defaultColor:t=G}={}){return e&&e.color?e.color:t}function un(e,t={},{alpha:n=V}={}){if(!e)return null;let o=t[e],r=vs(o);return ws(r,n)}function Co(e=[]){let t=[],n=null;for(let o of e){let r=(o.zone||"").trim(),s=r!==n;(o.stop||s)&&t.push(o),n=r}return t}function Lo(e,t,n,o,r,s,{font:a="helvetica",labelStyle:i="bold",valueStyle:d="normal",lineHeight:c=14}={}){e.setFont(a,i);let m=e.getTextWidth(r);e.setFont(a,d);let f=e.splitTextToSize(String(s||""),Math.max(20,o-m));e.setFont(a,i),e.text(r,t,n),e.setFont(a,d),e.text(f[0]||"",t+m,n);for(let l=1;l<f.length;l++)n+=c,e.text(f[l],t+m,n);return n+c}function xs(e,{margin:t,pageW:n,personName:o,startLocal:r,endLocal:s,nameColor:a=[0,62,120]}){let i=n-t*2,d=t;e.setFont("helvetica","bold"),e.setFontSize(16),e.setTextColor(a[0],a[1],a[2]);let c=e.splitTextToSize(o||"",i);return e.text(c,t,d),d+=c.length*18,e.setFontSize(11),e.setTextColor(a[0],a[1],a[2]),d=Lo(e,t,d,i,`${u("start")||"Inicio"}: `,r||"",{lineHeight:14,labelStyle:"bold",valueStyle:"normal"}),d=Lo(e,t,d,i,`${u("end")||"Fin"}: `,s||"",{lineHeight:14,labelStyle:"bold",valueStyle:"normal"}),d+=6,d}function Ss(e,t,n=.9){let o=e.internal.pageSize.getWidth(),r=o-t*2,s=Math.floor(r*n),a=t+Math.round((r-s)/2);return{tableWidth:s,left:a,pageW:o}}function Es(e){let t={date:.22,stop:.03,zone:.24,speed:.12,batt:.09,addr:.3},n={date:90,stop:12,zone:90,speed:54,batt:40,addr:90},o=Math.max(n.date,Math.floor(e*t.date)),r=Math.max(n.stop,Math.floor(e*t.stop)),s=Math.max(n.zone,Math.floor(e*t.zone)),a=Math.max(n.speed,Math.floor(e*t.speed)),i=Math.max(n.batt,Math.floor(e*t.batt)),d=Math.max(n.addr,Math.floor(e*t.addr)),c=o+r+s+a+i+d,m=e-c;return m!==0&&(d=Math.max(n.addr,d+m)),{wDate:o,wStop:r,wZone:s,wSpeed:a,wBatt:i,wAddr:d}}async function $o({filename:e,summaryRows:t,zonesRows:n,positionsRows:o,stopIconUrl:r,header:s}){await ys();let{jsPDF:a}=window.jspdf,i=new a({unit:"pt",format:"a4",compress:!0}),d=i.internal.pageSize.getWidth(),c=36,m=Ss(i,c,.9),f=null;if(r)try{let $=await(await fetch(r,{cache:"force-cache"})).blob();f=await new Promise(B=>{let A=new FileReader;A.onload=()=>B(A.result),A.readAsDataURL($)})}catch{}let l=xs(i,{margin:c,pageW:d,personName:s?.personName||"",startLocal:s?.startLocal||"",endLocal:s?.endLocal||"",nameColor:$t});try{let g=await bs();if(g){let $=i.getImageProperties(g),B=m.tableWidth,A=$.height*B/$.width;i.addImage(g,"JPEG",m.left,l,B,A),l+=A+8}}catch(g){console.warn("No se pudo capturar el mapa:",g)}i.autoTable({head:[[u("metric")||"M\xE9trica",u("value")||"Valor"]],body:(t||[]).map(g=>[g.label,g.value]),startY:l,theme:"grid",tableWidth:m.tableWidth,margin:{left:m.left,right:m.left},styles:{font:"helvetica",fontSize:10,cellPadding:4,overflow:"linebreak"},headStyles:{fillColor:$t,textColor:cn,fontStyle:"bold",halign:"left"},columnStyles:{0:{cellWidth:170,fontStyle:"bold"},1:{cellWidth:m.tableWidth-170}}}),l=i.lastAutoTable.finalY+8;{let g=!!Tt,$=100,B=60,A=60,E=60,b=$+A+E+(g?B:0),N=Math.max(160,m.tableWidth-b),M=[{key:"zone",header:u("zone")||"Zona",width:N,halign:"left"},{key:"time",header:u("time")||"Tiempo",width:$,halign:"center"}];g&&M.push({key:"visits",header:u("visits")||"Visitas",width:B,halign:"center"}),M.push({key:"stops",header:u("stops")||"Paradas",width:A,halign:"center"},{key:"distance",header:u("distance")||"Distancia",width:E,halign:"center"});let I=[M.map(j=>j.header)],q=(n||[]).map(j=>M.map(R=>R.key==="distance"?_s(j):R.key==="stops"||R.key==="visits"?String(j[R.key]??""):j[R.key]||"")),Z=M.reduce((j,R,he)=>(j[he]={cellWidth:R.width,halign:R.halign},j),{});i.autoTable({head:I,body:q,startY:l,theme:"grid",tableWidth:m.tableWidth,margin:{left:m.left,right:m.left},styles:{font:"helvetica",fontSize:10,cellPadding:4,overflow:"linebreak"},headStyles:{fillColor:$t,textColor:cn,fontStyle:"bold",halign:"left"},columnStyles:Z,didParseCell:j=>{if(j.section==="body"){let R=n[j.row.index];R?._fillColor&&(j.cell.styles.fillColor=R._fillColor)}}}),l=i.lastAutoTable.finalY+8}let{wDate:h,wStop:p,wZone:y,wSpeed:w,wBatt:_,wAddr:T}=Es(m.tableWidth),C=(o||[]).some(g=>/\bmph\b/i.test(String(g.speed||"")))?`${u("speed")||"Velocidad"} (${u("mi_per_hour")||"mph"})`:`${u("speed")||"Velocidad"} (${u("km_per_hour")||"km/h"})`,x=(o||[]).map(g=>[g.whenLocal||"","",g.zone||"",g.speed||"",(g.battery??"")===""?"":`${g.battery}%`,(g.address||"").replace(/\u00A0/g," ")]);i.autoTable({head:[[u("date")||"Fecha/Hora","",u("zone")||"Zona",C,u("battery")||"Bater\xEDa",u("address")||"Direcci\xF3n"]],body:x,startY:l,theme:"grid",tableWidth:m.tableWidth,margin:{left:m.left,right:m.left},styles:{font:"helvetica",fontSize:9,cellPadding:{top:3,right:3,bottom:3,left:3},halign:"left",valign:"top",overflow:"linebreak",cellWidth:"wrap"},headStyles:{fillColor:$t,textColor:cn,fontStyle:"bold",halign:"left"},columnStyles:{0:{cellWidth:h},1:{cellWidth:p,halign:"center"},2:{cellWidth:y},3:{cellWidth:w,halign:"center"},4:{cellWidth:_,halign:"center"},5:{cellWidth:T}},didParseCell:g=>{if(g.section==="body"){let $=o[g.row.index];$?._fillColor&&(g.cell.styles.fillColor=$._fillColor)}},didDrawCell:g=>{if(g.section==="body"&&g.column.index===1&&f&&o[g.row.index]?.isStop){let A=g.cell.x+(g.cell.width-10)/2,E=g.cell.y+(g.cell.height-10)/2;try{i.addImage(f,"PNG",A,E,10,10)}catch{}}},pageBreak:"auto"});let S=e?.endsWith(".pdf")?e:`${e||"export"}.pdf`;i.save(S)}function _s(e){if(!e)return"";if(e.distance!=null&&e.distance!=="")return String(e.distance);let t=Number(e.distanceMeters??e.meters??NaN);return Number.isFinite(t)?`${((e._unitShort==="mi"||e._unitShort==="km"?e._unitShort:"km")==="mi"?t/1609.344:t/1e3).toFixed(0)}`:""}var W,z,Y=null,To=null,Do=!1,Je=.3;function Dt(){let e=document.getElementById("positions-chart");e&&(W||(W=document.createElement("canvas"),W.style.width="100%",W.style.height="50px",W.setAttribute("aria-hidden","true"),e.innerHTML="",e.appendChild(W),z=W.getContext("2d"),To=new ResizeObserver(()=>{Y&&pn(Y.positions,Y.opts)}),To.observe(e)),Po())}function mn(){if(!W||!z)return;let e=window.devicePixelRatio||1,{width:t,height:n}=W.getBoundingClientRect();W.width=Math.max(1,Math.floor(t*e)),W.height=Math.max(1,Math.floor(n*e)),z.setTransform(e,0,0,e,0,0),z.clearRect(0,0,t,n),Y=null,W&&(W.style.cursor="default")}function No(e,t={}){if(Dt(),!(!W||!z)){if(!Array.isArray(e)||e.length<1){mn();return}Y={positions:e,opts:t},pn(e,t),W.style.cursor=Array.isArray(e)&&e.length>0?"pointer":"default",Po()}}function fn(e){if(Dt(),!Y)return;let t=Mo(e);Y.opts={...Y.opts||{},markerTs:t},pn(Y.positions,Y.opts)}function Mo(e){if(e==null)return null;if(e instanceof Date)return e.getTime();if(typeof e=="number")return Number.isFinite(e)?e:null;if(typeof e=="string"){if(/^\d+$/.test(e))return parseInt(e,10);let t=Date.parse(e);return Number.isFinite(t)?t:null}return null}function pn(e,t){let n=window.devicePixelRatio||1,{width:o,height:r}=W.getBoundingClientRect();W.width=Math.max(1,Math.floor(o*n)),W.height=Math.max(1,Math.floor(r*n)),z.setTransform(n,0,0,n,0,0);let s=o,a=r,i=5,d=(a-i)/2,c=0,m=c+d+i,f=[...e].sort((E,b)=>+new Date(E.last_updated)-+new Date(b.last_updated));if(!f.length){z.clearRect(0,0,s,a);return}let l=E=>{let b=+new Date(E.last_updated),N=E.stop&&E.stop_start?+new Date(E.stop_start):NaN;return Number.isFinite(N)?Math.min(b,N):b},h=E=>{let b=+new Date(E.last_updated),N=E.stop&&E.stop_end?+new Date(E.stop_end):NaN;return Number.isFinite(N)?Math.max(b,N):b},p=l(f[0]),y=h(f[0]);for(let E=1;E<f.length;E++)p=Math.min(p,l(f[E])),y=Math.max(y,h(f[E]));Y&&(Y.meta={t0:p,tn:y});let w=Math.max(1,y-p),_=E=>(E-p)/w*s,T=0;for(let E of f){let b=Number(E?.attributes?.speed)||0;b>T&&(T=b)}(!Number.isFinite(T)||T<=0)&&(T=1);let k=E=>{let b=Number(E?.attributes?.latitude),N=Number(E?.attributes?.longitude);if(!Number.isFinite(b)||!Number.isFinite(N))return Q("#ffffff",Je);try{let M=ge(b,N);if(M&&M.id!=null){let I=vt(M.id);if(I?.color)return Q(I.color,Je)}}catch{}return Q("#ffffff",Je)},C=Q("#ff0000",Je),x=Q("#00ff00",Je);z.clearRect(0,0,s,a),z.fillStyle="#fff",z.fillRect(0,0,s,a);let S=0,g=k(f[0]);for(let E=1;E<f.length;E++){let b=f[E],N=_(+new Date(b.last_updated)),M=k(b);M!==g&&(A(S,N,c,d,g),S=N,g=M)}A(S,s,c,d,g),S=0;let $=!!f[0].stop;for(let E=1;E<f.length;E++){let b=f[E],N=_(+new Date(b.last_updated)),M=!!b.stop;M!==$&&(A(S,N,m,d,$?C:x),S=N,$=M)}if(A(S,s,m,d,$?C:x),f.length>=1){let E=I=>{let Z=Math.max(0,Number(I)||0)/T;return m+(1-Z)*d};z.beginPath(),z.lineJoin="miter",z.lineCap="butt",z.strokeStyle="#227722",z.lineWidth=1.2;let b=f[0],N=_(+new Date(b.last_updated)),M=E(b?.attributes?.speed);if(f.length===1)z.moveTo(N,M),z.lineTo(s,M);else{z.moveTo(N,M);for(let I=1;I<f.length;I++){let q=f[I],Z=_(+new Date(q.last_updated)),j=E(q?.attributes?.speed);z.lineTo(Z,M),z.lineTo(Z,j),N=Z,M=j}z.lineTo(s,M)}z.stroke()}let B=Mo(t?.markerTs);if(Number.isFinite(B)){let E=_(B);if(E>=0&&E<=s){let b=Math.round(E),N=10,M=10;z.save(),z.lineCap="butt",z.beginPath(),z.moveTo(b-N/2,0),z.lineTo(b+N/2,0),z.lineTo(b,M),z.closePath(),z.fillStyle="#2563eb",z.fill(),z.beginPath(),z.moveTo(b,0),z.lineTo(b,a/2),z.lineWidth=2,z.strokeStyle="#2563eb",z.stroke(),z.restore()}}function A(E,b,N,M,I){let q=Math.min(E,b),Z=Math.max(E,b),j=Math.max(1,Z-q);z.fillStyle=I||Q("#ffffff",Je),z.fillRect(q,N,j,M)}}function Po(){Do||!W||(W.addEventListener("click",e=>{if(!Y||!Array.isArray(Y.positions)||Y.positions.length===0)return;let t=Y.meta;if(!t)return;let n=W.getBoundingClientRect(),o=e.clientX-n.left,r=n.width||1,s=t.t0+Math.max(0,Math.min(r,o))/r*(t.tn-t.t0),a=null;for(let d of Y.positions){let c=+new Date(d.last_updated),m=Math.abs(c-s);(!a||m<a.d)&&(a={p:d,d:m})}if(!a)return;fn(a.p.last_updated);let i=`${a.p.entity_id}_${new Date(a.p.last_updated).toISOString()}`;document.dispatchEvent(new CustomEvent("positions:select-by-id",{detail:{uniqueId:i}}))}),Do=!0)}var Pt=[],Ye=null,ee=null,Nt="zone",Ee=!0,hn=16,ks="/ha-tracker/images/filter.png",Ls="/ha-tracker/images/stop16x16.png",Bo="/ha-tracker/images/stop24x24.png",pe=e=>String(e).padStart(2,"0"),Ao=document.getElementById("combo-select");Ao&&Ao.addEventListener("change",()=>{At(),gn()});function gn(){let e=document.querySelector('.tab-button[data-tab="positions"]');e&&Ro({currentTarget:e},"positions")}function Ro(e,t){document.querySelectorAll(".tab").forEach(n=>n.classList.remove("active")),document.querySelectorAll(".tab-button").forEach(n=>n.classList.remove("active")),document.getElementById(t).classList.add("active"),e?.currentTarget&&e.currentTarget.classList.add("active")}async function Oo(){vn(!1),Bs(),an();let e=document.getElementById("person-select");e&&(e.addEventListener("focus",async()=>{try{await tn()}catch(n){console.error(n)}}),e.addEventListener("change",()=>{try{At(!0,!1),en(e.value)}catch(n){console.error(n)}})),document.querySelectorAll(".tab-button").forEach(n=>{n.addEventListener("click",o=>{try{let r=n.getAttribute("data-tab");Ro(o,r)}catch(r){console.error(r)}})}),await po({onApplyFilter:()=>Uo().catch(console.error)}),document.addEventListener("positions:select-by-id",n=>{let o=n?.detail?.uniqueId;if(o)try{bn(o)}catch(r){console.error("No se pudo seleccionar la fila desde el gr\xE1fico:",r)}}),Dt()}function Cs(){if(!ee)return;document.querySelectorAll("#filter-table-body tr").forEach(t=>{let n=t.dataset.zone||"",o=n&&ee.zonePositions?.[n]||null,r=n?{name:n,color:o?.color||null}:null;It(t,r,V)})}async function Ho(e){try{gn();let t=Array.isArray(e)?e:e?.positions||[],n=Array.isArray(e)?null:e?.summary||null,o=Array.isArray(e)?null:e?.zones||null;t.length>0?(console.log("Positions:",t),await At(!1,!1),No(t),o&&Ns(o),await $s(t),n&&Ds(n),await jo(),Cs(),await Ms(t),await Is(t,void 0,void 0,void 0,void 0,void 0,{curved:!0,curveAlg:"catmull",subdivisions:6,alpha:.5}),vn(!0)):(At(!0,!1),O(u("no_positions"),{title:u("filter")}))}catch(t){console.error("Error getting filtered positions:",t),O(u("filter_problem"),{title:u("filter")})}}async function $s(e){let t=document.getElementById("filter-table-body");if(!e||e.length===0)return;let n=[],o=null,r=0,s=[];e.forEach((l,h)=>{let p=ge(l.attributes.latitude,l.attributes.longitude),y=p?p.name:"";s[h]={zone:p,zn:y},h===0?(o=y,r=0):y!==o&&(n.push({start:r,end:h-1}),o=y,r=h),h===e.length-1&&n.push({start:r,end:h})});let a=Ws(),i=null,d=0,c=!1,m=document.createDocumentFragment();if(e.forEach((l,h)=>{let{zone:p,zn:y}=s[h];y!==i?(d++,i=y,c=!0):c=!1;let w=`group-${d}`,_=l?.stop?`<img src="${Ls}" alt="" style="width:16px;height:16px;">`:"",T=le(l.last_updated),k=Math.round((l.attributes.speed||0)*(F?2.23694:3.6)),C=J(k),x=`${l.entity_id}_${new Date(l.last_updated).toISOString()}`,S=document.createElement("tr");if(It(S,p,V),S.classList.add(w,"pos-main-row"),S.dataset.entityId=x,S.dataset.latitude=l.attributes.latitude,S.dataset.longitude=l.attributes.longitude,S.dataset.lastUpdated=l.last_updated,S.dataset.speed=String(k),S.dataset.battery=(Os(l?.attributes)??"").toString(),S.dataset.isStop=l&&l.stop?"1":"0",S.dataset.entity=l?.entity_id||"",S.dataset.zone=y||"",S.dataset.address="",S.style.cursor="pointer",c){let g=n[d-1],$=new Date(e[g.start].last_updated),B=new Date(e[g.end].last_updated),A=Io($),E=Io(B);S.classList.add("group-header"),S.innerHTML=`
				<td><button class="toggle-btn">\u25BA</button></td>
				<td>${_}</td>
				<td>${T}</td>
				<td>${y}</td>
				<td>${C}</td>
				<td>
				  <button class="group-filter-btn" title="${u("filter")||"Filtrar"}"
						  style="background:none;border:none;cursor:pointer;padding:0;line-height:0;">
						  <img src="${ks}" alt="" style="width:16px;height:16px;">
				  </button>
				</td>
			  `;let b=S.querySelector(".toggle-btn");b.addEventListener("click",M=>{M.stopPropagation(),Zo(w,b)}),S.querySelector(".group-filter-btn").addEventListener("click",async M=>{M.stopPropagation();try{let[I,q="00:00:00"]=A.split("T"),[Z,j="23:59:59"]=E.split("T"),R=he=>{let[re,Xe,Qe]=he.split("-").map(Number);return new Date(re,Xe-1,Qe,0,0,0,0)};kt(q,j),sn([R(I),R(Z)],!0),await Uo()}catch(I){console.error("No se pudo aplicar el rango al calendario",I)}})}else l&&l.stop?(S.style.display="table-row",S.classList.add("pin-visible")):S.style.display="none",S.innerHTML=`
				<td></td>
				<td>${_}</td>
				<td>${T}</td>
				<td>${y}</td>
				<td>${C}</td>
				<td></td>
			  `;if(S.onclick=()=>Mt(S),m.appendChild(S),l&&l.stop){S.classList.add("has-address");let g=document.createElement("tr");g.dataset.address="",g.classList.add(w,"position-address-row","pin-visible"),g.style.cursor="pointer",g.dataset.entityId=x,g.style.display="table-row",g.dataset.zone=y||"";let $=new Date(l.last_updated).getTime();g.dataset.latitude=String(+l.attributes.latitude),g.dataset.longitude=String(+l.attributes.longitude),g.dataset.lastUpdated=String($),g.innerHTML=`
        <td class="addr-spacer"></td>
        <td class="addr-cell" colspan="5" style="padding:4px 8px;">\u2026</td>
      `,g.onclick=()=>Mt(S),m.appendChild(g),It(g,p,V),a.observe(g)}}),t.innerHTML="",t.appendChild(m),e.length>0){let l=t.querySelector("tr");l&&Mt(l)}t.querySelectorAll(".group-header").forEach(l=>{let h=Array.from(l.classList).find(k=>k.startsWith("group-"));if(!h)return;let p=t.querySelectorAll(`tr.${h}:not(.group-header):not(.pin-visible)`),y=p.length>0,w=y&&Array.from(p).some(k=>k.style.display==="none"),_=l.querySelector(".toggle-btn"),T=l.querySelector(".group-filter-btn");_&&(_.style.display=y?"":"none",_.textContent=w?"\u25BA":"\u25BC"),T&&(T.style.display=y?"":"none")})}function Ts(){let e=document.getElementById("filter-table-body");if(!e)return;let t=Array.from(e.querySelectorAll("tr.pos-main-row"));if(!t.length)return;let n=null;for(let o of t){let r=Number(o.dataset.speed)||0,s=Date.parse(o.dataset.lastUpdated)||0;(!n||r>n.s||r===n.s&&s>n.ts)&&(n={id:o.dataset.entityId,s:r,ts:s})}n&&n.id?bn(n.id):O(u("no_positions")||"No hay posiciones.",{title:u("filter")})}function Ds(e){let t=F?2.23694:3.6,n=F?e.distance_m/1609.344:e.distance_m/1e3,o=s=>wn(s*1e3);document.getElementById("positions-count").textContent=J(e.positions_count),document.getElementById("total-time").textContent=o(e.total_time_s),document.getElementById("distance").textContent=`${J(n)} ${u(F?"miles":"kilometres")}`,document.getElementById("max-speed").textContent=`${J(e.max_speed_mps*t)} ${u(F?"mi_per_hour":"km_per_hour")}`,document.getElementById("average-speed").textContent=`${J(e.average_speed_mps*t)} ${u(F?"mi_per_hour":"km_per_hour")}`,document.getElementById("stops-count").textContent=J(e.stops_count),document.getElementById("stopped-time").textContent=o(e.stopped_time_s);let r=document.querySelector("#summary table tbody tr:nth-child(4)");r&&(r.style.cursor="pointer",r.onclick=Ts)}function Ns(e){ee={zoneDurations:{},zoneVisits:{},zonePositions:{},zoneStops:{},zoneDistanceMeters:{}};for(let t of e){let n=t.zone||"";if(ee.zoneDurations[n]=(t.time_s||0)*1e3,ee.zoneVisits[n]=t.visits||0,ee.zoneStops[n]=t.stops||0,ee.zoneDistanceMeters[n]=t.distance_m||0,t.id!=null){let o=vt(t.id);o&&(ee.zonePositions[n]={id:o.id,name:o.name||n,lat:o.lat,lon:o.lon,color:o.color||null})}}}async function Ms(e){v.getPane("filterMarkers")||(v.createPane("filterMarkers"),v.getPane("filterMarkers").style.zIndex=400);let t=hn;e.forEach(n=>{let o=Number(n?.attributes?.latitude),r=Number(n?.attributes?.longitude);if(!Number.isFinite(o)||!Number.isFinite(r))return;let s=n.stop?L.icon({iconUrl:Bo,iconSize:[24,24],iconAnchor:[12,12]}):L.divIcon({className:"",html:`<div style="
            width:10px;height:10px;border:1px solid rgba(0,0,255,0.8);
            border-radius:50%;background-color: rgba(0,0,255,0.5);
          "></div>`,iconSize:[10,10],iconAnchor:[5,5]}),a=L.marker([o,r],{icon:s,pane:"filterMarkers"});a.isStop=!!n.stop,(n.stop||v.getZoom()>=t)&&a.addTo(v),n.stop&&a.setZIndexOffset(50),a.on("click",()=>{let i=`${n.entity_id}_${new Date(n.last_updated).toISOString()}`;bn(i)}),Pt.push(a)}),zt||(v.on("zoomend",yn),zt=!0),yn()}async function Uo(){let e=document.getElementById("person-select").value,{startLocal:t,endLocal:n}=Lt();if(!e){O(u("select_user_filter"),{title:u("filter")}),mt();return}if(!t||!n){O(u("select_dates"),{title:u("filter")});return}let o=zo(t,!1),r=zo(n,!n.includes("T"));if(!o||!r){O(u("select_dates"),{title:u("filter")});return}let s=new Date(Date.parse(r)+1e3).toISOString(),a=Date.parse(o),i=Date.parse(s);if(!Number.isFinite(a)||!Number.isFinite(i)||a>=i){O(u("invalid_dates"),{title:u("filter")}),mt();return}let d=744*60*60*1e3;if(i-a>d){O(u("date_range"),{title:u("filter")}),mt();return}try{gt(u("running_filter")),await qo(e,o,s)}catch(c){console.error("Error during filter:",c),O(u("filter_error"),{title:u("filter")})}finally{bt()}}async function At(e=!0,t=!0){if(e&&mt(),t){let o=document.getElementById("person-select");o&&(o.value="",o.dispatchEvent(new Event("change",{bubbles:!0})))}As(),document.getElementById("filter-table-body").innerHTML="",document.getElementById("positions-count").textContent="--",document.getElementById("total-time").textContent="--",document.getElementById("distance").textContent="--",document.getElementById("max-speed").textContent="--",document.getElementById("average-speed").textContent="--",document.getElementById("stops-count").textContent="--",document.getElementById("stopped-time").textContent="--",document.getElementById("summary-zones-table-body").innerHTML="";let n=document.querySelector("#summary table tbody tr:nth-child(4)");if(n&&(n.style.cursor="",n.onclick=null),Pt.forEach(o=>{try{v.removeLayer(o)}catch{}}),Pt=[],window.routeLineSegments&&(window.routeLineSegments.forEach(o=>{try{v.removeLayer(o)}catch{}}),window.routeLineSegments=[]),window.routeOutline){try{v.removeLayer(window.routeOutline)}catch{}window.routeOutline=null}zt&&(v.off("zoomend",yn),zt=!1),Me&&(Me.disconnect(),Me=null),an(),vn(!1),mn()}async function Zo(e,t){let n=document.querySelectorAll(`tr.${e}:not(.group-header):not(.pin-visible)`);if(!n.length){t.textContent=t.textContent==="\u25BA"?"\u25BC":"\u25BA";return}let o=n[0].style.display==="none";n.forEach(r=>{r.style.display=o?"table-row":"none"}),t.textContent=o?"\u25BC":"\u25BA",o&&queueMicrotask(()=>{let r="#filter-table-body",s=document.querySelector(`${r} tr.${e}.selected`);if(s&&s.classList.contains("position-address-row")){let a=s.previousElementSibling;a&&a.classList.contains("pos-main-row")&&(s=a)}s||(s=document.querySelector(`${r} tr.${e}:not(.group-header)`)),s&&s.scrollIntoView({behavior:"smooth",block:"center"})})}async function Mt(e){document.querySelectorAll("#filter-table-body tr").forEach(d=>d.classList.remove("selected")),e.classList.add("selected");let n=e.nextElementSibling;n&&n.classList.contains("position-address-row")&&n.classList.add("selected");let o=parseFloat(e.dataset.latitude),r=parseFloat(e.dataset.longitude),s=e.dataset.lastUpdated,a=Math.round(e.dataset.speed||0),i=e.dataset.isStop==="1";Ps(o,r,s,a,i),fn(s)}function Ps(e,t,n,o,r=!1){let s=`https://www.google.com/maps/search/?api=1&query=${e},${t}`,i=`
	  ${r?`<strong>${u("stop")||"Stop"}</strong><br>`:""}
	  ${le(n)}<br>${u("speed")}: ${J(o)} ${u(F?"mi_per_hour":"km_per_hour")}
	  <br><br><a href="${s}" target="_blank" rel="noopener noreferrer"><strong>${u("open_location")}</strong></a>
	`;Ye&&Ye.remove(),Ye=L.popup({autoPan:!0}).setLatLng([e,t]).setContent(i).openOn(v),v.invalidateSize(),v.setView([e,t],v.getZoom())}function As(){Ye&&(Ye.remove(),Ye=null)}async function bn(e){let t=document.getElementById("filter-table-body");if(!t){console.error("Filter table tbody not found.");return}let n=t.querySelector(`tr[data-entity-id="${e}"]`);if(!n){console.error("Row not found for position:",e);return}let o=getComputedStyle(n).display==="none"||n.style.display==="none",r=[...n.classList].find(a=>a.startsWith("group-"));if(!r){console.error("The row does not belong to any group:",n);return}if(o){let a=document.querySelector(`tr.${r}.group-header`);if(a){let i=a.querySelector(".toggle-btn");i&&Zo(r,i)}}let s=document.getElementById("combo-select");if(s&&s.value!=="filter"){s.value="filter";let a=new Event("change",{bubbles:!0});s.dispatchEvent(a)}Mt(n),gn(),n.scrollIntoView({behavior:"smooth",block:"center"})}async function Is(e,t=[0,200,0,.8],n=[100,100,255,.8],o="#ffffff",r=9,s=6,a={}){let{curved:i=!1,curveAlg:d="catmull",subdivisions:c=8,alpha:m=.5}=a;if(!e||e.length<2)return;let f=e.map(h=>h.attributes.latitude&&h.attributes.longitude?[h.attributes.latitude,h.attributes.longitude]:null).filter(Boolean);if(f.length<2)return;if(i&&d==="catmull"){let y=(f.length-1)*c>4e3?Math.max(1,Math.floor(4e3/Math.max(f.length-1,1))):c;f=zs(f,y,m)}if(window.routeLineSegments&&window.routeLineSegments.forEach(h=>{try{v.removeLayer(h)}catch{}}),window.routeLineSegments=[],window.routeOutline){try{v.removeLayer(window.routeOutline)}catch{}window.routeOutline=null}v.getPane("routeOutline")||v.createPane("routeOutline"),v.getPane("routeColor")||v.createPane("routeColor"),v.getPane("routeOutline").style.zIndex=390,v.getPane("routeColor").style.zIndex=391;let l=f.length-1;for(let h=0;h<l;h++){let p=h/l,y=Math.round(t[0]+p*(n[0]-t[0])),w=Math.round(t[1]+p*(n[1]-t[1])),_=Math.round(t[2]+p*(n[2]-t[2])),T=t[3]+p*(n[3]-t[3]),k=`rgba(${y},${w},${_},${T})`,C=f[h],x=f[h+1],S=L.polyline([C,x],{color:o,weight:r,opacity:1,lineCap:"round",lineJoin:"round",pane:"routeOutline"}).addTo(v);window.routeLineSegments.push(S);let g=L.polyline([C,x],{color:k,weight:s,opacity:1,lineCap:"round",lineJoin:"round",pane:"routeColor"}).addTo(v);window.routeLineSegments.push(g)}v.fitBounds(L.latLngBounds(f))}function zs(e,t=8,n=.5){let r=e.map(d=>[Number(d[0]),Number(d[1])]).filter(d=>Number.isFinite(d[0])&&Number.isFinite(d[1]));if(r.length<2)return r;let s=[],a=(d,c,m)=>[d[0]+(c[0]-d[0])*m,d[1]+(c[1]-d[1])*m],i=(d,c)=>Math.pow(Math.hypot(c[0]-d[0],c[1]-d[1])||1e-6,n);s.push(r[0]);for(let d=0;d<r.length-1;d++){let c=d>0?r[d-1]:r[d],m=r[d],f=r[d+1],l=d+2<r.length?r[d+2]:r[d+1],h=0,p=h+i(c,m),y=p+i(m,f),w=y+i(f,l);for(let T=1;T<=t;T++){let k=p+T*(y-p)/t,C=a(c,m,(k-h)/(p-h+1e-6)),x=a(m,f,(k-p)/(y-p+1e-6)),S=a(f,l,(k-y)/(w-y+1e-6)),g=a(C,x,(k-h)/(y-h+1e-6)),$=a(x,S,(k-p)/(w-p+1e-6)),B=a(g,$,(k-p)/(y-p+1e-6)),A=s[s.length-1];(!A||Math.hypot(B[0]-A[0],B[1]-A[1])>1e-6)&&s.push(B)}let _=s[s.length-1];(!_||Math.hypot(f[0]-_[0],f[1]-_[1])>1e-6)&&s.push(f)}return s}async function jo(){let e=document.getElementById("summary-zones-table-body");if(!ee){console.error("There are no saved statistics for zones. Make sure to apply the filter first.");return}let{zoneDurations:t,zoneVisits:n,zonePositions:o,zoneStops:r,zoneDistanceMeters:s}=ee,d=[...new Set([...Object.keys(t||{}),...Object.keys(n||{}),...Object.keys(r||{}),...Object.keys(s||{})])].sort((c,m)=>{switch(Nt){case"zone":return Ee?c.localeCompare(m):m.localeCompare(c);case"time":return Ee?(t?.[c]||0)-(t?.[m]||0):(t?.[m]||0)-(t?.[c]||0);case"visits":return Ee?(n?.[c]||0)-(n?.[m]||0):(n?.[m]||0)-(n?.[c]||0);case"stops":return Ee?(r?.[c]||0)-(r?.[m]||0):(r?.[m]||0)-(r?.[c]||0);case"distance":return Ee?(s?.[c]||0)-(s?.[m]||0):(s?.[m]||0)-(s?.[c]||0);default:return 0}});e.innerHTML="";for(let c of d){let m=t?.[c]||0,f=n?.[c]||0,l=r?.[c]||0,h=s?.[c]||0,p=F?h/1609.344:h/1e3,y=`${J(p)}`,w=c,_=document.createElement("tr");_.innerHTML=`
		  <td>${w}</td>
		  <td>${wn(m)}</td>
		  <td>${J(f)}</td>
		  <td>${J(l)}</td>
		  <td>${y}</td>
		`;let T=o[c];T&&T.id!=null?(_.style.cursor="pointer",_.addEventListener("click",()=>Vt(T.id))):_.style.cursor="",_.addEventListener("click",()=>{let C=o[c];C&&Vt(C.id)});let k=o[c];if(c){let C={name:c,color:k?.color||null};It(_,C,V)}else _.classList.remove("zone-tinted"),_.style.removeProperty("--color-bg");e.appendChild(_)}Fs()}function Fs(){let e=document.querySelector("#summary-zones-table");if(!e){console.error("Zone summary table not found.");return}e.querySelectorAll("thead th").forEach(n=>{let o=n.getAttribute("data-i18n"),r="";switch(o){case"zone":r="zone";break;case"time":r="time";break;case"visits":r="visits";break;case"stops":r="stops";break;case"distance":r="distance";break}if(!r)return;n.style.cursor="pointer",n.onclick=()=>{Nt===r?Ee=!Ee:(Nt=r,Ee=!0),jo()};let s=Nt===r?Ee?"\u25B2":"\u25BC":"",a=o==="distance"?F?u("miles"):u("kilometres"):u(o);n.innerHTML=`
            <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:30px;">
                <span class="hdr-label">${a}</span>
                <span class="hdr-arrow" style="font-size:12px;">${s}</span>
            </div>`})}function Bs(){if(document.getElementById("zone-tint-css"))return;let e=document.createElement("style");e.id="zone-tint-css",e.textContent=`
		/* Aplica tinte solo si la fila NO est\xE1 seleccionada */
		#filter-table-body tr.zone-tinted:not(.selected),
		#summary-zones-table-body tr.zone-tinted:not(.selected) {
		  background-color: var(--color-bg);
		}
	  `,document.head.appendChild(e)}function It(e,t,n=V){if(!(!!t&&(t.name??"")!=="")){e.classList.remove("zone-tinted"),e.style.removeProperty("--color-bg");return}let r=Rs(t,n);r?(e.classList.add("zone-tinted"),e.style.setProperty("--color-bg",r)):(e.classList.remove("zone-tinted"),e.style.removeProperty("--color-bg"))}function Rs(e,t=V){if(!e)return null;let n=e.color;return!n&&e.name&&ee?.zonePositions?.[e.name]?.color&&(n=ee.zonePositions[e.name].color),n?Q(n,t):null}function wn(e){let t=Math.floor(e/1e3),n=Math.floor(t/(24*3600)),o=Math.floor(t%(24*3600)/3600),r=Math.floor(t%3600/60),s=t%60;return`${n>0?`${n} ${n===1?u("day"):u("days")} `:""}${String(o).padStart(2,"0")}:${String(r).padStart(2,"0")}`}function Io(e){return`${e.getFullYear()}-${pe(e.getMonth()+1)}-${pe(e.getDate())}T${pe(e.getHours())}:${pe(e.getMinutes())}:${pe(e.getSeconds())}`}function zo(e,t=!1){if(!e)return null;let n=e.match(/\d+/g)?.map(Number);if(!n||n.length<3)return null;let[o,r,s]=n,a=0,i=0,d=0,c=0;return n.length>=5?(a=n[3],i=n[4],d=n[5]??0):t&&(a=23,i=59,d=59,c=999),new Date(o,r-1,s,a,i,d,c).toISOString()}function vn(e){let t=document.getElementById("export-filter"),n=t?.closest(".group");!n||!t||(n.style.display=e?"":"none",t.disabled=!e,n.setAttribute("aria-hidden",e?"false":"true"))}function Os(e){if(!e||typeof e!="object")return null;let t=["battery","battery_level","battery_percent","battery_percentage","battery_level_pct","batteryLevel"],n=null;for(let o of t)if(o in e){n=e[o];break}if(n==null)return null;if(typeof n=="string"){let o=n.match(/(\d+(?:\.\d+)?)\s*%?/);o&&(n=Number(o[1]))}return n=Number(n),Number.isFinite(n)?n>0&&n<=1?Math.round(n*100):n>=1&&n<=100?Math.round(n):null:null}function Ft(){let e=document.getElementById("filter-table-body");if(!e)return[];let t=Array.from(e.querySelectorAll("tr.pos-main-row")),n=[];for(let o of t){let r=Number(o.dataset.latitude),s=Number(o.dataset.longitude);if(!Number.isFinite(r)||!Number.isFinite(s))continue;let a=o.dataset.lastUpdated,i=o.dataset.isStop==="1",d=o.dataset.entity||"",c=o.dataset.zone||"";if(!c&&typeof ge=="function")try{c=ge(r,s)?.name||""}catch{}let m=o.dataset.address||"";if(!m&&i){let p=o.nextElementSibling;if(p&&p.classList.contains("position-address-row")){let w=((p.querySelector("td.addr-cell")||p.querySelector("td"))?.textContent||"").trim();w&&w!=="\u2026"&&(m=w)}}let f=Number(o.dataset.speed),l=null;Number.isFinite(f)&&(l=(F?f*1.609344:f)/3.6);let h=o.dataset.battery&&Number.isFinite(Number(o.dataset.battery))?Number(o.dataset.battery):null;n.push({entity_id:d,last_updated:a,stop:i,zone:c,address:m,battery:h,attributes:{latitude:r,longitude:s,speed:l}})}return n}function Fo(e){if(!e)return"unknown";let t=e.match(/\d+/g)?.map(Number);if(!t||t.length<3)return"unknown";let[n,o,r,s=0,a=0]=t;return e.includes("T")?`${n}-${pe(o)}-${pe(r)}_${pe(s)}-${pe(a)}`:`${n}-${pe(o)}-${pe(r)}`}function Hs(e){return String(e).normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[\\/:*?"<>|]/g,"").trim().replace(/\s+/g,"_")}function Bt(e="kml"){let t=document.getElementById("person-select"),n=Hs(t?.selectedOptions?.[0]?.text||t?.value||"person"),{startLocal:o,endLocal:r}=Lt();return`${n}_${Fo(o)}_${Fo(r)}.${e}`}document.getElementById("export-filter")?.addEventListener("change",e=>{let t=e.target.value;t==="export-kml"?Us():t==="export-csv"?Zs():t==="export-xlsx"?js():t==="export-pdf"&&qs(),e.target.value="export-file"});function Us(){let e=Ft();if(!e.length){O(u("no_positions"),{title:"KML"});return}let t=Bt("kml");wo(e,{filename:t,stopIconHref:new URL(Bo,window.location.origin).href,includeRoute:!0,nameStop:n=>`${le(n.last_updated)}`,describeStop:n=>{let o=Math.round((n?.attributes?.speed||0)*(F?2.23694:3.6)),r=u(F?"mi_per_hour":"km_per_hour"),s=Number.isFinite(n?.battery)?`${n.battery}%`:"";return`<table cellspacing="0" cellpadding="0" style="border-collapse:collapse">
        ${n.zone?`<tr><td>\u25CF ${n.zone}</td></tr>`:""}
        ${n.address?`<tr><td>\u25CF ${n.address}</td></tr>`:""}
        <tr><td>\u25CF ${o} ${r}</td></tr>
		${s?`<tr><td>\u25CF ${u("battery")}: ${s}</td></tr>`:""}
      </table>`},formatLocal:n=>le(n),unitLabel:u(F?"mi_per_hour":"km_per_hour"),batteryLabel:u("battery")})}function Zs(){let e=Ft();if(!e.length){O(u("no_positions"),{title:"CSV"});return}let t=Bt("csv");Eo(e,{filename:t,useImperial:!!F,formatLocal:n=>le(n),delimiter:";",usePicker:!1})}async function js(){let e=Ft();if(!e.length){O(u("no_positions")||"No hay posiciones para exportar.",{title:"Excel"});return}let t=Bt("xlsx");await ko(e,{filename:t,useImperial:!!F,formatLocal:n=>le(n),sheetName:"Posiciones"})}async function qs(){let e=Ft();if(!e.length){O(u("no_positions"),{title:"PDF"});return}let t=[{label:u("positions"),value:document.getElementById("positions-count")?.textContent||""},{label:u("total_time"),value:document.getElementById("total-time")?.textContent||""},{label:u("distance"),value:document.getElementById("distance")?.textContent||""},{label:u("max_speed"),value:document.getElementById("max-speed")?.textContent||""},{label:u("average_speed"),value:document.getElementById("average-speed")?.textContent||""},{label:u("stops_count"),value:document.getElementById("stops-count")?.textContent||""},{label:u("stopped_time"),value:document.getElementById("stopped-time")?.textContent||""}],n=[],o=ee?.zonePositions||{};if(ee){let{zoneDurations:h,zoneVisits:p,zoneStops:y,zoneDistanceMeters:w}=ee,T=[...new Set([...Object.keys(h||{}),...Object.keys(w||{})])].sort((C,x)=>C.localeCompare(x)),k=F?"mi":"km";for(let C of T){let x=h?.[C]||0,S=p?.[C]||0,g=y?.[C]||0,$=w?.[C]||0,B=F?$/1609.344:$/1e3,A=`${J(B)} ${k}`;n.push({zone:C,time:wn(x),visits:S,stops:g,distance:A,_unitShort:k,_fillColor:un(C,o,{alpha:V})})}}let r=Co(e),s=u(F?"mi_per_hour":"km_per_hour")||(F?"mph":"km/h"),a=r.map(h=>{let p=Math.round((h?.attributes?.speed||0)*(F?2.23694:3.6));return{whenLocal:le(h.last_updated),isStop:!!h.stop,zone:h.zone||"",speed:Number.isFinite(p)?`${p} ${s}`:"",battery:Number.isFinite(h?.battery)?h.battery:"",address:h.address||"",_fillColor:h.zone?un(h.zone,o,{alpha:V}):null}}),i=document.getElementById("person-select"),d=i?.selectedOptions?.[0]?.text?.trim()||i?.value?.trim()||"\u2014",{startLocal:c,endLocal:m}=Lt()||{};c&&(c=le(c)),m&&(m=le(m));let f={personName:d,startLocal:c,endLocal:m},l=Bt("pdf");await $o({filename:l,summaryRows:t,zonesRows:n,positionsRows:a,stopIconUrl:new URL("/ha-tracker/images/stop16x16.png",window.location.origin).href,header:f})}var Me=null;function Ws(){if(Me)return Me;let e=document.querySelector("#positions .table-wrapper")||null;return Me=new IntersectionObserver(t=>{for(let n of t){if(!n.isIntersecting)continue;let o=n.target;Me.unobserve(o);let r=o.dataset.entityId,s=Number(o.dataset.latitude),a=Number(o.dataset.longitude),i=Number(o.dataset.lastUpdated);if(!(Number.isFinite(s)&&Number.isFinite(a)&&Number.isFinite(i)))continue;let d=o.querySelector("td.addr-cell")||o.querySelector("td");d&&d.textContent!=="\u2026"&&(d.textContent="\u2026"),it(r,s,a,i,c=>{let m=document.querySelector(`tr.position-address-row[data-entity-id="${r}"] td.addr-cell`)||document.querySelector(`tr.position-address-row[data-entity-id="${r}"] td`);m&&(m.textContent=c||"")})}},{root:e,rootMargin:"200px"}),Me}var zt=!1;function yn(){let e=v.getZoom();Pt.forEach(t=>{if(!t.isStop){let n=v.hasLayer(t);e>=hn&&!n?t.addTo(v):e<hn&&n&&v.removeLayer(t)}})}async function ce(e,{method:t="GET",headers:n={},body:o,timeoutMs:r=15e3}={},s=!0){let a=new AbortController,i=setTimeout(()=>a.abort("timeout"),r);try{let d;if(s){if(d=await Ln(),!d||!d.trim())throw new Error("Invalid token.");n={...n,Authorization:`Bearer ${d}`}}let c={method:t,headers:n,signal:a.signal,cache:"no-store"};t!=="GET"&&o!==void 0&&(c.body=o,!(o instanceof FormData)&&!(o instanceof Blob)&&!(o instanceof ArrayBuffer)&&(c.headers={"Content-Type":"application/json",...n}));let m=await fetch(e,c),f=m.status,l=Number(m.headers.get("Retry-After")),h=(m.headers.get("content-type")||"").toLowerCase();if(f===202){if(h.includes("application/json"))try{return await m.json()??{error:"queued",retry_after:Number.isFinite(l)?l:1.5}}catch{return{error:"queued",retry_after:Number.isFinite(l)?l:1.5}}return{error:"queued",retry_after:Number.isFinite(l)?l:1.5}}if(f===204)return null;if(!m.ok){let y=await m.text().catch(()=>""),w=new Error(`Error HTTP: ${f} - ${y}`);throw w.status=f,Number.isFinite(l)&&(w.retry_after=l),w}if(h.includes("application/json"))return await m.json();let p=await m.text();return p||null}catch(d){throw console.error("Error in fetchData:",d),d}finally{clearTimeout(i)}}async function Xn(e,t){if(!Number.isFinite(Number(e))||!Number.isFinite(Number(t)))throw new Error("latitude and longitude must be finite numbers.");let n=new URL(`${U}/api/ha_tracker/reverse_geocode`);n.searchParams.set("lat",String(e)),n.searchParams.set("lon",String(t)),n.searchParams.set("nowait","1"),n.searchParams.set("brief","1");try{return await ce(n.toString(),{timeoutMs:15e3})}catch(o){throw console.error("Error getting reverse geocode:",o),o}}async function Wo(){try{let e=`${U}/manifest.json`;return await ce(e,{method:"GET"},!1)}catch(e){throw console.error("Error getting manifest:",e),e}}async function Vo(){let e=`${U}/api/ha_tracker/config`;try{return await ce(e)}catch(t){throw console.error("Error getting configuration:",t),t}}async function Go(){let e=`${U}/api/ha_tracker/is_admin`;try{return(await ce(e))?.is_admin??!1}catch(t){throw console.error("Error checking admin status:",t),t}}async function ao(){let e=`${U}/api/ha_tracker/devices`;try{let t=await ce(e);await oo(t)}catch(t){throw console.error("Error getting Devices:",t),t}}async function io(){let e=`${U}/api/ha_tracker/persons`;try{let t=await ce(e);await ro(t)}catch(t){throw console.error("Error getting Persons:",t),t}}async function $e(){let e=`${U}/api/ha_tracker/zones`;try{let t=await ce(e);await jn(t)}catch(t){throw console.error("Error getting zones:",t),t}}async function Vn(e){if(!e)return console.error("Zone ID is required."),null;let t=JSON.stringify({id:e}),n=`${U}/api/ha_tracker/zones`;try{let o=await ce(n,{method:"DELETE",body:t});return o&&o.success?(console.log(`Zone with ID ${e} deleted successfully.`),!0):(console.error(`Error deleting zone: ${o?.error||"Unknown error"}`),!1)}catch(o){return console.error("Error trying to delete zone:",o),!1}}async function Gt(e,t,n,o,r,s=G,a=!0){if(!e||!t||!n||!o||!r)return console.error("Parameters: zoneId, name, radius, latitude and longitude are mandatory."),null;let i=`${U}/api/ha_tracker/zones`,d=JSON.stringify({id:e,name:t,radius:n,latitude:o,longitude:r,color:s,visible:a});try{let c=await ce(i,{method:"PUT",body:d});return c&&c.success?(console.log(`Zone with ID ${e} updated successfully.`),c):(console.error(`Error updating zone: ${c?.error||"Unknown error"}`),null)}catch(c){return console.error("Error trying to update the zone:",c),null}}async function Gn(e,t,n,o,r="mdi:map-marker",s=!1,a=!0,i=G){if(!e||!t||!n||!o)return console.error("All parameters (name, radius, latitude, longitude) are mandatory."),null;let d=`${U}/api/ha_tracker/zones`,c=JSON.stringify({name:e,radius:t,latitude:n,longitude:o,icon:r,passive:s,custom:a,color:i});try{let m=await ce(d,{method:"POST",body:c});return m&&m.success?(console.log(`Zone created successfully. ID: ${m.id}`),m.id):(console.error(`Error creating zone: ${m?.error||"Unknown error"}`),null)}catch(m){return console.error("Error trying to create zone:",m),null}}async function qo(e,t,n){if(!e||!t||!n){console.error("The person_id, startDate and endDate parameters are required.");return}let o=`${U}/api/ha_tracker/filtered_positions?person_id=${encodeURIComponent(e)}&start_date=${encodeURIComponent(t)}&end_date=${encodeURIComponent(n)}`;try{let r=await ce(o);await Ho(r)}catch(r){throw console.error("Error getting filtered positions:",r),r}}async function Cn(e){if(!e){console.error("No authorization code found in the URL.");return}try{let t=`${U}/auth/token`,n=new URLSearchParams({grant_type:"authorization_code",code:e,client_id:`${U}/`}),o=await ce(t,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n},!1);if(!o){console.error("Error getting token");return}console.log("************ Token Obtained ************",o);let r={...o,hassUrl:U,clientId:`${U}/`,expires:Date.now()+o.expires_in*1e3};try{localStorage.setItem("hassTokens",JSON.stringify(r))}catch(a){console.error("Error saving token to localStorage:",a);return}let s=`${U}/ha-tracker/index.html`;window.history.replaceState({},document.title,s)}catch(t){console.error("Error while obtaining token",t)}}async function $n(e){try{if(!U||!e)return console.error(`The base URL or refresh_token is not defined correctly.	haUrl: ${U}	refreshToken: ${e}`),null;let t=`${U}/auth/token`,n=new URLSearchParams({grant_type:"refresh_token",refresh_token:e,client_id:`${U}/`}),o=await ce(t,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n},!1);if(!o){console.error("Error renewing token");return}return console.log("************ Renewed Token ************",o),o}catch(t){return console.error("Error en la solicitud de renovaci\xF3n del token:",t),null}}var U=location.origin,Tt=!1,G="#008000",V=.3,J=Qo({max:0}),hi=Qo({min:2,max:2}),je=!1;var ft="",xn=10,nn=30,on=20;var Ko=!1,F=!1,He={log:console.log,debug:console.debug,info:console.info,warn:console.warn,error:console.error};async function Jo(){try{je=await Go()}catch(e){throw console.error("Error checking admin set:",e),e}}async function Yo(){try{let e=await Vo();e&&(ft=e.version,typeof e.update_interval=="number"&&e.update_interval>=10&&(xn=e.update_interval),typeof e.geocode_time=="number"&&e.geocode_time>=10&&(nn=e.geocode_time),typeof e.geocode_distance=="number"&&e.geocode_distance>=20&&(on=e.geocode_distance),typeof e.enable_debug=="boolean"&&(Ko=e.enable_debug),typeof e.use_imperial=="boolean"&&(F=e.use_imperial)),await Vs(),console.log("Configuration: ",e)}catch(e){throw console.error("Error checking admin set: ",e),e}}async function Xo(){try{return await Wo(),!0}catch{return console.warn("HA is Inactive"),!1}}async function Vs(){if(!Ko)console.log=()=>{},console.debug=()=>{},console.info=()=>{},console.warn=(...e)=>He.warn("[WARNING]:",...e),console.error=(...e)=>He.error("[ERROR]:",...e);else{let e=()=>{let t=new Date,n=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0"),r=String(t.getSeconds()).padStart(2,"0"),s=String(t.getMilliseconds()).padStart(3,"0");return`[${n}:${o}:${r}:${s}]`};console.log=(...t)=>He.log(e(),...t),console.debug=(...t)=>He.debug(e(),...t),console.info=(...t)=>He.info(e(),...t),console.warn=(...t)=>He.warn(e(),"[WARNING]:",...t),console.error=(...t)=>He.error(e(),"[ERROR]:",...t)}}function le(e){let t=new Date(e),n={weekday:"short",day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1};return t.toLocaleString(Ht||"en",n)}function Qo({locale:e,min:t=0,max:n=0,grouping:o=!0}={}){let r=e??(typeof navigator<"u"&&(navigator.languages?.[0]||navigator.language)||"en-GB"),s=new Intl.NumberFormat(r,{style:"decimal",minimumFractionDigits:t,maximumFractionDigits:n,useGrouping:o});return a=>s.format(Number(a)||0)}var nr=()=>requestAnimationFrame(()=>v?.invalidateSize(!0));async function or(){try{Sn(document.getElementById("combo-select"));let e=document.getElementById("person-select");e&&(e.dataset.defaultIcon="users",Sn(e));let t=document.getElementById("export-filter");t&&(t.dataset.defaultIcon="export",Sn(t));let n=document.getElementById("forms-container");window.innerWidth<=600?(n.classList.add("hidden"),n.classList.remove("visible")):(n.classList.add("visible"),n.classList.remove("hidden")),Ks(),document.body.classList.contains("loaded")||document.body.classList.add("loaded")}catch(e){console.error("Error during load:",e)}}window.addEventListener("resize",()=>{document.querySelectorAll(".table-container").forEach(Rt)});async function rr(){let e=document.getElementById("visits-col-css");e||(e=document.createElement("style"),e.id="visits-col-css",document.head.appendChild(e)),e.textContent=Tt?"":`
        #summary-zones-table thead th[data-i18n="visits"] { display: none !important; }
        #summary-zones-table-body tr > td:nth-child(3) { display: none !important; }
    `;let t=F?u("mi_per_hour"):u("km_per_hour"),n=F?u("miles"):u("kilometres"),o=F?u("feet"):u("meters");document.querySelectorAll('#positions-table thead th[data-i18n="speed"], #positions thead th[data-i18n="speed"]').forEach(r=>{let s=r.querySelector(".hdr-label");s?s.textContent=t:r.textContent=t}),document.querySelectorAll('#summary-zones-table thead th[data-i18n="distance"]').forEach(r=>{let s=r.querySelector(".hdr-label");s?s.textContent=n:r.textContent=n}),document.querySelectorAll('#zones-table thead th[data-i18n="radius"] .hdr-label').forEach(r=>{r.textContent=`${o}`}),document.querySelectorAll('#persons-table thead th[data-i18n="speed"] .hdr-label').forEach(r=>{r.textContent=`${t}`})}window.addEventListener("message",e=>{if(e.data?.type==="ping")try{e.source?.postMessage({type:"pong",id:e.data.id},e.origin||"*")}catch{}});document.getElementById("hamburger-button").addEventListener("click",async()=>{try{await Gs(),nr()}catch(e){console.error("Error handling menu button:",e)}});document.getElementById("combo-select").addEventListener("change",function(){try{let e=this.value,t=document.getElementById("filter-container"),n=document.getElementById("zones-container"),o=document.getElementById("persons-container");if(e==="filter")t.style.display="block",n.style.display="none",o.style.display="none";else if(e==="zones"){t.style.display="none",n.style.display="block",o.style.display="none";let r=document.getElementById("zones-table-body");r&&r.querySelectorAll("tr.selected").forEach(s=>s.classList.remove("selected")),Ie()}else if(e==="users"){t.style.display="none",n.style.display="none",o.style.display="block";let r=document.getElementById("persons-table-body");r&&r.querySelectorAll("tr.selected").forEach(s=>s.classList.remove("selected")),typeof updatePersonsTable=="function"&&updatePersonsTable()}typeof v<"u"&&v&&typeof v.closePopup=="function"&&v.closePopup(),nr()}catch(e){console.error("Error during combo-select:",e)}});async function Gs(){try{let e=document.getElementById("forms-container");e.classList.contains("hidden")?(e.classList.remove("hidden"),e.classList.add("visible")):(e.classList.add("hidden"),e.classList.remove("visible"))}catch(e){console.error("Error during toggleContainer:",e)}}async function Rt(e){try{if(getComputedStyle(e).display==="none"||e.offsetParent===null)return;let o=window.innerHeight,r=e.getBoundingClientRect().top,s=0;if(e.closest("#positions")){let i=document.getElementById("positions-chart");i&&(s=(i.offsetHeight||50)+10)}let a=Math.max(o-r-20-s,150);Math.abs(e.clientHeight-a)>2&&requestAnimationFrame(()=>{e.style.height=`${a}px`})}catch(t){console.error("Error adjusting table height:",t)}}async function Ks(){try{let e=document.querySelectorAll(".table-container"),t=document.getElementById("forms-container"),n=new ResizeObserver(s=>{requestAnimationFrame(()=>{s.forEach(a=>Rt(a.target))})}),o=new IntersectionObserver(s=>{requestAnimationFrame(()=>{s.forEach(a=>{a.isIntersecting&&Rt(a.target)})})}),r=new MutationObserver(()=>{requestAnimationFrame(()=>{document.querySelectorAll(".table-container").forEach(Rt)})});e.forEach(s=>{o.observe(s),n.observe(s)}),t&&r.observe(t,{childList:!0,subtree:!0})}catch(e){console.error("Error in observeTableContainers:",e)}}var er={users:'<path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5z"/>',zones:'<path d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7zm0 9.5A2.5 2.5 0 1 1 14.5 9 2.5 2.5 0 0 1 12 11.5z"/>',filter:'<path d="M3 4h18l-7 8v6l-4 2v-8z"/>',export:'<path d="M12 3v10"/><path d="M8 7l4-4 4 4"/><path d="M4 21h16v-2a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v2z"/>',dot:'<circle cx="12" cy="12" r="5"/>'},tr=e=>`<svg class="id-icon" viewBox="0 0 24 24" aria-hidden="true">${er[e]||er.dot}</svg>`;function Sn(e){if(!e||e.dataset.enhanced==="1")return;let t=document.createElement("div");t.className="id-wrap";let n=document.createElement("button");n.type="button",n.className="id-toggle",n.setAttribute("aria-haspopup","listbox"),n.setAttribute("aria-expanded","false"),n.setAttribute("aria-controls",e.id+"-menu");let o=document.createElement("div");o.className="id-menu",o.id=e.id+"-menu",o.setAttribute("role","listbox"),o.setAttribute("aria-hidden","true"),o.hidden=!0,e.classList.add("id-visually-hidden"),e.parentNode.insertBefore(t,e.nextSibling),t.appendChild(n),t.appendChild(o);function r(){return e.selectedOptions[0]||e.options[0]}function s(p){return p?.dataset.icon||e.dataset.defaultIcon||p?.value||"dot"}function a(){let p=r(),y=s(p);n.innerHTML=`${tr(y)}<span class="id-text">${p?.text||""}</span><span class="id-caret" aria-hidden="true">\u25BE</span>`}function i(){o.innerHTML="",Array.from(e.options).forEach((p,y)=>{let w=document.createElement("button");w.type="button",w.className="id-option",w.setAttribute("role","option"),w.dataset.value=p.value,w.setAttribute("aria-selected",String(p.selected)),w.innerHTML=`${tr(s(p))}<span>${p.text}</span>`,p.disabled&&(w.disabled=!0,w.style.opacity=.5,w.style.cursor="not-allowed"),w.addEventListener("click",()=>{p.disabled||(e.value=p.value,e.dispatchEvent(new Event("change",{bubbles:!0})),c(),n.focus())}),o.appendChild(w),w.tabIndex=p.selected||!e.value&&y===0?0:-1})}function d(){i(),o.hidden=!1,o.setAttribute("aria-hidden","false"),n.setAttribute("aria-expanded","true"),(o.querySelector('.id-option[aria-selected="true"]')||o.querySelector(".id-option"))?.focus(),document.addEventListener("click",f),document.addEventListener("keydown",l)}function c(){o.hidden=!0,o.setAttribute("aria-hidden","true"),n.setAttribute("aria-expanded","false"),document.removeEventListener("click",f),document.removeEventListener("keydown",l)}function m(){o.hidden?d():c()}function f(p){t.contains(p.target)||c()}function l(p){let y=Array.from(o.querySelectorAll(".id-option:not([disabled])")),w=y.indexOf(document.activeElement);p.key==="Escape"?(p.preventDefault(),c(),n.focus()):p.key==="ArrowDown"?(p.preventDefault(),(y[w+1]||y[0])?.focus()):p.key==="ArrowUp"?(p.preventDefault(),(y[w-1]||y.at(-1))?.focus()):p.key==="Home"?(p.preventDefault(),y[0]?.focus()):p.key==="End"?(p.preventDefault(),y.at(-1)?.focus()):(p.key==="Enter"||p.key===" ")&&document.activeElement?.classList.contains("id-option")&&(p.preventDefault(),document.activeElement.click())}e.addEventListener("change",()=>{a(),o.querySelectorAll(".id-option").forEach(p=>{p.setAttribute("aria-selected",String(p.dataset.value===e.value))})}),n.addEventListener("click",m),n.addEventListener("keydown",p=>{(p.key==="ArrowDown"||p.key==="Enter"||p.key===" ")&&(p.preventDefault(),d())}),new MutationObserver(()=>{a(),o.hidden||i()}).observe(e,{childList:!0,subtree:!0,characterData:!0}),a(),e.dataset.enhanced="1"}document.addEventListener("DOMContentLoaded",async()=>{try{await kn(),await Js()}catch(e){console.error("Error during DOMContentLoaded:",e)}});async function Js(){try{await Pn(),await Oo(),await Un(),await An(),await sr(),await so(),await or(),Ys()}catch(e){console.error("Error during init:",e)}}function Ys(){let e=performance.now();async function t(n){let o=(xn??10)*1e3;if(n-e>=o){e=n;try{await sr()}catch(r){console.error("update() failed:",r)}}requestAnimationFrame(t)}requestAnimationFrame(t)}async function sr(){try{await Xo()?(await Yo(),await Xs(),await Jo(),await no(),await Zn(),await rr(),bt()):gt(u("disconnected"),"rgba(255, 0, 0, 0.5)","white","rgba(200, 0, 0, 0.8)")}catch(e){console.error("Error during major update:",e)}}async function Xs(){try{if(!(window.self!==window.top)&&ft){let t=new URL(window.location.href);if(t.searchParams.get("v")!==ft){t.searchParams.set("v",ft);let o=t.toString();o!==window.location.href&&window.location.replace(o)}}}catch(e){console.error("Error during updateVersion:",e)}}
